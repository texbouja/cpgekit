\def\filedate{2021/03/08}
\def\fileversion{v0.1alpha}
\def\fileauthor{Sadik Boujaida, based on the work of Javier Bezos}

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{igtitle}[\filedate\space\fileversion]




%%% Le code qui suit est une agrégation des trois packages 
%%% titlesec.sty, titleps.sty et titletoc.sty du même auteur.  
%%% Le but est de transformer l'interface de configuration (compliquée)
%%% en un système clé/valeur basé sur pgfkeys et de supprimer 
%%% les options inutiles dans le cadre du projet igdoc.
%%% Le nom de domaine ttl a été changé en igt pour éviter les conflits.


%%% Copyright (C) 1998-2019 Javier Bezos http://www.texnia.com

%%% Notes
% ~~~~~
%
% The following tags are used:
% igt@  : the generic tag used through the style
% igth@ : a shape definition
% igtf@ : a macro containing the title format
% igts@ : id. the title space
% igtp@ : page key related macros
% igtl@ : level number
%
% The igtf@ and igts@ contains data in the form {..}{..}.
% Perhaps in future releases they should be converted
% to a prop-like list, similar to that proposed by the
% latex team.
%
% Admittedly, the current implementation seems too
% complicated, but that's necessary in order to provide
% certain compatibility with the sections as defined by the
% used class. Other packages opt for providing the sections
% as defined by standard classes ignoring the class; for
% instance sectsty which does a simple task in a simple and
% nice way. However, that was not my goal.
%
% Release
% ~~~~~~~

% Initialization
% ~~~~~~~~~~~~~~

\newif\ifigt@ps
\igt@psfalse

% The \igt@label switch is used when printing the label in titles.
% A numberless variant makes it to true.
% There is a \igt@toclabel as well, which is true iff the
% title is numbered; used in toc entries (except default part
% and chapter) and marks (only in igtitle pagestyles).

\newif\ifigt@label
\newif\ifigt@toclabel

\newbox\igt@box

% A provision for the report style:

\@ifundefined{if@mainmatter}
  {\let\if@mainmatter\iftrue}{}

\@ifundefined{if@openright}
  {\let\if@openright\iftrue}{}

% and the ams styles as well

\@ifundefined{@chapapp}
  {\let\@chapapp\chaptername}{}

\def\igt@trylist{\igt@try{}}

\def\igt@getkeys#1#2{%
  \if\expandafter @\@gobble#1@\@empty
    \edef\igt@b{\expandafter\@gobble\string#1}%
    \let\igt@a\igt@b
  \else
    \igt@keys
    \igt@getkeys{#1}{#2}%
  \fi}

% A more meaningful error for \@notdefinable

\expandafter\AtEndOfPackage\expandafter{\expandafter
  \gdef\expandafter\@notdefinable\expandafter{\@notdefinable}}

\def\@notdefinable{%
  \PackageError{igtitle}%
    {Incompatible package}%
    {igtitle cannot continue defining its own macros 
         because\MessageBreak
     \@backslashchar\reserved@a\space is already used by other package,
         the class\MessageBreak
     or the document.}}

%               +-----------------+
%               |  C L A S S E S  |
%               +-----------------+

\def\igt@useclass#1#2{%
  \@ifstar
    {\igt@labelfalse#1{#2}[]}%
    {\igt@labeltrue\@dblarg{#1{#2}}}}

\def\igt@straightclass{\igt@useclass\igt@straight@i}
\def\igt@partclass{\igt@useclass\igt@part@i}
\def\igt@topclass{\igt@useclass\igt@top@i}
\def\igt@pageclass{\igt@useclass\igt@page@i}

% Here \scantokens is used to make sure the unescaped name
% has `letters' and no `others'. Mainly for hyperref, so there
% should be no problems.

\newcommand\igtclass[1]{%
  \edef\igt@a{\expandafter\@gobble\string#1}%
  \ifx\scantokens\@undefined\else
    \scantokens\expandafter{\expandafter
      \def\expandafter\igt@a\expandafter{\igt@a}}%
  \fi
  \@ifnextchar[{\@tempswatrue\igt@class@i{#1}}%
               {\@tempswafalse\igt@class@ii{#1}}}

\def\igt@class@i#1[#2]{%
  \@namedef{igtl@\igt@a}{#2}%
  \expandafter\providecommand\csname\igt@a title\endcsname{}%%%%
  \@ifundefined{igt@toplevel}{}%
    {\expandafter\let\csname igtss@\igt@a\expandafter\endcsname
       \csname igtss@\igt@toplevel\endcsname}%
  \edef\igt@toplevel{\igt@a}%
  \igt@class@ii{#1}}

\def\igt@class@ii#1#2{%
  \@ifundefined{igt@#2class}%
    {\PackageError{igtitle}{Unknown sectioning class}%
       {Valid names are top, page and straight}}%
    {\expandafter\let\csname igt@compat\igt@a\endcsname\relax
     \@ifundefined{\igt@a mark}%
       {\@namedef{\igt@a mark}{\@gobble}}%
       {}%
     \edef#1{%
       \expandafter\noexpand\csname igt@#2class\endcsname{\igt@a}}}%
  \if@tempswa
    \expandafter\@gobble
  \else  
    \expandafter\@firstofone
  \fi
    {\@ifnextchar[%
       {\igt@class@iii}%
       {\@ifundefined{igtl@\igt@a}%
          {\PackageError{igtitle}{Unknown sectioning level}%
            {\string\igtclass\space with no optional arguments\MessageBreak
             only changes the class of an *existing* level}}}}}

\def\igt@class@iii[#1]{%
  \edef\igt@b{\expandafter\@gobble\string#1}%
  \expandafter\let\csname igtss@\igt@a\expandafter\endcsname
     \csname igtss@\igt@b\endcsname
  \expandafter\edef\csname igtss@\igt@b\endcsname{\igt@a}%
  \let\igt@a\igt@toplevel
  \count@\csname igtl@\igt@toplevel\endcsname
  \igt@class@iv}

\def\igt@class@iv{%
  \@ifundefined{igtss@\igt@a}{}%
    {\advance\count@\@ne
     \edef\igt@a{\csname igtss@\igt@a\endcsname}%
     \expandafter\edef\csname igtl@\igt@a\endcsname{\the\count@}%
     \igt@class@iv}}

% Typesetting Classes: General tools
% ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
% The following command handles the *n spacing
% Some tricks are necessary to multiply a
% skip by a non integer number

\newskip\beforetitleunit
\beforetitleunit=1ex\@plus.3ex\@minus.06ex
\newskip\aftertitleunit
\aftertitleunit=1ex\@plus.1ex

\newdimen\igt@plus
\newdimen\igt@minus

\def\igt@assign#1{%
  \@ifstar
    {\igt@assign@i{#1}}%
    {\igt@assign@d{#1}}}

\def\igt@assign@i#1#2\relax#3{%
  \igt@plus\z@
  \igt@minus\z@
  \afterassignment\igt@assign@ii
  \dimen@\the#3, % <- space 
  #1 =     #2\dimen@
     plus  #2\igt@plus
     minus #2\igt@minus}

\def\igt@assign@ii#1 {% <- space
  \if#1,\else\afterassignment\igt@assign@ii\fi
  \csname igt@\string#1\endcsname}

\def\igt@assign@d#1#2\relax#3{\setlength#1{#2}}

% To be used with \v/vspace to make them calc-savvy

\def\igt@calc#1#2{%
  {\setlength\@tempskipa{#2}%
   #1\@tempskipa}}
\def\ig@calc#1#2{%
	\expandafter#1\expandafter{\dimexpr#2\relax}}

\def\igt@calcneg#1#2{%
  {\setlength\@tempskipa{#2}%
   #1{-\@tempskipa}}}
\def\ig@calcneg#1#2{%
	\expandafter#1\expandafter{\expandafter-\dimexpr#2\relax}}

% Gets from igts@ and passes the spacing parameters:

\def\igt@startargs#1#2{% Get the first arguments, with the spacing
  \@ifundefined{igtp@#2}%
     {\let\igt@key@page\@empty}%
     {\igtp@fetch{#2}}%
  \begingroup
    \def\igt@b{igts@#2}%
    \edef\igt@key@numberless{\ifigt@label//\else/*\fi}%
    \def\igt@a##1{\csname igt@key@##1\endcsname}%  Used as elt in try
    \igt@trylist
    \xdef\igt@b{\igt@c}%
  \endgroup
  \ifx\igt@b\@empty
    \PackageError{igtitle}{Format/spacing not found}%
      {I was unable to find the format corresponding to #2.\MessageBreak
       Maybe you haven't set it with \string\igtformat\space and
       \string\igtspacing}
  \fi
  \expandafter#1\igt@b{#2}}

% Used in igt@select

\def\igt@savefn#1[#2]#3{%
  \ifcase#1%
    \footnotemark[#2]%
    \gdef\igt@fn{\footnotetext[#2]{#3}}%
  \else
    \footnotemark
    \gdef\igt@fn{\footnotetext{#3}}%
  \fi}

\def\igt@nest@error{%
  \PackageError{igtitle}{Nested titles}{Titles must not be nested}}

\def\igt@hmode@error{%
  \PackageError{igtitle}{Entered in horizontal mode}
    {The <format> argument cannot contain horizontal material\MessageBreak
     such as text, \string\noindent, \string\makebox, etc.}}

% \igt@select not only selects the right version to be
% used. It also take steps to ensure that a mark
% is not lost inside a box by saving it into \igt@mk,
% which in turn is used by the sect and chap commands.

% As of 2019 and due the LaTex
% kernel modifies \markboth, we consider two possibilities (2.13).

\newif\ifigt@explicit

\def\igt@gmk#1{\gdef\igt@mk{#1}}

\def\igt@select#1#2#3#4{%
  \igt@Hy@saveanchor
  \global\let\igt@mk\@empty  % global because of rigidchapters
  \global\let\igt@fn\@empty
  \begingroup
   \if@inlabel\else % Keep item's \everypar
      \everypar{\setbox\z@\lastbox\igt@strut}%
   \fi
   \let\igt@straight@i\igt@nest@error
   \let\igt@top@i     \igt@nest@error
   \let\igt@part@i    \igt@nest@error
   \let\igt@page@i    \igt@nest@error
   \let\igt@newpage\newpage
   \def\newpage{\igt@savewrite\igt@newpage}%
   \expandafter\ifx\csname markboth \endcsname\relax
     \def\markboth##1##2{\protect\igt@gmk{\protect\markboth{##1}{##2}}}%
     \def\markright##1{\protect\igt@gmk{\protect\markright{##1}}}%
   \else
     \@namedef{markboth }##1##2{\protect\igt@gmk{\markboth{##1}{##2}}}%
     \@namedef{markright }##1{\protect\igt@gmk{\markright{##1}}}%
   \fi
   \def\@mkboth##1##2{\protect\igt@gmk{\protect\@mkboth{##1}{##2}}}%
   \def\footnote{\@ifnextchar[%
     {\igt@savefn\z@}{\igt@savefn\@ne[]}}%
   \edef\igt@key@numberless{\ifigt@label//\else/*\fi}%
   \def\igt@b{igtf@#1}%
   \def\igt@a##1{\csname igt@key@##1\endcsname}% Used as elt in try
   \igt@trylist
   \ifigt@explicit
     \def\igt@passexplicit{\igt@case{#4}}% 
     \igt@c{#4}{#2}{#3}{}% igt@c is returned by igt@try with igtf@...
   \else     
     \let\igt@passexplicit\igt@case
     \igt@c{#2}{#3}{#4}% igt@c is returned by igt@try with igtf@...
   \fi
  \endgroup}

\let\igt@savewrite\@empty

\def\igt@finmarks{%
  \igt@savewrite
  \igt@mk  % Contains a possible mark, returned by \igt@select
  \igt@fn} % And a footnote

\def\igt@try#1{%
  \edef\igt@c{#1}%  #1 is a list in the form \igt@a{key}\igt@a{key}
  \@ifundefined{\igt@b\igt@c}{}{%
    \edef\igt@c{\expandafter\noexpand\csname\igt@b\igt@c\endcsname}%
    \def\igt@a##1{\csname igt@extra@##1\endcsname}%
    #1%
    \let\igt@try\@gobble}} % locally modified to `break' testings

% \igt@write writes marks and toc. tocdepth is taken care of when
% the toc is typesetted and not here.  Used always through
% igt@savewrite, which is reset to \@empty to avoid duplicated
% calls. 

\def\igt@write#1#2{%
  \igt@blinemarks
  \csname#1mark\endcsname{#2}%
  \def\igt@a{\protect\numberline{\@nameuse{the#1}}}%
  \@nameuse{igt@toc#1}% eg, \igt@tocpart modifies \igt@a
  \igt@addcontentsline{#1}{#2}% Depends on toctitles, uses \igt@a
  \igt@elinemarks
  \global\igt@toclabelfalse
  \global\let\igt@savewrite\@empty}

\newif\ifigt@premark % to be used in igps.def
\igt@premarkfalse

% 2019-06-20. Added the \lastskip stuff, because a mark 'forgets' the
% last skip.
  
\def\igt@premark#1#2{%
  \let\igt@lastskip\relax
  \ifvmode
    \ifdim\lastskip=\z@\else
      \edef\igt@lastskip{\the\lastskip}% 
      \vskip-\igt@lastskip\relax
    \fi
  \fi
  \protected@xdef\igt@prevmarks{\igt@marks}%
  \igt@blinemarks
  \csname#1mark\endcsname{#2}%
  \igt@elinemarks
  \ifx\igt@lastskip\relax\else
    \vskip\igt@lastskip\relax
  \fi
  \gdef\igt@prevmarks{\igt@marks}}

% Must be preceded by a default \igt@savewrite, which is used
% in starred variants--\@empty in top and straight classes.
% In straight class, it is preceded by the setting of
% prev marks to provide a "fixed" top mark. Otherwise,
% the default prev mark (= curr mark) is used (restored
% after igt@labelling in straight). This is the command
% to be hacked if you want to change the behaviour of
% starred variants.

\def\igt@labelling#1#2{%
  \let\igt@Hy@saveanchor\@empty
  \ifigt@label  %  1st - if star
    \def\igt@savewrite{\igt@write{#1}{#2}}%
    \@nameuse{igt@#1label}%  eg, sets if mainmatter in chapter.
    \ifigt@label  % 2nd - eg, if not main matter
      \ifnum\@nameuse{igtl@#1}>\c@secnumdepth\relax
        \igt@labelfalse     % 3rd - if too deep
      \else
        \igt@Hy@refstepcounter{#1}%
        \@nameuse{igt@#1out}%
      \fi
    \fi
  \fi
  \let\ifigt@toclabel\ifigt@label
  \ifx\igt@savewrite\@empty\else % If marks
    \ifigt@ps
      \ifigt@premark
        \global\igt@premarkfalse
      \else % if no \igtpretitlemark
        \igt@premark{#1}{#2}%
      \fi
    \fi
    \ifigt@label\else\igt@Hy@steplink{#1}\fi
  \fi}

% Executed by igt@labelling if the name of section is chapter:

\def\igt@chapterlabel{\if@mainmatter\else\igt@labelfalse\fi}

% Executed by igt@labelling if chapter has a number. Note
% you can define messages for other sectioning levels (eg,
% \igt@sectionout).

\def\igt@chapterout{\typeout{\chaptertitlename\space\thechapter.}}

% Straight class
% ~~~~~~~~~~~~~
% Default for nobottomtitles. Changed by nobottomtitles*

\def\igt@addstretch{\advance\@tempskipa-\pagestretch}

% 1:name 2:level 3:indent 4:before 5:after 6:afind [7]:cap 8:title
% The second argument of igt@sect is the level, which
% is empty if the star version is used. In this case
% neither the toc nor the marks are written.

\def\igt@straight@i#1[#2]#3{%
  \def\@currentlabelname{#2}% for nameref
  \gdef\igt@savemark{\csname#1mark\endcsname{#3}}%
  \let\igt@savewrite\@empty
  \def\igt@savetitle{#3}%
  \gdef\thetitle{\csname the#1\endcsname}%
  \if@noskipsec \leavevmode \fi
  \par
  \igt@labelling{#1}{#2}%
  \igt@startargs\igt@straight@ii{#1}{#3}}

% 1:left 2:right 3:before 4:after 5:afterindent 6:name 7:title

\def\igt@straight@ii#1#2#3#4#5#6#7{%
  \igt@assign\@tempskipa#3\relax\beforetitleunit
  \@ifundefined{igt@ps@#6}{}%
    {\PackageWarning{igtitle}{Page style in straight class ignored}}%
  \if@nobreak
    \igt@titlespace{\@tempskipa}%
  \else
    \@ifundefined{#6break}%
      {\addpenalty{\@secpenalty}}%
      {\csname#6break\endcsname}%
    \addvspace{\@tempskipa}%
    \ifdim\bottomtitlespace<\z@
    \else
      \begingroup
       \@tempskipb\pagegoal
       \@tempskipa\pagegoal
       \igt@addstretch  % \relax if nobottomtitle*
       \advance\@tempskipa-\bottomtitlespace\relax % not a register
       \pagegoal\@tempskipa
       \def\@textbottom{\vskip\z@\@plus.0001fil}%
       \penalty9999
       \pagegoal\@tempskipb
      \endgroup
    \fi
  \fi
  \@afterindenttrue
  \ifcase#5 \@afterindentfalse\fi
  \igt@assign\@tempskipb#4\relax\aftertitleunit
  \igt@select{#6}{#1}{#2}{#7}%
  \igt@finmarks
  \@ifundefined{igtp@#6}{}{\igtp@write{#6}}%
  \if@noskipsec
    \global\@nobreakfalse
    \everypar{%
      \if@noskipsec
        \global\@noskipsecfalse
        \clubpenalty\@M
        \hskip-\parindent
        \begingroup
          \@svsechd\unskip{\hspace{\@tempskipb}}%
        \endgroup
      \else
        \clubpenalty\@clubpenalty\everypar{}%
      \fi}%
  \else
    \par\nobreak
    \vspace{\@tempskipb}%
    \@afterheading
  \fi
  \ignorespaces}

% Part class
% ~~~~~~~~~~

\providecommand\partmark[1]{\markboth{}{}}

\def\igt@part@i#1[#2]#3{%
  \gdef\igt@savemark{\csname#1mark\endcsname{#3}}%
  \ifx\igt@notocparts\@undefined
    \def\igt@savewrite{\igt@write{#1}{#3}}% Not #2!
  \else
    \let\igt@savewrite\@empty
  \fi
  \def\igt@savetitle{#3}%
  \igt@labelling{#1}{#2}%
  \igt@startargs\igt@part@ii{#1}{#3}}

\def\igt@part@ii#1#2#3#4#5#6#7{%
  \igt@assign\@tempskipa#3\relax\beforetitleunit
  \vspace*{\@tempskipa}%
  \@ifundefined{igt@ps@#6}{}%
    {\PackageWarning{igtitle}{Page style in part class ignored}}%
  \global\@afterindenttrue
  \ifcase#5 \global\@afterindentfalse \fi
  \igt@assign\@tempskipb#4\relax\aftertitleunit 
  \igt@select{#6}{#1}{#2}{#7}%
  \igt@finmarks
  \@ifundefined{igtp@#6}{}{\igtp@write{#6}}%
  \par\nobreak
  \vspace{\@tempskipb}%
  \@afterheading}

% Page class
% ~~~~~~~~~~

\def\igt@page@i#1[#2]#3{%
  \gdef\igt@savemark{\csname#1mark\endcsname{#3}}%
  \ifx\igt@notocparts\@undefined
    \def\igt@savewrite{\igt@write{#1}{#3}}% Not #2!
  \else
    \let\igt@savewrite\@empty
  \fi
  \def\igt@savetitle{#3}%
  \igt@labelling{#1}{#2}%
  \igt@startargs\igt@page@ii{#1}{#3}}

\def\igt@page@ii#1#2#3#4#5#6#7{%
  \igt@assign\@tempskipa#3\relax\beforetitleunit
  \if@openright
    \cleardoublepage
  \else
    \clearpage
  \fi
  \@ifundefined{igt@ps@#6}%
    {\thispagestyle{plain}}%
    {\thispagestyle{\@nameuse{igt@ps@#6}}}%
  \if@twocolumn
    \onecolumn
    \@tempswatrue
  \else
    \@tempswafalse
  \fi
  \vspace*{\@tempskipa}%
  \@afterindenttrue
  \ifcase#5 \@afterindentfalse\fi
  \igt@assign\@tempskipb#4\relax\aftertitleunit
  \igt@select{#6}{#1}{#2}{#7}%
  \igt@finmarks
  \@ifundefined{igtp@#6}{}{\igtp@write{#6}}%
  \vspace{\@tempskipb}%
  \newpage
  \if@twoside
    \if@openright
      \null
      \@ifundefined{igt@ps@#6}%
        {\thispagestyle{empty}}%
        {\thispagestyle{\@nameuse{igt@ps@#6}}}%
      \newpage
    \fi
  \fi
  \if@tempswa
    \twocolumn
  \fi
  \ignorespaces}

% Top class and some makechapterhead stuff
% ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
%
% \igt@mkchap is the new make(s)chapterhead.

\def\igt@mkchap#1#2#3#4#5#6#7{%
  \gdef\igt@savemark{\csname#6mark\endcsname{#7}}%
  \let\igt@savewrite\@empty
  \let\igt@Hy@saveanchor\@empty
  \@ifundefined{igt@ps@#6}{}%
    {\thispagestyle{\@nameuse{igt@ps@#6}}}%
  \let\ifigt@toclabel\ifigt@label
  \igt@mkchap@i{#1}{#2}{#3}{#4}{#5}{#6}{#7}}

% But \igt@mkchap@i is used by both makechapterhead and
% the top class.

\def\igt@mkchap@i#1#2#3#4#5#6#7{%
  \igt@assign\@tempskipa#3\relax\beforetitleunit
  \vspace*{\@tempskipa}%
  \global\@afterindenttrue
  \ifcase#5 \global\@afterindentfalse\fi
  \igt@assign\@tempskipb#4\relax\aftertitleunit
  \igt@topmode{\@tempskipb}{%
    \igt@select{#6}{#1}{#2}{#7}}%
  \igt@finmarks  % Outside the box!
  \@ifundefined{igtp@#6}{}{\igtp@write{#6}}}

\def\igt@top@i#1[#2]#3{%
  \gdef\igt@savemark{\csname#1mark\endcsname{#3}}%
  \let\igt@savewrite\@empty
  \def\igt@savetitle{#3}%
  \igt@labelling{#1}{#2}%
  \igt@startargs\igt@top@ii{#1}{#3}}

\def\igt@top@ii#1#2#3#4#5#6#7{%
  \@ifundefined{#6break}%
    {\if@openright
       \cleardoublepage
     \else
       \clearpage
     \fi}%
    {\csname#6break\endcsname}%
  \@ifundefined{igt@ps@#6}%
    {\thispagestyle{plain}}%
    {\thispagestyle{\@nameuse{igt@ps@#6}}}%
  \global\@topnum\z@
  \@ifundefined{#6tolists}%
    {\addtocontents{lof}{\protect\igt@tocsep}%
     \addtocontents{lot}{\protect\igt@tocsep}}
    {\@nameuse{#6tolists}}%
  \if@twocolumn
    \@topnewpage[\igt@mkchap@i{#1}{#2}{#3}{#4}{#5}{#6}{#7}]%
  \else
    \igt@mkchap@i{#1}{#2}{#3}{#4}{#5}{#6}{#7}%
    \@afterheading
  \fi
  \ignorespaces}

%     \def\igt@noskipsectrue{%
%       \if@noskipsec
%     \PackageError{igtitle}{Invalid shape for top class}%
%        {The selected shape only makes sense when merged into\MessageBreak
%         a paragraph. That is impossible in the top class}%
%   \else

\newcommand\chaptertitlename{\@chapapp}
\def\igt@tocsep{\addvspace{10\p@}}

%               +-----------------+
%               |   S H A P E S   |
%               +-----------------+
%               
% Reformatting Titles: Interface
% ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

% The surrounding space is stored in a macro
% named \igts@<section> whose content is
% {left}{right}{before}{after}{afterindent}.
% But if there is the page key, the name is
% \igts@<section>/<page>

\newcommand\igtspacing{%
  \@ifstar{\igt@spacing@i{\z@}}{\igt@spacing@i{\@ne}}}

\def\igt@spacing@i#1#2#3#4#5{%
  \igt@getkeys{#2}{igtitle}%
  \@ifnextchar[{%
     \igt@spacing@ii{#1}{#3}{#4}{#5}%
   }{%
     \igt@spacing@ii{#1}{#3}{#4}{#5}[\z@]}}

\def\igt@spacing@ii#1#2#3#4[#5]{%
   \expandafter\def\csname igts@\igt@a\endcsname
       {{#2}{#5}{#3}{#4}{#1}}}

% The section name is built in \igt@a.
% The format is stored in a macro named \igtf@<section>,
% or \igtf@<section>/<page> if there is the page spec,
% or \igtf@.../* if numberless is true
% whose content is
%  \igt@<shape>{format}{label}{sep}{before}{after}

\newtoks\igt@toksa

\newcommand\igtformat{%
  \@ifstar{\igt@format@s}%
          {\igt@format@i}}

\def\igt@format@s#1#2{%
  \edef\igt@a{\expandafter\@gobble\string#1}%
  \@ifundefined{igtf@\igt@a}%
    {\PackageError{igtitle}{Not allowed in `easy' settings}
       {The sectiong command you are trying to redefine\MessageBreak
        is not handled by the starred variant (eg, \string\part)}}{}
  \expandafter\expandafter\expandafter
  \igt@format@si\csname igtf@\igt@a \endcsname
  {#2}}

\def\igt@format@si#1#2#3#4#5#6#7{%
  \@namedef{igtf@\igt@a}{#1{#7}{#3}{#4}{#5}{#6}}}

\def\igt@format@i#1{%
  \@ifnextchar[{\igt@format@ii{#1}}{\igt@format@ii{#1}[hang]}}

\def\igt@format@ii#1[#2]#3#4#5#6{%
  \igt@getkeys{#1}{igtitle}%
  \igt@toksa{{#3}{#4}{#5}{#6}}% Save  arguments
  \@ifnextchar[{%
    \igt@format@iii{#2}%
  }{%
    \igt@format@iii{#2}[]}}

% First, we get the shape -- if not defined it loads
% the corresponding file.

\def\igt@format@iii#1[#2]{%
  \@ifundefined{igth@#1}{%
    \begingroup
    \makeatletter
    \InputIfFileExists{#1.tss}{}{%
      \@ifundefined{igthx@#1}%
        {\PackageError{igtitle}{Unknown shape}%
           {Shapes are defined in files with extension tss\MessageBreak
            Either you have misspelled the shape\MessageBreak
            or there is no a #1.tss file}}%
        {\global\expandafter
         \let\csname igth@#1\expandafter\endcsname
           \csname igthx@#1\endcsname}}%
    \endgroup}{}%
  \@temptokena{#2}%
  \ifigt@explicit
    \edef\igt@b{%
      \def\expandafter\noexpand\csname igtf@\igt@a\endcsname####1%
      {\expandafter\noexpand\csname igth@#1\endcsname
       \the\igt@toksa{\the\@temptokena}}}%
  \else
    \edef\igt@b{%
      \def\expandafter\noexpand\csname igtf@\igt@a\endcsname
      {\expandafter\noexpand\csname igth@#1\endcsname
       \the\igt@toksa{\the\@temptokena}}}%
  \fi
  \igt@b
  \csname igt@compat\igt@a\endcsname}

% Styles
% ~~~~~~

% 1:global 2:label 3:sep 4:style 5:after 6:left 7:right 8:title
% \igt@<shape> and \igth@<shape> take the following eight
% arguments:
% {format}{label}{sep}{before}{after}{left}{right}{title}
% where before and after refer to the format.
% With the option explicit, #4 contains the title and #8 is
% empty.

\def\igt@strut{\strut}

\def\igth@display#1#2#3#4#5#6#7#8{%
  \gdef\igt@makeline##1{\ig@calc\hspace{#6}##1\ig@calc\hspace{#7}}%
  \setlength\leftskip{#6}%
  \setlength\rightskip{#7}%
  \interlinepenalty\@M
  \igt@changecentercr
  \igt@defnostruts
  \igt@beginlongest
    #1\ifhmode\igt@hmode@error\fi
    \igt@glcmds
    \parindent\z@
    \ifigt@label
      {#2\igt@strut\@@par}\nobreak\ig@calc\vspace{#3}%
    \fi
    #4{#8}%
   \kern\z@\igt@strut\@@par
   \nobreak\igt@midlongest#5\@@par
  \igt@endlongest}

\def\igth@hang#1#2#3#4#5#6#7#8{%
  \gdef\igt@makeline##1{\ig@calc\hspace{#6}##1\ig@calc\hspace{#7}}%
  \setlength\leftskip{#6}%
  \setlength\rightskip{#7}%
  \interlinepenalty\@M
  \igt@changecentercr
  \igt@defnostruts
  \igt@beginlongest
  #1{\ifhmode\igt@hmode@error\fi
     \igt@glcmds
     \parindent\z@
     \begingroup
       \ifigt@label
          \noindent
          \sbox\z@{#2\igt@strut\ig@calc\hspace{#3}}%
          \hangindent\wd\z@
          \box\z@
       \fi
       #4{#8}%
       \kern\z@\igt@strut\@@par
     \endgroup
     \nobreak\igt@midlongest#5\@@par}%
  \igt@endlongest}

\def\igth@runin#1#2#3#4#5#6#7#8{%
  \global\@noskipsectrue
  \gdef\igt@makeline##1{##1}%
  \igt@changecentercr
  \igt@defnostruts
  #1{\ifhmode\igt@hmode@error\fi
     \global\sbox\igt@box{%
       \ig@calc\hspace{#6}%
       \ifigt@label{\igt@strut#2}\ig@calc\hspace{#3}\fi
       #4{#8}#5\unskip}}%
    \gdef\@svsechd{\unhbox\igt@box}}

% ----------

\gdef\igthx@block#1#2#3#4#5#6#7#8{%
  \gdef\igt@makeline##1{\ig@calc\hspace{#6}##1\ig@calc\hspace{#7}}%
  \setlength\leftskip{#6}%
  \setlength\rightskip{#7}%
  \interlinepenalty\@M
  \igt@changecentercr
  \igt@defnostruts
  \igt@beginlongest
    #1% \ifhmode\igt@hmode@error\fi
    \igt@glcmds
    \parindent\z@
    \leavevmode
    \ifigt@label
       {#2}%
       \setlength\@tempskipa{#3}%
       \ifdim\@tempskipa=\z@\else\ig@calc\hspace{#3}\fi
    \fi
    #4{#8}%
    \kern\z@\igt@strut\@@par
    \nobreak\igt@midlongest#5\@@par
  \igt@endlongest}
  

\gdef\igthx@frame#1#2#3#4#5#6#7#8{%
  \def\igt@filleft##1{\hfill}%
  \def\igt@filright##1{\hfill}%
  \gdef\igt@makeline##1{%
    \ig@calc\hspace{#6}##1\ig@calc\hspace{#7}}%
  \interlinepenalty\@M
  \igt@changecentercr
  \igt@defnostruts
  #1\ifhmode\igt@hmode@error\fi
  \parindent\z@
  \leavevmode
  \@tempdima\fboxrule
  \addtolength\@tempdima{#3}%
  \setlength\leftskip{#6}%
  \setlength\rightskip{#7}%
  \lower\@tempdima\hbox{%
    \everypar{}%
    \setbox\z@\hbox{#2}%  
    \addtolength\hsize{-#6}%
    \addtolength\hsize{-#7}%
    \@tempdima\dp\z@ %  2002/3/22
    \advance\@tempdima.5\ht\z@
    \vbox{%
        \hbox to \hsize{%
          \leaders\hrule\@height\fboxrule\igt@filleft{#3}%
          \ifigt@label\lower.5\ht\z@\box\z@\fi
          \leaders\hrule\@height\fboxrule\igt@filright{#3}}%
        \vskip-\lineskip
        \ifigt@label\vskip-\@tempdima\fi
        \hbox{%
          \vrule\@width\fboxrule
          \kern-\fboxrule
          \vbox{%
             \ig@calc\vspace{#3}%
             \leavevmode
	         \addtolength\leftskip {#3}\addtolength\leftskip{-#6}%
	         \addtolength\rightskip{#3}\addtolength\rightskip{-#7}%
	         \igt@strut#4{#8}\kern\z@\igt@strut\@@par
             \ig@calc\vspace{#3}}%
          \kern-\fboxrule
          \vrule\@width\fboxrule}%
       \hrule\@height\fboxrule}}%
	   \@@par\nobreak#5\@@par}

\gdef\igthx@leftmargin#1#2#3#4#5#6#7#8{%
  \global\@noskipsectrue
  \addtolength\@tempskipb{#6}%
  \xdef\igt@makeline##1{\hskip-\the\@tempskipb\relax##1}%
  \leftskip\z@skip
  \rightskip\z@skip
  \igt@changecentercr
  \igt@defnostruts
  #1\ifhmode\igt@hmode@error\fi
  \parindent\z@
  \global\setbox\igt@box\vtop{%
    \setlength\hsize{#6}%
    \linewidth\hsize
    \everypar{}%
    \color@begingroup
    \ifigt@label{\igt@strut#2\igt@strut}\ig@calc\hspace{#3}\fi
	   \igt@strut#4{#8}\kern\z@\igt@strut\@@par
    \color@endgroup}%
  \advance\@tempskipa\ht\igt@box
  \advance\@tempskipa\dp\igt@box
  \advance\@tempskipa-\pagegoal
  \advance\@tempskipa\pagestretch
  \@tempskipb\pagegoal
  \pagegoal-\@tempskipa
  \ifdim\bottomtitlespace<\z@\else
    \def\@textbottom{\vskip\z@\@plus.0001fil}%
  \fi
  \penalty9999
  \pagegoal\@tempskipb
  \dp\igt@box=\z@
  \gdef\@svsechd##1##2{%   
    \llap{\box\igt@box##2}%
    \if@afterindent\hskip\parindent\fi
    #5}}

\let\igthx@margin\igthx@leftmargin

\gdef\igthx@rightmargin#1#2#3#4#5#6#7#8{%
  \global\@noskipsectrue
  \addtolength\@tempskipb{#6}%
  \xdef\igt@makeline##1{##1\hskip-\the\@tempskipb}%
  \leftskip\z@skip
  \rightskip\z@skip
  \igt@changecentercr
  \igt@defnostruts
  #1\ifhmode\igt@hmode@error\fi
  \parindent\z@
  \global\setbox\igt@box\vtop{%
     \setlength\hsize{#6}%
     \linewidth\hsize
     \everypar{}%
     \color@begingroup
     \ifigt@label{\igt@strut#2\igt@strut}\ig@calc\hspace{#3}\fi
	    \igt@strut#4{#8}\kern\z@\igt@strut\@@par
     \color@endgroup}%
  \advance\@tempskipa\ht\igt@box
  \advance\@tempskipa\dp\igt@box
  \advance\@tempskipa-\pagegoal
  \advance\@tempskipa\pagestretch
  \@tempskipb\pagegoal
  \pagegoal-\@tempskipa
  \ifdim\bottomtitlespace<\z@\else
    \def\@textbottom{\vskip\z@\@plus.0001fil}%
  \fi
  \penalty9999
  \pagegoal\@tempskipb
  \dp\igt@box=\z@  
  \gdef\@svsechd##1##2{%
    \rlap{\hskip\textwidth##2\box\igt@box}%
    \if@afterindent\hskip\parindent\fi}}

\gdef\igthx@wrap#1#2#3#4#5#6#7#8{%
  \global\@noskipsectrue
  \gdef\igt@makeline##1{##1}%
  \igt@changecentercr
  \igt@defnostruts
  \begingroup
    #1\ifhmode\igt@hmode@error\fi
    \igtwidth\z@
    \def\\{\@ifstar{\@ifnextchar[{\igt@bs}{\newline}}%
                   {\@ifnextchar[{\igt@bs}{\newline}}}%
    \def\igt@bs[##1]{\newline}%
    \let\@centercr\\%
    \advance\rightskip 1\leftskip plus 1fil
    \leftskip=\z@
    \parindent\z@
    \let\ifigttitlemeasuring\@firstoftwo
    \global\setbox\igt@box\vtop{\setlength\hsize{#6}%
      \color@begingroup
      \ifigt@label{#2}\ig@calc\hspace{#3}\fi
      #4{#8}\kern\z@\igt@strut
      \@@par
      \color@endgroup}%
    \let\ifigttitlemeasuring\@secondoftwo
    \igt@boxprocess
    \global\igtwidth\igtwidth
    \global\igtwidthfirst\igtwidthfirst
    \global\igtwidthlast\igtwidthlast
  \endgroup
  \edef\igt@maxdimen{\the\igtwidth}%
  #1\ifhmode\igt@hmode@error\fi
  \global\setbox\igt@box\vtop{\setlength\hsize{\igt@maxdimen}%
    \color@begingroup
    \ifigt@label{#2}\ig@calc\hspace{#3}\fi#4{#8}\kern\z@\igt@strut
    \@@par
    \color@endgroup}%
  \advance\@tempskipa1.5\baselineskip
  \advance\@tempskipa\ht\igt@box
  \advance\@tempskipa\dp\igt@box
  \advance\@tempskipa-\pagegoal
  \advance\@tempskipa\pagestretch
  \@tempskipb\pagegoal
  \pagegoal-\@tempskipa
  \ifdim\bottomtitlespace<\z@\else
    \def\@textbottom{\vskip\z@\@plus.0001fil}%
  \fi
  \penalty9999
  \pagegoal\@tempskipb
  \@tempdima\ht\igt@box \advance\@tempdima\dp\igt@box
  \@tempdimb\@tempdima
  \divide\@tempdima\baselineskip \count@\@tempdima
  \advance\count@
    \ifdim\@tempdimb<\the\count@.5\baselineskip\@ne\else\tw@\fi
  \dp\igt@box=\z@
  \xdef\@svsechd##1##2{%
    \noexpand\llap{\box\igt@box##2}%
    \setbox\z@\hbox{\hskip\igt@maxdimen\relax##2}%
    \global\hangindent\wd\z@
    \global\hangafter-\the\count@\relax}}

\gdef\igthx@drop#1#2#3#4#5#6#7#8{%
  \global\@noskipsectrue
  \gdef\igt@makeline##1{##1}%
  \igt@changecentercr
  \igt@defnostruts
  #1\ifhmode\igt@hmode@error\fi
  \parindent\z@
  \global\setbox\igt@box\vtop{\setlength\hsize{#6}%
    \color@begingroup
    \ifigt@label{#2}\ig@calc\hspace{#3}\fi
    #4{#8}\kern\z@\igt@strut
    \@@par
    \color@endgroup}%
  \advance\@tempskipa1.5\baselineskip
  \advance\@tempskipa\ht\igt@box
  \advance\@tempskipa\dp\igt@box
  \advance\@tempskipa-\pagegoal
  \advance\@tempskipa\pagestretch
  \@tempskipb\pagegoal
  \pagegoal-\@tempskipa
  \ifdim\bottomtitlespace<\z@\else
    \def\@textbottom{\vskip\z@\@plus.0001fil}%
  \fi
  \penalty9999
  \pagegoal\@tempskipb
  \@tempdima\ht\igt@box \advance\@tempdima\dp\igt@box
  \@tempdimb\@tempdima
  \divide\@tempdima\baselineskip \count@\@tempdima
  \advance\count@
  \ifdim\@tempdimb<\the\count@.5\baselineskip\@ne\else\tw@\fi
  \dp\igt@box=\z@
  \xdef\@svsechd##1##2{%
    \noexpand\llap{\box\igt@box##2}%
    \setbox\z@\hbox{\noexpand\ig@calc\noexpand\hspace{#6}\relax##2}%
    \global\hangindent\wd\z@
    \global\hangafter-\the\count@\relax}}

%               +-----------------+
%               |    T O O L S    |
%               +-----------------+
%
% calcwidth
% ~~~~~~~~~
% Implemented after code from soul (but much modified...)

\newdimen\igtwidth
\newdimen\igtwidthlast
\newdimen\igtwidthfirst

\let\igt@glcmds\relax
\let\igt@beginlongest\@empty
\let\igt@midlongest\@empty
\let\igt@endlongest\@empty
\let\ifigttitlemeasuring\@secondoftwo

\def\igt@xbeginlongest#1\igt@endlongest{%
  \igtwidth\z@
  \igtwidthlast\z@
  \let\ifigttitlemeasuring\@firstoftwo
  \setbox\igt@box\vbox{%
    \def\igt@glcmds{%
      \def\\{\@ifstar{\@ifnextchar[{\igt@bs}{\newline}}%
                     {\@ifnextchar[{\igt@bs}{\newline}}}%
      \def\igt@bs[####1]{\newline}%
      \let\@centercr\\%
      \def\igt@midlongest####1\@@par{}% Very dirty...
      \advance\rightskip 1\leftskip plus 1fil
      \leftskip=\z@}%
    #1}%
  \let\ifigttitlemeasuring\@secondoftwo
  \igt@boxprocess
  #1}

\def\igt@boxprocess{%
  \setbox\igt@box=\vbox{%
    \unvcopy\igt@box
    \unskip\unpenalty
    \global\setbox\@ne=\lastbox}%
  \ifvoid\@ne
  \else
    \setbox\tw@=\hbox{\hskip-\leftskip\unhbox\@ne\hskip-\rightskip}%
    \igtwidthfirst\wd\tw@
    \ifdim\igtwidth<\igtwidthfirst
	  \igtwidth\igtwidthfirst
	\fi
    \ifdim\igtwidthlast=\z@
      \igtwidthlast\igtwidthfirst
    \fi
    \expandafter\igt@boxprocess
  \fi}

% Rules
% ~~~~~

\providecommand\igtline{%
  \@ifstar{\igt@line@i{\hb@xt@\igtwidth}}%
          {\igt@line@i{}}}

\def\igt@line@i#1{%
  \@ifnextchar[{\igt@line{#1}}{\igt@line{#1}[s]}}

\def\igt@line#1[#2]#3{%
  \vskip\topskip
  \hrule \@height \z@
  \nobreak
  \vskip-\topskip
  \begingroup
    \parindent\z@
    \everypar{}%
    \leftskip\z@
    \rightskip\z@   %  #1 is either \hb@xt@\igtwidth or empty:
    \@makebox[\hsize][#2]{\igt@makeline{#1{#3}}}%
    \par
  \endgroup
  \hrule height \z@
  \nobreak}

\providecommand\igtrule{\@ifstar{\igt@row}{\igt@rule}}

\let\igt@leaders\xleaders % For igtitle compatibility

\def\igt@row{\@ifnextchar[{\igt@row@i}{\igt@row@i[\wd\z@]}}
\def\igt@row@i[#1]#2{%
  \ifvmode\expandafter\igtline\fi
  {\sbox\z@{#2}%
   \ig@calcneg\hspace{#1}%
   \hskip\wd\z@
   \igt@leaders\hb@xt@#1{\hss\box\z@}%
   \hfill\kern\z@}}

\def\igt@rule{\@ifnextchar[{\igt@rule@i}{\igt@rule@i[.4\p@]}}
\def\igt@rule@i[#1]{%
  \ifvmode\expandafter\igtline\fi
  {\leaders\hrule height #1\hfill\kern\z@}}

% Par shapes and space
% ~~~~~~~~~~~~~~~~~~~~

\providecommand\filright{%
  \gdef\igt@filleft##1{\hskip##1}%
  \gdef\igt@filright##1{\hfill}%
  \let\\\@centercr
  \advance\rightskip\z@ \@plus 1fil\relax}
\providecommand\filleft{%
  \gdef\igt@filleft##1{\hfill}%
  \gdef\igt@filright##1{\hskip##1}%
  \let\\\@centercr
  \advance\leftskip\z@ \@plus 1fil
  \parfillskip\z@}
\providecommand\filcenter{\filleft\filright
  \gdef\igt@filleft##1{\hfill}}
\providecommand\fillast{%
  \gdef\igt@filleft##1{\hfill}%
  \gdef\igt@filright##1{\hfill}%
  \let\\\@centercr
  \filleft\advance\rightskip\z@ \@plus -1fil
  \parfillskip\z@ \@plus 2fil\relax}
\providecommand\filinner{%
  \if@twoside
    \ifodd\count\z@\filleft\else\filright\fi
  \else
    \filleft
  \fi}
\providecommand\filouter{%
  \if@twoside
    \ifodd\count\z@\filright\else\filleft\fi
  \else
    \filright
  \fi}

\newcommand\igtwordsep{\fontdimen\tw@\font \@plus
  \fontdimen\thr@@\font \@minus \fontdimen4\font}

% Struts.
% ~~~~~~
% A way to remove the struts added by styles. May be redefined below
% with option nostruts.

\def\igt@defnostruts{\def\nostruts{\let\igt@strut\@empty}}

%               +-----------------+
%               |  O P T I O N S  |
%               +-----------------+

\let\sectiontitle\@empty
\DeclareOption{extramarks}{\let\igt@fetchmark\@empty}
\DeclareOption{floatps}{%
  \ifx\sectiontitle\@empty
    \let\igt@replace\space
  \else
    \PackageWarning{igtitle}{Ignoring `floatps' without 
      `pagestyles'. This option is now deprecated.}%
  \fi}
\DeclareOption{psfloats}{%
  \ifx\sectiontitle\@empty
    \let\igt@replace\@empty
  \else
    \PackageWarning{igtitle}{Ignoring `psfloats' without 
      `pagestyles'}%
  \fi}

\DeclareOption{outermarks}{%
  \def\igt@titlemarks{\igtoutertitlemarks}}
\DeclareOption{topmarks}{
  \def\igt@titlemarks{\igttoptitlemarks}}
\DeclareOption{botmarks}{%
  \def\igt@titlemarks{\igtbottitlemarks}}
\DeclareOption{innermarks}{%
  \def\igt@titlemarks{\igtinnertitlemarks}}

\DeclareOption{footmarks}{} % Backward compat

\DeclareOption{explicit}{\igt@explicittrue}

\DeclareOption{clearempty}{%
  \def\cleardoublepage{%
    \clearpage{\ps@empty\if@twoside\ifodd\c@page\else
    \hbox{}\newpage\if@twocolumn\hbox{}\newpage\fi\fi\fi}}}

\DeclareOption{rigidchapters}{%
  \def\igt@topmode#1#2{\vbox to #1{#2\vfil}}%
  \def\igt@chapafter{.26\textheight}}
\DeclareOption{rubberchapters}{%
  \def\igt@topmode#1#2{{#2}\ig@calc\vspace{#1}}%
  \def\igt@chapafter{40\p@}}

\DeclareOption{bottomtitles}{%
  \def\bottomtitlespace{-1\p@}}
\DeclareOption{nobottomtitles}{%
  \def\bottomtitlespace{.2\textheight}}
\DeclareOption{nobottomtitles*}{%
  \let\igt@addstretch\relax
  \def\bottomtitlespace{.2\textheight}}

\DeclareOption{calcwidth}{%
  \let\igt@beginlongest\igt@xbeginlongest}

\DeclareOption{aftersep}{%
  \let\igt@titlespace\@gobble}
\DeclareOption{largestsep}{%
  \let\igt@titlespace\addvspace}

\DeclareOption{oldparttoc}{%
  \def\igt@tocpart{\def\igt@a{\thepart\hspace{1em}}}}
\DeclareOption{newparttoc}{%
  \let\igt@tocpart\relax}
\DeclareOption{notocpart*}{%
  \let\igt@notocparts\@empty}

\DeclareOption{rm}{%
  \protected@xdef\igt@fonts{\igt@fonts\protect\rmfamily}}
\DeclareOption{sf}{%
  \protected@xdef\igt@fonts{\igt@fonts\protect\sffamily}}
\DeclareOption{tt}{%
  \protected@xdef\igt@fonts{\igt@fonts\protect\ttfamily}}
\DeclareOption{md}{%
  \protected@xdef\igt@fonts{\igt@fonts\protect\mdseries}}
\DeclareOption{bf}{%
  \protected@xdef\igt@fonts{\igt@fonts\protect\bfseries}}
\DeclareOption{up}{%
  \protected@xdef\igt@fonts{\igt@fonts\protect\upshape}}
\DeclareOption{it}{%
  \protected@xdef\igt@fonts{\igt@fonts\protect\itshape}}
\DeclareOption{sl}{%
  \protected@xdef\igt@fonts{\igt@fonts\protect\slshape}}
\DeclareOption{sc}{%
  \protected@xdef\igt@fonts{\igt@fonts\protect\scshape}}

\DeclareOption{big}{%
  \gdef\igt@sizes#1{\ifcase#1\relax\Huge\or\Large\or\large
       \or\normalsize\or\or\or\huge\fi}}
\DeclareOption{medium}{%
  \gdef\igt@sizes#1{\ifcase#1\relax\huge\or\Large\or\large
       \or\normalsize\or\or\or\LARGE\fi}}
\DeclareOption{small}{%
  \gdef\igt@sizes#1{\ifcase#1\relax\LARGE\or\large
       \or\normalsize\or\normalsize\or\or\or\Large\fi}}
\DeclareOption{tiny}{%
  \gdef\igt@sizes#1{\ifcase#1\relax\large\or\normalsize\or
    \normalsize\or\normalsize\or\or\or\normalsize\fi}}

\DeclareOption{raggedleft}{%
  \gdef\igt@fil{\filleft}}
\DeclareOption{center}{%
  \gdef\igt@fil{\filcenter}}
\DeclareOption{raggedright}{%
  \gdef\igt@fil{\filright}}

\DeclareOption{uppercase}{%
  \gdef\igt@case{\MakeUppercase}}

\DeclareOption{compact}{%
  \gdef\igt@space{1}%
  \gdef\igt@chapafter{30\p@}}

% Deprecated. To be remmoved in a major upgrade (3.0)
\DeclareOption{indentfirst}{%
  \gdef\@afterindentfalse{\let\if@afterindent\iftrue}%
  \@afterindenttrue
  \def\igtspacing{%
    \@ifstar{\igt@spacing@i{\@ne}}{\igt@spacing@i{\@ne}}}}
\DeclareOption{nonindentfirst}{%
  \def\igtspacing{%
    \@ifstar{\igt@spacing@i{\z@}}{\igt@spacing@i{\z@}}}}

% New names
\DeclareOption{indentafter}{%
  \gdef\@afterindentfalse{\let\if@afterindent\iftrue}%
  \@afterindenttrue
  \def\igtspacing{%
    \@ifstar{\igt@spacing@i{\@ne}}{\igt@spacing@i{\@ne}}}}
\DeclareOption{noindentafter}{%
  \def\igtspacing{%
    \@ifstar{\igt@spacing@i{\z@}}{\igt@spacing@i{\z@}}}}

% newlinetospace
\let\igt@blinemarks\relax
\let\igt@elinemarks\relax

\DeclareRobustCommand\igt@linetosp{%
  \@ifstar{\igt@linetosp@i}{\igt@linetosp@i}}%

\def\igt@linetosp@i{%
  \ifdim\lastskip>\z@\else\space\fi
  \ignorespaces}

\DeclareOption{newlinetospace}{%
  \def\igt@blinemarks{%
    \let\igt@e\\%
    \def\\{\igt@linetosp}}%
  \def\igt@elinemarks{\let\\\igt@e}}%

%%% newlinetocolon
\DeclareRobustCommand\igt@linetocolon{%
  \@ifstar{\igt@linetocolon@i}{\igt@linetocolon@i}}%
\def\igt@linetocolon@i{%
  \ifdim\lastskip>\z@\else\ :\ \fi
  \ignorespaces}
\def\igt@blinemarks{%
    \let\igt@e\\%
    \def\\{\igt@linetocolon}}%
\def\igt@elinemarks{\let\\\igt@e}%

% toctitles
\def\igt@addcontentsline#1#2{%
  \addcontentsline{toc}{#1}{\ifigt@toclabel\igt@a\fi#2}%
  \nobreak}

\DeclareOption{toctitles}{%
  \def\igt@addcontentsline#1#2{%
    \addcontentsline{toc}{#1}{\ifigt@toclabel\igt@a\fi\igt@savetitle}%
    \nobreak}}

% pageatnewline

\def\igt@changecentercr{%
  \let\igt@centercr\@centercr
  \def\@centercr{\@ifstar{\igt@centercr*}{\igt@centercr*}}}

\DeclareOption{pageatnewline}{\let\igt@changecentercr\relax}

\def\igt@fonts{}

% nostruts

\DeclareOption{nostruts}{%
  \let\igt@strut\@empty
  \def\igt@defnostruts{%
    \let\igt@strut\@empty
    \def\nostruts{\let\igt@strut\@empty}}}

\ExecuteOptions{rubberchapters,bottomtitles,aftersep,oldparttoc,%
  innermarks}

\ProcessOptions

%               +-----------------+
%               | H Y P E R R E F |
%               +-----------------+
%
% These two commands are provided by hyperref. But if they
% are not defined at \begin{document} hyperref has not been
% loaded or it is an old version.

\AtBeginDocument{%
  \ifx\igt@Hy@steplink\@undefined
    \let\igt@Hy@steplink\@gobble
    \let\igt@Hy@refstepcounter\refstepcounter
  \fi}

%               +-----------------+
%               |   PAGE STYLES   |
%               +-----------------+
%
% This is generic:

\newcommand\igtassignpagestyle[2]{%
  \@namedef{igt@ps@\expandafter\@gobble\string#1}{#2}}

% pagestyles intégré 
% ~~~~~~~~~~~~~~

%\let\igt@compatps\@empty % marks the ``old interface''
\let\igt@coreps\@empty


\ifx\igt@coreps\@empty\else      % START code for package


\expandafter\newif\csname ifigt@ps\endcsname
\expandafter\newif\csname ifigt@toclabel\endcsname
\igt@toclabeltrue

\def\igt@calcneg#1#2{%
  {\setlength\@tempskipa{#2}%
   #1{-\@tempskipa}}}

\expandafter\newif\csname ifigt@premark\endcsname
\igt@premarkfalse

% 2019-02-25. Added the \lastskip stuff, because a mark 'forgets' the
% last skip.

\def\igt@premark#1#2{%
  \let\igt@lastskip\relax
  \ifvmode
    \ifdim\lastskip=\z@\else
      \edef\igt@lastskip{\the\lastskip}% 
      \vskip-\igt@lastskip\relax
    \fi
  \fi
  \protected@xdef\igt@prevmarks{\igt@marks}%
  \csname#1mark\endcsname{#2}%
  \ifx\igt@lastskip\relax\else
    \vskip\igt@lastskip\relax
  \fi
  \gdef\igt@prevmarks{\igt@marks}}

\let\igt@savemark\@empty

% Patching sectioning commands

\newcommand\igtTitlepsPatchSection{%
  \@ifstar{\igt@setsec\@gobbletwo}%
          {\igt@setsec\igtpretitlemark}}

\def\igt@setsec#1#2{%
  \@ifundefined{#2}{}{%
    \expandafter\let\csname igt@s@#2\expandafter\endcsname
      \csname#2\endcsname
    \@namedef{#2}{%
      \@ifstar{\igt@presec@s{#2}}%
              {\@dblarg{\igt@presec@x#1{#2}}}}}}%

% premark/gobble, sect-name, opt, title
\def\igt@presec@x#1#2[#3]#4{%
  #1{#2}{#3}%
  \@nameuse{igt@s@#2}[#3]{#4}}

\def\igt@presec@s#1#2{%
  \gdef\igt@savemark{\@nameuse{#1mark}{#2}}%
  \@nameuse{igt@s@#1}*{#2}}

\def\igt@atbegin{%
  \igtTitlepsPatchSection*{chapter}%
  \igtTitlepsPatchSection{section}%
  \igtTitlepsPatchSection{subsection}%
  \igtTitlepsPatchSection{subsubsection}%
  \igtTitlepsPatchSection{paragraph}%
  \igtTitlepsPatchSection{subparagraph}}

\AtBeginDocument{\igt@atbegin}

% Package options

\DeclareOption{psfloats}{\let\igt@replace\@empty} % a flag

\DeclareOption{outermarks}{%
  \def\igt@titlemarks{\igtoutertitlemarks}}
\DeclareOption{topmarks}{
  \def\igt@titlemarks{\igttoptitlemarks}}
\DeclareOption{botmarks}{%
  \def\igt@titlemarks{\igtbottitlemarks}}
\DeclareOption{innermarks}{%
  \def\igt@titlemarks{\igtinnertitlemarks}}
\DeclareOption{extramarks}{\let\igt@fetchmark\@empty}
\DeclareOption{nopatches}{\let\igt@atbegin\relax}

\ExecuteOptions{innermarks}

\ProcessOptions

% Load the package body

\let\igtnewpagestyle\@empty
\let\igtrenewpagestyle\@empty
\let\igtwidenhead\@empty

\fi                          % PAUSE code for package

% START core code

% As before, all marks has two parts but now they don't refer to left or 
% right pages at all.  There are some issues related to top marks which 
% are explained by Knuth in \textit{The \TeX book}, pp.  259f, as well 
% as an incompatibility between them and \LaTeX{} floats.  To overcome 
% both limitations, in the \textsf{igtitle} page styles, the second 
% part in |\cs{firstmark}| is a \emph{fixed} top mark and the first one 
% the actual first mark; the right way to get the bot mark is from the 
% second part.  Marks are stored at each section and used before and 
% after the title (straight class); the first part contains the values 
% of current title, but the second one contains the previously stored 
% values in the mark before the title, and the current values in the 
% mark after.

%\let\igt@compatps\@undefined
\ifx\igt@compatps\@undefined\else
  \PackageWarningNoLine{igtitle}
      {You are using an old interface for page styles\MessageBreak
      (or you forgot the package option 'pagestyles').\MessageBreak
      You could proceed but don't complain if you run\MessageBreak
      into errors}
\fi

\igt@pstrue

\let\parttitle\@empty
\let\chaptertitle\@empty
\let\sectiontitle\@empty
\let\subsectiontitle\@empty
\let\subsubsectiontitle\@empty
\let\paragraphtitle\@empty
\let\subparagraphtitle\@empty

\newcommand\ifigttitle[1]{%
  \expandafter\ifx\csname #1title\endcsname\@empty
    \expandafter\@secondoftwo
  \else
    \expandafter\@firstoftwo
  \fi}

% \ignewtitlemarks belongs to a nameless markset (ie, \@empty).
% For named extra marksets see below. 

\newcommand\ignewtitlemark{%
  \@ifstar{\@tempswafalse\igt@newmk@i\@empty}%
          {\@tempswatrue\igt@newmk@i\@empty}}

\def\igt@newmk@i#1#2{%   markset, macro/var
  \edef\igt@a{\expandafter\@gobble\string#2}%
  \expandafter\ifx\csname\igt@a\endcsname#2\else
    \edef\igt@a{c@#2}%
  \fi
  \expandafter\igt@newmk@ii\expandafter{\igt@a}{#1}}

\def\igt@newmk@ii#1#2{%   macro/var, markset
  \expandafter\let\expandafter\igt@a\csname igt@mks@#2\endcsname
  \if@tempswa
    \expandafter\def\expandafter\igt@a\expandafter{%
      \igt@a
      \protect\@namedef{#1}{\@nameuse{#1}}}%
  \else
    \expandafter\def\expandafter\igt@a\expandafter{%
      \igt@a
      \protect\@nameuse{#1}=\the\@nameuse{#1}\relax}%
  \fi
  \expandafter\let\csname igt@mks@#2\endcsname\igt@a}

\let\igt@mks@\@empty
\def\igt@moremarks{\igt@mks@} % backward compat

\def\igt@prevmarks{\igt@marks}
\let\igt@marks\relax

% The following command sets the ifthe... commands to
% be used in heads. When the call is from inside a sectioning
% command, toclabel is either true (in most of cases) or false
% (a chapter in the front matter, for example). Otherwise (an
% explicit \...mark) is false

\def\igt@setifthe#1{%
  \expandafter\protected@edef\csname ifthe#1\endcsname{%
    \ifigt@toclabel
      \protect\@firstoftwo
    \else
      \protect\@secondoftwo
    \fi}}

% At this point \igt@toclabel is always false

\igt@setifthe{part}
\igt@setifthe{chapter}
\igt@setifthe{section}
\igt@setifthe{subsection}
\igt@setifthe{subsubsection}
\igt@setifthe{paragraph}
\igt@setifthe{subparagraph}

% Putting marks
% -------------

\ignewtitlemark{\igt@running}
\let\igt@enccode\relax
\def\igt@running{\igt@enccode}

% \igt@markboth redefines temporarily \mark to fetch changes made by
% babel or ams, saved in \igt@running.  When this is done, the actual
% \mark es emitted, which has \igt@running as part of the markset (see
% the \ignewtitlemark above). As of 2019 and due to a change in the LaTex
% kernel, we consider two possibilities (2.13).

\expandafter\ifx\csname markboth \endcsname\relax
  \def\igt@mb@mark{\markboth}
\else
  \edef\igt@mb@mark{\expandafter\noexpand\csname markboth \endcsname}
\fi

\def\igt@mb@warn{%
  \PackageWarningNoLine{igtitle}
    {Direct use of \string\markboth\space and \string\markleft\space
     can lead\MessageBreak
     to unpredictable results. Please, read the manual\MessageBreak
     for an explanation of this warning.}}

\def\igt@markboth#1{%
 \begingroup
   \let\protect\@unexpandable@protect
   \let\@mkboth\@gobbletwo
   \let\igt@enccode\relax
   \let\label\relax
   \let\index\relax
   \let\glossary\relax
   \let\igt@c\mark
   \def\mark##1{\xdef\igt@running{\expandafter\@gobble##1}}%
   \igt@mb@mark{}{\igt@enccode}%
   \expandafter\let\csname#1mark\endcsname\@gobble
   \xdef\igt@marks{\igt@marks}%
   \gdef\@themark{{\igt@marks}{\igt@prevmarks}}%
   \igt@c{\@themark\let\noexpand\igt@mb@warn\relax}%
   \@nameuse{igt@tem@#1}%
   \if@nobreak\ifvmode\nobreak\fi\fi
 \endgroup}

\newcommand\igtsettitlemarks{\@ifstar\igt@svmarks@s\igt@svmarks@x}

\def\igt@svmarks@x#1{\def\igt@marksset{{#1}}}
\def\igt@svmarks@s#1{\def\igt@marksset{*{#1}}}

\newcommand\igtsetmarks[2]{\igtsettitlemarks{#1,#2}} % back compat

\def\igt@settopmark#1\@@{%
  \expandafter\def\csname#1mark\endcsname##1{%
    \expandafter\gdef\csname#1title\endcsname{##1}%
    %\csgappto{#1title}{##1}%
    \igt@setifthe{#1}%
    \expandafter\let\expandafter\igt@marks\csname igt@tm@#1\endcsname
    \igt@markboth{#1}}%
  \global\@namedef{igt@tm@#1}{%
    \protect\@namedef{#1title}{\@nameuse{#1title}}%
    \protect\@namedef{the#1}{\@nameuse{the#1}}%
    \protect\@namedef{ifthe#1}{\@nameuse{ifthe#1}}}%
  \def\igt@elt##1{%
    \expandafter\igt@setsubmark\igt@a\@@{##1}}%
  \igt@c}%

\def\igt@setsubmark#1\@@#2{%
  \expandafter\g@addto@macro\csname igt@tm@#2\endcsname{%
    \protect\@namedef{#1title}{}%
    \protect\@namedef{the#1}{}%
    \protect\@namedef{ifthe#1}{\protect\@secondoftwo}}
  \expandafter\g@addto@macro\csname igt@tm@#1\endcsname{%
    \protect\@namedef{#2title}{\@nameuse{#2title}}%
    \protect\@namedef{the#2}{\@nameuse{the#2}}%
    \protect\@namedef{ifthe#2}{\@nameuse{ifthe#2}}}}%

\def\igt@setmarks@x#1{%
  \let\igt@c\@empty % sub list
  \@for\igt@a:=#1\do{%
    \expandafter\igt@settopmark\igt@a\@@
    \let\igt@elt\relax
    \xdef\igt@c{\igt@c\igt@elt{\igt@a}}}%
  \@for\igt@a:=#1\do{%
    \expandafter\g@addto@macro\csname igt@tm@\igt@a\endcsname{%
      \igt@moremarks}}}

\def\igt@setmarks@s#1{% Solo con extramarks
  \PackageError{igtitle}%
     {You need `extramarks' for \string\igtsettitlemarks*}%
     {\string\igtsettitlemarks* requires the package option `extramarks'}}

\newcommand\igtpretitlemark{%
  \global\igt@premarktrue
  \@ifstar{\igt@pretitlemark\z@}%
          {\igt@pretitlemark\@ne}}

\def\igt@pretitlemark#1#2#3{%
  \addtocounter{#2}#1%
  \igt@premark{#2}{#3}%
  \addtocounter{#2}{-#1}}

% Rules
% -----

\newcommand\igtheadrule{\igtsetheadrule{.4\p@}}
\newcommand\igtfootrule{\igtsetfootrule{.4\p@}}

\newcommand\igtsetheadrule[1]{%
  \ifdim#1=\z@
    \let\makeheadrule\@empty
  \else
    \def\makeheadrule{\rule[-.3\baselineskip]{\linewidth}{#1}}%
  \fi}
\newcommand\igtsetfootrule[1]{%
  \ifdim#1=\z@
    \let\makefootrule\@empty
  \else
    \def\makefootrule{\rule[.7\baselineskip]{\linewidth}{#1}}%
  \fi}

\newcommand\igtnewpagestyle[1]{%
  \begingroup
  \catcode`\^^M=9
  \@ifnextchar[%
    {\igt@pagestyle\newcommand{#1}}%
    {\igt@pagestyle\newcommand{#1}[]}}

\newcommand\igtrenewpagestyle[1]{%
  \begingroup
  \catcode`\^^M=9
  \@ifnextchar[%
    {\igt@pagestyle\renewcommand{#1}}%
    {\igt@pagestyle\renewcommand{#1}[]}}

\def\igt@pagestyle#1#2[#3]#4{%
  \endgroup
  \expandafter#1\csname ps@#2\endcsname{%
    \igt@defaultps
    \def\igt@headfmt{#3}%
    #4%
    \def\igtsettitlemarks{\@ifstar\igt@svmarks@s\igt@svmarks@x}}}

\def\igt@userunning#1#2{\csname igtr@#1#2\endcsname}

\def\igt@defaultps{%
  \let\makeheadrule\@empty
  \let\makefootrule\@empty
  \def\@mkboth{\igt@savemark\@gobbletwo}%
  \def\@oddfoot{\igt@userunning of}%
  \def\@evenfoot{\igt@userunning ef}%
  \def\@oddhead{\igt@userunning oh}%
  \def\@evenhead{\igt@userunning eh}%
  \def\igtr@of{\igt@makefoot\@empty\@@\igt@hiol\igt@hior}%
  \def\igtr@ef{\igt@makefoot\@empty\@@\igt@hiel\igt@hier}%
  \def\igtr@oh{\igt@makehead\@empty\@@\igt@hiol\igt@hior}%
  \def\igtr@eh{\igt@makehead\@empty\@@\igt@hiel\igt@hier}%
  \let\igtr@of@b\relax  \let\igtr@of@p\relax
  \let\igtr@ef@b\relax  \let\igtr@ef@p\relax
  \let\igtr@oh@t\relax  \let\igtr@oh@p\relax
  \let\igtr@eh@t\relax  \let\igtr@eh@p\relax
  \def\igtsettitlemarks{\@ifstar\igt@setmarks@s\igt@setmarks@x}%
  \expandafter\igtsettitlemarks\igt@marksset}

\@ifundefined{chapter}%
  {\igtsettitlemarks{section,subsection}}%
  {\igtsettitlemarks{chapter,section}}

\newcommand\igtusepage{\protect\thepage} % back compat

\newcommand\igttoptitlemarks{\expandafter\@secondoftwo\firstmark{}{}{}}
\def\firsttitlemarks{%
   \toks@\expandafter\expandafter\expandafter{%
      \expandafter\@secondoftwo \firstmark{}{}{}}%
   \@temptokena\expandafter\expandafter\expandafter{%
      \expandafter\@secondoftwo \botmark{}{}{}}%
   \edef\igt@a{\the\toks@}%
   \edef\igt@b{\the\@temptokena}%
   \ifx\igt@a\igt@b
     \expandafter\@secondoftwo\firstmark{}{}{}%
   \else
     \expandafter\@firstoftwo \firstmark{}{}{}%
   \fi}
\newcommand\igtbottitlemarks{\expandafter\@secondoftwo\botmark{}{}{}}
\newcommand\igtnexttoptitlemarks{\expandafter\@firstoftwo\botmark{}{}{}}
\newcommand\igtoutertitlemarks{%
  \if@twoside
    \ifodd\c@page\relax
      \igtbottitlemarks
    \else
      \igttoptitlemarks
    \fi
  \else
    \igttoptitlemarks
  \fi}
\newcommand\igtinnertitlemarks{%
  \if@twoside
    \ifodd\c@page\relax
      \firsttitlemarks
    \else
      \igtbottitlemarks
    \fi
  \else
    \igtbottitlemarks
  \fi}

\def\igt@duplthreeargs#1#2#3#4{#1[#2][#3][#4]{#2}{#3}{#4}}
\def\igt@dupltwoargs#1#2#3{#1[#2][#3]{#2}{#3}}
\def\igt@duplthreeargsrev#1#2#3#4{#1[#4][#3][#2]{#2}{#3}{#4}}
\def\igt@dupltwoargsrev#1#2#3{#1[#3][#2]{#2}{#3}}

\def\igt@setany#1{%
  \@ifstar{\igt@duplthreeargsrev#1}%
          {\@ifnextchar[{#1}{\igt@duplthreeargs#1}}}

\newcommand\igtsetfoot{\igt@setany\igt@setfoot}
\newcommand\igtsethead{\igt@setany\igt@sethead}

\def\igt@setfoot[#1][#2][#3]#4#5#6{%
  \def\igtr@ef{\igt@makefoot{#1}{#2}{#3}\@@\igt@hiel\igt@hier}%
  \def\igtr@of{\igt@makefoot{#4}{#5}{#6}\@@\igt@hiol\igt@hior}}

\def\igt@sethead[#1][#2][#3]#4#5#6{%
  \def\igtr@eh{\igt@makehead{#1}{#2}{#3}\@@\igt@hiel\igt@hier}%
  \def\igtr@oh{\igt@makehead{#4}{#5}{#6}\@@\igt@hiol\igt@hior}}

\def\igt@headinline#1#2#3{%
  \igt@headfmt
  \def\igt@a{#1#3}\def\igt@b{#2}%
  \ifx\igt@a\@empty
    \hfil{#2}\hfil
  \else\ifx\igt@b\@empty
    {#1}\hfil{#3}%
  \else
    \sbox\z@ {#1}%
    \sbox\tw@{#3}%
    \copy\z@
    \ifdim\wd\z@<\wd\tw@
      \kern-\wd\z@\kern\wd\tw@
    \fi
    \hfil{#2}\hfil
    \ifdim\wd\z@>\wd\tw@
      \kern-\wd\tw@\kern\wd\z@
    \fi
    \box\tw@
  \fi\fi}

\def\igt@makeboth#1#2#3#4{%
  \igt@calcneg\hspace{#3}%
  \normalsize
  \linewidth\textwidth
  \addtolength\linewidth{#3}%
  \addtolength\linewidth{#4}%
  \ifx#2\@empty\else   
    \setbox\z@\hb@xt@\linewidth{%
      \color@begingroup
      #2%
      \color@endgroup}%
      \wd\z@\z@
      \ht\z@\z@
      \dp\z@\z@
      \box\z@
  \fi
  \igt@titlemarks % Must precede the format. Defines \igt@running
  \def\igt@enccode{\igt@headinline#1{}{}{}}% which contains igt@enccode
  \igt@running
  \igt@calcneg\hspace{#4}}% 

\def\igt@makehead#1\@@{\igt@makeboth{#1}\makeheadrule}
\def\igt@makefoot#1\@@{\igt@makeboth{#1}\makefootrule}

\newcommand\igtwidenhead{%
  \@ifstar{\igt@dupltwoargsrev\igt@widenhd}%
          {\@ifnextchar[{\igt@widenhd}{\igt@dupltwoargs\igt@widenhd}}}

\def\igt@widenhd[#1][#2]#3#4{%
  \def\igt@hiel{#1}\def\igt@hier{#2}%
  \def\igt@hiol{#3}\def\igt@hior{#4}}

\let\igtsetheadindent\igtwidenhead

\def\igt@hiel{\z@}\def\igt@hier{\z@}
\def\igt@hiol{\z@}\def\igt@hior{\z@}

% A tool:

\def\ifsamemark#1#2{%
  {#1\global\let\igt@c#2}%
  \ifx\igt@c#2%
    \expandafter\@firstoftwo
  \else
    \expandafter\@secondoftwo
  \fi}

% Another tool:
% As of 2019 and due to a change in the LaTex kernel, we consider two
% possibilities (2.13).

\expandafter\ifx\csname markboth \endcsname\relax

  \newcommand\igtsetmarkboth{%
    \ifx\markboth\igt@mb@use\else
      \let\igt@mb@mark\markboth
      \let\markboth\igt@mb@use
    \fi
    \def\igt@mb@new##1##2}

  % \igt@mb@temp is a trick to allow resetting inside \igtsetmarkboth.

  \def\igt@mb@use#1#2{%
    \let\markboth\igt@mb@mark
    \def\igt@mb@temp{\let\markboth\igt@mb@use}%
    \igt@mb@new{#1}{#2}%
    \igt@mb@temp
    \let\igt@mb@temp\@undefined}

  \newcommand\igtresetmarkboth{%
    \ifx\igt@mb@temp\@undefined
      \let\markboth\igt@mb@mark
      \def\igt@mb@mark{\markboth}%
    \else
      \def\igt@mb@temp{%
        \let\markboth\igt@mb@mark
        \def\igt@mb@mark{\markboth}}%
    \fi}

\else

  \newcommand\igtsetmarkboth{%
    \expandafter\ifx\csname markboth \endcsname\igt@mb@use\else
      \expandafter\let\expandafter\igt@mb@mark\csname markboth \endcsname
      \expandafter\let\csname markboth \endcsname\igt@mb@use
    \fi
    \def\igt@mb@new##1##2}

  \def\igt@mb@use#1#2{%
    \expandafter\let\csname markboth \endcsname\igt@mb@mark
    \def\igt@mb@temp{\expandafter\let\csname markboth \endcsname\igt@mb@use}%
    \igt@mb@new{#1}{#2}%
    \igt@mb@temp
    \let\igt@mb@temp\@undefined}

  \newcommand\igtresetmarkboth{%
    \ifx\igt@mb@temp\@undefined
      \expandafter\let\csname markboth \endcsname\igt@mb@mark
      \edef\igt@mb@mark{\expandafter\noexpand\csname markboth \endcsname}%
    \else
      \def\igt@mb@temp{%
        \expandafter\let\csname markboth \endcsname\igt@mb@mark
        \edef\igt@mb@mark{\expandafter\noexpand\csname markboth \endcsname}}%
    \fi}

\fi

% ===========
% EXTRA MARKS
% ===========

\ifx\igt@fetchmark\@empty

\ifx\newmarks\@undefined
  \PackageInfo{igtitle}{%
    You have requested `extramarks' but etex or similar\MessageBreak
    has not been loaded. I'll do it for you.}
  \RequirePackage{etex}
\fi

\def\igt@setmarks@s#1{%
   \@for\igt@a:=#1\do{%
     \@ifundefined{igt@mkc@\igt@a}{%
       \expandafter\newmarks\csname igt@mkc@\igt@a\endcsname}{}%
     \expandafter\xdef\csname igt@tem@\igt@a\endcsname{%
       \marks\expandafter\noexpand\csname igt@mkc@\igt@a\endcsname
       {\noexpand\@themark}}}%
  \igt@setmarks@x{#1}}%

\newcommand\igtnewmarkset[1]{%
  \expandafter\newmarks\csname igt@mkc@#1\endcsname
  \@namedef{igt@mks@#1}{}%
  \@namedef{igt@premks@#1}{\@nameuse{igt@mks@#1}}}

\newcommand\igtnewextramark{%
  \@ifstar{\@tempswafalse\igt@newmk@i}%
          {\@tempswatrue\igt@newmk@i}}

\def\igt@extramark#1{%
 \begingroup
   \let\protect\@unexpandable@protect
   \let\@mkboth\@gobbletwo
   \let\label\relax
   \let\index\relax
   \let\glossary\relax\endgroup}

\newcommand\igtextramark[1]{%
  \begingroup
    \let\protect\@unexpandable@protect
    \let\@mkboth\@gobbletwo
    \let\label\relax
    \let\index\relax
    \let\glossary\relax
    \marks\csname igt@mkc@#1\endcsname{%
      {\@nameuse{igt@mks@#1}}%
      {\@nameuse{igt@mks@#1}}}%
    \expandafter\xdef\csname igt@premks@#1\endcsname
      {\@nameuse{igt@mks@#1}}%
  \endgroup
  \if@nobreak\ifvmode\nobreak\fi\fi}%

\newcommand\igtpreextramark[1]{%
  \begingroup
    \let\protect\@unexpandable@protect
    \let\@mkboth\@gobbletwo
    \let\label\relax
    \let\index\relax
    \let\glossary\relax
    \marks\csname igt@mkc@#1\endcsname{%
      {\csname igt@mks@#1\endcsname}%
      {\csname igt@premks@#1\endcsname}}%
  \endgroup
  \if@nobreak\ifvmode\nobreak\fi\fi}

\newcommand\igtnewshortmark[1]{%
  \igtnewmarkset{\string#1}%
  \igtnewextramark{\string#1}#1}

\newcommand\igtshortmark[1]{\igtextramark{\string#1}}
\newcommand\igtpreshortmark[1]{\igtpreextramark{\string#1}}

\newcommand\igttopshortmark[1]{{\igttopextramarks{\string#1}#1}}
\newcommand\igtfirstshortmark[1]{{\igtfirstextramarks{\string#1}#1}}
\newcommand\igtbotshortmark[1]{{\igtbotextramarks{\string#1}#1}}
\newcommand\igtnexttopshortmark[1]{{\igtnexttopextramarks{\string#1}#1}}

\def\igt@fetchmark#1#2#3{%
  \expandafter#1#2\csname igt@mkc@#3\endcsname{}{}{}}

\newcommand\igttopextramarks[1]{\igt@fetchmark\@secondoftwo\firstmarks{#1}}
\newcommand\igtfirstextramarks[1]{%
   \toks@\expandafter\expandafter\expandafter{%
      \igt@fetchmark\@secondoftwo\firstmarks{#1}}%
   \@temptokena\expandafter\expandafter\expandafter{%
      \igt@fetchmark\@secondoftwo\botmarks{#1}}%
   \edef\igt@a{\the\toks@}%
   \edef\igt@b{\the\@temptokena}%
   \ifx\igt@a\igt@b
     \igt@fetchmark\@secondoftwo\firstmarks{#1}%
   \else
     \igt@fetchmark\@firstoftwo\firstmarks{#1}%
   \fi}
\newcommand\igtbotextramarks[1]{\igt@fetchmark\@secondoftwo\botmarks{#1}}
\newcommand\igtnexttopextramarks[1]{\igt@fetchmark\@firstoftwo\botmarks{#1}}

\newcommand\igtouterextramarks[1]{%
  \if@twoside
    \ifodd\c@page\relax
      \igtbotextramarks{#1}%
    \else
      \igttopextramarks{#1}%
    \fi
  \else
    \igttopextramarks{#1}%
  \fi}
\newcommand\igtinnerextramarks[1]{%
  \if@twoside
    \ifodd\c@page\relax
      \igtfirstextramarks{#1}%
    \else
      \igtbotextramarks{#1}%
    \fi
  \else
    \igtbotextramarks{#1}%
  \fi}

\fi

% ======
% FLOATS
% ======
%
% Pagestyles with floats. There macros are defined only with the
% psfloats package option.

\ifx\igt@replace\@undefined\else

% User interface

  \newcommand\igtsetfloatfoot{%
    \let\igt@c\@empty % <- current float, empty if general
    \igt@setany\igt@setftfoot}

  \newcommand\igtsetfloathead{%
    \let\igt@c\@empty % <- current float, empty if general
    \igt@setany\igt@setfthead}

  \def\igt@setftfoot[#1][#2][#3]#4#5#6#7{%
    \@ifnextchar[{\igt@setftfoot@i{#1}{#2}{#3}{#4}{#5}{#6}{#7}}%
                 {\igt@setftfoot@i{#1}{#2}{#3}{#4}{#5}{#6}{#7}[bp]}}

  \def\igt@setfthead[#1][#2][#3]#4#5#6#7{%
    \@ifnextchar[{\igt@setfthead@i{#1}{#2}{#3}{#4}{#5}{#6}{#7}}%
                 {\igt@setfthead@i{#1}{#2}{#3}{#4}{#5}{#6}{#7}[tp]}}

  \def\igt@setftfoot@i#1#2#3#4#5#6#7[#8]{%
    \@tfor\igt@b:=#8\do{%
      \@namedef{igtr@ef@\igt@b\igt@c}%
         {#7\igt@makefoot{#1}{#2}{#3}\@@\igt@hiel\igt@hier}%
      \@namedef{igtr@of@\igt@b\igt@c}%
         {#7\igt@makefoot{#4}{#5}{#6}\@@\igt@hiol\igt@hior}}}

  \def\igt@setfthead@i#1#2#3#4#5#6#7[#8]{%
    \@tfor\igt@b:=#8\do{%
      \@namedef{igtr@eh@\igt@b\igt@c}%
         {#7\igt@makehead{#1}{#2}{#3}\@@\igt@hiel\igt@hier}%
      \@namedef{igtr@oh@\igt@b\igt@c}%
         {#7\igt@makehead{#4}{#5}{#6}\@@\igt@hiol\igt@hior}}}

  \newcommand\igtnextfloathead{%
    \igt@nextfree  % returns igt@c with the next float
    \igt@setany\igt@setfthead}

  \newcommand\igtnextfloatfoot{%
    \igt@nextfree  % returns igt@c with the next float
    \igt@setany\igt@setftfoot}

% Compat mode with floatps

  \ifx\igt@replace\space

    \let\igt@setnewfoot\igt@setftfoot
    \let\igt@setnewhead\igt@setfthead

    \def\igt@setftfoot[#1][#2][#3]#4#5#6{%
      \igt@setnewfoot[#1][#2][#3]{#4}{#5}{#6}{}}
    \def\igt@setfthead[#1][#2][#3]#4#5#6{%
      \igt@setnewhead[#1][#2][#3]{#4}{#5}{#6}{}}

  \fi

% The simple default value of \igt@userunning is
% replaced by one more elaborated

  \def\igt@userunning#1#2{%
    \if@fcolmade  % From a post by D. Arseneau to comp.text.tex
      \def\@elt##1{\edef\igt@pageft{\string##1}}%
      \@flsucceed
      \let\@elt\relax
      \if#2h%
        \igt@replace #1hp\igt@pageft
      \else
        \igt@replace #1fp\igt@pageft
        \igt@killftps\igt@pageft
      \fi
    \else\if#2h%
      \ifx\igt@topft\@empty\else
        \igt@replace #1ht\igt@topft
      \fi
    \else
      \ifx\igt@botft\@empty\else
        \igt@replace #1fb\igt@botft
      \fi
    \fi\fi
    \csname igtr@#1#2\endcsname}

% [Don't move above as \igt@replace is used as a flag.]

  \def\igt@replace#1#2#3#4{%
      \@ifundefined{igtr@#1#2@#3#4}%
        {\@ifundefined{igtr@#1#2@#3}{}%
           {\@namedef{igtr@#1#2}{\@nameuse{igtr@#1#2@#3}}}}%
        {\csname igtr@xx@x#4\endcsname\@gobble
         {\expandafter\let\csname igtr@#1#2\expandafter\endcsname
           \csname igtr@#1#2@#3#4\endcsname}}}

  \def\igt@nextfree{%
    \def\@elt##1{%
      \edef\igt@c{\string##1}%
      \let\@elt\@gobble}%
    \@freelist
    \let\@elt\relax
    \@ifundefined{igtr@xx@x\igt@c}%
      {\expandafter\let\csname igtr@xx@x\igt@c\endcsname\@secondoftwo
       \@tfor\igt@a:={eh@t}{oh@t}{ef@b}{of@b}{eh@p}{oh@p}{ef@p}{of@p}\do{%
         \expandafter\global\expandafter
         \let\csname igtr@\igt@a\igt@c\endcsname\relax}}{}}

  \def\igt@killftps#1{%
    \expandafter\global\expandafter
    \let\csname igtr@xx@x#1\endcsname\relax}

  \let\igt@topft\@empty
  \let\igt@botft\@empty
  \let\igt@pageft\@empty

  \def\igt@combinefloats{%
   \ifx\@toplist\@empty\else   
     \def\@elt##1{%
       \edef\igt@topft{\string##1}%
       \def\@elt####1{\igt@killftps{\string####1}}}%
     \@toplist
    \fi
    \ifx\@botlist\@empty\else
      \def\@elt##1{%
        \def\@elt####1{%
          \def\@elt####1{\igt@killftps\igt@botft}%
          \edef\igt@botft{\string####1}}%
        \edef\igt@botft{\string##1}}%
      \@botlist
    \fi
    \let\@elt\relax
    \igt@combinefloats@x}

  \AtBeginDocument{%
    \let\igt@combinefloats@x\@combinefloats
    \let\@combinefloats\igt@combinefloats}

\fi

% END core code

\ifx\igt@coreps\@empty\else      % CONTINUE code for package

% Raise error if the following are used without igtitle

\DeclareRobustCommand\igt@naerror[1]{%
  \PackageError{igtitle}%
    {#1\space only available in igtitle.\MessageBreak
     Consider using it instead of igtitle}%
    {igtitle provides a subset of the macros\MessageBreak
     for pagestyles defined in igtitle.}}

\def\igt@setifthe#1{%
  \expandafter\protected@edef\csname ifthe#1\endcsname{%
    \igt@naerror{\string\ifthe#1}}}

\igt@setifthe{part}
\igt@setifthe{chapter}
\igt@setifthe{section}
\igt@setifthe{subsection}
\igt@setifthe{subsubsection}
\igt@setifthe{paragraph}
\igt@setifthe{subparagraph}

\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%% igtitle.sty intégré %%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newif\ifigt@label
\newif\ifigt@fromblock
\newdimen\igt@leftsep

\providecommand\igtline{%
  \@ifstar{\igt@line@i{\hb@xt@\igtwidth}}%
          {\igt@line@i{}}}

\def\igt@line@i#1{%
  \@ifnextchar[{\igt@line{#1}}{\igt@line{#1}[s]}}

\def\igt@line#1[#2]#3{%
  \vskip\topskip
  \hrule \@height \z@
  \nobreak
  \vskip-\topskip
  \begingroup
    \parindent\z@
    \everypar{}%
    \leftskip\z@
    \rightskip\z@   %  #1 is either \hb@xt@\igtwidth or empty:
    \@makebox[\hsize][#2]{\igt@makeline{#1{#3}}}%
    \par
  \endgroup
  \hrule height \z@
  \nobreak}

% Fillers:

\providecommand\igtrule{\@ifstar{\igt@row}{\igt@rule}}

\let\igt@leaders\xleaders

\def\igt@row{\@ifnextchar[{\igt@row@i}{\igt@row@i[\wd\z@]}}
\def\igt@row@i[#1]#2{%
  \ifvmode\expandafter\igtline\fi
  {\sbox\z@{#2}%
   \hspace{-#1}%
   \hskip\wd\z@
   \igt@leaders\hb@xt@#1{\hss\box\z@}%
   \hfill\kern\z@}}

\def\igt@rule{\@ifnextchar[{\igt@rule@i}{\igt@rule@i[.4pt]}}
\def\igt@rule@i[#1]{%
  \ifvmode\expandafter\igtline\fi
  {\leaders\hrule height #1\hfill\kern\z@}}

%\providecommand\filright{%
%  \gdef\igt@filleft##1{\hskip##1}%
%  \gdef\igt@filright##1{\hfill}%
%  \let\\\@centercr
%  \advance\rightskip\z@ \@plus 1fil\relax}
%\providecommand\filleft{%
%  \gdef\igt@filleft##1{\hfill}%
%  \gdef\igt@filright##1{\hskip##1}%
%  \let\\\@centercr
%  \advance\leftskip\z@ \@plus 1fil
%  \parfillskip\z@}
%\providecommand\filcenter{\filleft\filright
%  \gdef\igt@filleft##1{\hfill}}
%\providecommand\fillast{%
%  \gdef\igt@filleft##1{\hfill}%
%  \gdef\igt@filright##1{\hfill}%
%  \let\\\@centercr
%  \filleft\advance\rightskip\z@ \@plus -1fil
%  \parfillskip\z@ \@plus 2fil\relax}

% Now, the specific igtitle part

% User interface
% ~~~~~~~~~~~~~~
% Tools:

\DeclareOption{dotinlabels}{\def\igt@idot{.}}
\DeclareOption{nodotinlabels}{\let\igt@idot\@empty}

\DeclareOption{rigidseps}{%
  \def\igt@contentsstretch{\vskip\z@}}
\DeclareOption{rubberseps}{%
  \def\igt@contentsstretch{\vskip\z@\@plus.1\p@}}

\DeclareOption{leftlabels}{%
  \renewcommand\numberline[1]{\hb@xt@\@tempdima{#1\igt@idot\hfil}}%
  \newcommand\igtcontentslabel[2][\thecontentslabel\igt@idot]{%
%   \let\igt@a\thecontentslabel   %%%%% For the star variant
%   \def\thecontentslabel{#2}%    %%% To be fully implemented... when?
%   \setbox\z@\hbox{#1}%
%   \dimen@\wd\z@
%   \let\thecontentslabel\igt@a
%   \hspace*{-\dimen@}\hb@xt@\dimen@{#1\hfil}
%  \show\igt@b \show\igt@a
    \hspace*{-#2}\hb@xt@#2{#1\hfil}}}

\DeclareOption{rightlabels}{%
  \renewcommand\numberline[1]{\hb@xt@\@tempdima{\hss#1\igt@idot\enspace}}%
  \let\igtcontentslabel\relax
  \newcommand\igtcontentslabel[2][\thecontentslabel\igt@idot\enspace]{%
    \hspace*{-#2}\hb@xt@#2{\hfil#1}}}

\newcommand\igtcontentspage[1][\thecontentspage]{%
  \hb@xt@\@pnumwidth{\hfil#1}%
  \hspace*{-\@pnumwidth}}

\newcommand\igtcontentspush[1]{%
  \sbox\z@{#1}%
  \xdef\igt@b{\advance\leftskip\the\wd\z@}%
  \aftergroup\igt@b
  \leavevmode\llap{\box\z@}}

% General commands. A level register. Explicit numbers
% because they are used in csnames. Ignored if already defined.

\ifx\igtl@section\@undefined

  \@ifundefined{chapter}
    {\def\igtl@part{0}}
    {\def\igtl@part{-1}%
     \def\igtl@chapter{0}}
  \def\igtl@section{1}
  \def\igtl@subsection{2}
  \def\igtl@subsubsection{3}
  \def\igtl@paragraph{4}
  \def\igtl@subparagraph{5}

\fi

% We make sure that a series of * entries are finished and
% that a \igtcontents in the middle of a document is
% written to the right file. We need ship out floats before;
% that's very tricky.

\newcommand\igtcontentsuse[2]{%
  \expandafter\def\csname igtx@#1\endcsname{#2}%
  \expandafter\def\csname igtl@#1\endcsname{-1000}%
  \expandafter\def\expandafter\igt@finishall\expandafter{%
    \igt@finishall
    \@writefile{#2}{\igtcontentsfinish}}}

\def\igt@finishall{\@writefile{toc}{\igtcontentsfinish}}

\AtEndDocument{%
  \igt@startlists
  \let\igt@newpage\newpage
  \def\newpage{%
    \let\newpage\igt@newpage
    \newpage
    \if@filesw
      \immediate\write\@mainaux{\string\igt@finishall}%
    \fi}}

\igtcontentsuse{figure}{lof}
\igtcontentsuse{table}{lot}

\def\igtcontentsfinish{%
  \ifigt@fromblock
    \xdef\igt@b{-10000}% ships out any saved punctuation
    \igt@preend
    \@@par
    \endgroup
    \global\igt@fromblockfalse
  \fi}

% The two basic commands. First \igtcontentsmargin:

\newcommand\igtcontentsmargin[1][\z@]{%
  \def\igt@corr{#1}\def\@pnumwidth}

% The following is the value of \igtcontentsmargin when
% used inside \igt@tocenty (ie, \igtcontents).

\newcommand\igtmargin[2][\z@]{%
  \def\igt@corr{#1}%
  \advance\rightskip-\@pnumwidth\relax
  \advance\rightskip#2\relax
  \def\@pnumwidth{#2}}

% \igtcontents deals with concepts, not commands; hence no
% escape char

\newcommand\igtcontents{%
  \@ifstar{\igt@contents{\z@}}%
          {\igt@contents{\@ne}}}

\def\igt@contents#1#2{%
  \@ifnextchar[{\igt@contents@i{#1}{#2}}%
               {\igt@contents@i{#1}{#2}[\@nil]}}

% A dirty hack to fix wrong destinations with hyperref. But activate
% only if some inline entry is defined (ie, #1 = 0):
\let\igt@fixhyperref\relax

\def\igt@contents@i#1#2[#3]#4#5#6#7{%
  \ifcase#1\relax
    \def\igt@fixhyperref{%
      \ifx\Hy@tocdestname\@undefined\else
        \global\let\Hy@tocdestname\Hy@tocdestname
      \fi}%
  \fi
  \expandafter\def\csname l@#2\endcsname
    {\igt@tocentry{#1}{#2}{#3}{#4}{{#5}{#6}}{#7}}%
  \@ifnextchar[{\igt@contents@ii{#1}{#2}}%
               {\igt@contents@ii{#1}{#2}[]}}

\def\igt@contents@ii#1#2[#3]{%
  \ifcase#1\relax
    \expandafter\@firstoftwo
  \else
    \expandafter\@secondoftwo
  \fi
  {\@ifnextchar[{\igt@contents@iii{#1}{#2}{#3}}%
                {\igt@contents@iii{#1}{#2}{#3}[]}}%
  {\igt@contents@iv{#1}{#2}{#3}[][]}}

\def\igt@contents@iii#1#2#3[#4]{%
  \@ifnextchar[{\@tempswatrue\igt@contents@iv{#1}{#2}{#3}[#4]}%
               {\@tempswafalse\igt@contents@iv{#1}{#2}{#3}[#4][]}}

\def\igt@contents@iv#1#2#3[#4][#5]{%
  \ifcase#1\relax
    \if@tempswa
      \igt@contents@v{#2}{#3}{#4}{#5}%
    \else
      \igt@contents@v{#2}{}{#3}{#4}%
    \fi
  \else
    \igt@contents@v{#2}{}{}{#3}%
  \fi}

\def\igt@contents@v#1#2#3#4{%
  \expandafter\def\csname igtb@#1\endcsname{#2}%
  \expandafter\def\csname igtm@#1\endcsname{#3}%
  \expandafter\def\csname igte@#1\endcsname{#4}}

\begingroup
\catcode`\-=12\catcode`\>=12
\gdef\igt@strip#1->#2\@@#3{\def#3{#2}}
\endgroup

\AtBeginDocument{%
  \def\igt@change@i#1#2#3#4#5#6#7{%
    \expandafter\def\csname l@#2\endcsname
      {\igt@tocentry{#1}{#2}{#3}{#4}{{#5}{#6}}{#7}}}%
  \let\igt@change@v\igt@contents@v
  \def\igt@contents@i#1#2[#3]#4#5#6#7{%
    \def\igt@a{\igt@change@i{#1}{#2}{#3}{#4}{#5}{#6}{#7}}%
    \@ifnextchar[{\igt@contents@ii{#1}{#2}}%
                 {\igt@contents@ii{#1}{#2}[]}}%
  \def\igt@contents@v#1#2#3#4{%
    \def\igt@b{\igt@change@v{#1}{#2}{#3}{#4}}%
    \expandafter\igt@strip\meaning\igt@a\@@\igt@a
    \expandafter\igt@strip\meaning\igt@b\@@\igt@b
    \edef\igt@c{%
      \expandafter\ifx\csname igtx@#2\endcsname\relax
        toc%
      \else
        \csname igtx@#2\endcsname
      \fi}%
    \addtocontents{\igt@c}{\igt@a\relax}%
    \addtocontents{\igt@c}{\igt@b\relax}}}

% Printing the toc entry
% ~~~~~~~~~~~~~~~~~~~~~~

\def\igt@lasttoc{-1000} % An inital dummy assignment

\def\igt@provideigtl#1#2{%
  \@ifundefined{igtl@#1#2}%
    {\global\expandafter\let\csname igtl@#1#2\expandafter\endcsname
        \csname igtl@#2\endcsname}%
    {}%
  \@ifundefined{igtl@#1#2}%
    {\PackageWarning{igtitle}%
       {Unknown TOC type #1#2. I'll set it for you with\MessageBreak
        level -1000.}%
     \expandafter\gdef\csname igtl@#1#2\endcsname{-1000}}%
    {}}

% 1 ifblock, 2 sect name, 3 left, 4 before,
% 5 {with}{without}, 6 filler/page, 7  title 8 pageno

\let\igt@preend\@empty

\def\igt@outpunct{%
  \ifnum\igt@c>\igt@b\relax
    \igt@preend
  \fi}

\def\igt@outblock#1#2#3{%
  \ifcase#1\relax
    \ifnum\igt@b>\igt@a\relax
      \begingroup
      \protected@edef\igt@preend{%
        \@nameuse{igte@#2}%
        \endgroup
        \protect\@namedef{igt@c}{\igt@a}%
        \protect\igt@outpunct}%
      #3%
      \@nameuse{igtb@#2}%
    \else\ifnum\igt@b<\igt@a\relax
      \igt@preend
      \@nameuse{igtm@#2}%
    \else
      \@nameuse{igtm@#2}%
    \fi\fi
  \else
    \igt@preend
    \@@par
    \endgroup
    \@firstoftwo
  \fi}

\def\igt@outnoblock#1#2#3{%
  \begingroup
  \ifnum\igt@b>\igt@a
    \nobreak
  \else\ifnum\igt@b<\igt@a
    \addpenalty{\@secpenalty}%
  \else
    \addpenalty{\z@}% 
  \fi\fi
  \igt@contentsstretch
  \nobreak
  \ifcase#1\relax\else\interlinepenalty\@M\fi
  \parindent\z@
  \ifx\@nil#2%
    \PackageError{igtitle}{Unimplemented}%
	    {The optional argument is currently mandatory}%
  \else
    \setlength\leftskip{#2}%
  \fi
  \setlength\rightskip{\@pnumwidth}%
  \let\igtcontentsmargin\igtmargin
  \def\igt@makeline##1{##1}%
  #3%
  \addtolength{\parfillskip}{-\igt@corr}%
  \addtolength{\rightskip}{\igt@corr}%
  \let\igt@leaders\leaders}

\def\igt@tocentry#1#2#3#4#5#6#7#8{%
  \igt@fixhyperref
  \igt@provideigtl{}{#2}%
  \xdef\igt@b{\csname igtl@#2\endcsname}%
  \ifnum\igt@b>\c@tocdepth\else
    \ifnum\igt@b<\igt@toctop\else
      \edef\igt@a{\igt@lasttoc}%
      \gdef\thecontentspage{#8}%
      \global\let\thecontentslabel\@empty
      \global\igt@labelfalse
      \sbox\z@{%  Unused box. It just catch the numberline
        \def\numberline##1{\global\igt@labeltrue\gdef\thecontentslabel{##1}}%
        #7}%    \igt@b = current     \igt@a = previous
      \ifigt@fromblock
        \igt@outblock{#1}{#2}{#4}%
      \else
        \igt@outnoblock{#1}{#3}{#4}%
      \fi
      \def\numberline##1{\ignorespaces}%
      \ifigt@label
        {\leavevmode\strut\@firstoftwo#5{#7}\strut\kern\z@}%
      \else
        {\leavevmode\strut\@secondoftwo#5{#7}\strut\kern\z@}%
      \fi
      {#6}%
      \ifcase#1\relax
        \ifigt@fromblock\else
          \protected@edef\igt@preend{\@nameuse{igte@#2}}%
        \fi
        \global\igt@fromblocktrue
      \else
        \@@par
        \nobreak
        \csname igte@#2\endcsname
        \endgroup
        \global\igt@fromblockfalse
      \fi
      \xdef\igt@lasttoc{\csname igtl@#2\endcsname}%
    \fi
  \fi
  \ignorespaces}

\newcommand\igtdottedcontents{}
\def\igtdottedcontents#1[#2]#3#4#5{%
  \igtcontents{#1}[#2]{#3}%
    {\igtcontentslabel{#4}}%
    {\hspace*{-#4}}%
    {\igtrule*[#5]{.}\igtcontentspage}}

\ExecuteOptions{leftlabels,nodotinlabels,rubberseps}

\ProcessOptions

% Multiple tocs and lists
% ~~~~~~~~~~~~~~~~~~~~~~~~
% After some attemps to adapt igtitle to minitoc, I decided to
% implement my own solution, because entries as written by minitoc are
% non standard. The new commands provides a good deal of flexibility,
% too.

\let\igt@startlists\@empty
\let\igt@writefile\@writefile

\def\igt@partialtoc{ptc}
\def\igt@partiallof{plf}
\def\igt@partiallot{plt}

\def\igt@writepartial#1#2{%
  \igt@topartial{toc}{#1}{#2}%
  \igt@topartial{lof}{#1}{#2}%
  \igt@topartial{lot}{#1}{#2}%
  \igt@writefile{#1}{#2}}

\def\igt@topartial#1#2#3{%
  \def\igt@a{#1}%
  \def\igt@b{#2}%
  \ifx\igt@a\igt@b
     \igt@writefile{\csname igt@partial#2\endcsname}{#3}%
  \fi}

\def\igt@xstartlist#1{%
  \@ifundefined{igt@startlist#1}{%
    \global\@namedef{igt@startlist#1}{%
      \let\@writefile\igt@writepartial
      \if@filesw
        \expandafter\newwrite\csname tf@#1\endcsname
        \immediate\openout\csname tf@#1\endcsname\jobname.#1\relax
      \fi
      \@nobreakfalse}%
    \expandafter\gdef\expandafter\igt@startlists\expandafter{%
      \igt@startlists
      \@nameuse{igt@startlist#1}}}{}}

\newcommand\igtstartcontents[1][default]{\igtstartlist[#1]{toc}}

\newcommand\igtstartlist[2][default]{%
  \expandafter\igt@xstartlist\csname igt@partial#2\endcsname
  \@ifundefined{c@igt@#2@#1}%
    {\newcounter{igt@#2@#1}}%
    {\igtstoplist[#1]{#2}}%  
  \stepcounter{igt@#2@#1}%
  \igtresumelist[#1]{#2}}

\newcommand\igtstopcontents[1][default]{\igtstoplist[#1]{toc}}

\newcommand\igtstoplist[2][default]{%
  \protected@write\@auxout{}{%
    \string\igt@writefile{\csname igt@partial#2\endcsname}{%
       \string\igt@stoptoc{#1@\arabic{igt@#2@#1}}}}}

\newcommand\igtresumecontents[1][default]{\igtresumelist[#1]{toc}}

\newcommand\igtresumelist[2][default]{%
  \protected@write\@auxout{}{%
    \string\igt@writefile{\csname igt@partial#2\endcsname}{%
       \string\igt@starttoc{#1@\arabic{igt@#2@#1}}}}}

\def\igt@starttoc#1{%
  \ifx\@writefile\@gobbletwo\else % Is this test necessary?
    \def\igt@a{#1}%
    \ifx\igt@a\igt@ptoc
      \let\contentsline\igt@contentsline
    \fi
  \fi
  \ignorespaces}

\def\igt@stoptoc#1{%
  \ifx\@writefile\@gobbletwo\else % Is this test necessary?
    \def\igt@a{#1}%
    \ifx\igt@a\igt@ptoc
      \let\contentsline\igt@gobblecontents
    \fi
  \fi
  \ignorespaces}

\newcommand\igtprintcontents[3][default]{%
  \def\igt@a{[#1]{toc}{#2}{#3}}%
  \igtpreprint}

\newcommand\igtprintlist[3][default]{%
  \def\igt@a{[#1]{#2}{#3}{-1001}}%
  \igtpreprint}

\newcommand\igtpreprint[2][\c@tocdepth]{%
  \expandafter\igt@printlist\igt@a{#1}{#2}}

% 1:name 2:list 3:prefix 4:startlevel 5:depth 6:toccode
\newcommand\igt@printlist[6][default]{%
  \begingroup
    \@ifundefined{c@igt@#2@#1}%
      {\PackageError{igtitle}{No partial #2 named #1}%
          {You must start before a partial toc/list\MessageBreak
          with \string/startcontents/\string\igtstartlist.}}{}%
    \edef\igt@ptoc{#1@\arabic{igt@#2@#1}}%
    \def\igt@toctop{#4}%
    \c@tocdepth=#5\relax
    #6%
    \let\igt@xcontentsline\contentsline
    \let\contentsline\igt@gobblecontents
    \def\igt@contentsline##1{%
      \igt@provideigtl{#3}{##1}%
      \@ifundefined{l@#3##1}%
        {\igt@xcontentsline{##1}}%
        {\igt@xcontentsline{#3##1}}}%
    \makeatletter
    \@input{\jobname.\csname igt@partial#2\endcsname}%
    \makeatother
    \@nobreakfalse
  \endgroup}

\AtBeginDocument{%
  \ifx\igt@gobblecontents\@undefined
    \def\igt@gobblecontents#1#2#3{\ignorespaces}%
  \fi}

\def\igt@toctop{-1000}

% Now the we add \igtcontentsfinish to the current definitions and a
% "selector" for partial tocs with a wrapper for the original
% definitions (saved as \igt@savel@#1).

\def\igt@lselect#1{%
  \igt@fixhyperref
  \ifnum\csname igtl@#1\endcsname>\c@tocdepth\else
    \igtcontentsfinish
  \fi
  \ifnum\csname igtl@#1\endcsname<\igt@toctop\relax
    \expandafter\@gobbletwo
  \else
    \expandafter\expandafter\csname igt@savel@#1\endcsname
  \fi}

\let\igt@savel@part\l@part
\def\l@part{\igt@lselect{part}}

\let\igt@savel@chapter\l@chapter
\def\l@chapter{\igt@lselect{chapter}}

\let\igt@savel@section\l@section
\def\l@section{\igt@lselect{section}}

\let\igt@savel@subsection\l@subsection
\def\l@subsection{\igt@lselect{subsection}}

\let\igt@savel@subsubsection\l@subsubsection
\def\l@subsubsection{\igt@lselect{subsubsection}}

\let\igt@savel@paragraph\l@paragraph
\def\l@paragraph{\igt@lselect{paragraph}}

\let\igt@savel@subparagraph\l@subparagraph
\def\l@subparagraph{\igt@lselect{subparagraph}}

\let\igt@savel@figure\l@figure
\def\l@figure{\igt@lselect{figure}}

\let\igt@savel@table\l@table
\def\l@table{\igt@lselect{table}}

\@tempskipa\@pnumwidth
\edef\@pnumwidth{\the\@tempskipa}
\advance\@tempskipa-\@tocrmarg
\edef\igt@corr{-\the\@tempskipa}


%               +-----------------+
%               |     K E Y S     |
%               +-----------------+

\def\igt@keys{%
  \let\igt@keys\relax
  \@ifundefined{define@key}{\RequirePackage{keyval}}{}%
  \def\igt@getkeys##1##2{%
    \let\igt@a\@empty
    \if\expandafter @\@gobble##1@\@empty % if there is a single token
      \edef\igt@b{\expandafter\@gobble\string##1}%
      \let\igt@a\igt@b
    \else
      \igt@labelfalse  %  A temporary flag: true if there is page key
      \setkeys{##2}{##1}%
      \ifigt@label
        \@ifundefined{igtp@\igt@b}{%
          \expandafter\let\csname igtp@\igt@b\endcsname\@empty}{}%
      \fi
      \edef\igt@a{\igt@b\igt@a}%
    \fi}%
  %
  \define@key{igtitle}{name}{%
    \edef\igt@b{\expandafter\@gobble\string##1}}%
  \define@key{igtitle}{numberless}[true]{%
    \csname @tempswa##1\endcsname
    \if@tempswa
      \edef\igt@a{\igt@a/*}%
    \fi}%
  \define@key{igtitle}{page}{%
    \igt@labeltrue  % Used as flag
    \edef\igt@a{/##1\igt@a}}%
  %
  \def\igt@extra@numberless{\igt@labeltrue}% The actual meaning
  \let\igt@key@numberless\@empty
  %\let\igt@key@matter\@empty
  \let\igtp@append\@gobbletwo
  \def\igt@setkeys##1{%
    \def\igt@trylist{\igt@try{}}%
    \@for\igt@b:=##1\do{%
      \begingroup
        \let\igt@a\relax
        \def\igt@try####1{%
          \noexpand\igt@try{####1\igt@a{\igt@b}}%
          \noexpand\igt@try{####1}}%
        \xdef\igt@trylist{\igt@trylist}%
      \endgroup}}%
  \igt@setkeys{page,numberless}% matter
  %
  \if@twoside
    \newcounter{igtp@side}%
    \newcount\igtp@side
    \def\igtp@theside{\ifodd\c@page o\else e\fi}%
    \def\igtp@append##1##2{%
     {\let\@elt\relax
      \expandafter\xdef\csname igtp@##1\endcsname{%
         \csname igtp@##1\endcsname\@elt ##2}}}%
    \def\igtp@write##1{%
      {\let\igtp@theside\relax
       \protected@write\@auxout{}%
         {\string\igtp@append{##1}{\igtp@theside}}}}%
    \def\igtp@fetch##1{%
       \stepcounter{igtp@side}%
       \global\advance\igtp@side\@ne
       \@whilenum\igtp@side<\c@igtp@side\do{%
          \expandafter\@next\expandafter\@tempa\csname igtp@##1\endcsname{}{}%
          \global\advance\igtp@side\@ne}%
       \expandafter\@next\expandafter\igt@b\csname igtp@##1\endcsname{%
          \xdef\igt@key@page{/\if\igt@b oodd\else even\fi}%
       }{%
          \xdef\igt@key@page{/\ifodd\c@page odd\else even\fi}%
       \@@warning{Unsynchronized `##1' title on page \thepage}}}%
  \else
    \let\igtp@write\@gobble
    \def\igtp@fetch##1{\gdef\igt@key@page{/odd}}%
  \fi}

%               +-----------------+
%               |   C O M P A T   |
%               +-----------------+
% Easy setup, i.e., that of package options, is
% taken care of, if necessary.

\renewcommand\secdef[2]{%
  \@ifstar
    {\igt@labelfalse
     #2}
    {\igt@labeltrue
     \ifx#1\@chapter
       \if@mainmatter\else\igt@labelfalse\fi
       \ifnum\igtl@chapter>\c@secnumdepth\igt@labelfalse\fi
     \else\ifx#1\@part
       \ifnum\igtl@part>\c@secnumdepth\igt@labelfalse\fi
     \fi\fi
     \let\ifigt@toclabel\ifigt@label
     \@dblarg{#1}}}
     
%               +-----------------+
%               |    loadonly     |
%               +-----------------+
% Easy setup, i.e., that of package options, is
% taken care of, if necessary.

\newtoks\loadclass@toks
\def\loadclasses{\the\loadclass@toks}
\loadclass@toks={
\newcommand\\igtlabel[1]{%
  \def\@seccntformat##1{#1}}

\expandafter\ifx\csname chapter\endcsname\relax

  \def\igt@compatpart{\igtclass{\part}{part}\relax}

\else

  \def\igt@compatchapter{%
    \def\@makechapterhead{%
      \igt@labeltrue
      \if@mainmatter\else\igt@labelfalse\fi
      \ifnum\igtl@chapter>\c@secnumdepth\igt@labelfalse\fi
      \igt@startargs\igt@mkchap{chapter}}%
    \def\@makeschapterhead{%
      \igt@labelfalse
      \if@mainmatter\else\igt@labelfalse\fi
      \ifnum\igtl@chapter>\c@secnumdepth\igt@labelfalse\fi
      \igt@startargs\igt@mkchap{chapter}}}

  \def\igt@compatpart{\igtclass{\part}{page}\relax}

\fi

\def\igt@@extract#1\@startsection#2#3#4#5#6#7#8{%
  \@tempskipa=#5
  \@tempskipb=#6
  \ifdim\@tempskipa<\z@
    \toks@{\igtspacing*#8{#4}}%
    \@tempskipa-\@tempskipa
  \else
    \toks@{\igtspacing#8{#4}}%
  \fi
  \@ifundefined{igt@space}{}{%
    \igt@assign\@tempskipa*\igt@space\relax\beforetitleunit}%
  \ifdim\@tempskipb<\z@
    \if@tempswa
      \igtformat#8[runin]%
         {\igt@fonts\igt@sizes{#3}}{\@seccntformat{#2}}%
         {\z@}\igt@passexplicit
    \else
      \igtformat#8[runin]%
         {#7}{\@seccntformat{#2}}%
         {\z@}\igt@passexplicit
    \fi
    \@tempskipb-\@tempskipb
  \else
    \if@tempswa
      \igtformat#8%
        {\igt@fil\igt@fonts\igt@sizes{#3}}{\@seccntformat{#2}}%
        {\z@}\igt@passexplicit 
    \else
      \igtformat#8%
        {#7}{\@seccntformat{#2}}%
        {\z@}\igt@passexplicit
    \fi
    \@ifundefined{igt@space}{}{%
      \igt@assign\@tempskipb*\igt@space\relax\aftertitleunit}%
  \fi
  \edef\igt@a{\the\toks@{\the\@tempskipa}{\the\@tempskipb}}
  \igt@a}

\def\igt@extract#1{%
  \ifx#1\@undefined
    \let#1\relax % Avoid error if undefined
  \fi
  \expandafter\in@\expandafter\@startsection\expandafter{#1}%
  \ifin@
    \expandafter\igt@@extract#1#1%
  \else
    \PackageWarningNoLine{igtitle}%
      {Non standard sectioning command \string#1\MessageBreak
       detected. Using default spacing and no format}%
    \igtspacing*#1{\z@}{*3}{*2}%
  \fi}

\@tempswafalse

\ifx\igt@fonts\@empty
  \def\igt@fonts{\bfseries}
\else
  \@tempswatrue
\fi

\expandafter\ifx\csname igt@sizes\endcsname\relax
  \gdef\igt@sizes#1{\ifcase#1\relax\Huge\or\Large\or\large
       \or\normalsize\or\or\or\huge\fi}
\else
  \@tempswatrue
\fi

\expandafter\ifx\csname igt@fil\endcsname\relax
  \let\igt@fil\@empty
\else
  \@tempswatrue
\fi

\expandafter\ifx\csname igt@case\endcsname\relax
  \let\igt@case\@firstofone
\else
  \@tempswatrue
\fi

\if@tempswa

  \expandafter\ifx\csname chapter\endcsname\relax\else
   \igtformat\chapter[display]%
    {\@ifundefined{igt@fil}{\raggedright}{\igt@fil}\igt@fonts\igt@sizes6}
    {\@chapapp\space\thechapter}{.8\baselineskip}{\igt@sizes\z@\igt@passexplicit}
  \fi

\fi

\igt@extract\section
\igt@extract\subsection
\igt@extract\subsubsection
\igt@extract\paragraph
\igt@extract\subparagraph

\let\igt@extract\@undefined
\let\igt@@extract\@undefined

\def\igt@toplevel{part}

\expandafter\ifx\csname chapter\endcsname\relax

  \@namedef{igtl@part}{0}
  \igtclass{\section}{straight}[\part]

  \igtspacing*{\part}
    {\z@}
    {4ex}
    {3ex}

\else

  \let\igt@save@mkchap\@makechapterhead
  \let\igt@save@mkschap\@makeschapterhead

  \def\@makechapterhead#1{%
    \gdef\igt@savemark{\chaptermark{#1}}%
    \igt@save@mkchap{#1}%
    \@ifundefined{igt@ps@chapter}{}%
      {\thispagestyle{\@nameuse{igt@ps@chapter}}}}

  \def\@makeschapterhead#1{%
    \gdef\igt@savemark{\chaptermark{#1}}%
    \igt@save@mkschap{#1}%
    \@ifundefined{igt@ps@chapter}{}%
      {\thispagestyle{\@nameuse{igt@ps@chapter}}}}

  \@namedef{igtl@part}{-1}
  \@namedef{igtss@part}{chapter}
  \@namedef{igtl@chapter}{0}
  \igtclass{\section}{straight}[\chapter]

% The following is unoperant, unless when \chapter / \part
% format is redefined

  \igtspacing*{\part}
    {\z@}
    {\z@\@plus1fil}
    {\z@\@plus1fil}
    
  \igtspacing*\chapter
    {\z@}%
    {50\p@}%
    {\igt@chapafter}%

\fi

\igtclass{\subsection}   {straight}[\section]
\igtclass{\subsubsection}{straight}[\subsection]
\igtclass{\paragraph}    {straight}[\subsubsection]
\igtclass{\subparagraph} {straight}[\paragraph]
}

\endinput

MIT License
-----------

Permission is hereby granted, free of charge, to any person obtaining a
copy of this software and associated documentation files (the
"Software"), to deal in the Software without restriction, including
without limitation the rights to use, copy, modify, merge, publish,
distribute, sublicense, and/or sell copies of the Software, and to
permit persons to whom the Software is furnished to do so, subject to
the following conditions:

The above copyright notice and this permission notice shall be included
in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY
CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,
TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.


