\def\filedate{2021/03/08}
\def\fileversion{v0.1alpha}
\def\fileauthor{Sadik Boujaida, based on the work of Javier Bezos}

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{cpgetitle}[\filedate\space\fileversion]




%%% Le code qui suit est une agrégation des trois packages 
%%% titlesec.sty, titleps.sty et titletoc.sty du même auteur.  
%%% Le but est de transformer l'interface de configuration (compliquée)
%%% en un système clé/valeur basé sur pgfkeys et de supprimer 
%%% les options inutiles dans le cadre du projet cpgedoc.
%%% Le nom de domaine ttl a été changé en cpget pour éviter les conflits.


%%% Copyright (C) 1998-2019 Javier Bezos http://www.texnia.com

%%% Notes
% ~~~~~
%
% The following tags are used:
% cpget@  : the generic tag used through the style
% cpgeth@ : a shape definition
% cpgetf@ : a macro containing the title format
% cpgets@ : id. the title space
% cpgetp@ : page key related macros
% cpgetl@ : level number
%
% The cpgetf@ and cpgets@ contains data in the form {..}{..}.
% Perhaps in future releases they should be converted
% to a prop-like list, similar to that proposed by the
% latex team.
%
% Admittedly, the current implementation seems too
% complicated, but that's necessary in order to provide
% certain compatibility with the sections as defined by the
% used class. Other packages opt for providing the sections
% as defined by standard classes ignoring the class; for
% instance sectsty which does a simple task in a simple and
% nice way. However, that was not my goal.
%
% Release
% ~~~~~~~

% Initialization
% ~~~~~~~~~~~~~~

\newif\ifcpget@ps
\cpget@psfalse

% The \cpget@label switch is used when printing the label in titles.
% A numberless variant makes it to true.
% There is a \cpget@toclabel as well, which is true iff the
% title is numbered; used in toc entries (except default part
% and chapter) and marks (only in cpgetitle pagestyles).

\newif\ifcpget@label
\newif\ifcpget@toclabel

\newbox\cpget@box

% A provision for the report style:

\@ifundefined{if@mainmatter}
  {\let\if@mainmatter\iftrue}{}

\@ifundefined{if@openright}
  {\let\if@openright\iftrue}{}

% and the ams styles as well

\@ifundefined{@chapapp}
  {\let\@chapapp\chaptername}{}

\def\cpget@trylist{\cpget@try{}}

\def\cpget@getkeys#1#2{%
  \if\expandafter @\@gobble#1@\@empty
    \edef\cpget@b{\expandafter\@gobble\string#1}%
    \let\cpget@a\cpget@b
  \else
    \cpget@keys
    \cpget@getkeys{#1}{#2}%
  \fi}

% A more meaningful error for \@notdefinable

\expandafter\AtEndOfPackage\expandafter{\expandafter
  \gdef\expandafter\@notdefinable\expandafter{\@notdefinable}}

\def\@notdefinable{%
  \PackageError{cpgetitle}%
    {Incompatible package}%
    {cpgetitle cannot continue defining its own macros 
         because\MessageBreak
     \@backslashchar\reserved@a\space is already used by other package,
         the class\MessageBreak
     or the document.}}

%               +-----------------+
%               |  C L A S S E S  |
%               +-----------------+

\def\cpget@useclass#1#2{%
  \@ifstar
    {\cpget@labelfalse#1{#2}[]}%
    {\cpget@labeltrue\@dblarg{#1{#2}}}}

\def\cpget@straightclass{\cpget@useclass\cpget@straight@i}
\def\cpget@partclass{\cpget@useclass\cpget@part@i}
\def\cpget@topclass{\cpget@useclass\cpget@top@i}
\def\cpget@pageclass{\cpget@useclass\cpget@page@i}

% Here \scantokens is used to make sure the unescaped name
% has `letters' and no `others'. Mainly for hyperref, so there
% should be no problems.

\newcommand\cpgetclass[1]{%
  \edef\cpget@a{\expandafter\@gobble\string#1}%
  \ifx\scantokens\@undefined\else
    \scantokens\expandafter{\expandafter
      \def\expandafter\cpget@a\expandafter{\cpget@a}}%
  \fi
  \@ifnextchar[{\@tempswatrue\cpget@class@i{#1}}%
               {\@tempswafalse\cpget@class@ii{#1}}}

\def\cpget@class@i#1[#2]{%
  \@namedef{cpgetl@\cpget@a}{#2}%
  \expandafter\providecommand\csname\cpget@a title\endcsname{}%%%%
  \@ifundefined{cpget@toplevel}{}%
    {\expandafter\let\csname cpgetss@\cpget@a\expandafter\endcsname
       \csname cpgetss@\cpget@toplevel\endcsname}%
  \edef\cpget@toplevel{\cpget@a}%
  \cpget@class@ii{#1}}

\def\cpget@class@ii#1#2{%
  \@ifundefined{cpget@#2class}%
    {\PackageError{cpgetitle}{Unknown sectioning class}%
       {Valid names are top, page and straight}}%
    {\expandafter\let\csname cpget@compat\cpget@a\endcsname\relax
     \@ifundefined{\cpget@a mark}%
       {\@namedef{\cpget@a mark}{\@gobble}}%
       {}%
     \edef#1{%
       \expandafter\noexpand\csname cpget@#2class\endcsname{\cpget@a}}}%
  \if@tempswa
    \expandafter\@gobble
  \else  
    \expandafter\@firstofone
  \fi
    {\@ifnextchar[%
       {\cpget@class@iii}%
       {\@ifundefined{cpgetl@\cpget@a}%
          {\PackageError{cpgetitle}{Unknown sectioning level}%
            {\string\cpgetclass\space with no optional arguments\MessageBreak
             only changes the class of an *existing* level}}}}}

\def\cpget@class@iii[#1]{%
  \edef\cpget@b{\expandafter\@gobble\string#1}%
  \expandafter\let\csname cpgetss@\cpget@a\expandafter\endcsname
     \csname cpgetss@\cpget@b\endcsname
  \expandafter\edef\csname cpgetss@\cpget@b\endcsname{\cpget@a}%
  \let\cpget@a\cpget@toplevel
  \count@\csname cpgetl@\cpget@toplevel\endcsname
  \cpget@class@iv}

\def\cpget@class@iv{%
  \@ifundefined{cpgetss@\cpget@a}{}%
    {\advance\count@\@ne
     \edef\cpget@a{\csname cpgetss@\cpget@a\endcsname}%
     \expandafter\edef\csname cpgetl@\cpget@a\endcsname{\the\count@}%
     \cpget@class@iv}}

% Typesetting Classes: General tools
% ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
% The following command handles the *n spacing
% Some tricks are necessary to multiply a
% skip by a non integer number

\newskip\beforetitleunit
\beforetitleunit=1ex\@plus.3ex\@minus.06ex
\newskip\aftertitleunit
\aftertitleunit=1ex\@plus.1ex

\newdimen\cpget@plus
\newdimen\cpget@minus

\def\cpget@assign#1{%
  \@ifstar
    {\cpget@assign@i{#1}}%
    {\cpget@assign@d{#1}}}

\def\cpget@assign@i#1#2\relax#3{%
  \cpget@plus\z@
  \cpget@minus\z@
  \afterassignment\cpget@assign@ii
  \dimen@\the#3, % <- space 
  #1 =     #2\dimen@
     plus  #2\cpget@plus
     minus #2\cpget@minus}

\def\cpget@assign@ii#1 {% <- space
  \if#1,\else\afterassignment\cpget@assign@ii\fi
  \csname cpget@\string#1\endcsname}

\def\cpget@assign@d#1#2\relax#3{\setlength#1{#2}}

% To be used with \v/vspace to make them calc-savvy

\def\cpget@calc#1#2{%
  {\setlength\@tempskipa{#2}%
   #1\@tempskipa}}
\def\cpge@calc#1#2{%
	\expandafter#1\expandafter{\dimexpr#2\relax}}

\def\cpget@calcneg#1#2{%
  {\setlength\@tempskipa{#2}%
   #1{-\@tempskipa}}}
\def\cpge@calcneg#1#2{%
	\expandafter#1\expandafter{\expandafter-\dimexpr#2\relax}}

% Gets from cpgets@ and passes the spacing parameters:

\def\cpget@startargs#1#2{% Get the first arguments, with the spacing
  \@ifundefined{cpgetp@#2}%
     {\let\cpget@key@page\@empty}%
     {\cpgetp@fetch{#2}}%
  \begingroup
    \def\cpget@b{cpgets@#2}%
    \edef\cpget@key@numberless{\ifcpget@label//\else/*\fi}%
    \def\cpget@a##1{\csname cpget@key@##1\endcsname}%  Used as elt in try
    \cpget@trylist
    \xdef\cpget@b{\cpget@c}%
  \endgroup
  \ifx\cpget@b\@empty
    \PackageError{cpgetitle}{Format/spacing not found}%
      {I was unable to find the format corresponding to #2.\MessageBreak
       Maybe you haven't set it with \string\cpgetformat\space and
       \string\cpgetspacing}
  \fi
  \expandafter#1\cpget@b{#2}}

% Used in cpget@select

\def\cpget@savefn#1[#2]#3{%
  \ifcase#1%
    \footnotemark[#2]%
    \gdef\cpget@fn{\footnotetext[#2]{#3}}%
  \else
    \footnotemark
    \gdef\cpget@fn{\footnotetext{#3}}%
  \fi}

\def\cpget@nest@error{%
  \PackageError{cpgetitle}{Nested titles}{Titles must not be nested}}

\def\cpget@hmode@error{%
  \PackageError{cpgetitle}{Entered in horizontal mode}
    {The <format> argument cannot contain horizontal material\MessageBreak
     such as text, \string\noindent, \string\makebox, etc.}}

% \cpget@select not only selects the right version to be
% used. It also take steps to ensure that a mark
% is not lost inside a box by saving it into \cpget@mk,
% which in turn is used by the sect and chap commands.

% As of 2019 and due the LaTex
% kernel modifies \markboth, we consider two possibilities (2.13).

\newif\ifcpget@explicit

\def\cpget@gmk#1{\gdef\cpget@mk{#1}}

\def\cpget@select#1#2#3#4{%
  \cpget@Hy@saveanchor
  \global\let\cpget@mk\@empty  % global because of rigidchapters
  \global\let\cpget@fn\@empty
  \begingroup
   \if@inlabel\else % Keep item's \everypar
      \everypar{\setbox\z@\lastbox\cpget@strut}%
   \fi
   \let\cpget@straight@i\cpget@nest@error
   \let\cpget@top@i     \cpget@nest@error
   \let\cpget@part@i    \cpget@nest@error
   \let\cpget@page@i    \cpget@nest@error
   \let\cpget@newpage\newpage
   \def\newpage{\cpget@savewrite\cpget@newpage}%
   \expandafter\ifx\csname markboth \endcsname\relax
     \def\markboth##1##2{\protect\cpget@gmk{\protect\markboth{##1}{##2}}}%
     \def\markright##1{\protect\cpget@gmk{\protect\markright{##1}}}%
   \else
     \@namedef{markboth }##1##2{\protect\cpget@gmk{\markboth{##1}{##2}}}%
     \@namedef{markright }##1{\protect\cpget@gmk{\markright{##1}}}%
   \fi
   \def\@mkboth##1##2{\protect\cpget@gmk{\protect\@mkboth{##1}{##2}}}%
   \def\footnote{\@ifnextchar[%
     {\cpget@savefn\z@}{\cpget@savefn\@ne[]}}%
   \edef\cpget@key@numberless{\ifcpget@label//\else/*\fi}%
   \def\cpget@b{cpgetf@#1}%
   \def\cpget@a##1{\csname cpget@key@##1\endcsname}% Used as elt in try
   \cpget@trylist
   \ifcpget@explicit
     \def\cpget@passexplicit{\cpget@case{#4}}% 
     \cpget@c{#4}{#2}{#3}{}% cpget@c is returned by cpget@try with cpgetf@...
   \else     
     \let\cpget@passexplicit\cpget@case
     \cpget@c{#2}{#3}{#4}% cpget@c is returned by cpget@try with cpgetf@...
   \fi
  \endgroup}

\let\cpget@savewrite\@empty

\def\cpget@finmarks{%
  \cpget@savewrite
  \cpget@mk  % Contains a possible mark, returned by \cpget@select
  \cpget@fn} % And a footnote

\def\cpget@try#1{%
  \edef\cpget@c{#1}%  #1 is a list in the form \cpget@a{key}\cpget@a{key}
  \@ifundefined{\cpget@b\cpget@c}{}{%
    \edef\cpget@c{\expandafter\noexpand\csname\cpget@b\cpget@c\endcsname}%
    \def\cpget@a##1{\csname cpget@extra@##1\endcsname}%
    #1%
    \let\cpget@try\@gobble}} % locally modified to `break' testings

% \cpget@write writes marks and toc. tocdepth is taken care of when
% the toc is typesetted and not here.  Used always through
% cpget@savewrite, which is reset to \@empty to avoid duplicated
% calls. 

\def\cpget@write#1#2{%
  \cpget@blinemarks
  \csname#1mark\endcsname{#2}%
  \def\cpget@a{\protect\numberline{\@nameuse{the#1}}}%
  \@nameuse{cpget@toc#1}% eg, \cpget@tocpart modifies \cpget@a
  \cpget@addcontentsline{#1}{#2}% Depends on toctitles, uses \cpget@a
  \cpget@elinemarks
  \global\cpget@toclabelfalse
  \global\let\cpget@savewrite\@empty}

\newif\ifcpget@premark % to be used in cpgeps.def
\cpget@premarkfalse

% 2019-06-20. Added the \lastskip stuff, because a mark 'forgets' the
% last skip.
  
\def\cpget@premark#1#2{%
  \let\cpget@lastskip\relax
  \ifvmode
    \ifdim\lastskip=\z@\else
      \edef\cpget@lastskip{\the\lastskip}% 
      \vskip-\cpget@lastskip\relax
    \fi
  \fi
  \protected@xdef\cpget@prevmarks{\cpget@marks}%
  \cpget@blinemarks
  \csname#1mark\endcsname{#2}%
  \cpget@elinemarks
  \ifx\cpget@lastskip\relax\else
    \vskip\cpget@lastskip\relax
  \fi
  \gdef\cpget@prevmarks{\cpget@marks}}

% Must be preceded by a default \cpget@savewrite, which is used
% in starred variants--\@empty in top and straight classes.
% In straight class, it is preceded by the setting of
% prev marks to provide a "fixed" top mark. Otherwise,
% the default prev mark (= curr mark) is used (restored
% after cpget@labelling in straight). This is the command
% to be hacked if you want to change the behaviour of
% starred variants.

\def\cpget@labelling#1#2{%
  \let\cpget@Hy@saveanchor\@empty
  \ifcpget@label  %  1st - if star
    \def\cpget@savewrite{\cpget@write{#1}{#2}}%
    \@nameuse{cpget@#1label}%  eg, sets if mainmatter in chapter.
    \ifcpget@label  % 2nd - eg, if not main matter
      \ifnum\@nameuse{cpgetl@#1}>\c@secnumdepth\relax
        \cpget@labelfalse     % 3rd - if too deep
      \else
        \cpget@Hy@refstepcounter{#1}%
        \@nameuse{cpget@#1out}%
      \fi
    \fi
  \fi
  \let\ifcpget@toclabel\ifcpget@label
  \ifx\cpget@savewrite\@empty\else % If marks
    \ifcpget@ps
      \ifcpget@premark
        \global\cpget@premarkfalse
      \else % if no \cpgetpretitlemark
        \cpget@premark{#1}{#2}%
      \fi
    \fi
    \ifcpget@label\else\cpget@Hy@steplink{#1}\fi
  \fi}

% Executed by cpget@labelling if the name of section is chapter:

\def\cpget@chapterlabel{\if@mainmatter\else\cpget@labelfalse\fi}

% Executed by cpget@labelling if chapter has a number. Note
% you can define messages for other sectioning levels (eg,
% \cpget@sectionout).

\def\cpget@chapterout{\typeout{\chaptertitlename\space\thechapter.}}

% Straight class
% ~~~~~~~~~~~~~
% Default for nobottomtitles. Changed by nobottomtitles*

\def\cpget@addstretch{\advance\@tempskipa-\pagestretch}

% 1:name 2:level 3:indent 4:before 5:after 6:afind [7]:cap 8:title
% The second argument of cpget@sect is the level, which
% is empty if the star version is used. In this case
% neither the toc nor the marks are written.

\def\cpget@straight@i#1[#2]#3{%
  \def\@currentlabelname{#2}% for nameref
  \gdef\cpget@savemark{\csname#1mark\endcsname{#3}}%
  \let\cpget@savewrite\@empty
  \def\cpget@savetitle{#3}%
  \gdef\thetitle{\csname the#1\endcsname}%
  \if@noskipsec \leavevmode \fi
  \par
  \cpget@labelling{#1}{#2}%
  \cpget@startargs\cpget@straight@ii{#1}{#3}}

% 1:left 2:right 3:before 4:after 5:afterindent 6:name 7:title

\def\cpget@straight@ii#1#2#3#4#5#6#7{%
  \cpget@assign\@tempskipa#3\relax\beforetitleunit
  \@ifundefined{cpget@ps@#6}{}%
    {\PackageWarning{cpgetitle}{Page style in straight class ignored}}%
  \if@nobreak
    \cpget@titlespace{\@tempskipa}%
  \else
    \@ifundefined{#6break}%
      {\addpenalty{\@secpenalty}}%
      {\csname#6break\endcsname}%
    \addvspace{\@tempskipa}%
    \ifdim\bottomtitlespace<\z@
    \else
      \begingroup
       \@tempskipb\pagegoal
       \@tempskipa\pagegoal
       \cpget@addstretch  % \relax if nobottomtitle*
       \advance\@tempskipa-\bottomtitlespace\relax % not a register
       \pagegoal\@tempskipa
       \def\@textbottom{\vskip\z@\@plus.0001fil}%
       \penalty9999
       \pagegoal\@tempskipb
      \endgroup
    \fi
  \fi
  \@afterindenttrue
  \ifcase#5 \@afterindentfalse\fi
  \cpget@assign\@tempskipb#4\relax\aftertitleunit
  \cpget@select{#6}{#1}{#2}{#7}%
  \cpget@finmarks
  \@ifundefined{cpgetp@#6}{}{\cpgetp@write{#6}}%
  \if@noskipsec
    \global\@nobreakfalse
    \everypar{%
      \if@noskipsec
        \global\@noskipsecfalse
        \clubpenalty\@M
        \hskip-\parindent
        \begingroup
          \@svsechd\unskip{\hspace{\@tempskipb}}%
        \endgroup
      \else
        \clubpenalty\@clubpenalty\everypar{}%
      \fi}%
  \else
    \par\nobreak
    \vspace{\@tempskipb}%
    \@afterheading
  \fi
  \ignorespaces}

% Part class
% ~~~~~~~~~~

\providecommand\partmark[1]{\markboth{}{}}

\def\cpget@part@i#1[#2]#3{%
  \gdef\cpget@savemark{\csname#1mark\endcsname{#3}}%
  \ifx\cpget@notocparts\@undefined
    \def\cpget@savewrite{\cpget@write{#1}{#3}}% Not #2!
  \else
    \let\cpget@savewrite\@empty
  \fi
  \def\cpget@savetitle{#3}%
  \cpget@labelling{#1}{#2}%
  \cpget@startargs\cpget@part@ii{#1}{#3}}

\def\cpget@part@ii#1#2#3#4#5#6#7{%
  \cpget@assign\@tempskipa#3\relax\beforetitleunit
  \vspace*{\@tempskipa}%
  \@ifundefined{cpget@ps@#6}{}%
    {\PackageWarning{cpgetitle}{Page style in part class ignored}}%
  \global\@afterindenttrue
  \ifcase#5 \global\@afterindentfalse \fi
  \cpget@assign\@tempskipb#4\relax\aftertitleunit 
  \cpget@select{#6}{#1}{#2}{#7}%
  \cpget@finmarks
  \@ifundefined{cpgetp@#6}{}{\cpgetp@write{#6}}%
  \par\nobreak
  \vspace{\@tempskipb}%
  \@afterheading}

% Page class
% ~~~~~~~~~~

\def\cpget@page@i#1[#2]#3{%
  \gdef\cpget@savemark{\csname#1mark\endcsname{#3}}%
  \ifx\cpget@notocparts\@undefined
    \def\cpget@savewrite{\cpget@write{#1}{#3}}% Not #2!
  \else
    \let\cpget@savewrite\@empty
  \fi
  \def\cpget@savetitle{#3}%
  \cpget@labelling{#1}{#2}%
  \cpget@startargs\cpget@page@ii{#1}{#3}}

\def\cpget@page@ii#1#2#3#4#5#6#7{%
  \cpget@assign\@tempskipa#3\relax\beforetitleunit
  \if@openright
    \cleardoublepage
  \else
    \clearpage
  \fi
  \@ifundefined{cpget@ps@#6}%
    {\thispagestyle{plain}}%
    {\thispagestyle{\@nameuse{cpget@ps@#6}}}%
  \if@twocolumn
    \onecolumn
    \@tempswatrue
  \else
    \@tempswafalse
  \fi
  \vspace*{\@tempskipa}%
  \@afterindenttrue
  \ifcase#5 \@afterindentfalse\fi
  \cpget@assign\@tempskipb#4\relax\aftertitleunit
  \cpget@select{#6}{#1}{#2}{#7}%
  \cpget@finmarks
  \@ifundefined{cpgetp@#6}{}{\cpgetp@write{#6}}%
  \vspace{\@tempskipb}%
  \newpage
  \if@twoside
    \if@openright
      \null
      \@ifundefined{cpget@ps@#6}%
        {\thispagestyle{empty}}%
        {\thispagestyle{\@nameuse{cpget@ps@#6}}}%
      \newpage
    \fi
  \fi
  \if@tempswa
    \twocolumn
  \fi
  \ignorespaces}

% Top class and some makechapterhead stuff
% ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
%
% \cpget@mkchap is the new make(s)chapterhead.

\def\cpget@mkchap#1#2#3#4#5#6#7{%
  \gdef\cpget@savemark{\csname#6mark\endcsname{#7}}%
  \let\cpget@savewrite\@empty
  \let\cpget@Hy@saveanchor\@empty
  \@ifundefined{cpget@ps@#6}{}%
    {\thispagestyle{\@nameuse{cpget@ps@#6}}}%
  \let\ifcpget@toclabel\ifcpget@label
  \cpget@mkchap@i{#1}{#2}{#3}{#4}{#5}{#6}{#7}}

% But \cpget@mkchap@i is used by both makechapterhead and
% the top class.

\def\cpget@mkchap@i#1#2#3#4#5#6#7{%
  \cpget@assign\@tempskipa#3\relax\beforetitleunit
  \vspace*{\@tempskipa}%
  \global\@afterindenttrue
  \ifcase#5 \global\@afterindentfalse\fi
  \cpget@assign\@tempskipb#4\relax\aftertitleunit
  \cpget@topmode{\@tempskipb}{%
    \cpget@select{#6}{#1}{#2}{#7}}%
  \cpget@finmarks  % Outside the box!
  \@ifundefined{cpgetp@#6}{}{\cpgetp@write{#6}}}

\def\cpget@top@i#1[#2]#3{%
  \gdef\cpget@savemark{\csname#1mark\endcsname{#3}}%
  \let\cpget@savewrite\@empty
  \def\cpget@savetitle{#3}%
  \cpget@labelling{#1}{#2}%
  \cpget@startargs\cpget@top@ii{#1}{#3}}

\def\cpget@top@ii#1#2#3#4#5#6#7{%
  \@ifundefined{#6break}%
    {\if@openright
       \cleardoublepage
     \else
       \clearpage
     \fi}%
    {\csname#6break\endcsname}%
  \@ifundefined{cpget@ps@#6}%
    {\thispagestyle{plain}}%
    {\thispagestyle{\@nameuse{cpget@ps@#6}}}%
  \global\@topnum\z@
  \@ifundefined{#6tolists}%
    {\addtocontents{lof}{\protect\cpget@tocsep}%
     \addtocontents{lot}{\protect\cpget@tocsep}}
    {\@nameuse{#6tolists}}%
  \if@twocolumn
    \@topnewpage[\cpget@mkchap@i{#1}{#2}{#3}{#4}{#5}{#6}{#7}]%
  \else
    \cpget@mkchap@i{#1}{#2}{#3}{#4}{#5}{#6}{#7}%
    \@afterheading
  \fi
  \ignorespaces}

%     \def\cpget@noskipsectrue{%
%       \if@noskipsec
%     \PackageError{cpgetitle}{Invalid shape for top class}%
%        {The selected shape only makes sense when merged into\MessageBreak
%         a paragraph. That is impossible in the top class}%
%   \else

\newcommand\chaptertitlename{\@chapapp}
\def\cpget@tocsep{\addvspace{10\p@}}

%               +-----------------+
%               |   S H A P E S   |
%               +-----------------+
%               
% Reformatting Titles: Interface
% ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

% The surrounding space is stored in a macro
% named \cpgets@<section> whose content is
% {left}{right}{before}{after}{afterindent}.
% But if there is the page key, the name is
% \cpgets@<section>/<page>

\newcommand\cpgetspacing{%
  \@ifstar{\cpget@spacing@i{\z@}}{\cpget@spacing@i{\@ne}}}

\def\cpget@spacing@i#1#2#3#4#5{%
  \cpget@getkeys{#2}{cpgetitle}%
  \@ifnextchar[{%
     \cpget@spacing@ii{#1}{#3}{#4}{#5}%
   }{%
     \cpget@spacing@ii{#1}{#3}{#4}{#5}[\z@]}}

\def\cpget@spacing@ii#1#2#3#4[#5]{%
   \expandafter\def\csname cpgets@\cpget@a\endcsname
       {{#2}{#5}{#3}{#4}{#1}}}

% The section name is built in \cpget@a.
% The format is stored in a macro named \cpgetf@<section>,
% or \cpgetf@<section>/<page> if there is the page spec,
% or \cpgetf@.../* if numberless is true
% whose content is
%  \cpget@<shape>{format}{label}{sep}{before}{after}

\newtoks\cpget@toksa

\newcommand\cpgetformat{%
  \@ifstar{\cpget@format@s}%
          {\cpget@format@i}}

\def\cpget@format@s#1#2{%
  \edef\cpget@a{\expandafter\@gobble\string#1}%
  \@ifundefined{cpgetf@\cpget@a}%
    {\PackageError{cpgetitle}{Not allowed in `easy' settings}
       {The sectiong command you are trying to redefine\MessageBreak
        is not handled by the starred variant (eg, \string\part)}}{}
  \expandafter\expandafter\expandafter
  \cpget@format@si\csname cpgetf@\cpget@a \endcsname
  {#2}}

\def\cpget@format@si#1#2#3#4#5#6#7{%
  \@namedef{cpgetf@\cpget@a}{#1{#7}{#3}{#4}{#5}{#6}}}

\def\cpget@format@i#1{%
  \@ifnextchar[{\cpget@format@ii{#1}}{\cpget@format@ii{#1}[hang]}}

\def\cpget@format@ii#1[#2]#3#4#5#6{%
  \cpget@getkeys{#1}{cpgetitle}%
  \cpget@toksa{{#3}{#4}{#5}{#6}}% Save  arguments
  \@ifnextchar[{%
    \cpget@format@iii{#2}%
  }{%
    \cpget@format@iii{#2}[]}}

% First, we get the shape -- if not defined it loads
% the corresponding file.

\def\cpget@format@iii#1[#2]{%
  \@ifundefined{cpgeth@#1}{%
    \begingroup
    \makeatletter
    \InputIfFileExists{#1.tss}{}{%
      \@ifundefined{cpgethx@#1}%
        {\PackageError{cpgetitle}{Unknown shape}%
           {Shapes are defined in files with extension tss\MessageBreak
            Either you have misspelled the shape\MessageBreak
            or there is no a #1.tss file}}%
        {\global\expandafter
         \let\csname cpgeth@#1\expandafter\endcsname
           \csname cpgethx@#1\endcsname}}%
    \endgroup}{}%
  \@temptokena{#2}%
  \ifcpget@explicit
    \edef\cpget@b{%
      \def\expandafter\noexpand\csname cpgetf@\cpget@a\endcsname####1%
      {\expandafter\noexpand\csname cpgeth@#1\endcsname
       \the\cpget@toksa{\the\@temptokena}}}%
  \else
    \edef\cpget@b{%
      \def\expandafter\noexpand\csname cpgetf@\cpget@a\endcsname
      {\expandafter\noexpand\csname cpgeth@#1\endcsname
       \the\cpget@toksa{\the\@temptokena}}}%
  \fi
  \cpget@b
  \csname cpget@compat\cpget@a\endcsname}

% Styles
% ~~~~~~

% 1:global 2:label 3:sep 4:style 5:after 6:left 7:right 8:title
% \cpget@<shape> and \cpgeth@<shape> take the following eight
% arguments:
% {format}{label}{sep}{before}{after}{left}{right}{title}
% where before and after refer to the format.
% With the option explicit, #4 contains the title and #8 is
% empty.

\def\cpget@strut{\strut}

\def\cpgeth@display#1#2#3#4#5#6#7#8{%
  \gdef\cpget@makeline##1{\cpge@calc\hspace{#6}##1\cpge@calc\hspace{#7}}%
  \setlength\leftskip{#6}%
  \setlength\rightskip{#7}%
  \interlinepenalty\@M
  \cpget@changecentercr
  \cpget@defnostruts
  \cpget@beginlongest
    #1\ifhmode\cpget@hmode@error\fi
    \cpget@glcmds
    \parindent\z@
    \ifcpget@label
      {#2\cpget@strut\@@par}\nobreak\cpge@calc\vspace{#3}%
    \fi
    #4{#8}%
   \kern\z@\cpget@strut\@@par
   \nobreak\cpget@midlongest#5\@@par
  \cpget@endlongest}

\def\cpgeth@hang#1#2#3#4#5#6#7#8{%
  \gdef\cpget@makeline##1{\cpge@calc\hspace{#6}##1\cpge@calc\hspace{#7}}%
  \setlength\leftskip{#6}%
  \setlength\rightskip{#7}%
  \interlinepenalty\@M
  \cpget@changecentercr
  \cpget@defnostruts
  \cpget@beginlongest
  #1{\ifhmode\cpget@hmode@error\fi
     \cpget@glcmds
     \parindent\z@
     \begingroup
       \ifcpget@label
          \noindent
          \sbox\z@{#2\cpget@strut\cpge@calc\hspace{#3}}%
          \hangindent\wd\z@
          \box\z@
       \fi
       #4{#8}%
       \kern\z@\cpget@strut\@@par
     \endgroup
     \nobreak\cpget@midlongest#5\@@par}%
  \cpget@endlongest}

\def\cpgeth@runin#1#2#3#4#5#6#7#8{%
  \global\@noskipsectrue
  \gdef\cpget@makeline##1{##1}%
  \cpget@changecentercr
  \cpget@defnostruts
  #1{\ifhmode\cpget@hmode@error\fi
     \global\sbox\cpget@box{%
       \cpge@calc\hspace{#6}%
       \ifcpget@label{\cpget@strut#2}\cpge@calc\hspace{#3}\fi
       #4{#8}#5\unskip}}%
    \gdef\@svsechd{\unhbox\cpget@box}}

% ----------

\gdef\cpgethx@block#1#2#3#4#5#6#7#8{%
  \gdef\cpget@makeline##1{\cpge@calc\hspace{#6}##1\cpge@calc\hspace{#7}}%
  \setlength\leftskip{#6}%
  \setlength\rightskip{#7}%
  \interlinepenalty\@M
  \cpget@changecentercr
  \cpget@defnostruts
  \cpget@beginlongest
    #1% \ifhmode\cpget@hmode@error\fi
    \cpget@glcmds
    \parindent\z@
    \leavevmode
    \ifcpget@label
       {#2}%
       \setlength\@tempskipa{#3}%
       \ifdim\@tempskipa=\z@\else\cpge@calc\hspace{#3}\fi
    \fi
    #4{#8}%
    \kern\z@\cpget@strut\@@par
    \nobreak\cpget@midlongest#5\@@par
  \cpget@endlongest}
  

\gdef\cpgethx@frame#1#2#3#4#5#6#7#8{%
  \def\cpget@filleft##1{\hfill}%
  \def\cpget@filright##1{\hfill}%
  \gdef\cpget@makeline##1{%
    \cpge@calc\hspace{#6}##1\cpge@calc\hspace{#7}}%
  \interlinepenalty\@M
  \cpget@changecentercr
  \cpget@defnostruts
  #1\ifhmode\cpget@hmode@error\fi
  \parindent\z@
  \leavevmode
  \@tempdima\fboxrule
  \addtolength\@tempdima{#3}%
  \setlength\leftskip{#6}%
  \setlength\rightskip{#7}%
  \lower\@tempdima\hbox{%
    \everypar{}%
    \setbox\z@\hbox{#2}%  
    \addtolength\hsize{-#6}%
    \addtolength\hsize{-#7}%
    \@tempdima\dp\z@ %  2002/3/22
    \advance\@tempdima.5\ht\z@
    \vbox{%
        \hbox to \hsize{%
          \leaders\hrule\@height\fboxrule\cpget@filleft{#3}%
          \ifcpget@label\lower.5\ht\z@\box\z@\fi
          \leaders\hrule\@height\fboxrule\cpget@filright{#3}}%
        \vskip-\lineskip
        \ifcpget@label\vskip-\@tempdima\fi
        \hbox{%
          \vrule\@width\fboxrule
          \kern-\fboxrule
          \vbox{%
             \cpge@calc\vspace{#3}%
             \leavevmode
	         \addtolength\leftskip {#3}\addtolength\leftskip{-#6}%
	         \addtolength\rightskip{#3}\addtolength\rightskip{-#7}%
	         \cpget@strut#4{#8}\kern\z@\cpget@strut\@@par
             \cpge@calc\vspace{#3}}%
          \kern-\fboxrule
          \vrule\@width\fboxrule}%
       \hrule\@height\fboxrule}}%
	   \@@par\nobreak#5\@@par}

\gdef\cpgethx@leftmargin#1#2#3#4#5#6#7#8{%
  \global\@noskipsectrue
  \addtolength\@tempskipb{#6}%
  \xdef\cpget@makeline##1{\hskip-\the\@tempskipb\relax##1}%
  \leftskip\z@skip
  \rightskip\z@skip
  \cpget@changecentercr
  \cpget@defnostruts
  #1\ifhmode\cpget@hmode@error\fi
  \parindent\z@
  \global\setbox\cpget@box\vtop{%
    \setlength\hsize{#6}%
    \linewidth\hsize
    \everypar{}%
    \color@begingroup
    \ifcpget@label{\cpget@strut#2\cpget@strut}\cpge@calc\hspace{#3}\fi
	   \cpget@strut#4{#8}\kern\z@\cpget@strut\@@par
    \color@endgroup}%
  \advance\@tempskipa\ht\cpget@box
  \advance\@tempskipa\dp\cpget@box
  \advance\@tempskipa-\pagegoal
  \advance\@tempskipa\pagestretch
  \@tempskipb\pagegoal
  \pagegoal-\@tempskipa
  \ifdim\bottomtitlespace<\z@\else
    \def\@textbottom{\vskip\z@\@plus.0001fil}%
  \fi
  \penalty9999
  \pagegoal\@tempskipb
  \dp\cpget@box=\z@
  \gdef\@svsechd##1##2{%   
    \llap{\box\cpget@box##2}%
    \if@afterindent\hskip\parindent\fi
    #5}}

\let\cpgethx@margin\cpgethx@leftmargin

\gdef\cpgethx@rightmargin#1#2#3#4#5#6#7#8{%
  \global\@noskipsectrue
  \addtolength\@tempskipb{#6}%
  \xdef\cpget@makeline##1{##1\hskip-\the\@tempskipb}%
  \leftskip\z@skip
  \rightskip\z@skip
  \cpget@changecentercr
  \cpget@defnostruts
  #1\ifhmode\cpget@hmode@error\fi
  \parindent\z@
  \global\setbox\cpget@box\vtop{%
     \setlength\hsize{#6}%
     \linewidth\hsize
     \everypar{}%
     \color@begingroup
     \ifcpget@label{\cpget@strut#2\cpget@strut}\cpge@calc\hspace{#3}\fi
	    \cpget@strut#4{#8}\kern\z@\cpget@strut\@@par
     \color@endgroup}%
  \advance\@tempskipa\ht\cpget@box
  \advance\@tempskipa\dp\cpget@box
  \advance\@tempskipa-\pagegoal
  \advance\@tempskipa\pagestretch
  \@tempskipb\pagegoal
  \pagegoal-\@tempskipa
  \ifdim\bottomtitlespace<\z@\else
    \def\@textbottom{\vskip\z@\@plus.0001fil}%
  \fi
  \penalty9999
  \pagegoal\@tempskipb
  \dp\cpget@box=\z@  
  \gdef\@svsechd##1##2{%
    \rlap{\hskip\textwidth##2\box\cpget@box}%
    \if@afterindent\hskip\parindent\fi}}

\gdef\cpgethx@wrap#1#2#3#4#5#6#7#8{%
  \global\@noskipsectrue
  \gdef\cpget@makeline##1{##1}%
  \cpget@changecentercr
  \cpget@defnostruts
  \begingroup
    #1\ifhmode\cpget@hmode@error\fi
    \cpgetwidth\z@
    \def\\{\@ifstar{\@ifnextchar[{\cpget@bs}{\newline}}%
                   {\@ifnextchar[{\cpget@bs}{\newline}}}%
    \def\cpget@bs[##1]{\newline}%
    \let\@centercr\\%
    \advance\rightskip 1\leftskip plus 1fil
    \leftskip=\z@
    \parindent\z@
    \let\ifcpgettitlemeasuring\@firstoftwo
    \global\setbox\cpget@box\vtop{\setlength\hsize{#6}%
      \color@begingroup
      \ifcpget@label{#2}\cpge@calc\hspace{#3}\fi
      #4{#8}\kern\z@\cpget@strut
      \@@par
      \color@endgroup}%
    \let\ifcpgettitlemeasuring\@secondoftwo
    \cpget@boxprocess
    \global\cpgetwidth\cpgetwidth
    \global\cpgetwidthfirst\cpgetwidthfirst
    \global\cpgetwidthlast\cpgetwidthlast
  \endgroup
  \edef\cpget@maxdimen{\the\cpgetwidth}%
  #1\ifhmode\cpget@hmode@error\fi
  \global\setbox\cpget@box\vtop{\setlength\hsize{\cpget@maxdimen}%
    \color@begingroup
    \ifcpget@label{#2}\cpge@calc\hspace{#3}\fi#4{#8}\kern\z@\cpget@strut
    \@@par
    \color@endgroup}%
  \advance\@tempskipa1.5\baselineskip
  \advance\@tempskipa\ht\cpget@box
  \advance\@tempskipa\dp\cpget@box
  \advance\@tempskipa-\pagegoal
  \advance\@tempskipa\pagestretch
  \@tempskipb\pagegoal
  \pagegoal-\@tempskipa
  \ifdim\bottomtitlespace<\z@\else
    \def\@textbottom{\vskip\z@\@plus.0001fil}%
  \fi
  \penalty9999
  \pagegoal\@tempskipb
  \@tempdima\ht\cpget@box \advance\@tempdima\dp\cpget@box
  \@tempdimb\@tempdima
  \divide\@tempdima\baselineskip \count@\@tempdima
  \advance\count@
    \ifdim\@tempdimb<\the\count@.5\baselineskip\@ne\else\tw@\fi
  \dp\cpget@box=\z@
  \xdef\@svsechd##1##2{%
    \noexpand\llap{\box\cpget@box##2}%
    \setbox\z@\hbox{\hskip\cpget@maxdimen\relax##2}%
    \global\hangindent\wd\z@
    \global\hangafter-\the\count@\relax}}

\gdef\cpgethx@drop#1#2#3#4#5#6#7#8{%
  \global\@noskipsectrue
  \gdef\cpget@makeline##1{##1}%
  \cpget@changecentercr
  \cpget@defnostruts
  #1\ifhmode\cpget@hmode@error\fi
  \parindent\z@
  \global\setbox\cpget@box\vtop{\setlength\hsize{#6}%
    \color@begingroup
    \ifcpget@label{#2}\cpge@calc\hspace{#3}\fi
    #4{#8}\kern\z@\cpget@strut
    \@@par
    \color@endgroup}%
  \advance\@tempskipa1.5\baselineskip
  \advance\@tempskipa\ht\cpget@box
  \advance\@tempskipa\dp\cpget@box
  \advance\@tempskipa-\pagegoal
  \advance\@tempskipa\pagestretch
  \@tempskipb\pagegoal
  \pagegoal-\@tempskipa
  \ifdim\bottomtitlespace<\z@\else
    \def\@textbottom{\vskip\z@\@plus.0001fil}%
  \fi
  \penalty9999
  \pagegoal\@tempskipb
  \@tempdima\ht\cpget@box \advance\@tempdima\dp\cpget@box
  \@tempdimb\@tempdima
  \divide\@tempdima\baselineskip \count@\@tempdima
  \advance\count@
  \ifdim\@tempdimb<\the\count@.5\baselineskip\@ne\else\tw@\fi
  \dp\cpget@box=\z@
  \xdef\@svsechd##1##2{%
    \noexpand\llap{\box\cpget@box##2}%
    \setbox\z@\hbox{\noexpand\cpge@calc\noexpand\hspace{#6}\relax##2}%
    \global\hangindent\wd\z@
    \global\hangafter-\the\count@\relax}}

%               +-----------------+
%               |    T O O L S    |
%               +-----------------+
%
% calcwidth
% ~~~~~~~~~
% Implemented after code from soul (but much modified...)

\newdimen\cpgetwidth
\newdimen\cpgetwidthlast
\newdimen\cpgetwidthfirst

\let\cpget@glcmds\relax
\let\cpget@beginlongest\@empty
\let\cpget@midlongest\@empty
\let\cpget@endlongest\@empty
\let\ifcpgettitlemeasuring\@secondoftwo

\def\cpget@xbeginlongest#1\cpget@endlongest{%
  \cpgetwidth\z@
  \cpgetwidthlast\z@
  \let\ifcpgettitlemeasuring\@firstoftwo
  \setbox\cpget@box\vbox{%
    \def\cpget@glcmds{%
      \def\\{\@ifstar{\@ifnextchar[{\cpget@bs}{\newline}}%
                     {\@ifnextchar[{\cpget@bs}{\newline}}}%
      \def\cpget@bs[####1]{\newline}%
      \let\@centercr\\%
      \def\cpget@midlongest####1\@@par{}% Very dirty...
      \advance\rightskip 1\leftskip plus 1fil
      \leftskip=\z@}%
    #1}%
  \let\ifcpgettitlemeasuring\@secondoftwo
  \cpget@boxprocess
  #1}

\def\cpget@boxprocess{%
  \setbox\cpget@box=\vbox{%
    \unvcopy\cpget@box
    \unskip\unpenalty
    \global\setbox\@ne=\lastbox}%
  \ifvoid\@ne
  \else
    \setbox\tw@=\hbox{\hskip-\leftskip\unhbox\@ne\hskip-\rightskip}%
    \cpgetwidthfirst\wd\tw@
    \ifdim\cpgetwidth<\cpgetwidthfirst
	  \cpgetwidth\cpgetwidthfirst
	\fi
    \ifdim\cpgetwidthlast=\z@
      \cpgetwidthlast\cpgetwidthfirst
    \fi
    \expandafter\cpget@boxprocess
  \fi}

% Rules
% ~~~~~

\providecommand\cpgetline{%
  \@ifstar{\cpget@line@i{\hb@xt@\cpgetwidth}}%
          {\cpget@line@i{}}}

\def\cpget@line@i#1{%
  \@ifnextchar[{\cpget@line{#1}}{\cpget@line{#1}[s]}}

\def\cpget@line#1[#2]#3{%
  \vskip\topskip
  \hrule \@height \z@
  \nobreak
  \vskip-\topskip
  \begingroup
    \parindent\z@
    \everypar{}%
    \leftskip\z@
    \rightskip\z@   %  #1 is either \hb@xt@\cpgetwidth or empty:
    \@makebox[\hsize][#2]{\cpget@makeline{#1{#3}}}%
    \par
  \endgroup
  \hrule height \z@
  \nobreak}

\providecommand\cpgetrule{\@ifstar{\cpget@row}{\cpget@rule}}

\let\cpget@leaders\xleaders % For cpgetitle compatibility

\def\cpget@row{\@ifnextchar[{\cpget@row@i}{\cpget@row@i[\wd\z@]}}
\def\cpget@row@i[#1]#2{%
  \ifvmode\expandafter\cpgetline\fi
  {\sbox\z@{#2}%
   \cpge@calcneg\hspace{#1}%
   \hskip\wd\z@
   \cpget@leaders\hb@xt@#1{\hss\box\z@}%
   \hfill\kern\z@}}

\def\cpget@rule{\@ifnextchar[{\cpget@rule@i}{\cpget@rule@i[.4\p@]}}
\def\cpget@rule@i[#1]{%
  \ifvmode\expandafter\cpgetline\fi
  {\leaders\hrule height #1\hfill\kern\z@}}

% Par shapes and space
% ~~~~~~~~~~~~~~~~~~~~

\providecommand\filright{%
  \gdef\cpget@filleft##1{\hskip##1}%
  \gdef\cpget@filright##1{\hfill}%
  \let\\\@centercr
  \advance\rightskip\z@ \@plus 1fil\relax}
\providecommand\filleft{%
  \gdef\cpget@filleft##1{\hfill}%
  \gdef\cpget@filright##1{\hskip##1}%
  \let\\\@centercr
  \advance\leftskip\z@ \@plus 1fil
  \parfillskip\z@}
\providecommand\filcenter{\filleft\filright
  \gdef\cpget@filleft##1{\hfill}}
\providecommand\fillast{%
  \gdef\cpget@filleft##1{\hfill}%
  \gdef\cpget@filright##1{\hfill}%
  \let\\\@centercr
  \filleft\advance\rightskip\z@ \@plus -1fil
  \parfillskip\z@ \@plus 2fil\relax}
\providecommand\filinner{%
  \if@twoside
    \ifodd\count\z@\filleft\else\filright\fi
  \else
    \filleft
  \fi}
\providecommand\filouter{%
  \if@twoside
    \ifodd\count\z@\filright\else\filleft\fi
  \else
    \filright
  \fi}

\newcommand\cpgetwordsep{\fontdimen\tw@\font \@plus
  \fontdimen\thr@@\font \@minus \fontdimen4\font}

% Struts.
% ~~~~~~
% A way to remove the struts added by styles. May be redefined below
% with option nostruts.

\def\cpget@defnostruts{\def\nostruts{\let\cpget@strut\@empty}}

%               +-----------------+
%               |  O P T I O N S  |
%               +-----------------+

\let\sectiontitle\@empty
\DeclareOption{extramarks}{\let\cpget@fetchmark\@empty}
\DeclareOption{floatps}{%
  \ifx\sectiontitle\@empty
    \let\cpget@replace\space
  \else
    \PackageWarning{cpgetitle}{Ignoring `floatps' without 
      `pagestyles'. This option is now deprecated.}%
  \fi}
\DeclareOption{psfloats}{%
  \ifx\sectiontitle\@empty
    \let\cpget@replace\@empty
  \else
    \PackageWarning{cpgetitle}{Ignoring `psfloats' without 
      `pagestyles'}%
  \fi}

\DeclareOption{outermarks}{%
  \def\cpget@titlemarks{\cpgetoutertitlemarks}}
\DeclareOption{topmarks}{
  \def\cpget@titlemarks{\cpgettoptitlemarks}}
\DeclareOption{botmarks}{%
  \def\cpget@titlemarks{\cpgetbottitlemarks}}
\DeclareOption{innermarks}{%
  \def\cpget@titlemarks{\cpgetinnertitlemarks}}

\DeclareOption{footmarks}{} % Backward compat

\DeclareOption{explicit}{\cpget@explicittrue}

\DeclareOption{clearempty}{%
  \def\cleardoublepage{%
    \clearpage{\ps@empty\if@twoside\ifodd\c@page\else
    \hbox{}\newpage\if@twocolumn\hbox{}\newpage\fi\fi\fi}}}

\DeclareOption{rigidchapters}{%
  \def\cpget@topmode#1#2{\vbox to #1{#2\vfil}}%
  \def\cpget@chapafter{.26\textheight}}
\DeclareOption{rubberchapters}{%
  \def\cpget@topmode#1#2{{#2}\cpge@calc\vspace{#1}}%
  \def\cpget@chapafter{40\p@}}

\DeclareOption{bottomtitles}{%
  \def\bottomtitlespace{-1\p@}}
\DeclareOption{nobottomtitles}{%
  \def\bottomtitlespace{.2\textheight}}
\DeclareOption{nobottomtitles*}{%
  \let\cpget@addstretch\relax
  \def\bottomtitlespace{.2\textheight}}

\DeclareOption{calcwidth}{%
  \let\cpget@beginlongest\cpget@xbeginlongest}

\DeclareOption{aftersep}{%
  \let\cpget@titlespace\@gobble}
\DeclareOption{largestsep}{%
  \let\cpget@titlespace\addvspace}

\DeclareOption{oldparttoc}{%
  \def\cpget@tocpart{\def\cpget@a{\thepart\hspace{1em}}}}
\DeclareOption{newparttoc}{%
  \let\cpget@tocpart\relax}
\DeclareOption{notocpart*}{%
  \let\cpget@notocparts\@empty}

\DeclareOption{rm}{%
  \protected@xdef\cpget@fonts{\cpget@fonts\protect\rmfamily}}
\DeclareOption{sf}{%
  \protected@xdef\cpget@fonts{\cpget@fonts\protect\sffamily}}
\DeclareOption{tt}{%
  \protected@xdef\cpget@fonts{\cpget@fonts\protect\ttfamily}}
\DeclareOption{md}{%
  \protected@xdef\cpget@fonts{\cpget@fonts\protect\mdseries}}
\DeclareOption{bf}{%
  \protected@xdef\cpget@fonts{\cpget@fonts\protect\bfseries}}
\DeclareOption{up}{%
  \protected@xdef\cpget@fonts{\cpget@fonts\protect\upshape}}
\DeclareOption{it}{%
  \protected@xdef\cpget@fonts{\cpget@fonts\protect\itshape}}
\DeclareOption{sl}{%
  \protected@xdef\cpget@fonts{\cpget@fonts\protect\slshape}}
\DeclareOption{sc}{%
  \protected@xdef\cpget@fonts{\cpget@fonts\protect\scshape}}

\DeclareOption{big}{%
  \gdef\cpget@sizes#1{\ifcase#1\relax\Huge\or\Large\or\large
       \or\normalsize\or\or\or\huge\fi}}
\DeclareOption{medium}{%
  \gdef\cpget@sizes#1{\ifcase#1\relax\huge\or\Large\or\large
       \or\normalsize\or\or\or\LARGE\fi}}
\DeclareOption{small}{%
  \gdef\cpget@sizes#1{\ifcase#1\relax\LARGE\or\large
       \or\normalsize\or\normalsize\or\or\or\Large\fi}}
\DeclareOption{tiny}{%
  \gdef\cpget@sizes#1{\ifcase#1\relax\large\or\normalsize\or
    \normalsize\or\normalsize\or\or\or\normalsize\fi}}

\DeclareOption{raggedleft}{%
  \gdef\cpget@fil{\filleft}}
\DeclareOption{center}{%
  \gdef\cpget@fil{\filcenter}}
\DeclareOption{raggedright}{%
  \gdef\cpget@fil{\filright}}

\DeclareOption{uppercase}{%
  \gdef\cpget@case{\MakeUppercase}}

\DeclareOption{compact}{%
  \gdef\cpget@space{1}%
  \gdef\cpget@chapafter{30\p@}}

% Deprecated. To be remmoved in a major upgrade (3.0)
\DeclareOption{indentfirst}{%
  \gdef\@afterindentfalse{\let\if@afterindent\iftrue}%
  \@afterindenttrue
  \def\cpgetspacing{%
    \@ifstar{\cpget@spacing@i{\@ne}}{\cpget@spacing@i{\@ne}}}}
\DeclareOption{nonindentfirst}{%
  \def\cpgetspacing{%
    \@ifstar{\cpget@spacing@i{\z@}}{\cpget@spacing@i{\z@}}}}

% New names
\DeclareOption{indentafter}{%
  \gdef\@afterindentfalse{\let\if@afterindent\iftrue}%
  \@afterindenttrue
  \def\cpgetspacing{%
    \@ifstar{\cpget@spacing@i{\@ne}}{\cpget@spacing@i{\@ne}}}}
\DeclareOption{noindentafter}{%
  \def\cpgetspacing{%
    \@ifstar{\cpget@spacing@i{\z@}}{\cpget@spacing@i{\z@}}}}

% newlinetospace
\let\cpget@blinemarks\relax
\let\cpget@elinemarks\relax

\DeclareRobustCommand\cpget@linetosp{%
  \@ifstar{\cpget@linetosp@i}{\cpget@linetosp@i}}%

\def\cpget@linetosp@i{%
  \ifdim\lastskip>\z@\else\space\fi
  \ignorespaces}

\DeclareOption{newlinetospace}{%
  \def\cpget@blinemarks{%
    \let\cpget@e\\%
    \def\\{\cpget@linetosp}}%
  \def\cpget@elinemarks{\let\\\cpget@e}}%

%%% newlinetocolon
\DeclareRobustCommand\cpget@linetocolon{%
  \@ifstar{\cpget@linetocolon@i}{\cpget@linetocolon@i}}%
\def\cpget@linetocolon@i{%
  \ifdim\lastskip>\z@\else\ :\ \fi
  \ignorespaces}
\def\cpget@blinemarks{%
    \let\cpget@e\\%
    \def\\{\cpget@linetocolon}}%
\def\cpget@elinemarks{\let\\\cpget@e}%

% toctitles
\def\cpget@addcontentsline#1#2{%
  \addcontentsline{toc}{#1}{\ifcpget@toclabel\cpget@a\fi#2}%
  \nobreak}

\DeclareOption{toctitles}{%
  \def\cpget@addcontentsline#1#2{%
    \addcontentsline{toc}{#1}{\ifcpget@toclabel\cpget@a\fi\cpget@savetitle}%
    \nobreak}}

% pageatnewline

\def\cpget@changecentercr{%
  \let\cpget@centercr\@centercr
  \def\@centercr{\@ifstar{\cpget@centercr*}{\cpget@centercr*}}}

\DeclareOption{pageatnewline}{\let\cpget@changecentercr\relax}

\def\cpget@fonts{}

% nostruts

\DeclareOption{nostruts}{%
  \let\cpget@strut\@empty
  \def\cpget@defnostruts{%
    \let\cpget@strut\@empty
    \def\nostruts{\let\cpget@strut\@empty}}}

\ExecuteOptions{rubberchapters,bottomtitles,aftersep,oldparttoc,%
  innermarks}

\ProcessOptions

%               +-----------------+
%               | H Y P E R R E F |
%               +-----------------+
%
% These two commands are provided by hyperref. But if they
% are not defined at \begin{document} hyperref has not been
% loaded or it is an old version.

\AtBeginDocument{%
  \ifx\cpget@Hy@steplink\@undefined
    \let\cpget@Hy@steplink\@gobble
    \let\cpget@Hy@refstepcounter\refstepcounter
  \fi}

%               +-----------------+
%               |   PAGE STYLES   |
%               +-----------------+
%
% This is generic:

\newcommand\cpgetassignpagestyle[2]{%
  \@namedef{cpget@ps@\expandafter\@gobble\string#1}{#2}}

% pagestyles intégré 
% ~~~~~~~~~~~~~~

%\let\cpget@compatps\@empty % marks the ``old interface''
\let\cpget@coreps\@empty


\ifx\cpget@coreps\@empty\else      % START code for package


\expandafter\newif\csname ifcpget@ps\endcsname
\expandafter\newif\csname ifcpget@toclabel\endcsname
\cpget@toclabeltrue

\def\cpget@calcneg#1#2{%
  {\setlength\@tempskipa{#2}%
   #1{-\@tempskipa}}}

\expandafter\newif\csname ifcpget@premark\endcsname
\cpget@premarkfalse

% 2019-02-25. Added the \lastskip stuff, because a mark 'forgets' the
% last skip.

\def\cpget@premark#1#2{%
  \let\cpget@lastskip\relax
  \ifvmode
    \ifdim\lastskip=\z@\else
      \edef\cpget@lastskip{\the\lastskip}% 
      \vskip-\cpget@lastskip\relax
    \fi
  \fi
  \protected@xdef\cpget@prevmarks{\cpget@marks}%
  \csname#1mark\endcsname{#2}%
  \ifx\cpget@lastskip\relax\else
    \vskip\cpget@lastskip\relax
  \fi
  \gdef\cpget@prevmarks{\cpget@marks}}

\let\cpget@savemark\@empty

% Patching sectioning commands

\newcommand\cpgetTitlepsPatchSection{%
  \@ifstar{\cpget@setsec\@gobbletwo}%
          {\cpget@setsec\cpgetpretitlemark}}

\def\cpget@setsec#1#2{%
  \@ifundefined{#2}{}{%
    \expandafter\let\csname cpget@s@#2\expandafter\endcsname
      \csname#2\endcsname
    \@namedef{#2}{%
      \@ifstar{\cpget@presec@s{#2}}%
              {\@dblarg{\cpget@presec@x#1{#2}}}}}}%

% premark/gobble, sect-name, opt, title
\def\cpget@presec@x#1#2[#3]#4{%
  #1{#2}{#3}%
  \@nameuse{cpget@s@#2}[#3]{#4}}

\def\cpget@presec@s#1#2{%
  \gdef\cpget@savemark{\@nameuse{#1mark}{#2}}%
  \@nameuse{cpget@s@#1}*{#2}}

\def\cpget@atbegin{%
  \cpgetTitlepsPatchSection*{chapter}%
  \cpgetTitlepsPatchSection{section}%
  \cpgetTitlepsPatchSection{subsection}%
  \cpgetTitlepsPatchSection{subsubsection}%
  \cpgetTitlepsPatchSection{paragraph}%
  \cpgetTitlepsPatchSection{subparagraph}}

\AtBeginDocument{\cpget@atbegin}

% Package options

\DeclareOption{psfloats}{\let\cpget@replace\@empty} % a flag

\DeclareOption{outermarks}{%
  \def\cpget@titlemarks{\cpgetoutertitlemarks}}
\DeclareOption{topmarks}{
  \def\cpget@titlemarks{\cpgettoptitlemarks}}
\DeclareOption{botmarks}{%
  \def\cpget@titlemarks{\cpgetbottitlemarks}}
\DeclareOption{innermarks}{%
  \def\cpget@titlemarks{\cpgetinnertitlemarks}}
\DeclareOption{extramarks}{\let\cpget@fetchmark\@empty}
\DeclareOption{nopatches}{\let\cpget@atbegin\relax}

\ExecuteOptions{innermarks}

\ProcessOptions

% Load the package body

\let\cpgetnewpagestyle\@empty
\let\cpgetrenewpagestyle\@empty
\let\cpgetwidenhead\@empty

\fi                          % PAUSE code for package

% START core code

% As before, all marks has two parts but now they don't refer to left or 
% right pages at all.  There are some issues related to top marks which 
% are explained by Knuth in \textit{The \TeX book}, pp.  259f, as well 
% as an incompatibility between them and \LaTeX{} floats.  To overcome 
% both limitations, in the \textsf{cpgetitle} page styles, the second 
% part in |\cs{firstmark}| is a \emph{fixed} top mark and the first one 
% the actual first mark; the right way to get the bot mark is from the 
% second part.  Marks are stored at each section and used before and 
% after the title (straight class); the first part contains the values 
% of current title, but the second one contains the previously stored 
% values in the mark before the title, and the current values in the 
% mark after.

%\let\cpget@compatps\@undefined
\ifx\cpget@compatps\@undefined\else
  \PackageWarningNoLine{cpgetitle}
      {You are using an old interface for page styles\MessageBreak
      (or you forgot the package option 'pagestyles').\MessageBreak
      You could proceed but don't complain if you run\MessageBreak
      into errors}
\fi

\cpget@pstrue

\let\parttitle\@empty
\let\chaptertitle\@empty
\let\sectiontitle\@empty
\let\subsectiontitle\@empty
\let\subsubsectiontitle\@empty
\let\paragraphtitle\@empty
\let\subparagraphtitle\@empty

\newcommand\ifcpgettitle[1]{%
  \expandafter\ifx\csname #1title\endcsname\@empty
    \expandafter\@secondoftwo
  \else
    \expandafter\@firstoftwo
  \fi}

% \cpgenewtitlemarks belongs to a nameless markset (ie, \@empty).
% For named extra marksets see below. 

\newcommand\cpgenewtitlemark{%
  \@ifstar{\@tempswafalse\cpget@newmk@i\@empty}%
          {\@tempswatrue\cpget@newmk@i\@empty}}

\def\cpget@newmk@i#1#2{%   markset, macro/var
  \edef\cpget@a{\expandafter\@gobble\string#2}%
  \expandafter\ifx\csname\cpget@a\endcsname#2\else
    \edef\cpget@a{c@#2}%
  \fi
  \expandafter\cpget@newmk@ii\expandafter{\cpget@a}{#1}}

\def\cpget@newmk@ii#1#2{%   macro/var, markset
  \expandafter\let\expandafter\cpget@a\csname cpget@mks@#2\endcsname
  \if@tempswa
    \expandafter\def\expandafter\cpget@a\expandafter{%
      \cpget@a
      \protect\@namedef{#1}{\@nameuse{#1}}}%
  \else
    \expandafter\def\expandafter\cpget@a\expandafter{%
      \cpget@a
      \protect\@nameuse{#1}=\the\@nameuse{#1}\relax}%
  \fi
  \expandafter\let\csname cpget@mks@#2\endcsname\cpget@a}

\let\cpget@mks@\@empty
\def\cpget@moremarks{\cpget@mks@} % backward compat

\def\cpget@prevmarks{\cpget@marks}
\let\cpget@marks\relax

% The following command sets the ifthe... commands to
% be used in heads. When the call is from inside a sectioning
% command, toclabel is either true (in most of cases) or false
% (a chapter in the front matter, for example). Otherwise (an
% explicit \...mark) is false

\def\cpget@setifthe#1{%
  \expandafter\protected@edef\csname ifthe#1\endcsname{%
    \ifcpget@toclabel
      \protect\@firstoftwo
    \else
      \protect\@secondoftwo
    \fi}}

% At this point \cpget@toclabel is always false

\cpget@setifthe{part}
\cpget@setifthe{chapter}
\cpget@setifthe{section}
\cpget@setifthe{subsection}
\cpget@setifthe{subsubsection}
\cpget@setifthe{paragraph}
\cpget@setifthe{subparagraph}

% Putting marks
% -------------

\cpgenewtitlemark{\cpget@running}
\let\cpget@enccode\relax
\def\cpget@running{\cpget@enccode}

% \cpget@markboth redefines temporarily \mark to fetch changes made by
% babel or ams, saved in \cpget@running.  When this is done, the actual
% \mark es emitted, which has \cpget@running as part of the markset (see
% the \cpgenewtitlemark above). As of 2019 and due to a change in the LaTex
% kernel, we consider two possibilities (2.13).

\expandafter\ifx\csname markboth \endcsname\relax
  \def\cpget@mb@mark{\markboth}
\else
  \edef\cpget@mb@mark{\expandafter\noexpand\csname markboth \endcsname}
\fi

\def\cpget@mb@warn{%
  \PackageWarningNoLine{cpgetitle}
    {Direct use of \string\markboth\space and \string\markleft\space
     can lead\MessageBreak
     to unpredictable results. Please, read the manual\MessageBreak
     for an explanation of this warning.}}

\def\cpget@markboth#1{%
 \begingroup
   \let\protect\@unexpandable@protect
   \let\@mkboth\@gobbletwo
   \let\cpget@enccode\relax
   \let\label\relax
   \let\index\relax
   \let\glossary\relax
   \let\cpget@c\mark
   \def\mark##1{\xdef\cpget@running{\expandafter\@gobble##1}}%
   \cpget@mb@mark{}{\cpget@enccode}%
   \expandafter\let\csname#1mark\endcsname\@gobble
   \xdef\cpget@marks{\cpget@marks}%
   \gdef\@themark{{\cpget@marks}{\cpget@prevmarks}}%
   \cpget@c{\@themark\let\noexpand\cpget@mb@warn\relax}%
   \@nameuse{cpget@tem@#1}%
   \if@nobreak\ifvmode\nobreak\fi\fi
 \endgroup}

\newcommand\cpgetsettitlemarks{\@ifstar\cpget@svmarks@s\cpget@svmarks@x}

\def\cpget@svmarks@x#1{\def\cpget@marksset{{#1}}}
\def\cpget@svmarks@s#1{\def\cpget@marksset{*{#1}}}

\newcommand\cpgetsetmarks[2]{\cpgetsettitlemarks{#1,#2}} % back compat

\def\cpget@settopmark#1\@@{%
  \expandafter\def\csname#1mark\endcsname##1{%
    \expandafter\gdef\csname#1title\endcsname{##1}%
    %\csgappto{#1title}{##1}%
    \cpget@setifthe{#1}%
    \expandafter\let\expandafter\cpget@marks\csname cpget@tm@#1\endcsname
    \cpget@markboth{#1}}%
  \global\@namedef{cpget@tm@#1}{%
    \protect\@namedef{#1title}{\@nameuse{#1title}}%
    \protect\@namedef{the#1}{\@nameuse{the#1}}%
    \protect\@namedef{ifthe#1}{\@nameuse{ifthe#1}}}%
  \def\cpget@elt##1{%
    \expandafter\cpget@setsubmark\cpget@a\@@{##1}}%
  \cpget@c}%

\def\cpget@setsubmark#1\@@#2{%
  \expandafter\g@addto@macro\csname cpget@tm@#2\endcsname{%
    \protect\@namedef{#1title}{}%
    \protect\@namedef{the#1}{}%
    \protect\@namedef{ifthe#1}{\protect\@secondoftwo}}
  \expandafter\g@addto@macro\csname cpget@tm@#1\endcsname{%
    \protect\@namedef{#2title}{\@nameuse{#2title}}%
    \protect\@namedef{the#2}{\@nameuse{the#2}}%
    \protect\@namedef{ifthe#2}{\@nameuse{ifthe#2}}}}%

\def\cpget@setmarks@x#1{%
  \let\cpget@c\@empty % sub list
  \@for\cpget@a:=#1\do{%
    \expandafter\cpget@settopmark\cpget@a\@@
    \let\cpget@elt\relax
    \xdef\cpget@c{\cpget@c\cpget@elt{\cpget@a}}}%
  \@for\cpget@a:=#1\do{%
    \expandafter\g@addto@macro\csname cpget@tm@\cpget@a\endcsname{%
      \cpget@moremarks}}}

\def\cpget@setmarks@s#1{% Solo con extramarks
  \PackageError{cpgetitle}%
     {You need `extramarks' for \string\cpgetsettitlemarks*}%
     {\string\cpgetsettitlemarks* requires the package option `extramarks'}}

\newcommand\cpgetpretitlemark{%
  \global\cpget@premarktrue
  \@ifstar{\cpget@pretitlemark\z@}%
          {\cpget@pretitlemark\@ne}}

\def\cpget@pretitlemark#1#2#3{%
  \addtocounter{#2}#1%
  \cpget@premark{#2}{#3}%
  \addtocounter{#2}{-#1}}

% Rules
% -----

\newcommand\cpgetheadrule{\cpgetsetheadrule{.4\p@}}
\newcommand\cpgetfootrule{\cpgetsetfootrule{.4\p@}}

\newcommand\cpgetsetheadrule[1]{%
  \ifdim#1=\z@
    \let\makeheadrule\@empty
  \else
    \def\makeheadrule{\rule[-.3\baselineskip]{\linewidth}{#1}}%
  \fi}
\newcommand\cpgetsetfootrule[1]{%
  \ifdim#1=\z@
    \let\makefootrule\@empty
  \else
    \def\makefootrule{\rule[.7\baselineskip]{\linewidth}{#1}}%
  \fi}

\newcommand\cpgetnewpagestyle[1]{%
  \begingroup
  \catcode`\^^M=9
  \@ifnextchar[%
    {\cpget@pagestyle\newcommand{#1}}%
    {\cpget@pagestyle\newcommand{#1}[]}}

\newcommand\cpgetrenewpagestyle[1]{%
  \begingroup
  \catcode`\^^M=9
  \@ifnextchar[%
    {\cpget@pagestyle\renewcommand{#1}}%
    {\cpget@pagestyle\renewcommand{#1}[]}}

\def\cpget@pagestyle#1#2[#3]#4{%
  \endgroup
  \expandafter#1\csname ps@#2\endcsname{%
    \cpget@defaultps
    \def\cpget@headfmt{#3}%
    #4%
    \def\cpgetsettitlemarks{\@ifstar\cpget@svmarks@s\cpget@svmarks@x}}}

\def\cpget@userunning#1#2{\csname cpgetr@#1#2\endcsname}

\def\cpget@defaultps{%
  \let\makeheadrule\@empty
  \let\makefootrule\@empty
  \def\@mkboth{\cpget@savemark\@gobbletwo}%
  \def\@oddfoot{\cpget@userunning of}%
  \def\@evenfoot{\cpget@userunning ef}%
  \def\@oddhead{\cpget@userunning oh}%
  \def\@evenhead{\cpget@userunning eh}%
  \def\cpgetr@of{\cpget@makefoot\@empty\@@\cpget@hiol\cpget@hior}%
  \def\cpgetr@ef{\cpget@makefoot\@empty\@@\cpget@hiel\cpget@hier}%
  \def\cpgetr@oh{\cpget@makehead\@empty\@@\cpget@hiol\cpget@hior}%
  \def\cpgetr@eh{\cpget@makehead\@empty\@@\cpget@hiel\cpget@hier}%
  \let\cpgetr@of@b\relax  \let\cpgetr@of@p\relax
  \let\cpgetr@ef@b\relax  \let\cpgetr@ef@p\relax
  \let\cpgetr@oh@t\relax  \let\cpgetr@oh@p\relax
  \let\cpgetr@eh@t\relax  \let\cpgetr@eh@p\relax
  \def\cpgetsettitlemarks{\@ifstar\cpget@setmarks@s\cpget@setmarks@x}%
  \expandafter\cpgetsettitlemarks\cpget@marksset}

\@ifundefined{chapter}%
  {\cpgetsettitlemarks{section,subsection}}%
  {\cpgetsettitlemarks{chapter,section}}

\newcommand\cpgetusepage{\protect\thepage} % back compat

\newcommand\cpgettoptitlemarks{\expandafter\@secondoftwo\firstmark{}{}{}}
\def\firsttitlemarks{%
   \toks@\expandafter\expandafter\expandafter{%
      \expandafter\@secondoftwo \firstmark{}{}{}}%
   \@temptokena\expandafter\expandafter\expandafter{%
      \expandafter\@secondoftwo \botmark{}{}{}}%
   \edef\cpget@a{\the\toks@}%
   \edef\cpget@b{\the\@temptokena}%
   \ifx\cpget@a\cpget@b
     \expandafter\@secondoftwo\firstmark{}{}{}%
   \else
     \expandafter\@firstoftwo \firstmark{}{}{}%
   \fi}
\newcommand\cpgetbottitlemarks{\expandafter\@secondoftwo\botmark{}{}{}}
\newcommand\cpgetnexttoptitlemarks{\expandafter\@firstoftwo\botmark{}{}{}}
\newcommand\cpgetoutertitlemarks{%
  \if@twoside
    \ifodd\c@page\relax
      \cpgetbottitlemarks
    \else
      \cpgettoptitlemarks
    \fi
  \else
    \cpgettoptitlemarks
  \fi}
\newcommand\cpgetinnertitlemarks{%
  \if@twoside
    \ifodd\c@page\relax
      \firsttitlemarks
    \else
      \cpgetbottitlemarks
    \fi
  \else
    \cpgetbottitlemarks
  \fi}

\def\cpget@duplthreeargs#1#2#3#4{#1[#2][#3][#4]{#2}{#3}{#4}}
\def\cpget@dupltwoargs#1#2#3{#1[#2][#3]{#2}{#3}}
\def\cpget@duplthreeargsrev#1#2#3#4{#1[#4][#3][#2]{#2}{#3}{#4}}
\def\cpget@dupltwoargsrev#1#2#3{#1[#3][#2]{#2}{#3}}

\def\cpget@setany#1{%
  \@ifstar{\cpget@duplthreeargsrev#1}%
          {\@ifnextchar[{#1}{\cpget@duplthreeargs#1}}}

\newcommand\cpgetsetfoot{\cpget@setany\cpget@setfoot}
\newcommand\cpgetsethead{\cpget@setany\cpget@sethead}

\def\cpget@setfoot[#1][#2][#3]#4#5#6{%
  \def\cpgetr@ef{\cpget@makefoot{#1}{#2}{#3}\@@\cpget@hiel\cpget@hier}%
  \def\cpgetr@of{\cpget@makefoot{#4}{#5}{#6}\@@\cpget@hiol\cpget@hior}}

\def\cpget@sethead[#1][#2][#3]#4#5#6{%
  \def\cpgetr@eh{\cpget@makehead{#1}{#2}{#3}\@@\cpget@hiel\cpget@hier}%
  \def\cpgetr@oh{\cpget@makehead{#4}{#5}{#6}\@@\cpget@hiol\cpget@hior}}

\def\cpget@headinline#1#2#3{%
  \cpget@headfmt
  \def\cpget@a{#1#3}\def\cpget@b{#2}%
  \ifx\cpget@a\@empty
    \hfil{#2}\hfil
  \else\ifx\cpget@b\@empty
    {#1}\hfil{#3}%
  \else
    \sbox\z@ {#1}%
    \sbox\tw@{#3}%
    \copy\z@
    \ifdim\wd\z@<\wd\tw@
      \kern-\wd\z@\kern\wd\tw@
    \fi
    \hfil{#2}\hfil
    \ifdim\wd\z@>\wd\tw@
      \kern-\wd\tw@\kern\wd\z@
    \fi
    \box\tw@
  \fi\fi}

\def\cpget@makeboth#1#2#3#4{%
  \cpget@calcneg\hspace{#3}%
  \normalsize
  \linewidth\textwidth
  \addtolength\linewidth{#3}%
  \addtolength\linewidth{#4}%
  \ifx#2\@empty\else   
    \setbox\z@\hb@xt@\linewidth{%
      \color@begingroup
      #2%
      \color@endgroup}%
      \wd\z@\z@
      \ht\z@\z@
      \dp\z@\z@
      \box\z@
  \fi
  \cpget@titlemarks % Must precede the format. Defines \cpget@running
  \def\cpget@enccode{\cpget@headinline#1{}{}{}}% which contains cpget@enccode
  \cpget@running
  \cpget@calcneg\hspace{#4}}% 

\def\cpget@makehead#1\@@{\cpget@makeboth{#1}\makeheadrule}
\def\cpget@makefoot#1\@@{\cpget@makeboth{#1}\makefootrule}

\newcommand\cpgetwidenhead{%
  \@ifstar{\cpget@dupltwoargsrev\cpget@widenhd}%
          {\@ifnextchar[{\cpget@widenhd}{\cpget@dupltwoargs\cpget@widenhd}}}

\def\cpget@widenhd[#1][#2]#3#4{%
  \def\cpget@hiel{#1}\def\cpget@hier{#2}%
  \def\cpget@hiol{#3}\def\cpget@hior{#4}}

\let\cpgetsetheadindent\cpgetwidenhead

\def\cpget@hiel{\z@}\def\cpget@hier{\z@}
\def\cpget@hiol{\z@}\def\cpget@hior{\z@}

% A tool:

\def\ifsamemark#1#2{%
  {#1\global\let\cpget@c#2}%
  \ifx\cpget@c#2%
    \expandafter\@firstoftwo
  \else
    \expandafter\@secondoftwo
  \fi}

% Another tool:
% As of 2019 and due to a change in the LaTex kernel, we consider two
% possibilities (2.13).

\expandafter\ifx\csname markboth \endcsname\relax

  \newcommand\cpgetsetmarkboth{%
    \ifx\markboth\cpget@mb@use\else
      \let\cpget@mb@mark\markboth
      \let\markboth\cpget@mb@use
    \fi
    \def\cpget@mb@new##1##2}

  % \cpget@mb@temp is a trick to allow resetting inside \cpgetsetmarkboth.

  \def\cpget@mb@use#1#2{%
    \let\markboth\cpget@mb@mark
    \def\cpget@mb@temp{\let\markboth\cpget@mb@use}%
    \cpget@mb@new{#1}{#2}%
    \cpget@mb@temp
    \let\cpget@mb@temp\@undefined}

  \newcommand\cpgetresetmarkboth{%
    \ifx\cpget@mb@temp\@undefined
      \let\markboth\cpget@mb@mark
      \def\cpget@mb@mark{\markboth}%
    \else
      \def\cpget@mb@temp{%
        \let\markboth\cpget@mb@mark
        \def\cpget@mb@mark{\markboth}}%
    \fi}

\else

  \newcommand\cpgetsetmarkboth{%
    \expandafter\ifx\csname markboth \endcsname\cpget@mb@use\else
      \expandafter\let\expandafter\cpget@mb@mark\csname markboth \endcsname
      \expandafter\let\csname markboth \endcsname\cpget@mb@use
    \fi
    \def\cpget@mb@new##1##2}

  \def\cpget@mb@use#1#2{%
    \expandafter\let\csname markboth \endcsname\cpget@mb@mark
    \def\cpget@mb@temp{\expandafter\let\csname markboth \endcsname\cpget@mb@use}%
    \cpget@mb@new{#1}{#2}%
    \cpget@mb@temp
    \let\cpget@mb@temp\@undefined}

  \newcommand\cpgetresetmarkboth{%
    \ifx\cpget@mb@temp\@undefined
      \expandafter\let\csname markboth \endcsname\cpget@mb@mark
      \edef\cpget@mb@mark{\expandafter\noexpand\csname markboth \endcsname}%
    \else
      \def\cpget@mb@temp{%
        \expandafter\let\csname markboth \endcsname\cpget@mb@mark
        \edef\cpget@mb@mark{\expandafter\noexpand\csname markboth \endcsname}}%
    \fi}

\fi

% ===========
% EXTRA MARKS
% ===========

\ifx\cpget@fetchmark\@empty

\ifx\newmarks\@undefined
  \PackageInfo{cpgetitle}{%
    You have requested `extramarks' but etex or similar\MessageBreak
    has not been loaded. I'll do it for you.}
  \RequirePackage{etex}
\fi

\def\cpget@setmarks@s#1{%
   \@for\cpget@a:=#1\do{%
     \@ifundefined{cpget@mkc@\cpget@a}{%
       \expandafter\newmarks\csname cpget@mkc@\cpget@a\endcsname}{}%
     \expandafter\xdef\csname cpget@tem@\cpget@a\endcsname{%
       \marks\expandafter\noexpand\csname cpget@mkc@\cpget@a\endcsname
       {\noexpand\@themark}}}%
  \cpget@setmarks@x{#1}}%

\newcommand\cpgetnewmarkset[1]{%
  \expandafter\newmarks\csname cpget@mkc@#1\endcsname
  \@namedef{cpget@mks@#1}{}%
  \@namedef{cpget@premks@#1}{\@nameuse{cpget@mks@#1}}}

\newcommand\cpgetnewextramark{%
  \@ifstar{\@tempswafalse\cpget@newmk@i}%
          {\@tempswatrue\cpget@newmk@i}}

\def\cpget@extramark#1{%
 \begingroup
   \let\protect\@unexpandable@protect
   \let\@mkboth\@gobbletwo
   \let\label\relax
   \let\index\relax
   \let\glossary\relax\endgroup}

\newcommand\cpgetextramark[1]{%
  \begingroup
    \let\protect\@unexpandable@protect
    \let\@mkboth\@gobbletwo
    \let\label\relax
    \let\index\relax
    \let\glossary\relax
    \marks\csname cpget@mkc@#1\endcsname{%
      {\@nameuse{cpget@mks@#1}}%
      {\@nameuse{cpget@mks@#1}}}%
    \expandafter\xdef\csname cpget@premks@#1\endcsname
      {\@nameuse{cpget@mks@#1}}%
  \endgroup
  \if@nobreak\ifvmode\nobreak\fi\fi}%

\newcommand\cpgetpreextramark[1]{%
  \begingroup
    \let\protect\@unexpandable@protect
    \let\@mkboth\@gobbletwo
    \let\label\relax
    \let\index\relax
    \let\glossary\relax
    \marks\csname cpget@mkc@#1\endcsname{%
      {\csname cpget@mks@#1\endcsname}%
      {\csname cpget@premks@#1\endcsname}}%
  \endgroup
  \if@nobreak\ifvmode\nobreak\fi\fi}

\newcommand\cpgetnewshortmark[1]{%
  \cpgetnewmarkset{\string#1}%
  \cpgetnewextramark{\string#1}#1}

\newcommand\cpgetshortmark[1]{\cpgetextramark{\string#1}}
\newcommand\cpgetpreshortmark[1]{\cpgetpreextramark{\string#1}}

\newcommand\cpgettopshortmark[1]{{\cpgettopextramarks{\string#1}#1}}
\newcommand\cpgetfirstshortmark[1]{{\cpgetfirstextramarks{\string#1}#1}}
\newcommand\cpgetbotshortmark[1]{{\cpgetbotextramarks{\string#1}#1}}
\newcommand\cpgetnexttopshortmark[1]{{\cpgetnexttopextramarks{\string#1}#1}}

\def\cpget@fetchmark#1#2#3{%
  \expandafter#1#2\csname cpget@mkc@#3\endcsname{}{}{}}

\newcommand\cpgettopextramarks[1]{\cpget@fetchmark\@secondoftwo\firstmarks{#1}}
\newcommand\cpgetfirstextramarks[1]{%
   \toks@\expandafter\expandafter\expandafter{%
      \cpget@fetchmark\@secondoftwo\firstmarks{#1}}%
   \@temptokena\expandafter\expandafter\expandafter{%
      \cpget@fetchmark\@secondoftwo\botmarks{#1}}%
   \edef\cpget@a{\the\toks@}%
   \edef\cpget@b{\the\@temptokena}%
   \ifx\cpget@a\cpget@b
     \cpget@fetchmark\@secondoftwo\firstmarks{#1}%
   \else
     \cpget@fetchmark\@firstoftwo\firstmarks{#1}%
   \fi}
\newcommand\cpgetbotextramarks[1]{\cpget@fetchmark\@secondoftwo\botmarks{#1}}
\newcommand\cpgetnexttopextramarks[1]{\cpget@fetchmark\@firstoftwo\botmarks{#1}}

\newcommand\cpgetouterextramarks[1]{%
  \if@twoside
    \ifodd\c@page\relax
      \cpgetbotextramarks{#1}%
    \else
      \cpgettopextramarks{#1}%
    \fi
  \else
    \cpgettopextramarks{#1}%
  \fi}
\newcommand\cpgetinnerextramarks[1]{%
  \if@twoside
    \ifodd\c@page\relax
      \cpgetfirstextramarks{#1}%
    \else
      \cpgetbotextramarks{#1}%
    \fi
  \else
    \cpgetbotextramarks{#1}%
  \fi}

\fi

% ======
% FLOATS
% ======
%
% Pagestyles with floats. There macros are defined only with the
% psfloats package option.

\ifx\cpget@replace\@undefined\else

% User interface

  \newcommand\cpgetsetfloatfoot{%
    \let\cpget@c\@empty % <- current float, empty if general
    \cpget@setany\cpget@setftfoot}

  \newcommand\cpgetsetfloathead{%
    \let\cpget@c\@empty % <- current float, empty if general
    \cpget@setany\cpget@setfthead}

  \def\cpget@setftfoot[#1][#2][#3]#4#5#6#7{%
    \@ifnextchar[{\cpget@setftfoot@i{#1}{#2}{#3}{#4}{#5}{#6}{#7}}%
                 {\cpget@setftfoot@i{#1}{#2}{#3}{#4}{#5}{#6}{#7}[bp]}}

  \def\cpget@setfthead[#1][#2][#3]#4#5#6#7{%
    \@ifnextchar[{\cpget@setfthead@i{#1}{#2}{#3}{#4}{#5}{#6}{#7}}%
                 {\cpget@setfthead@i{#1}{#2}{#3}{#4}{#5}{#6}{#7}[tp]}}

  \def\cpget@setftfoot@i#1#2#3#4#5#6#7[#8]{%
    \@tfor\cpget@b:=#8\do{%
      \@namedef{cpgetr@ef@\cpget@b\cpget@c}%
         {#7\cpget@makefoot{#1}{#2}{#3}\@@\cpget@hiel\cpget@hier}%
      \@namedef{cpgetr@of@\cpget@b\cpget@c}%
         {#7\cpget@makefoot{#4}{#5}{#6}\@@\cpget@hiol\cpget@hior}}}

  \def\cpget@setfthead@i#1#2#3#4#5#6#7[#8]{%
    \@tfor\cpget@b:=#8\do{%
      \@namedef{cpgetr@eh@\cpget@b\cpget@c}%
         {#7\cpget@makehead{#1}{#2}{#3}\@@\cpget@hiel\cpget@hier}%
      \@namedef{cpgetr@oh@\cpget@b\cpget@c}%
         {#7\cpget@makehead{#4}{#5}{#6}\@@\cpget@hiol\cpget@hior}}}

  \newcommand\cpgetnextfloathead{%
    \cpget@nextfree  % returns cpget@c with the next float
    \cpget@setany\cpget@setfthead}

  \newcommand\cpgetnextfloatfoot{%
    \cpget@nextfree  % returns cpget@c with the next float
    \cpget@setany\cpget@setftfoot}

% Compat mode with floatps

  \ifx\cpget@replace\space

    \let\cpget@setnewfoot\cpget@setftfoot
    \let\cpget@setnewhead\cpget@setfthead

    \def\cpget@setftfoot[#1][#2][#3]#4#5#6{%
      \cpget@setnewfoot[#1][#2][#3]{#4}{#5}{#6}{}}
    \def\cpget@setfthead[#1][#2][#3]#4#5#6{%
      \cpget@setnewhead[#1][#2][#3]{#4}{#5}{#6}{}}

  \fi

% The simple default value of \cpget@userunning is
% replaced by one more elaborated

  \def\cpget@userunning#1#2{%
    \if@fcolmade  % From a post by D. Arseneau to comp.text.tex
      \def\@elt##1{\edef\cpget@pageft{\string##1}}%
      \@flsucceed
      \let\@elt\relax
      \if#2h%
        \cpget@replace #1hp\cpget@pageft
      \else
        \cpget@replace #1fp\cpget@pageft
        \cpget@killftps\cpget@pageft
      \fi
    \else\if#2h%
      \ifx\cpget@topft\@empty\else
        \cpget@replace #1ht\cpget@topft
      \fi
    \else
      \ifx\cpget@botft\@empty\else
        \cpget@replace #1fb\cpget@botft
      \fi
    \fi\fi
    \csname cpgetr@#1#2\endcsname}

% [Don't move above as \cpget@replace is used as a flag.]

  \def\cpget@replace#1#2#3#4{%
      \@ifundefined{cpgetr@#1#2@#3#4}%
        {\@ifundefined{cpgetr@#1#2@#3}{}%
           {\@namedef{cpgetr@#1#2}{\@nameuse{cpgetr@#1#2@#3}}}}%
        {\csname cpgetr@xx@x#4\endcsname\@gobble
         {\expandafter\let\csname cpgetr@#1#2\expandafter\endcsname
           \csname cpgetr@#1#2@#3#4\endcsname}}}

  \def\cpget@nextfree{%
    \def\@elt##1{%
      \edef\cpget@c{\string##1}%
      \let\@elt\@gobble}%
    \@freelist
    \let\@elt\relax
    \@ifundefined{cpgetr@xx@x\cpget@c}%
      {\expandafter\let\csname cpgetr@xx@x\cpget@c\endcsname\@secondoftwo
       \@tfor\cpget@a:={eh@t}{oh@t}{ef@b}{of@b}{eh@p}{oh@p}{ef@p}{of@p}\do{%
         \expandafter\global\expandafter
         \let\csname cpgetr@\cpget@a\cpget@c\endcsname\relax}}{}}

  \def\cpget@killftps#1{%
    \expandafter\global\expandafter
    \let\csname cpgetr@xx@x#1\endcsname\relax}

  \let\cpget@topft\@empty
  \let\cpget@botft\@empty
  \let\cpget@pageft\@empty

  \def\cpget@combinefloats{%
   \ifx\@toplist\@empty\else   
     \def\@elt##1{%
       \edef\cpget@topft{\string##1}%
       \def\@elt####1{\cpget@killftps{\string####1}}}%
     \@toplist
    \fi
    \ifx\@botlist\@empty\else
      \def\@elt##1{%
        \def\@elt####1{%
          \def\@elt####1{\cpget@killftps\cpget@botft}%
          \edef\cpget@botft{\string####1}}%
        \edef\cpget@botft{\string##1}}%
      \@botlist
    \fi
    \let\@elt\relax
    \cpget@combinefloats@x}

  \AtBeginDocument{%
    \let\cpget@combinefloats@x\@combinefloats
    \let\@combinefloats\cpget@combinefloats}

\fi

% END core code

\ifx\cpget@coreps\@empty\else      % CONTINUE code for package

% Raise error if the following are used without cpgetitle

\DeclareRobustCommand\cpget@naerror[1]{%
  \PackageError{cpgetitle}%
    {#1\space only available in cpgetitle.\MessageBreak
     Consider using it instead of cpgetitle}%
    {cpgetitle provides a subset of the macros\MessageBreak
     for pagestyles defined in cpgetitle.}}

\def\cpget@setifthe#1{%
  \expandafter\protected@edef\csname ifthe#1\endcsname{%
    \cpget@naerror{\string\ifthe#1}}}

\cpget@setifthe{part}
\cpget@setifthe{chapter}
\cpget@setifthe{section}
\cpget@setifthe{subsection}
\cpget@setifthe{subsubsection}
\cpget@setifthe{paragraph}
\cpget@setifthe{subparagraph}

\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%% cpgetitle.sty intégré %%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newif\ifcpget@label
\newif\ifcpget@fromblock
\newdimen\cpget@leftsep

\providecommand\cpgetline{%
  \@ifstar{\cpget@line@i{\hb@xt@\cpgetwidth}}%
          {\cpget@line@i{}}}

\def\cpget@line@i#1{%
  \@ifnextchar[{\cpget@line{#1}}{\cpget@line{#1}[s]}}

\def\cpget@line#1[#2]#3{%
  \vskip\topskip
  \hrule \@height \z@
  \nobreak
  \vskip-\topskip
  \begingroup
    \parindent\z@
    \everypar{}%
    \leftskip\z@
    \rightskip\z@   %  #1 is either \hb@xt@\cpgetwidth or empty:
    \@makebox[\hsize][#2]{\cpget@makeline{#1{#3}}}%
    \par
  \endgroup
  \hrule height \z@
  \nobreak}

% Fillers:

\providecommand\cpgetrule{\@ifstar{\cpget@row}{\cpget@rule}}

\let\cpget@leaders\xleaders

\def\cpget@row{\@ifnextchar[{\cpget@row@i}{\cpget@row@i[\wd\z@]}}
\def\cpget@row@i[#1]#2{%
  \ifvmode\expandafter\cpgetline\fi
  {\sbox\z@{#2}%
   \hspace{-#1}%
   \hskip\wd\z@
   \cpget@leaders\hb@xt@#1{\hss\box\z@}%
   \hfill\kern\z@}}

\def\cpget@rule{\@ifnextchar[{\cpget@rule@i}{\cpget@rule@i[.4pt]}}
\def\cpget@rule@i[#1]{%
  \ifvmode\expandafter\cpgetline\fi
  {\leaders\hrule height #1\hfill\kern\z@}}

%\providecommand\filright{%
%  \gdef\cpget@filleft##1{\hskip##1}%
%  \gdef\cpget@filright##1{\hfill}%
%  \let\\\@centercr
%  \advance\rightskip\z@ \@plus 1fil\relax}
%\providecommand\filleft{%
%  \gdef\cpget@filleft##1{\hfill}%
%  \gdef\cpget@filright##1{\hskip##1}%
%  \let\\\@centercr
%  \advance\leftskip\z@ \@plus 1fil
%  \parfillskip\z@}
%\providecommand\filcenter{\filleft\filright
%  \gdef\cpget@filleft##1{\hfill}}
%\providecommand\fillast{%
%  \gdef\cpget@filleft##1{\hfill}%
%  \gdef\cpget@filright##1{\hfill}%
%  \let\\\@centercr
%  \filleft\advance\rightskip\z@ \@plus -1fil
%  \parfillskip\z@ \@plus 2fil\relax}

% Now, the specific cpgetitle part

% User interface
% ~~~~~~~~~~~~~~
% Tools:

\DeclareOption{dotinlabels}{\def\cpget@idot{.}}
\DeclareOption{nodotinlabels}{\let\cpget@idot\@empty}

\DeclareOption{rigidseps}{%
  \def\cpget@contentsstretch{\vskip\z@}}
\DeclareOption{rubberseps}{%
  \def\cpget@contentsstretch{\vskip\z@\@plus.1\p@}}

\DeclareOption{leftlabels}{%
  \renewcommand\numberline[1]{\hb@xt@\@tempdima{#1\cpget@idot\hfil}}%
  \newcommand\cpgetcontentslabel[2][\thecontentslabel\cpget@idot]{%
%   \let\cpget@a\thecontentslabel   %%%%% For the star variant
%   \def\thecontentslabel{#2}%    %%% To be fully implemented... when?
%   \setbox\z@\hbox{#1}%
%   \dimen@\wd\z@
%   \let\thecontentslabel\cpget@a
%   \hspace*{-\dimen@}\hb@xt@\dimen@{#1\hfil}
%  \show\cpget@b \show\cpget@a
    \hspace*{-#2}\hb@xt@#2{#1\hfil}}}

\DeclareOption{rightlabels}{%
  \renewcommand\numberline[1]{\hb@xt@\@tempdima{\hss#1\cpget@idot\enspace}}%
  \let\cpgetcontentslabel\relax
  \newcommand\cpgetcontentslabel[2][\thecontentslabel\cpget@idot\enspace]{%
    \hspace*{-#2}\hb@xt@#2{\hfil#1}}}

\newcommand\cpgetcontentspage[1][\thecontentspage]{%
  \hb@xt@\@pnumwidth{\hfil#1}%
  \hspace*{-\@pnumwidth}}

\newcommand\cpgetcontentspush[1]{%
  \sbox\z@{#1}%
  \xdef\cpget@b{\advance\leftskip\the\wd\z@}%
  \aftergroup\cpget@b
  \leavevmode\llap{\box\z@}}

% General commands. A level register. Explicit numbers
% because they are used in csnames. Ignored if already defined.

\ifx\cpgetl@section\@undefined

  \@ifundefined{chapter}
    {\def\cpgetl@part{0}}
    {\def\cpgetl@part{-1}%
     \def\cpgetl@chapter{0}}
  \def\cpgetl@section{1}
  \def\cpgetl@subsection{2}
  \def\cpgetl@subsubsection{3}
  \def\cpgetl@paragraph{4}
  \def\cpgetl@subparagraph{5}

\fi

% We make sure that a series of * entries are finished and
% that a \cpgetcontents in the middle of a document is
% written to the right file. We need ship out floats before;
% that's very tricky.

\newcommand\cpgetcontentsuse[2]{%
  \expandafter\def\csname cpgetx@#1\endcsname{#2}%
  \expandafter\def\csname cpgetl@#1\endcsname{-1000}%
  \expandafter\def\expandafter\cpget@finishall\expandafter{%
    \cpget@finishall
    \@writefile{#2}{\cpgetcontentsfinish}}}

\def\cpget@finishall{\@writefile{toc}{\cpgetcontentsfinish}}

\AtEndDocument{%
  \cpget@startlists
  \let\cpget@newpage\newpage
  \def\newpage{%
    \let\newpage\cpget@newpage
    \newpage
    \if@filesw
      \immediate\write\@mainaux{\string\cpget@finishall}%
    \fi}}

\cpgetcontentsuse{figure}{lof}
\cpgetcontentsuse{table}{lot}

\def\cpgetcontentsfinish{%
  \ifcpget@fromblock
    \xdef\cpget@b{-10000}% ships out any saved punctuation
    \cpget@preend
    \@@par
    \endgroup
    \global\cpget@fromblockfalse
  \fi}

% The two basic commands. First \cpgetcontentsmargin:

\newcommand\cpgetcontentsmargin[1][\z@]{%
  \def\cpget@corr{#1}\def\@pnumwidth}

% The following is the value of \cpgetcontentsmargin when
% used inside \cpget@tocenty (ie, \cpgetcontents).

\newcommand\cpgetmargin[2][\z@]{%
  \def\cpget@corr{#1}%
  \advance\rightskip-\@pnumwidth\relax
  \advance\rightskip#2\relax
  \def\@pnumwidth{#2}}

% \cpgetcontents deals with concepts, not commands; hence no
% escape char

\newcommand\cpgetcontents{%
  \@ifstar{\cpget@contents{\z@}}%
          {\cpget@contents{\@ne}}}

\def\cpget@contents#1#2{%
  \@ifnextchar[{\cpget@contents@i{#1}{#2}}%
               {\cpget@contents@i{#1}{#2}[\@nil]}}

% A dirty hack to fix wrong destinations with hyperref. But activate
% only if some inline entry is defined (ie, #1 = 0):
\let\cpget@fixhyperref\relax

\def\cpget@contents@i#1#2[#3]#4#5#6#7{%
  \ifcase#1\relax
    \def\cpget@fixhyperref{%
      \ifx\Hy@tocdestname\@undefined\else
        \global\let\Hy@tocdestname\Hy@tocdestname
      \fi}%
  \fi
  \expandafter\def\csname l@#2\endcsname
    {\cpget@tocentry{#1}{#2}{#3}{#4}{{#5}{#6}}{#7}}%
  \@ifnextchar[{\cpget@contents@ii{#1}{#2}}%
               {\cpget@contents@ii{#1}{#2}[]}}

\def\cpget@contents@ii#1#2[#3]{%
  \ifcase#1\relax
    \expandafter\@firstoftwo
  \else
    \expandafter\@secondoftwo
  \fi
  {\@ifnextchar[{\cpget@contents@iii{#1}{#2}{#3}}%
                {\cpget@contents@iii{#1}{#2}{#3}[]}}%
  {\cpget@contents@iv{#1}{#2}{#3}[][]}}

\def\cpget@contents@iii#1#2#3[#4]{%
  \@ifnextchar[{\@tempswatrue\cpget@contents@iv{#1}{#2}{#3}[#4]}%
               {\@tempswafalse\cpget@contents@iv{#1}{#2}{#3}[#4][]}}

\def\cpget@contents@iv#1#2#3[#4][#5]{%
  \ifcase#1\relax
    \if@tempswa
      \cpget@contents@v{#2}{#3}{#4}{#5}%
    \else
      \cpget@contents@v{#2}{}{#3}{#4}%
    \fi
  \else
    \cpget@contents@v{#2}{}{}{#3}%
  \fi}

\def\cpget@contents@v#1#2#3#4{%
  \expandafter\def\csname cpgetb@#1\endcsname{#2}%
  \expandafter\def\csname cpgetm@#1\endcsname{#3}%
  \expandafter\def\csname cpgete@#1\endcsname{#4}}

\begingroup
\catcode`\-=12\catcode`\>=12
\gdef\cpget@strip#1->#2\@@#3{\def#3{#2}}
\endgroup

\AtBeginDocument{%
  \def\cpget@change@i#1#2#3#4#5#6#7{%
    \expandafter\def\csname l@#2\endcsname
      {\cpget@tocentry{#1}{#2}{#3}{#4}{{#5}{#6}}{#7}}}%
  \let\cpget@change@v\cpget@contents@v
  \def\cpget@contents@i#1#2[#3]#4#5#6#7{%
    \def\cpget@a{\cpget@change@i{#1}{#2}{#3}{#4}{#5}{#6}{#7}}%
    \@ifnextchar[{\cpget@contents@ii{#1}{#2}}%
                 {\cpget@contents@ii{#1}{#2}[]}}%
  \def\cpget@contents@v#1#2#3#4{%
    \def\cpget@b{\cpget@change@v{#1}{#2}{#3}{#4}}%
    \expandafter\cpget@strip\meaning\cpget@a\@@\cpget@a
    \expandafter\cpget@strip\meaning\cpget@b\@@\cpget@b
    \edef\cpget@c{%
      \expandafter\ifx\csname cpgetx@#2\endcsname\relax
        toc%
      \else
        \csname cpgetx@#2\endcsname
      \fi}%
    \addtocontents{\cpget@c}{\cpget@a\relax}%
    \addtocontents{\cpget@c}{\cpget@b\relax}}}

% Printing the toc entry
% ~~~~~~~~~~~~~~~~~~~~~~

\def\cpget@lasttoc{-1000} % An inital dummy assignment

\def\cpget@providecpgetl#1#2{%
  \@ifundefined{cpgetl@#1#2}%
    {\global\expandafter\let\csname cpgetl@#1#2\expandafter\endcsname
        \csname cpgetl@#2\endcsname}%
    {}%
  \@ifundefined{cpgetl@#1#2}%
    {\PackageWarning{cpgetitle}%
       {Unknown TOC type #1#2. I'll set it for you with\MessageBreak
        level -1000.}%
     \expandafter\gdef\csname cpgetl@#1#2\endcsname{-1000}}%
    {}}

% 1 ifblock, 2 sect name, 3 left, 4 before,
% 5 {with}{without}, 6 filler/page, 7  title 8 pageno

\let\cpget@preend\@empty

\def\cpget@outpunct{%
  \ifnum\cpget@c>\cpget@b\relax
    \cpget@preend
  \fi}

\def\cpget@outblock#1#2#3{%
  \ifcase#1\relax
    \ifnum\cpget@b>\cpget@a\relax
      \begingroup
      \protected@edef\cpget@preend{%
        \@nameuse{cpgete@#2}%
        \endgroup
        \protect\@namedef{cpget@c}{\cpget@a}%
        \protect\cpget@outpunct}%
      #3%
      \@nameuse{cpgetb@#2}%
    \else\ifnum\cpget@b<\cpget@a\relax
      \cpget@preend
      \@nameuse{cpgetm@#2}%
    \else
      \@nameuse{cpgetm@#2}%
    \fi\fi
  \else
    \cpget@preend
    \@@par
    \endgroup
    \@firstoftwo
  \fi}

\def\cpget@outnoblock#1#2#3{%
  \begingroup
  \ifnum\cpget@b>\cpget@a
    \nobreak
  \else\ifnum\cpget@b<\cpget@a
    \addpenalty{\@secpenalty}%
  \else
    \addpenalty{\z@}% 
  \fi\fi
  \cpget@contentsstretch
  \nobreak
  \ifcase#1\relax\else\interlinepenalty\@M\fi
  \parindent\z@
  \ifx\@nil#2%
    \PackageError{cpgetitle}{Unimplemented}%
	    {The optional argument is currently mandatory}%
  \else
    \setlength\leftskip{#2}%
  \fi
  \setlength\rightskip{\@pnumwidth}%
  \let\cpgetcontentsmargin\cpgetmargin
  \def\cpget@makeline##1{##1}%
  #3%
  \addtolength{\parfillskip}{-\cpget@corr}%
  \addtolength{\rightskip}{\cpget@corr}%
  \let\cpget@leaders\leaders}

\def\cpget@tocentry#1#2#3#4#5#6#7#8{%
  \cpget@fixhyperref
  \cpget@providecpgetl{}{#2}%
  \xdef\cpget@b{\csname cpgetl@#2\endcsname}%
  \ifnum\cpget@b>\c@tocdepth\else
    \ifnum\cpget@b<\cpget@toctop\else
      \edef\cpget@a{\cpget@lasttoc}%
      \gdef\thecontentspage{#8}%
      \global\let\thecontentslabel\@empty
      \global\cpget@labelfalse
      \sbox\z@{%  Unused box. It just catch the numberline
        \def\numberline##1{\global\cpget@labeltrue\gdef\thecontentslabel{##1}}%
        #7}%    \cpget@b = current     \cpget@a = previous
      \ifcpget@fromblock
        \cpget@outblock{#1}{#2}{#4}%
      \else
        \cpget@outnoblock{#1}{#3}{#4}%
      \fi
      \def\numberline##1{\ignorespaces}%
      \ifcpget@label
        {\leavevmode\strut\@firstoftwo#5{#7}\strut\kern\z@}%
      \else
        {\leavevmode\strut\@secondoftwo#5{#7}\strut\kern\z@}%
      \fi
      {#6}%
      \ifcase#1\relax
        \ifcpget@fromblock\else
          \protected@edef\cpget@preend{\@nameuse{cpgete@#2}}%
        \fi
        \global\cpget@fromblocktrue
      \else
        \@@par
        \nobreak
        \csname cpgete@#2\endcsname
        \endgroup
        \global\cpget@fromblockfalse
      \fi
      \xdef\cpget@lasttoc{\csname cpgetl@#2\endcsname}%
    \fi
  \fi
  \ignorespaces}

\newcommand\cpgetdottedcontents{}
\def\cpgetdottedcontents#1[#2]#3#4#5{%
  \cpgetcontents{#1}[#2]{#3}%
    {\cpgetcontentslabel{#4}}%
    {\hspace*{-#4}}%
    {\cpgetrule*[#5]{.}\cpgetcontentspage}}

\ExecuteOptions{leftlabels,nodotinlabels,rubberseps}

\ProcessOptions

% Multiple tocs and lists
% ~~~~~~~~~~~~~~~~~~~~~~~~
% After some attemps to adapt cpgetitle to minitoc, I decided to
% implement my own solution, because entries as written by minitoc are
% non standard. The new commands provides a good deal of flexibility,
% too.

\let\cpget@startlists\@empty
\let\cpget@writefile\@writefile

\def\cpget@partialtoc{ptc}
\def\cpget@partiallof{plf}
\def\cpget@partiallot{plt}

\def\cpget@writepartial#1#2{%
  \cpget@topartial{toc}{#1}{#2}%
  \cpget@topartial{lof}{#1}{#2}%
  \cpget@topartial{lot}{#1}{#2}%
  \cpget@writefile{#1}{#2}}

\def\cpget@topartial#1#2#3{%
  \def\cpget@a{#1}%
  \def\cpget@b{#2}%
  \ifx\cpget@a\cpget@b
     \cpget@writefile{\csname cpget@partial#2\endcsname}{#3}%
  \fi}

\def\cpget@xstartlist#1{%
  \@ifundefined{cpget@startlist#1}{%
    \global\@namedef{cpget@startlist#1}{%
      \let\@writefile\cpget@writepartial
      \if@filesw
        \expandafter\newwrite\csname tf@#1\endcsname
        \immediate\openout\csname tf@#1\endcsname\jobname.#1\relax
      \fi
      \@nobreakfalse}%
    \expandafter\gdef\expandafter\cpget@startlists\expandafter{%
      \cpget@startlists
      \@nameuse{cpget@startlist#1}}}{}}

\newcommand\cpgetstartcontents[1][default]{\cpgetstartlist[#1]{toc}}

\newcommand\cpgetstartlist[2][default]{%
  \expandafter\cpget@xstartlist\csname cpget@partial#2\endcsname
  \@ifundefined{c@cpget@#2@#1}%
    {\newcounter{cpget@#2@#1}}%
    {\cpgetstoplist[#1]{#2}}%  
  \stepcounter{cpget@#2@#1}%
  \cpgetresumelist[#1]{#2}}

\newcommand\cpgetstopcontents[1][default]{\cpgetstoplist[#1]{toc}}

\newcommand\cpgetstoplist[2][default]{%
  \protected@write\@auxout{}{%
    \string\cpget@writefile{\csname cpget@partial#2\endcsname}{%
       \string\cpget@stoptoc{#1@\arabic{cpget@#2@#1}}}}}

\newcommand\cpgetresumecontents[1][default]{\cpgetresumelist[#1]{toc}}

\newcommand\cpgetresumelist[2][default]{%
  \protected@write\@auxout{}{%
    \string\cpget@writefile{\csname cpget@partial#2\endcsname}{%
       \string\cpget@starttoc{#1@\arabic{cpget@#2@#1}}}}}

\def\cpget@starttoc#1{%
  \ifx\@writefile\@gobbletwo\else % Is this test necessary?
    \def\cpget@a{#1}%
    \ifx\cpget@a\cpget@ptoc
      \let\contentsline\cpget@contentsline
    \fi
  \fi
  \ignorespaces}

\def\cpget@stoptoc#1{%
  \ifx\@writefile\@gobbletwo\else % Is this test necessary?
    \def\cpget@a{#1}%
    \ifx\cpget@a\cpget@ptoc
      \let\contentsline\cpget@gobblecontents
    \fi
  \fi
  \ignorespaces}

\newcommand\cpgetprintcontents[3][default]{%
  \def\cpget@a{[#1]{toc}{#2}{#3}}%
  \cpgetpreprint}

\newcommand\cpgetprintlist[3][default]{%
  \def\cpget@a{[#1]{#2}{#3}{-1001}}%
  \cpgetpreprint}

\newcommand\cpgetpreprint[2][\c@tocdepth]{%
  \expandafter\cpget@printlist\cpget@a{#1}{#2}}

% 1:name 2:list 3:prefix 4:startlevel 5:depth 6:toccode
\newcommand\cpget@printlist[6][default]{%
  \begingroup
    \@ifundefined{c@cpget@#2@#1}%
      {\PackageError{cpgetitle}{No partial #2 named #1}%
          {You must start before a partial toc/list\MessageBreak
          with \string/startcontents/\string\cpgetstartlist.}}{}%
    \edef\cpget@ptoc{#1@\arabic{cpget@#2@#1}}%
    \def\cpget@toctop{#4}%
    \c@tocdepth=#5\relax
    #6%
    \let\cpget@xcontentsline\contentsline
    \let\contentsline\cpget@gobblecontents
    \def\cpget@contentsline##1{%
      \cpget@providecpgetl{#3}{##1}%
      \@ifundefined{l@#3##1}%
        {\cpget@xcontentsline{##1}}%
        {\cpget@xcontentsline{#3##1}}}%
    \makeatletter
    \@input{\jobname.\csname cpget@partial#2\endcsname}%
    \makeatother
    \@nobreakfalse
  \endgroup}

\AtBeginDocument{%
  \ifx\cpget@gobblecontents\@undefined
    \def\cpget@gobblecontents#1#2#3{\ignorespaces}%
  \fi}

\def\cpget@toctop{-1000}

% Now the we add \cpgetcontentsfinish to the current definitions and a
% "selector" for partial tocs with a wrapper for the original
% definitions (saved as \cpget@savel@#1).

\def\cpget@lselect#1{%
  \cpget@fixhyperref
  \ifnum\csname cpgetl@#1\endcsname>\c@tocdepth\else
    \cpgetcontentsfinish
  \fi
  \ifnum\csname cpgetl@#1\endcsname<\cpget@toctop\relax
    \expandafter\@gobbletwo
  \else
    \expandafter\expandafter\csname cpget@savel@#1\endcsname
  \fi}

\let\cpget@savel@part\l@part
\def\l@part{\cpget@lselect{part}}

\let\cpget@savel@chapter\l@chapter
\def\l@chapter{\cpget@lselect{chapter}}

\let\cpget@savel@section\l@section
\def\l@section{\cpget@lselect{section}}

\let\cpget@savel@subsection\l@subsection
\def\l@subsection{\cpget@lselect{subsection}}

\let\cpget@savel@subsubsection\l@subsubsection
\def\l@subsubsection{\cpget@lselect{subsubsection}}

\let\cpget@savel@paragraph\l@paragraph
\def\l@paragraph{\cpget@lselect{paragraph}}

\let\cpget@savel@subparagraph\l@subparagraph
\def\l@subparagraph{\cpget@lselect{subparagraph}}

\let\cpget@savel@figure\l@figure
\def\l@figure{\cpget@lselect{figure}}

\let\cpget@savel@table\l@table
\def\l@table{\cpget@lselect{table}}

\@tempskipa\@pnumwidth
\edef\@pnumwidth{\the\@tempskipa}
\advance\@tempskipa-\@tocrmarg
\edef\cpget@corr{-\the\@tempskipa}


%               +-----------------+
%               |     K E Y S     |
%               +-----------------+

\def\cpget@keys{%
  \let\cpget@keys\relax
  \@ifundefined{define@key}{\RequirePackage{keyval}}{}%
  \def\cpget@getkeys##1##2{%
    \let\cpget@a\@empty
    \if\expandafter @\@gobble##1@\@empty % if there is a single token
      \edef\cpget@b{\expandafter\@gobble\string##1}%
      \let\cpget@a\cpget@b
    \else
      \cpget@labelfalse  %  A temporary flag: true if there is page key
      \setkeys{##2}{##1}%
      \ifcpget@label
        \@ifundefined{cpgetp@\cpget@b}{%
          \expandafter\let\csname cpgetp@\cpget@b\endcsname\@empty}{}%
      \fi
      \edef\cpget@a{\cpget@b\cpget@a}%
    \fi}%
  %
  \define@key{cpgetitle}{name}{%
    \edef\cpget@b{\expandafter\@gobble\string##1}}%
  \define@key{cpgetitle}{numberless}[true]{%
    \csname @tempswa##1\endcsname
    \if@tempswa
      \edef\cpget@a{\cpget@a/*}%
    \fi}%
  \define@key{cpgetitle}{page}{%
    \cpget@labeltrue  % Used as flag
    \edef\cpget@a{/##1\cpget@a}}%
  %
  \def\cpget@extra@numberless{\cpget@labeltrue}% The actual meaning
  \let\cpget@key@numberless\@empty
  %\let\cpget@key@matter\@empty
  \let\cpgetp@append\@gobbletwo
  \def\cpget@setkeys##1{%
    \def\cpget@trylist{\cpget@try{}}%
    \@for\cpget@b:=##1\do{%
      \begingroup
        \let\cpget@a\relax
        \def\cpget@try####1{%
          \noexpand\cpget@try{####1\cpget@a{\cpget@b}}%
          \noexpand\cpget@try{####1}}%
        \xdef\cpget@trylist{\cpget@trylist}%
      \endgroup}}%
  \cpget@setkeys{page,numberless}% matter
  %
  \if@twoside
    \newcounter{cpgetp@side}%
    \newcount\cpgetp@side
    \def\cpgetp@theside{\ifodd\c@page o\else e\fi}%
    \def\cpgetp@append##1##2{%
     {\let\@elt\relax
      \expandafter\xdef\csname cpgetp@##1\endcsname{%
         \csname cpgetp@##1\endcsname\@elt ##2}}}%
    \def\cpgetp@write##1{%
      {\let\cpgetp@theside\relax
       \protected@write\@auxout{}%
         {\string\cpgetp@append{##1}{\cpgetp@theside}}}}%
    \def\cpgetp@fetch##1{%
       \stepcounter{cpgetp@side}%
       \global\advance\cpgetp@side\@ne
       \@whilenum\cpgetp@side<\c@cpgetp@side\do{%
          \expandafter\@next\expandafter\@tempa\csname cpgetp@##1\endcsname{}{}%
          \global\advance\cpgetp@side\@ne}%
       \expandafter\@next\expandafter\cpget@b\csname cpgetp@##1\endcsname{%
          \xdef\cpget@key@page{/\if\cpget@b oodd\else even\fi}%
       }{%
          \xdef\cpget@key@page{/\ifodd\c@page odd\else even\fi}%
       \@@warning{Unsynchronized `##1' title on page \thepage}}}%
  \else
    \let\cpgetp@write\@gobble
    \def\cpgetp@fetch##1{\gdef\cpget@key@page{/odd}}%
  \fi}

%               +-----------------+
%               |   C O M P A T   |
%               +-----------------+
% Easy setup, i.e., that of package options, is
% taken care of, if necessary.

\renewcommand\secdef[2]{%
  \@ifstar
    {\cpget@labelfalse
     #2}
    {\cpget@labeltrue
     \ifx#1\@chapter
       \if@mainmatter\else\cpget@labelfalse\fi
       \ifnum\cpgetl@chapter>\c@secnumdepth\cpget@labelfalse\fi
     \else\ifx#1\@part
       \ifnum\cpgetl@part>\c@secnumdepth\cpget@labelfalse\fi
     \fi\fi
     \let\ifcpget@toclabel\ifcpget@label
     \@dblarg{#1}}}
     
%               +-----------------+
%               |    loadonly     |
%               +-----------------+
% Easy setup, i.e., that of package options, is
% taken care of, if necessary.

\newtoks\loadclass@toks
\def\loadclasses{\the\loadclass@toks}
\loadclass@toks={
\newcommand\\cpgetlabel[1]{%
  \def\@seccntformat##1{#1}}

\expandafter\ifx\csname chapter\endcsname\relax

  \def\cpget@compatpart{\cpgetclass{\part}{part}\relax}

\else

  \def\cpget@compatchapter{%
    \def\@makechapterhead{%
      \cpget@labeltrue
      \if@mainmatter\else\cpget@labelfalse\fi
      \ifnum\cpgetl@chapter>\c@secnumdepth\cpget@labelfalse\fi
      \cpget@startargs\cpget@mkchap{chapter}}%
    \def\@makeschapterhead{%
      \cpget@labelfalse
      \if@mainmatter\else\cpget@labelfalse\fi
      \ifnum\cpgetl@chapter>\c@secnumdepth\cpget@labelfalse\fi
      \cpget@startargs\cpget@mkchap{chapter}}}

  \def\cpget@compatpart{\cpgetclass{\part}{page}\relax}

\fi

\def\cpget@@extract#1\@startsection#2#3#4#5#6#7#8{%
  \@tempskipa=#5
  \@tempskipb=#6
  \ifdim\@tempskipa<\z@
    \toks@{\cpgetspacing*#8{#4}}%
    \@tempskipa-\@tempskipa
  \else
    \toks@{\cpgetspacing#8{#4}}%
  \fi
  \@ifundefined{cpget@space}{}{%
    \cpget@assign\@tempskipa*\cpget@space\relax\beforetitleunit}%
  \ifdim\@tempskipb<\z@
    \if@tempswa
      \cpgetformat#8[runin]%
         {\cpget@fonts\cpget@sizes{#3}}{\@seccntformat{#2}}%
         {\z@}\cpget@passexplicit
    \else
      \cpgetformat#8[runin]%
         {#7}{\@seccntformat{#2}}%
         {\z@}\cpget@passexplicit
    \fi
    \@tempskipb-\@tempskipb
  \else
    \if@tempswa
      \cpgetformat#8%
        {\cpget@fil\cpget@fonts\cpget@sizes{#3}}{\@seccntformat{#2}}%
        {\z@}\cpget@passexplicit 
    \else
      \cpgetformat#8%
        {#7}{\@seccntformat{#2}}%
        {\z@}\cpget@passexplicit
    \fi
    \@ifundefined{cpget@space}{}{%
      \cpget@assign\@tempskipb*\cpget@space\relax\aftertitleunit}%
  \fi
  \edef\cpget@a{\the\toks@{\the\@tempskipa}{\the\@tempskipb}}
  \cpget@a}

\def\cpget@extract#1{%
  \ifx#1\@undefined
    \let#1\relax % Avoid error if undefined
  \fi
  \expandafter\in@\expandafter\@startsection\expandafter{#1}%
  \ifin@
    \expandafter\cpget@@extract#1#1%
  \else
    \PackageWarningNoLine{cpgetitle}%
      {Non standard sectioning command \string#1\MessageBreak
       detected. Using default spacing and no format}%
    \cpgetspacing*#1{\z@}{*3}{*2}%
  \fi}

\@tempswafalse

\ifx\cpget@fonts\@empty
  \def\cpget@fonts{\bfseries}
\else
  \@tempswatrue
\fi

\expandafter\ifx\csname cpget@sizes\endcsname\relax
  \gdef\cpget@sizes#1{\ifcase#1\relax\Huge\or\Large\or\large
       \or\normalsize\or\or\or\huge\fi}
\else
  \@tempswatrue
\fi

\expandafter\ifx\csname cpget@fil\endcsname\relax
  \let\cpget@fil\@empty
\else
  \@tempswatrue
\fi

\expandafter\ifx\csname cpget@case\endcsname\relax
  \let\cpget@case\@firstofone
\else
  \@tempswatrue
\fi

\if@tempswa

  \expandafter\ifx\csname chapter\endcsname\relax\else
   \cpgetformat\chapter[display]%
    {\@ifundefined{cpget@fil}{\raggedright}{\cpget@fil}\cpget@fonts\cpget@sizes6}
    {\@chapapp\space\thechapter}{.8\baselineskip}{\cpget@sizes\z@\cpget@passexplicit}
  \fi

\fi

\cpget@extract\section
\cpget@extract\subsection
\cpget@extract\subsubsection
\cpget@extract\paragraph
\cpget@extract\subparagraph

\let\cpget@extract\@undefined
\let\cpget@@extract\@undefined

\def\cpget@toplevel{part}

\expandafter\ifx\csname chapter\endcsname\relax

  \@namedef{cpgetl@part}{0}
  \cpgetclass{\section}{straight}[\part]

  \cpgetspacing*{\part}
    {\z@}
    {4ex}
    {3ex}

\else

  \let\cpget@save@mkchap\@makechapterhead
  \let\cpget@save@mkschap\@makeschapterhead

  \def\@makechapterhead#1{%
    \gdef\cpget@savemark{\chaptermark{#1}}%
    \cpget@save@mkchap{#1}%
    \@ifundefined{cpget@ps@chapter}{}%
      {\thispagestyle{\@nameuse{cpget@ps@chapter}}}}

  \def\@makeschapterhead#1{%
    \gdef\cpget@savemark{\chaptermark{#1}}%
    \cpget@save@mkschap{#1}%
    \@ifundefined{cpget@ps@chapter}{}%
      {\thispagestyle{\@nameuse{cpget@ps@chapter}}}}

  \@namedef{cpgetl@part}{-1}
  \@namedef{cpgetss@part}{chapter}
  \@namedef{cpgetl@chapter}{0}
  \cpgetclass{\section}{straight}[\chapter]

% The following is unoperant, unless when \chapter / \part
% format is redefined

  \cpgetspacing*{\part}
    {\z@}
    {\z@\@plus1fil}
    {\z@\@plus1fil}
    
  \cpgetspacing*\chapter
    {\z@}%
    {50\p@}%
    {\cpget@chapafter}%

\fi

\cpgetclass{\subsection}   {straight}[\section]
\cpgetclass{\subsubsection}{straight}[\subsection]
\cpgetclass{\paragraph}    {straight}[\subsubsection]
\cpgetclass{\subparagraph} {straight}[\paragraph]
}

\endinput

MIT License
-----------

Permission is hereby granted, free of charge, to any person obtaining a
copy of this software and associated documentation files (the
"Software"), to deal in the Software without restriction, including
without limitation the rights to use, copy, modify, merge, publish,
distribute, sublicense, and/or sell copies of the Software, and to
permit persons to whom the Software is furnished to do so, subject to
the following conditions:

The above copyright notice and this permission notice shall be included
in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY
CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,
TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.


