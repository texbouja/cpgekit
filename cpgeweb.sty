\def\filedate{2021/08/15}
\def\fileversion{v0.1alpha}
\def\fileauthor{Sadik Boujaida}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%% Adaptation de standalone.cls %%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%% Copyright (C) 2011-2017 by Martin Scharrer <martin@scharrer-online.de>
%% ---------------------------------------------------------------------------
%% This work may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, either version 1.3
%% of this license or (at your option) any later version.
%% The latest version of this license is in
%%   http://www.latex-project.org/lppl.txt
%% and version 1.3 or later is part of all distributions of LaTeX
%% version 2005/12/01 or later.
%%
%% This work has the LPPL maintenance status `maintained'.
%%
%% The Current Maintainer of this work is Martin Scharrer.
%%
%%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{cpgeweb}[cpgeweb package pour gestion de quiz]



\let\onlyifcpgeweb\@firstofone
\let\IfStandalone\@firstoftwo
\def\cpge@border@left{0.50001bp}
\let\cpge@border@right\cpge@border@left
\let\cpge@border@top\cpge@border@left
\let\cpge@border@bottom\cpge@border@left
\def\rem@bp#1bp\relax#2\@nnil{#1}%
\def\default@bp#1#2{%
    \begingroup
    \afterassignment\remove@to@nnil
    \dimen@ #2bp\relax\@nnil
    \expandafter
    \endgroup
    \expandafter
    \def\expandafter#1\expandafter{\the\dimen@}%
}
\def\cpge@readborder#1 #2 #3 #4 #5\@nnil{%
    \ifx\\#2#3#4\\%
        \default@bp\cpge@border@left{#1}%
        \let\cpge@border@right\cpge@border@left
        \let\cpge@border@top\cpge@border@left
        \let\cpge@border@bottom\cpge@border@left
    \else
        \ifx\\#4\\%
            \default@bp\cpge@border@left{#1}%
            \let\cpge@border@right\cpge@border@left
            \default@bp\cpge@border@top{#2}%
            \let\cpge@border@bottom\cpge@border@top
        \else
            \default@bp\cpge@border@left{#1}%
            \default@bp\cpge@border@bottom{#2}%
            \default@bp\cpge@border@right{#3}%
            \default@bp\cpge@border@top{#4}%
        \fi\fi
}%

\expandafter\ifx\csname ShellEscape\endcsname\relax
    \IfFileExists{shellesc.sty}{
        \RequirePackage{shellesc}
        \@ifpackagelater{shellesc}{2016/04/29}{
        }{
            \protected\def\ShellEscape{\immediate\write18 }
        }
    }{
        \protected\def\ShellEscape{\immediate\write18 }
    }
\fi
\expandafter\ifx\csname ifluatex\endcsname\relax
    \IfFileExists{ifluatex.sty}{\@firstoftwo}{\@secondoftwo}{%
        \RequirePackage{ifluatex}
    }{
        \begingroup
        \expandafter\ifx\csname directlua\endcsname\relax
            \endgroup
            \expandafter\let\csname ifluatex\expandafter\endcsname\csname iffalse\endcsname
        \else
            \endgroup
            \expandafter\let\csname ifluatex\expandafter\endcsname\csname iftrue\endcsname
        \fi
    }
\fi
\expandafter\ifx\csname ifpdf\endcsname\relax
    \IfFileExists{ifpdf.sty}{\@firstoftwo}{\@secondoftwo}{%
        \RequirePackage{ifpdf}
    }{
        \begingroup
        \expandafter\ifx\csname pdfoutput\endcsname\relax
            \endgroup
            \expandafter\let\csname ifpdf\expandafter\endcsname\csname iffalse\endcsname
        \else
            \endgroup
            \ifnum\pdfoutput<1
                \expandafter\let\csname ifpdf\expandafter\endcsname\csname iffalse\endcsname
            \else
                \expandafter\let\csname ifpdf\expandafter\endcsname\csname iftrue\endcsname
            \fi
        \fi
    }
\fi
\expandafter\ifx\csname ifxetex\endcsname\relax
    \IfFileExists{ifxetex.sty}{\@firstoftwo}{\@secondoftwo}{%
        \RequirePackage{ifxetex}
    }{
        \begingroup
        \expandafter\ifx\csname XeTeXrevision\endcsname\relax
            \endgroup
            \expandafter\let\csname ifxetex\expandafter\endcsname\csname iffalse\endcsname
        \else
            \endgroup
            \expandafter\let\csname ifxetex\expandafter\endcsname\csname iftrue\endcsname
        \fi
    }
\fi
\let\cpge@packageoptionslist\@packageoptionslist
\RequirePackage{xkeyval}
%\newif\ifcpge@noscorepattern\cpge@noscorepatterntrue
\newif\ifcpge@crop
\newif\ifcpge@multi
\newif\ifcpge@multido
\newif\ifcpge@varwidth
\newif\ifcpge@ignorerest
\newif\ifcpge@ignoreempty
\newif\ifcpge@tikz
\newif\ifcpge@convert
\def\cpge@pkgoption{%
    \define@key{CPGEWEB}%
}
\cpge@pkgoption{border}{%
    \cpge@readborder#1 {} {} {} {} \@nnil
}
\cpge@pkgoption{margin}{%
    \cpge@readborder#1 {} {} {} {} \@nnil
}
\def\cpge@boolean#1#2{%
    \cpge@boolorvalue{#1}{#2}%
    {\PackageError{cpgeweb}{Invalid value '#2' for boolean key '#1'}{}}%
}
\def\cpge@boolorvalue#1#2{%
    \begingroup
    \edef\@tempa{#2}%
    \def\@tempb{true}%
    \ifx\@tempa\@tempb
        \endgroup
        \csname cpge@#1true\endcsname
        \expandafter\@gobble
    \else
        \def\@tempb{false}%
        \ifx\@tempa\@tempb
            \endgroup
            \csname cpge@#1false\endcsname
            \expandafter\expandafter
            \expandafter\@gobble
        \else
            \endgroup
            \expandafter\expandafter
            \expandafter\@firstofone
        \fi\fi
}
%\setkeys{CPGEWEB}{pathtoquiz}

%\cpge@pkgoption{scorepattern}[false]{%
%	\cpge@boolean{noscorepattern}{#1}%
%}
\cpge@pkgoption{crop}[true]{%
    \cpge@boolean{crop}{#1}%
}
\setkeys{CPGEWEB}{crop}

\cpge@pkgoption{ignorerest}[true]{%
    \cpge@boolean{ignorerest}{#1}%
}
\cpge@pkgoption{ignoreempty}[true]{%
    \cpge@boolean{ignoreempty}{#1}%
}
\cpge@pkgoption{multi}[true]{%
    \cpge@boolorvalue{multi}{#1}{\cpge@multitrue\AtBeginDocument{\cpgewebenv{#1}}}%
}

\cpge@pkgoption{multido}[true]{%
    \cpge@boolean{multido}{#1}%
    \ifcpge@multido
        \setkeys{CPGEWEB}{multi=cpgemultido}%
    \fi
}
\setkeys{CPGEWEB}{multido}

\cpge@pkgoption{varwidth}[true]{%
    \cpge@boolorvalue{varwidth}{#1}{\cpge@varwidthtrue\def\cpge@width{#1}}%
    \ifcpge@varwidth
        \def\cpge@varwidth{\varwidth{\cpge@width}}%
        \def\cpge@endvarwidth{\endvarwidth}%
    \else
        \let\cpge@varwidth\@empty
        \let\cpge@endvarwidth\@empty
    \fi
}
\let\sa@varwidth\@empty
\let\sa@endvarwidth\@empty
\cpge@pkgoption{tikz}[true]{%
    \cpge@boolean{tikz}{#1}%
    \ifcpge@tikz
        \setkeys{CPGEWEB}{multi=tikzpicture,varwidth=false}%
    \fi
}
\setkeys{CPGEWEB}{tikz}

%\cpge@pkgoption{class}{%
%    \def\cpge@class{#1}%
%}
%\def\cpge@class{article}

\cpge@pkgoption{convert}[]{%
    \setkeys{CPGEWEB/convert}{true,#1}%
}

\cpge@pkgoption{disable@convert}[]{%
    \typeout{Disable conversion}
    \cpge@convertfalse
    \let\cpge@converttrue\relax
}
\def\cpge@convertoption{%
    \define@key{CPGEWEB/convert}%
}
\def\cpge@convertvar#1#2{%
    \define@key{CPGEWEB/convert}{#1}{%
        \@namedef{cpge@convert@#1}{##1}%
    }%
    \@namedef{cpge@convert@#1}{#2}%
}
\cpge@convertoption{true}[]{%
    \cpge@converttrue
}
\cpge@convertoption{false}[]{%
    \cpge@convertfalse
}
\cpge@convertoption{png}[]{%
    \setkeys{CPGEWEB/convert}{true,outext={.png}}%
}
\cpge@pkgoption{png}[]{%
    \setkeys{CPGEWEB/convert}{png,#1}%
}
\cpge@convertoption{realmainfile}[]{%
    \RequirePackage{currfile-abspath}%
    \getmainfile
    \let\cpge@convert@mainfile\themainfile
}
\cpge@convertoption{jpg}[]{%
    \setkeys{CPGEWEB/convert}{true,outext={.jpg}}%
}
\cpge@pkgoption{jpg}[]{%
    \setkeys{CPGEWEB/convert}{jpg,#1}%
}
\cpge@convertoption{gif}[]{%
    \setkeys{CPGEWEB/convert}{true,outext={.gif}}%
}
\cpge@pkgoption{gif}[]{%
    \setkeys{CPGEWEB/convert}{gif,#1}%
}
\cpge@convertoption{onfailure}{%
    \begingroup
    \edef\@tempa{#1}%
    \def\@tempb{error}%
    \ifx\@tempa\@tempb
        \endgroup
        \let\cpge@convert@failuremsg\PackageError
    \else
        \def\@tempb{warning}%
        \ifx\@tempa\@tempb
            \endgroup
            \let\cpge@convert@failuremsg\PackageWarning
        \else
            \def\@tempb{info}%
            \ifx\@tempa\@tempb
                \endgroup
                \let\cpge@convert@failuremsg\PackageInfo
            \else
                \def\@tempb{ignore}%
                \ifx\@tempa\@tempb
                    \endgroup
                    \def\cpge@convert@failuremsg##1##2##3{}%
                    \let\cpge@convert@notfoundmsg\@gobbletwo
                \else
                    \let\on@line\@empty
                    \PackageError{cpgeweb}{Invalid value '\@tempa' for the 'onfailure' option.\MessageBreak
                        Valid values: 'error', 'warning', 'info', 'ignore'}{}%
                    \endgroup
                \fi\fi\fi\fi
}
\let\cpge@convert@failuremsg\PackageWarning
\let\cpge@convert@notfoundmsg\PackageWarning
\cpge@convertoption{defgsdevice}{%
    \cpge@defgsdevice#1\relax\relax
}
\def\cpge@defgsdevice#1#2{%
    \@namedef{cpge@gsdevice@#1}{#2}%
}
\@namedef{cpge@gsdevice@.jpg}{jpeg}%
\@namedef{cpge@gsdevice@.png}{png16m}%
\cpge@convertoption{command}{%
    \def\cpge@convert@command{#1}%
}
\cpge@convertoption{pdf2svg}[]{%
    \def\cpge@convert@command{pdf2svg \infile\space\outfile}%
    \cpge@convertvar{outext}{.svg}
}
\cpge@convertoption{imagemagick}[]{%
    \def\cpge@convert@command{\convertexe\space -density \density\space -units PixelsPerInch \infile\space \ifx\size\empty\else -resize \size\fi\space -quality 90 \outfile}%
    \let\cpge@convert@pageoffset\m@ne
}
\cpge@convertoption{ghostscript}[]{%
    \def\cpge@convert@command{\gsexe\space -dSAFER -dBATCH -dNOPAUSE -sDEVICE=\gsdevice\space -r\density\space -sOutputFile=\outfile\space \infile}%
    \let\cpge@convert@pageoffset\z@
}
\cpge@convertvar{latexoptions}{ -shell-escape }
\cpge@convertvar{subjobname}{\jobname}
\cpge@convertvar{mainfile}{\jobname}
\cpge@convertvar{quote}{}
\let\cpge@convert@quote\relax
\cpge@convertvar{size}{}
\cpge@convertvar{inname}{\subjobname}
\cpge@convertvar{infile}{\inname\inext}
\cpge@convertvar{outext}{.png}
\cpge@convertvar{imgdir}{\jobname-\expandafter\@gobble\cpge@convert@outext}
\cpge@convertvar{outname}{\cpge@convert@imgdir/}
\cpge@convertvar{outfile}{\outname\ifcpge@multi\cpge@multi@pagemark\fi\outext}
\def\cpge@multi@pagemark{\percent0d}%
\cpge@convertvar{density}{300}
\cpge@convertvar{gsdevice}{%
    \expandafter\ifx\csname cpge@gsdevice@\outext\endcsname\relax
        \expandafter\@gobble\outext
    \else
        \csname cpge@gsdevice@\outext\endcsname
    \fi
}
\ifluatex
    \cpge@convertvar{latex}{lualatex}
    \cpge@convertvar{inext}{.pdf}
    \cpge@convertvar{precommand}{}
    \setkeys{CPGEWEB/convert}{imagemagick}
\else
    \ifpdf
        \cpge@convertvar{latex}{pdflatex}
        \cpge@convertvar{inext}{.pdf}
        \cpge@convertvar{precommand}{}
        \setkeys{CPGEWEB/convert}{imagemagick}
    \else
        \ifxetex
            \cpge@convertvar{latex}{xelatex}
            \cpge@convertvar{inext}{.pdf}
            \cpge@convertvar{precommand}{}
            \setkeys{CPGEWEB/convert}{imagemagick}
        \else
            \cpge@convertvar{latex}{latex}
            \cpge@convertvar{inext}{.ps}
            \cpge@convertvar{precommand}{dvips \subjobname.dvi}
            \setkeys{CPGEWEB/convert}{ghostscript}
        \fi\fi\fi

\def\cpge@convertvar#1#2{%
    \define@key{CPGEWEB/convert}{#1}{%
        \@namedef{cpge@convert@#1}{##1}%
    }%
    \@namedef{cpge@convert@#1}{#2}%
}
\begingroup
\ifluatex
    \csname @tempswa\directlua{
        if os.type == "windows" then
        tex.sprint("true")
        else
        tex.sprint("false")
        end
    }\endcsname
\else
    \IfFileExists{/dev/null}{\@tempswafalse}{\@tempswatrue}%
\fi
\if@tempswa
    \endgroup
    \cpge@convertvar{convertexe}{imgconvert}
    \cpge@convertvar{gsexe}{gswin32c}
\else
    \endgroup
    \cpge@convertvar{convertexe}{convert}
    \cpge@convertvar{gsexe}{gs}
\fi
\newcommand*\cpgewebenv[1]{%
    \begingroup
    \edef\@tempa{\endgroup\noexpand\@for\noexpand\@tempa:=\zap@space#1 \@empty}%
    \@tempa\do{\expandafter\@cpgewebenv\expandafter{\@tempa}}%
    \setkeys{CPGEWEB}{multi}%
}
\@onlypreamble\cpgewebenv
\newcommand*{\cpgesetupweb}{\setkeys{CPGEWEB}}
\expandafter\cpgesetupweb\expandafter{\convert@options}
\let\@cpgewebenv\@gobble
\newcount\cpge@internal
\newcounter{cpgepage}
\let\cpgeweb\empty
\let\endcpgeweb\relax
\def\cpge@width{\linewidth}
\InputIfFileExists{cpgeweb.cfg}{}{}
\begingroup
\def\@tempa{\endgroup\setkeys*{CPGEWEB}}
\expandafter\expandafter\expandafter\@tempa
\expandafter\expandafter\expandafter{\csname opt@cpgeweb.sty\endcsname}
\let\@packageoptionslist\XKV@rm
\disable@keys{CPGEWEB}{crop,ignorerest}
\AtBeginDocument{%
    \disable@keys{CPGEWEB}{multi}%
}
\ifcpge@convert\cpge@mkdir{\cpge@convert@imgdir}\fi%

\ifcpge@ignorerest
    \def\cpge@startignore{\cpge@boxit}
\else
    \let\cpge@startignore\relax
\fi
\ifcpge@ignorerest
    \def\cpge@stopignore{\endcpge@boxit}
\else
    \let\cpge@stopignore\relax
\fi
%\ifcpge@multido
\RequirePackage{multido}
\let\cpge@orcpge@multido@\multido@
\renewcommand{\multido@}[6]{%
    \cpge@stopignore
    \cpge@orcpge@multido@{#1}{#2}{#3}{#4}{#5}{%
        \cpge@startignore
        \begin{cpgemultido}%
            \let\multido@\cpge@orcpge@multido@
            #6%
        \end{cpgemultido}%
        \cpge@stopignore
    }%
    \cpge@startignore
}
%\fi
\ifluatex
    \RequirePackage{luatex85}
    \RequirePackage{pdftexcmds}
\fi
\ifcpge@convert
    \ifx\cpge@convert@quote\relax
        \begingroup
        \@tempswafalse
        \expandafter\ifx\csname pdftexbanner\endcsname\relax
            \@tempswatrue
        \else
            \def\MiKTeX{MiKTeX}
            \@onelevel@sanitize\MiKTeX
            \expandafter\def\expandafter\testmiktex\expandafter#\expandafter1\MiKTeX#2\relax{%
                \ifx\empty#2\empty
                    \@tempswafalse
                \else
                    \@tempswatrue
                \fi
            }
            \expandafter\expandafter
            \expandafter\testmiktex\expandafter\pdftexbanner\MiKTeX\relax\relax
        \fi
        \expandafter
        \endgroup
        \if@tempswa
            \def\cpge@convert@quote{"}
        \else
            \def\cpge@convert@quote{'}
        \fi
    \fi
\fi

\RequirePackage{tikz}

\newcounter{quiz}
\cpgedefcounter{ch@ice}{}[quiz]
\cpgedefcounter{fake@choice}{}[quiz]

\ifcpge@crop
    \newbox\cpge@box
    \pagestyle{empty}
    \hoffset=-72.27pt
    \voffset=-72.27pt
    \topmargin=0pt
    \headheight=0pt
    \headsep=0pt
    \marginparsep=0pt
    \marginparwidth=0pt
    \footskip=0pt
    \marginparpush=0pt
    \oddsidemargin=0pt
    \evensidemargin=0pt
    \topskip=0pt
    \textheight=\maxdimen
    \def\cpge@boxit{%
        \setbox\cpge@box\hbox\bgroup\color@setgroup\cpge@varwidth
    }%
    \def\endcpge@boxit{%
        \cpge@endvarwidth\color@endgroup\egroup
    }%
    \renewenvironment{cpgeweb}{%
        \csuse{ifcpge@multi}
        \cpge@startignore
        \csuse{else}
        \cpge@boxit
        \csuse{fi}
    }{%
        \csuse{ifcpge@multi}
        \cpge@stopignore
        \csuse{else}
        \endcpge@boxit
        \cpge@handlebox
        \csuse{fi}
    }
    \ifcpge@multi\else
        \cpge@ignorerestfalse
    \fi
    \ifcpge@ignorerest
        \def\@cpgewebenv#1{%
            \expandafter\ifx\csname cpge@orcpge@#1\endcsname\relax
                \expandafter\let\csname cpge@orcpge@#1\expandafter\endcsname\csname #1\endcsname
                \expandafter\let\csname cpge@orcpge@end#1\expandafter\endcsname\csname end#1\endcsname
            \fi
            \expandafter\def\csname #1\endcsname{%
                \ifnum\cpge@internal=0
                    \addtocounter{cpgepage}\@ne
                    \edef\@tempa{\endgroup
                        \noexpand\endcpge@boxit
                        \begingroup
                        \def\noexpand\@currenvir{\@currenvir}%
                        \def\noexpand\@currenvline{\@currenvline}%
                    }%
                    \@tempa
                    \cpge@boxit
                \fi
                \advance\cpge@internal\@ne
                \csname cpge@orcpge@#1\endcsname
            }%
            \expandafter\def\csname end#1\endcsname{%
                \csname cpge@orcpge@end#1\endcsname
                \advance\cpge@internal\m@ne
                \ifnum\cpge@internal=0
                    \endcpge@boxit
                    \cpge@handlebox
                    \aftergroup\cpge@boxit
                \fi
            }%
        }%
    \else
        \def\@cpgewebenv#1{%
            \expandafter\ifx\csname cpge@orcpge@#1\endcsname\relax
                \expandafter\let\csname cpge@orcpge@#1\expandafter\endcsname\csname #1\endcsname
                \expandafter\let\csname cpge@orcpge@end#1\expandafter\endcsname\csname end#1\endcsname
            \fi
            \expandafter\def\csname #1\endcsname{%
                \ifnum\cpge@internal=0
                    \addtocounter{cpgepage}\@ne
                    \cpge@boxit
                \fi
                \advance\cpge@internal\@ne
                \csname cpge@orcpge@#1\endcsname
            }%
            \expandafter\def\csname end#1\endcsname{%
                \csname cpge@orcpge@end#1\endcsname
                \advance\cpge@internal\m@ne
                \ifnum\cpge@internal=0
                    \endcpge@boxit
                    \cpge@handlebox
                \fi
            }%
        }%
    \fi
    \def\cpge@handlebox{%
        \ifcase
            0%
            \ifcpge@ignoreempty
                \ifdim\wd\cpge@box=\z@
                    \ifdim\ht\cpge@box=\z@
                        \ifdim\dp\cpge@box=\z@
                            1%
                        \fi\fi\fi
            \fi
            \relax
            \sbox\cpge@box{%
                \hskip\cpge@border@left
                \@tempdima=\ht\cpge@box
                \advance\@tempdima\cpge@border@top\relax
                \ht\cpge@box=\@tempdima
                \@tempdima=\dp\cpge@box
                \advance\@tempdima\cpge@border@bottom\relax
                \dp\cpge@box=\@tempdima
                \raise\dp\cpge@box
                \box\cpge@box
                \hskip\cpge@border@right
            }%
            \cpge@placebox
        \fi
    }
    \ifcase0%
        \ifpdf\else\ifluatex\else\ifxetex\else 1\fi\fi\fi
        \relax
        \def\cpge@placebox{%
            \newpage
            \ifluatex
                \ifnum\luatexversion<85
                    % LuaLaTeX < 0.85 does define the PDF-specific globals.
                    \global\pdfpagewidth=\wd\cpge@box
                    \global\pdfpageheight=\ht\cpge@box
                \else
                    % LuaLaTeX >= 0.85 doesn't define the PDF-specific globals.
                    \global\pagewidth=\wd\cpge@box
                    \global\pageheight=\ht\cpge@box
                \fi
            \else
                % Not LuaLaTeX at all, so still need this.
                \global\pdfpagewidth=\wd\cpge@box
                \global\pdfpageheight=\ht\cpge@box
            \fi
            \global\paperwidth=\wd\cpge@box
            \global\paperheight=\ht\cpge@box
            \global\hsize=\wd\cpge@box
            \global\vsize=\ht\cpge@box
            \global\@colht=\ht\cpge@box
            \global\@colroom=\ht\cpge@box
            \noindent\usebox\cpge@box
            \newpage
        }
    \else
        \def\cpge@placebox{%
            \global\paperwidth=\wd\cpge@box
            \global\paperheight=\ht\cpge@box
            \global\@colht=\maxdimen
            \global\@colroom=\maxdimen
            \global\hsize=\maxdimen
            \global\vsize=\maxdimen
            \cpge@papersize
            \ifcpge@multi
                \begingroup
                \@tempdima0.99626\paperwidth
                \@tempdimb0.99626\paperheight
                \edef\@tempc{\strip@pt\@tempdima}%
                \edef\@tempd{\strip@pt\@tempdimb}%
                \advance\@tempdima by .998pt
                \advance\@tempdimb by .998pt
                \def\strip@float##1.##2\relax{##1}%
                \edef\@tempa{\expandafter\strip@float\the\@tempdima\relax}%
                \edef\@tempb{\expandafter\strip@float\the\@tempdimb\relax}%
                \special{ps::%
                \@percentchar\@percentchar PageBoundingBox: 0 0 \@tempa\space\@tempb^^J%
                \@percentchar\@percentchar HiResPageBoundingBox: 0 0 \@tempc\space\@tempd^^J%
                \@percentchar\@percentchar BeginPageSetup^^J%
                << /PageSize [\@tempc\space\@tempd]
                >> setpagedevice^^J%<<
                0 0 bop^^J%
                \@percentchar\@percentchar EndPageSetup}%
                \endgroup
            \fi
            \topskip=0pt
            \noindent\cpge@ps@content
            \newpage
        }
        \def\cpge@ps@content{%
            \noindent\usebox\cpge@box
            \global\def\cpge@ps@content{%
                \@tempdima\cpge@yoffset
                \advance\@tempdima-\topskip
                \dp\cpge@box\z@
                \ht\cpge@box\z@
                \noindent\lower\@tempdima\copy\cpge@box
            }%
        }
        \def\cpge@papersize{%
            \global\let\cpge@papersize\relax
            \global\cpge@yoffset=\paperheight
            \global\setbox\@begindvibox\vbox{%
                \special{papersize=\the\paperwidth,\the\paperheight}%
                \special{ps::%
                    \@percentchar\@percentchar HiResBoundingBox: 0 0 \the\paperwidth\space\the\paperheight^^J%
                }%
                \unvbox\@begindvibox
                \special{papersize=\the\paperwidth,\the\paperheight}%
            }%
        }
        \newlength\cpge@yoffset
    \fi
\fi

\expandafter\ifx\csname cpge@internal@run\endcsname\relax\else
    \AtEndDocument{%
        \immediate\write\@mainaux{\noexpand\@gobbletwo\noexpand\cpge@multi@setnumpages{\arabic{cpgepage}}}%
    }
    \cpge@convertfalse
\fi
\ifcpge@convert
    \let\cpge@convert@stop\stop
    \begingroup
    \let\on@line\@gobble
    \def\cpge@convert#1{%
    \IfFileExists{\outfile}{%
        \edef\filemodbefore{\csname pdf\ifluatex @\fi filemoddate\endcsname{\outfile}}%
    }{%
        \IfFileExists{\outname\outext}{%
            \edef\filemodbefore{\csname pdf\ifluatex @\fi filemoddate\endcsname{\outname\outext}}%
        }{%
            \IfFileExists{\outname-0\outext}{%
                \edef\filemodbefore{\csname pdf\ifluatex @\fi filemoddate\endcsname{\outname-0\outext}}%
            }{%
                \IfFileExists{\outname-1\outext}{%
                    \edef\filemodbefore{\csname pdf\ifluatex @\fi filemoddate\endcsname{\outname-1\outext}}%
                }{%
                    \def\filemodbefore{}%
                }}}}%
    \edef\@tempa{\jobname}%
    \edef\@tempb{\cpge@convert@subjobname}%
    \@onelevel@sanitize\@tempa
    \@onelevel@sanitize\@tempb
    \@tempswafalse
    \ifx\@tempa\@tempb
        \@tempswatrue
        \edef\infile@filemodbefore{\csname pdf\ifluatex @\fi filemoddate\endcsname{\infile}}%
    \else
        \global\let\cpge@convert@stop\relax
    \fi
    \ShellEscape{\cpge@convert@latex\space\cpge@convert@latexoptions\space
        -jobname \cpge@convert@quote\cpge@convert@subjobname\cpge@convert@quote\space
        \cpge@convert@quote\string\expandafter\string\def\string\csname\space
        cpge@internal@run\string\endcsname{1}\string\input{\cpge@convert@mainfile}\cpge@convert@quote}%
    \def\cpge@multi@numpages{0}%
    \begingroup
    \IfFileExists{\cpge@convert@subjobname.aux}{\@tempswatrue}{\@tempswafalse}%
    \if@tempswa
        \newread\cpge@read
        \def\@tempa##1\cpge@multi@setnumpages##2##3\@nnil{%
            \def\@tempc{##2}%
            \ifx\@tempc\@nnil\else
                \gdef\cpge@multi@numpages{##2}%
            \fi
        }%
        \endlinechar=\m@ne
        \immediate\openin\cpge@read=\cpge@convert@subjobname.aux\relax
        \loop\unless\ifeof\cpge@read
            \read\cpge@read to\@tempb
            \expandafter\@tempa\@tempb\cpge@multi@setnumpages\@nil\@empty\@nnil
            \repeat
            \immediate\closein\cpge@read
        \fi
        \endgroup
        \@tempcnta\cpge@multi@numpages\relax
        \advance\@tempcnta\cpge@convert@pageoffset\relax
        \ifnum\@tempcnta=\z@
            \def\cpge@multi@pagemark{}%
            \edef\cpge@lastoutfile{\outfile}%
        \else
            \@tempcntb\z@
            \loop\ifnum\@tempcnta>0
                \advance\@tempcntb\@ne
                \divide\@tempcnta by 10\relax
                \repeat
                \edef\cpge@multi@pagemark{\percent0\the\@tempcntb d}%
                \begingroup
                \def\cpge@multi@pagemark{-\the\@tempcnta}%
                \xdef\cpge@lastoutfile{\outfile}%
                \endgroup
            \fi
            \if@tempswa
                \edef\infile@filemodafter{\csname pdf\ifluatex @\fi filemoddate\endcsname{\infile}}%
                \ifx\infile@filemodbefore\infile@filemodafter
                    \global\let\cpge@convert@stop\relax
                \fi
            \fi
            \edef\cpge@convert@precommand{\cpge@convert@precommand}%
            \ifx\cpge@convert@precommand\@empty\else
                \ShellEscape{\cpge@convert@precommand}%
            \fi
            \ShellEscape{\cpge@convert@command}%
            \@tempswafalse
            \IfFileExists{\cpge@lastoutfile}{%
                \edef\filemodafter{\csname pdf\ifluatex @\fi filemoddate\endcsname{\cpge@lastoutfile}}%
                \ifx\filemodbefore\filemodafter
                    \expandafter\ifx\csname pdf\ifluatex @\fi filemoddate\endcsname\relax\else
                        \cpge@convert@failuremsg{cpgeweb}{#1}{}%
                    \fi
                \else
                    \typeout{Package cpgeweb:^^JOutput written on \cpge@lastoutfile.}%
                \fi
            }{%
                \cpge@convert@failuremsg{cpgeweb}{#1}{}%
            }%
            }
            \let\subjobname\cpge@convert@subjobname
            \let\mainfile\cpge@convert@mainfile
            \let\infile\cpge@convert@infile
            \let\inext\cpge@convert@inext
            \let\inname\cpge@convert@inname
            \let\gsdevice\cpge@convert@gsdevice
            \let\convertexe\cpge@convert@convertexe
            \let\gsexe\cpge@convert@gsexe
            \let\density\cpge@convert@density
            \let\size\cpge@convert@size
            \let\outext\cpge@convert@outext
            \let\outname\cpge@convert@outname
            \let\outfile\cpge@convert@outfile
            \let\percent\@percentchar
            \let\quote\cpge@convert@quote
            \edef\cpge@shellescape{%
                \ifluatex
                    \directlua{tex.write(status.shell_escape or 2)}%
                \else\ifxetex
                        \the\shellescape
                    \else
                        \expandafter\ifx\csname pdfshellescape\endcsname\relax
                            0%
                        \else
                            \the\pdfshellescape
                        \fi\fi\fi
            }%
            \ifcase\cpge@shellescape\relax% 0
                \cpge@convert@failuremsg
                {cpgeweb}{Shell escape disabled! Cannot convert file '\infile'.}{}%
                \global\let\cpge@convert@stop\relax
            \or% 1
                \PackageWarning{cpgeweb}{conversion begins}{}%
                \cpge@convert{successful Conversion!\MessageBreak
                    Images files are in \cpge@convert@imgdir}%
            \else% 2 or 3
                \cpge@convert{Conversion failed! Please ensure that shell escape\MessageBreak
                    is enabled (e.g. use '-shell-escape').}%
            \fi
            \endgroup
            \expandafter\cpge@convert@stop
        \fi

        %\begingroup
        %\toks@\expandafter{%
        %    \document
        %    \cpge@cls@afterbegindocument
        %}
        %\xdef\document{\the\toks@}%
        %\toks@\expandafter{%
        %    \expandafter
        %    \cpge@cls@beforeenddocument
        %    \enddocument
        %}
        %\xdef\enddocument{\the\toks@}%
        %\endgroup
        %\def\cpge@cls@afterbegindocument{\cpgeweb\ignorespaces}
        %\def\cpge@cls@beforeenddocument{\ifhmode\unskip\fi\endcpgeweb}




        %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
        %%%%%%%%%%%% Les ajouts propres à CPGEWEB %%%%%%%%%%%%%
        %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

        \cpgedefcounter{quiz}{}
        \cpgedefcounter{ch@ice}{}[quiz]
        \cpgedefcounter{rigid@choice}{}[quiz]
        \newcounter{imgcnt}
        \RequirePackage{cpgecolor}

        \pgfdeclarelayer{background}
        \pgfdeclarelayer{foreground}
        \pgfsetlayers{background,main,foreground}
        \tikzset{ifvaluetf/.code n args =
                {3}{\IfValueTF{#1}{\pgfkeysalso{#2}}{\pgfkeysalso{#3}}}
        }

        \def\mlform#1{\formule{$\begin{multlined}#1\end{multlined}$}}

        \def\cpgesetupnullify#1{\cpgesetup{#1/.is family, #1/.unknown/.code=\relax}}
        \cpgesetupnullify{geometry}
        \cpgesetupnullify{tcb}
        \cpgesetupnullify{devoir}
        \cpgesetupnullify{problem}

        \cpgesetup[theme]{%
            dark/.is if=dark,
            colors/.code=\pgfkeysalso{/cpge/colors/.cd,#1},
            font/.style={},
            rm/.style={},
            sf/.style={},
            .unknown/.code={}
        }

        \DeclareDocumentCommand\cpgetheme{O{} m}{%
            \cpgesetup[theme]{#1}
            %\cpgefont{fira}
            \IfFileExists{#2web.sty}
            {\AtEndPreamble{\RequirePackage{#2web}}}{}%
            \reloadthecolors%
        }
        \DeclareDocumentCommand\cpgegeometry{om}{}



        %%%% Mécanisme de désactivation des environnements à ignorer


        \tikzset{page decoration/.style={%
                    fill=backcol,
                    draw=strokecol,
                    line width=20pt,
                    rounded corners= 20pt
                }
        }
        \tikzset{question style/.style={%
                    font=\fontsize{32pt}{32pt}\bfseries,
                    text=strokecol, xshift=1cm, text width=1cm,
                    align=left, yshift=-.8cm
                }
        }
        \tikzset{title geometry/.style={%
                    text width=.7\imagewidth,
                    align=flush center,
                }}
        \def\TitleFont{\fontsize{24pt}{24pt}\firaextrabold\scshape}
        \def\SubTitleFont{\fontsize{16}{18}\firasemibold}
        \tikzset{title style/.style={%
                    font=\TitleFont,
                    text = titletextcol,
                }
        }
        \tikzset{subtitle style/.style={%
                    font=\SubTitleFont,
                    text = strokecol,
                }
        }
        \long\def\title@format#1#2{%
            \null\hfill
            \begin{tikzpicture}
                \node (title) [title geometry, title style] {#1};
                \ifblank{#2}{}
                {\ifblank{#1}
                    {\node (subtitle) at (title.base) [title geometry, subtitle style] {#2};}
                    {\node (subtitle) at ([yshift=-1.4ex]title.south) [title geometry, subtitle style, anchor=north] {(#2)};}
                }
            \end{tikzpicture}%
            \hfill\null%
        }
        \newcommand\cpgetitleformat[1]{\long\def\title@format##1##2{#1}}
        \cpgesetup[webenv]{
            before/.store in=\webenv@prehook,
            image width/.code= \imagewidth#1,
            image height/.code = \tikzset{minimum height=#1\imagewidth},
            top skip/.store in=\cpge@topskip,
            bottom skip/.store in=\cpge@bottomskip,
            foot skip/.store in=\cpge@footskip,
            head height/.store in=\cpge@headheight,
            top skip=1.5cm, bottom skip=1.5cm, foot skip=14pt, head height=30pt,
            page decoration code/.store in=\page@deco,
            add decoration code/.store in=\inner@deco,
            reset decoration style/.store in=\tikz@opts,
            .unknown/.code=\relax
        }
        \def\tikz@opts{}
        \NewDocumentEnvironment{webenv}{m O{} D(){} d<> +b}{%
            \cpgesetup[webenv]{#2}%
            \csuse{webenv@prehook}%
            \stepcounter{imgcnt}%
            \long\def\titlelabel{#1}%
            \long\def\titletext{#3}%
            \set@defaultforlistsinsideunite%
            \begin{tikzpicture}
                \begin{pgfonlayer}{main}
                    \begingroup\edef\cpge@tmpa{\endgroup%
                        \noexpand\node (page)
                        [inner sep=0, outer sep=0, text width=\noexpand\imagewidth, \expandonce\tikz@opts]}
                    \cpge@tmpa
                    {
                        \tikzset{minimum height=0}%
                        \vrule width\z@ height\cpge@headheight depth\z@\par\vskip-\baselineskip%
                        \begingroup\title@format{#1}{#3}\endgroup\ifhmode\par\fi%
                        \vskip\cpge@topskip plus 1fil%
                        \fontsize{16pt}{20pt}\selectfont\hfill%
                        \minipage{\imagewidth-32pt}%
                        \flushleft%
                        #5
                        \fi@%
                        \endminipage%
                        \hfill\null\par%
                        \vskip\cpge@bottomskip plus 1fill%
                        \vrule width\z@ height\cpge@footskip depth\z@%
                    };
                    \ifdef\inner@deco
                    {\begin{scope}[overlay]\inner@deco\end{scope}}{}
                \end{pgfonlayer}
                \begin{pgfonlayer}{background}
                    \begin{scope}[overlay, minimum height=0]
                        \clip (page.north west) rectangle (page.south east);
                        \fill [overlay, backcol] (page.north west) rectangle (page.south east);
                        \page@deco%
                    \end{scope}
                \end{pgfonlayer}%
            \end{tikzpicture}%
        }{\closeunite}
        \NewDocumentEnvironment{notations}{}{%
            \cpgesetdeco{enumi}{\color{strokecol}\xsquare}
            \webenv{Notations}
        }{\endwebenv}

        \newcommand\cpgenewwebenv[3][]{
            \ifblank{#1}
            {\csdef{#2}{\webenv{#3}}}
            {\csdef{#2}{\cpgesetup[webenv]{#1}\webenv{#3}}}
            \cslet{end#2}\endwebenv
        }
        \cpgenewwebenv[before=\hideproof, image height=.75]{theo}{Théorème}
        \cpgenewwebenv[before=\hideproof, image height=.75]{prop}{Proposition}
        \cpgenewwebenv[before=\hideproof, image height=.75]{coro}{Corollaire}
        \cpgenewwebenv[before=\hideproof, image height=.75]{lemm}{Lemme}
        \cpgenewwebenv[before=\hideproof, image height=.75]{ppte}{Propriétés}
        \cpgenewwebenv[before=\hidesolution, image height=.75]{exer}{Exercice}
        \cpgenewwebenv{remas}{Remarques}
        \cpgenewwebenv{defi}{Définition}
        \newenvironment{genthm}[2][]{
            \cpgesetup[webenv]{image height=.75,#1}%
            \webenv{#2}
        }{\endwebenv}
        \newenvironment{image}[1][]{
            \cpgesetup[webenv]{tikz options=#1}%
            \webenv{}
        }{\endwebenv}
        \def\hideproof{\def\proof{\let\fi@\fi\iffalse}}
\def\hidesolution{\def\solution{\let\fi@\fi\iffalse}}
\let\fi@\relax
\begingroup
\def\do#1{\xtrimspaces{#1},}
\xdef\cpgecomment@list{\expandafter\docsvlist\expandafter{\cpgecomment@list}}
\endgroup


%%%%% Cette partie est une version adaptée du fichier xcomment.sty %%%
\newif\ifcpgeincluded
\def\newcpgecomment{\@ifnextchar [{\@newcpgecommentwitharg}{\@newcpgecomment}}
\def\@newcpgecomment#1{%
    \expandafter\def\csname #1\endcsname##1{\@cpgecomment{#1}{##1}}}%
\def\@newcpgecommentwitharg[#1]#2{%
    \expandafter\def\csname #2\endcsname{\@cpgecomment{#2}{#1}}}
\newcpgecomment{cpgecomment}
\def\envirsep{\par}
\def\rescanfile#1{\def\@rescanfile{#1}}
\rescanfile{\jobname.tmp}
\def\norescanfile{\let\@rescanfile\relax}
\def\@nofloat#1{\hrule height\z@\nobreak\vfill\vbox\bgroup\def\@captype{#1}}
\def\end@nofloat{\egroup\nobreak\vfill\nobreak\hrule height\z@\medbreak}
\def\nofloat#1{\@for\@tempa:=#1\do{\@namedef{#1}{\@nofloat{#1}}%
        \@namedef{end#1}{\end@nofloat}}}
\def\cpge@makeother#1{%
    \ifnum\the\catcode`#1=0\catcode`#112%
    \else \ifnum\the\catcode`#1=1\catcode`#112%
        \else \ifnum\the\catcode`#1=2\catcode`#112%
            \else \ifnum\the\catcode`#1=6\catcode`#112%
                \fi\fi\fi\fi\relax}
\newwrite\tokout
\newread\tokin
\def\rescan#1{%
    \ifx\@rescanfile\relax\else
        \ifx\@rescanfile\@empty #1{}\else
            \immediate\openout\tokout=\@rescanfile
            \immediate\write\tokout{{\the#1}\relax}%
            \immediate\closeout\tokout
            \openin\tokin=\@rescanfile
            \read\tokin to\@tempd
            \closein\tokin
            \expandafter#1\@tempd%
        \fi\fi}
\def\@cpgecomment#1#2{%
    \ifx\@preamblecmds\@notprerr
        \def\cpge@csname{#1}%
        \edef\cpge@envirlist{#2}%
        \ifx\cpge@envirlist\@empty \@bsphack \else
            \begingroup
            \def\@envirsep{}%
            \@ifundefined{normal@begin}{\let\normal@begin\begin}{}%
            \@ifundefined{normal@end}{\let\normal@end\end}{}%
            \def\begin##1{\do@begin{##1}\normal@begin{##1}}%
            \def\end##1{\normal@end{##1}\do@end}%
            \def\do@begin##1{\@ifundefined{##1}{}{\def\do@end{}}}%
            \let\do@end\cpge@begin
        \fi
        \let\next\cpge@begin
    \else
        \expandafter\@temptokena\expandafter{\document\@cpgecomment{@@@}{#2}}%
        \edef\document{\the\@temptokena}%
        \let\next\relax
    \fi
    \next}
\def\end@cpgecomment{\ifx\cpge@envirlist\@empty \@esphack \else \endgroup \fi}%
\def\cpge@begin{%
    \begingroup
    \let\do\cpge@makeother
    \dospecials
    \ifx\cpgecommentchar\@empty\else
        \expandafter\catcode\expandafter`\cpgecommentchar=14
    \fi
    \catcode`\^^M\active
    \cpgecomment@}
\def\cpgecommentchar{\%}
\begingroup
\catcode`\!=12
\catcode`\[=12
    \catcode`\]=12
\catcode`\"=12
\lccode`\!=`\\
\lccode`\[=`\{
    \lccode`\]=`\}
\lccode`\"=`\%
\catcode`\~=\active
\lccode`\~=`\^^M
\lowercase{
\gdef\cpgecomment@#1~{\cpgecomment@@#1\@nnil!\@nil}
\gdef\cpgecomment@@#1!{\cpgecomment@@@}
\gdef\cpgecomment@@@#1\@nil{%
    \def\@tempa{#1}%
    \ifx\@tempa\@empty
        \let\next\cpgecomment@
    \else
        \def\next{\cpgecomment@@#1\@nil}%
        \@testtrue
        \cpge@checkbegin#1\relax begin[]\relax\relax
        \if@test
            \cpge@checkend#1\relax end[]\relax\relax
            \if@test
                \cpge@checkinput#1\relax input[]\relax\relax
                \if@test
                    \cpge@checkinclude#1\relax include[]\relax\relax
                    \if@test
                        \cpge@checkcpgeincludeweb#1\relax cpgeincludeweb[]\relax\relax
                        \if@test
                            \cpge@checkendinput#1\relax endinputss\relax\relax
                        \fi\fi\fi\fi\fi\fi
    \next}
\gdef\cpge@checkbegin#1begin[#2]#3\relax#4\relax{%
    \def\@tempa{#1}%
    \ifx\@tempa\@empty
        \def\@tempa{#2}%
        \@for\@tempb:=\cpge@envirlist\do{%
            \ifx\@tempa\@tempb\def\next{\cpge@end{#2}#3\@nil}\fi}%
    \fi}
\gdef\cpge@checkend#1end[#2]#3\relax#4\relax{%
    \def\@tempa{#1}%
    \ifx\@tempa\@empty
        \@testfalse
        \def\@tempa{#2}\def\@tempb{document}%
        \ifx\@tempa\@tempb
            \def\next{%
                \ifcpgeincluded
                    \def\next{\global\cpgeincludedfalse\endinput}%
                \else
                    \def\next{\endgroup\end@cpgecomment\end{document}}%
                \fi%
                \next}%
        \else
            \ifx\@tempa\cpge@csname
                \def\next{\end@@cpgecomment{#2}#3\@nil}%
            \fi\fi\fi}
\gdef\cpge@checkinput#1input[#2]#3\relax#4\relax{%
    \def\@tempa{#1}%
    \ifx\@tempa\@empty
        \def\next{\expandafter\cpgecomment@\@@input #2 \cpgecomment@@#3\@nil}%
        \@testfalse
    \fi}
\gdef\cpge@checkcpgeincludeweb#1cpgeincludeweb[#2]#3\relax#4\relax{%
    \def\@tempa{#1}%
    \ifx\@tempa\@empty
        \def\next{%
            \global\let\cpge@savedinput\@@input
            \def\@@input{%
                \global\let\@@input\cpge@savedinput
                \expandafter\cpgecomment@\@@input}%
            \cpgeincludeweb{#2}%#3\@nil%
            \global\let\@@input\cpge@savedinput
            \cpgecomment@@#3\@nil}%
        \@testfalse
    \fi}
\gdef\cpge@checkendinput#1endinput#2#3\relax#4\relax{%
    \def\@tempa{#1}%
    \ifx\@tempa\@empty\ifcat\noexpand#2a\relax\else
            \let\next\endinput
        \fi\fi}
\gdef\cpge@checkinclude#1include[#2]#3\relax#4\relax{%
    \def\@tempa{#1}%
    \ifx\@tempa\@empty
        \def\next{%
            \global\let\cpge@savedinput\@@input
            \def\@@input{%
                \global\let\@@input\cpge@savedinput
                \expandafter\cpgecomment@\@@input}%
            \include{#2}%
            \global\let\@@input\cpge@savedinput
            \cpgecomment@@#3\@nil}%
        \@testfalse
    \fi}
\gdef\end@@cpgecomment#1#2\@nnil!\@nil{%
    \endgroup
    \toks@{#2 }\rescan{\toks@}%
    \edef\next{\noexpand\end@cpgecomment\noexpand\end{#1}\the\toks@}%
    \next}%
\gdef\cpge@end#1#2\@nnil!\@nil{%
    \endgroup
    \@envirsep \let\@envirsep\envirsep
    \toks@{#2 }\rescan{\toks@}%
    \edef\next{\noexpand\normal@begin{#1}\the\toks@}%
    \next}%
\gdef\cpge@cpgeincludeweb#1#2\@nnil!\@nil{%
    \endgroup
    \toks@{#2 }\rescan{\toks@}%
    \edef\next{\noexpand\cpgeincludeweb{#1}\the\toks@}%
    \next}%
}%  END OF LOWERCASE
\endgroup
%%%% End of xcomment.sty 

%\RequirePackage{cpgecomment}
\NewDocumentCommand\cpgeinclude{om}{}
\NewDocumentCommand\cpgeincludeweb{m}{
    \global\cpgeincludedtrue%
    \IfFileExists{#1-eno.tex}
    {\input{#1-eno}}
    {\input{#1}}%
}
\expandafter\cpgecomment\expandafter{\cpgecomment@list}

%%%% Inhibition des commandes d'écriture \solution et \proof
%%%% dans des fichiers externes


%%%% écriture du CSV

\newwrite\cpge@out

\def\cpge@null#1{}
\newcommand{\cpgecsv@record}[1]{%
    \begingroup\let\tofs\@secondoftwo%
    \cpgeprotected@iwrite\cpge@out{}{#1}
    \endgroup}

\def\question@do{%
    \stepcounter{tmpdo}%
    \ifnum\value{tmpdo}>\ques@number\relax\else%
        \eappto\csv@header{, "Question \thetmpdo", "Reponse \thetmpdo"}
        \expandafter\question@do\fi
}
\DeclareDocumentCommand\startcsvrecording{O{4}}{%
    \gdef\ques@number{#1}%
    \def\csv@header{"Quiz", "Title image", "Title text"}
    \question@do%
    \let\cpgecsvrecord\cpgecsv@record%
    \edef\cpge@recordfile{\jobname.csv}%
    \immediate\openout\cpge@out\cpge@recordfile%
    \cpgecsvrecord{\csv@header}
}

\newcommand{\stopcsvrecording}{%
    \immediate\closeout\cpge@out%
    \let\cpgecsvrecord\cpge@null%
}

\ifdefstring\cpgecurrentclass{dev}{\AtBeginDocument{\startcsvrecording}}{}
\ifdefstring\cpgecurrentclass{dev}{\AtEndDocument{\stopcsvrecording}}{}


%%% Traitement des quiz en deux passes

\def\choice@undef{%
    \gdef\cpge@choicelist{}%
    \setcounter{ch@ice}0%
}

%\def\undef@afterexec#1{\ifdefvoid{#1}{\relax}{#1}\gundef{#1}}
%\def\csundef@afterexec#1{\csuse{#1}\csgundef{#1}}

\long\def\intro#1\endintro{#1}
\long\def\collect@intro#1\endintro{%
    \gdef\intro@body{#1}}
\def\intro@body{}

\DeclareDocumentCommand\firstpass@cmd{t+ t- m O{ } D<>{} E\br{{}}}{%
    \stepcounter{fake@choice}%
    \cpge@prechoicedo{\thefake@choice}
    \csgdef{choice@body\thefake@choice}{\rawchoice}%
    \IfBooleanT{#1}{\csxappto{choice@body\thefake@choice}{{TRUE}}}
    \IfBooleanT{#2}{\csxappto{choice@body\thefake@choice}{{FALSE}}}
    \csname collect@#3\endcsname
}

\long\def\collect@choice#1\endchoice{%
    \preprocess@genbody{#1}%
    \csxappto{choice@body\thefake@choice}{{\expandonce\gen@upper}}%
}
\long\def\collect@ques#1\endques{%
    \preprocess@genbody{#1}%
    \csxappto{choice@body\thefake@choice}{{\expandonce\gen@upper}}%
}

\DeclareDocumentCommand\rawchoice@singleimage{m+m}{%
    \stepcounter{ch@ice}%
    \xappto\cpge@quizcsventry{, "\two@digits\theimgcnt.png", "#1"}%
    \cpge@choicesingleimage{#2}%
}
\DeclareDocumentCommand\rawchoice@commonimage{m+m}{%
    \stepcounter{ch@ice}%
    \cpge@choicecommonimage{#2}%
    \xappto\cpge@quizcsventry{, "\two@digits\theenumi", "#1"}%
}

\def\number@deco{
    \node at ([yshift=-8pt]page.north)
    [question style, anchor=north, minimum height=0]
    {\arabic{ch@ice}};
}
\NewDocumentCommand\cpge@choicesingleimage{+m}{%
    \begin{webenv}{}
        [image width=8cm,
            image height=1,
            top skip=0pt,
            bottom skip=12pt,
            foot skip=8pt,
            head height=34pt]{}
        #1
    \end{webenv}%  
}
\NewDocumentCommand\cpge@choicecommonimage{+m}{\xit #1}

\long\def\firstpass@quiz#1{\begingroup%
\def\ques##1\endques{}%
\def\choice##1\endchoice{}%
\def\tchoice{\firstpass@cmd+{choice}}%
\def\fchoice{\firstpass@cmd-{choice}}%
\let\intro\collect@intro%
%\def\hint##1\endhint{}
\let\solution\relax%
\DeclareDocumentCommand\justification{O{} D(){}}{}%
\setbox\trash@box\vbox{#1}%
\numgdef\choice@count{\thefake@choice}%
\endgroup}

\let\tofs\@firstoftwo

%%% Commande commune pour le traitement des options
% \DeclareDocumentCommand{quiz@env}{mm+m O{} d()  d<> E\br{{}}}{%
%     \csuse{quiz#1}%
%     \cpgexname{quiz}{#2}%
%     \stepcounter{quiz}%
%     \def\cpge@quizcsventry{"\thequiz"}
%     \def\cpge@tmpe{}
%     \ifcpge@rigid{title}
%     {\let\cpge@tmpe\cpge@rigid@title}
%     {\IfValueT{#5}{\def\cpge@tmpe{#5}}}%
%     \eappto\cpge@quizcsventry{, "\two@digits\theimgcnt.png",
%         "\expandafter\unexpanded\expandafter{\cpge@tmpe}"}
%     \firstpass@quiz{#3}%
%     \ifcpge@rigid{choicelist}{\reprocess@choicelist}{}%
%     {\begin{cpge@intro}(\cpge@tmpe)
%             \csundef@afterexec{intro@body}
%         \end{cpge@intro}}%
%     \let\inner@deco\number@deco%
%     \ifdef{\cpge@choicelist}
%     {\forlistloop{\for@cmd{choice}}\cpge@choicelist}{}
% }{%
%     \choice@undef%
%     \cpgecsvrecord{\cpge@quizcsventry}
% }

%%% Une page par question
\DeclareDocumentEnvironment{quiz@singleimage}{mm O{} d()  d<> E\br{{}} +b}{%
    \csuse{quiz#1}%
    \cpgexname{quiz}{#2}%
    \stepcounter{quiz}%
    \def\cpge@quizcsventry{"\thequiz"}
    \def\cpge@tmpe{}
    \ifcpge@rigid{title}
    {\let\cpge@tmpe\cpge@rigid@title}
    {\IfValueT{#4}{\def\cpge@tmpe{#4}}}%
    \eappto\cpge@quizcsventry{, "\two@digits\theimgcnt.png",
        "\expandafter\unexpanded\expandafter{\cpge@tmpe}"}
    \firstpass@quiz{#7}%
    \ifcpge@rigid{choicelist}{\reprocess@choicelist}{}%
    {\begin{cpge@intro}(\cpge@tmpe)
            \csundef@afterexec{intro@body}
        \end{cpge@intro}}%
    \let\inner@deco\number@deco%
    \ifdef{\cpge@choicelist}
    {\forlistloop{\for@cmd{choice}}\cpge@choicelist}{}
}{%
    \choice@undef%
    \cpgecsvrecord{\cpge@quizcsventry}
}
\NewDocumentEnvironment{cpge@intro}{d()}{%
    \webenv{\deco@thequiz{\thequiz}\IfValueT{#1}{\\ #1}}[.1]
    \mbox{}
}{\endwebenv}
\def\for@cmd#1#2{\csundef@afterexec{#1@body#2}}

%%% Une page par quiz

\newif\ifcommonquizimage
\def\xitball{\fbox}
\DeclareDocumentEnvironment{quiz@commonimage}{mm O{} d()  d<> E\br{{}} +b}{%
    \csuse{quiz#1}%
    \cpgexname{quiz}{#2}%
    \stepcounter{quiz}%
    \def\cpge@quizcsventry{"\thequiz"}
    \def\cpge@tmpe{}
    \ifcpge@rigid{title}
    {\let\cpge@tmpe\cpge@rigid@title}
    {\IfValueT{#4}{\def\cpge@tmpe{#4}}}%
    \eappto\cpge@quizcsventry{, "\two@digits\theimgcnt.png",
        "\expandafter\unexpanded\expandafter{\cpge@tmpe}"}
    \firstpass@quiz{#7}%
    \ifcpge@rigid{choicelist}{\reprocess@choicelist}{}%
    \commonquizimagetrue
    \webenv
    {\deco@thequiz{\thequiz}\ifdefempty{\cpge@tmpe}{}{\\[\medskipamount] \cpge@tmpe}}[image height=1,#3]
    \begin{xenum}[d=\xitball, m, s=.5\baselineskip]
        \item[]\csundef@afterexec{intro@body}
        \ifdef{\cpge@choicelist}
        {\forlistloop{\for@cmd{choice}}\cpge@choicelist}{}
    \end{xenum}
    \endwebenv%
}{%
    \choice@undef%
    \cpgecsvrecord{\cpge@quizcsventry}
}
\AtBeginDocument{
    \unless\ifsingleimage
        \def\quiz{\quiz@commonimage{true}{\name@quiz}}
        \let\endquiz\endquiz@commonimage
        \def\rawchoice{\rawchoice@commonimage}
    \else
        \def\quiz{\quiz@singleimage{true}{\name@quiz}}
        \let\endquiz\endquiz@singleimage
        \def\rawchoice{\rawchoice@singleimage}
    \fi
}
%%%% Les instructions de rendu des "pages" 
\usetikzlibrary{shadows, fadings, positioning}
\newdimen\imagewidth

\cpgesetup[tikz]{%
    image width/.code={\imagewidth=#1},
    image width=16cm,
}

\def\page@deco{
    \draw [overlay, fill=backcol,
        draw=strokecol,
        line width=20pt,
        rounded corners= 20pt]
    (page.north west) rectangle (page.south east);
}



\cpgesetdeco{thequiz}{{\color{strokecol}\bfseries[\ #1\ ]}}


%%%%% Définition du contenu de la commande \titre.
\cpgesetup[rules]{ %
    question style/.code=\gdef\cpge@quesnum{#1},
    quiz number/.code=\gdef\cpge@quiznum{#1},
    title/.code=\cpgename*{rules}{#1},
    quiz score/.code=\gdef\cpge@quizscore{#1},
    question style=4,
    quiz number=6,
    quiz score=4,
    title={R\`egles du questionnaire}
}
\def\cpge@totalscore{\number\numexpr\cpge@quizscore*\cpge@quiznum\relax}
\def\numbername#1{%
    \ifcase#1%
    \or un \or deux \or trois \or quatre
    \or cinq \or six \or sept \or huit
    \or  neuf \or dix \or onze \or douze
    \or treize or quatorze \else\fi}

\NewDocumentEnvironment{regles}{O{}+b}{}{}
\NewDocumentEnvironment{webregles}{O{}+b}{%
    \cpgesetup[rules]{#1}%
    \ifblank{#2}
    {%
        \gdef\rules@body{%
            Le devoir est form\'e de \cpge@quiznum{} unit\'es de \cpge@quesnum{}
            questions pour un bar\`eme total de \cpge@totalscore{}
            points. La note d'une unité est indivisible.
            Pour la recevoir il faut r\'epondre
            \strut\scshape\bfseries correctement aux
            \numbername{\cpge@quesnum} questions.}
    }{%
        \long\gdef\rules@body{#2}
    }%
}{}

% \cpgeaddkeyword{title}{regles}{%
% 	\begin{webenv}(\csuse{name@rules})
% 		\rules@body
% 	\end{webenv}
% }
% \RenewDocumentCommand\titre{sod()}{%
% 	cpgelocaltitle{|regles|}
% 	\cpgetitlecontents
% 	}


\AtBeginDocument{%
    \fontsize{20pt}{24pt}\selectfont
    \everymath{\displaystyle}%
}

\cpgesetup[mini]{%
    font=\Large,
    label font=\Large\scshape\bfseries\color{strokecol},
    left margin=1pc
}

\endinput
