\def\filedate{2021/08/15}
\def\fileversion{v0.1alpha}
\def\fileauthor{Sadik Boujaida}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%% Adaptation de standalone.cls %%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%% Copyright (C) 2011-2017 by Martin Scharrer <martin@scharrer-online.de>
%% ---------------------------------------------------------------------------
%% This work may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, either version 1.3
%% of this license or (at your option) any later version.
%% The latest version of this license is in
%%   http://www.latex-project.org/lppl.txt
%% and version 1.3 or later is part of all distributions of LaTeX
%% version 2005/12/01 or later.
%%
%% This work has the LPPL maintenance status `maintained'.
%%
%% The Current Maintainer of this work is Martin Scharrer.
%%
%%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{igweb}[igweb package pour gestion de quiz]



\let\onlyifigweb\@firstofone
\let\IfStandalone\@firstoftwo
\def\ig@border@left{0.50001bp}
\let\ig@border@right\ig@border@left
\let\ig@border@top\ig@border@left
\let\ig@border@bottom\ig@border@left
\def\rem@bp#1bp\relax#2\@nnil{#1}%
\def\default@bp#1#2{%
    \begingroup
    \afterassignment\remove@to@nnil
    \dimen@ #2bp\relax\@nnil
    \expandafter
    \endgroup
    \expandafter
    \def\expandafter#1\expandafter{\the\dimen@}%
}
\def\ig@readborder#1 #2 #3 #4 #5\@nnil{%
    \ifx\\#2#3#4\\%
        \default@bp\ig@border@left{#1}%
        \let\ig@border@right\ig@border@left
        \let\ig@border@top\ig@border@left
        \let\ig@border@bottom\ig@border@left
    \else
    \ifx\\#4\\%
        \default@bp\ig@border@left{#1}%
        \let\ig@border@right\ig@border@left
        \default@bp\ig@border@top{#2}%
        \let\ig@border@bottom\ig@border@top
    \else
        \default@bp\ig@border@left{#1}%
        \default@bp\ig@border@bottom{#2}%
        \default@bp\ig@border@right{#3}%
        \default@bp\ig@border@top{#4}%
    \fi\fi
}%

\expandafter\ifx\csname ShellEscape\endcsname\relax
    \IfFileExists{shellesc.sty}{
        \RequirePackage{shellesc}
        \@ifpackagelater{shellesc}{2016/04/29}{
        }{
            \protected\def\ShellEscape{\immediate\write18 }
        }
    }{
        \protected\def\ShellEscape{\immediate\write18 }
    }
\fi
\expandafter\ifx\csname ifluatex\endcsname\relax
    \IfFileExists{ifluatex.sty}{\@firstoftwo}{\@secondoftwo}{%
        \RequirePackage{ifluatex}
    }{
        \begingroup
        \expandafter\ifx\csname directlua\endcsname\relax
            \endgroup
            \expandafter\let\csname ifluatex\expandafter\endcsname\csname iffalse\endcsname
        \else
            \endgroup
            \expandafter\let\csname ifluatex\expandafter\endcsname\csname iftrue\endcsname
        \fi
    }
\fi
\expandafter\ifx\csname ifpdf\endcsname\relax
    \IfFileExists{ifpdf.sty}{\@firstoftwo}{\@secondoftwo}{%
        \RequirePackage{ifpdf}
    }{
        \begingroup
        \expandafter\ifx\csname pdfoutput\endcsname\relax
            \endgroup
            \expandafter\let\csname ifpdf\expandafter\endcsname\csname iffalse\endcsname
        \else
            \endgroup
            \ifnum\pdfoutput<1
                \expandafter\let\csname ifpdf\expandafter\endcsname\csname iffalse\endcsname
            \else
                \expandafter\let\csname ifpdf\expandafter\endcsname\csname iftrue\endcsname
            \fi
        \fi
    }
\fi
\expandafter\ifx\csname ifxetex\endcsname\relax
    \IfFileExists{ifxetex.sty}{\@firstoftwo}{\@secondoftwo}{%
        \RequirePackage{ifxetex}
    }{
        \begingroup
        \expandafter\ifx\csname XeTeXrevision\endcsname\relax
            \endgroup
            \expandafter\let\csname ifxetex\expandafter\endcsname\csname iffalse\endcsname
        \else
            \endgroup
            \expandafter\let\csname ifxetex\expandafter\endcsname\csname iftrue\endcsname
        \fi
    }
\fi
\let\ig@packageoptionslist\@packageoptionslist
\RequirePackage{xkeyval}
%\newif\ifig@noscorepattern\ig@noscorepatterntrue
\newif\ifig@crop
\newif\ifig@multi
\newif\ifig@multido
\newif\ifig@varwidth
\newif\ifig@ignorerest
\newif\ifig@ignoreempty
\newif\ifig@tikz
\newif\ifig@convert
\def\ig@clsoption{%
    \define@key{igweb.sty}%
}
\ig@clsoption{border}{%
    \ig@readborder#1 {} {} {} {} \@nnil
}
\ig@clsoption{margin}{%
    \ig@readborder#1 {} {} {} {} \@nnil
}
\def\ig@boolean#1#2{%
    \ig@boolorvalue{#1}{#2}%
        {\PackageError{igweb}{Invalid value '#2' for boolean key '#1'}{}}%
}
\def\ig@boolorvalue#1#2{%
    \begingroup
    \edef\@tempa{#2}%
    \def\@tempb{true}%
    \ifx\@tempa\@tempb
        \endgroup
        \csname ig@#1true\endcsname
        \expandafter\@gobble
    \else
    \def\@tempb{false}%
    \ifx\@tempa\@tempb
        \endgroup
        \csname ig@#1false\endcsname
        \expandafter\expandafter
        \expandafter\@gobble
    \else
        \endgroup
        \expandafter\expandafter
        \expandafter\@firstofone
    \fi\fi
}
\ig@clsoption{inpath}[quizes]{%
	\iginpathtoquiz{#1}%
}
\ig@clsoption{outpath}[\jobname-quizes]{%
	\igoutpathtoquiz{#1}%
}
%\setkeys{igweb.sty}{pathtoquiz}

%\ig@clsoption{scorepattern}[false]{%
%	\ig@boolean{noscorepattern}{#1}%
%}
\ig@clsoption{crop}[true]{%
    \ig@boolean{crop}{#1}%
}
\setkeys{igweb.sty}{crop}

\ig@clsoption{ignorerest}[true]{%
    \ig@boolean{ignorerest}{#1}%
}
\ig@clsoption{ignoreempty}[true]{%
    \ig@boolean{ignoreempty}{#1}%
}
\ig@clsoption{multi}[true]{%
    \ig@boolorvalue{multi}{#1}{\ig@multitrue\AtBeginDocument{\igwebenv{#1}}}%
}

\ig@clsoption{multido}[true]{%
    \ig@boolean{multido}{#1}%
    \ifig@multido
        \setkeys{igweb.sty}{multi=igmultido}%
    \fi
}
\setkeys{igweb.sty}{multido}

\ig@clsoption{varwidth}[true]{%
    \ig@boolorvalue{varwidth}{#1}{\ig@varwidthtrue\def\ig@width{#1}}%
    \ifig@varwidth
        \def\ig@varwidth{\varwidth{\ig@width}}%
        \def\ig@endvarwidth{\endvarwidth}%
    \else
        \let\ig@varwidth\@empty
        \let\ig@endvarwidth\@empty
    \fi
}
\let\sa@varwidth\@empty
\let\sa@endvarwidth\@empty
\ig@clsoption{tikz}[true]{%
    \ig@boolean{tikz}{#1}%
    \ifig@tikz
        \setkeys{igweb.sty}{multi=tikzpicture,varwidth=false}%
    \fi
}
\setkeys{igweb.sty}{tikz}

%\ig@clsoption{class}{%
%    \def\ig@class{#1}%
%}
%\def\ig@class{article}

\ig@clsoption{convert}[]{%
    \setkeys{igweb.sty/convert}{true,#1}%
}

\ig@clsoption{disable@convert}[]{%
    \typeout{Disable conversion}
    \ig@convertfalse
    \let\ig@converttrue\relax
}
\def\ig@convertoption{%
    \define@key{igweb.sty/convert}%
}
\def\ig@convertvar#1#2{%
    \define@key{igweb.sty/convert}{#1}{%
        \@namedef{ig@convert@#1}{##1}%
    }%
    \@namedef{ig@convert@#1}{#2}%
}
\ig@convertoption{true}[]{%
    \ig@converttrue
}
\ig@convertoption{false}[]{%
    \ig@convertfalse
}
\ig@convertoption{png}[]{%
    \setkeys{igweb.sty/convert}{true,outext={.png}}%
}
\ig@clsoption{png}[]{%
    \setkeys{igweb.sty/convert}{png,#1}%
}
\ig@convertoption{realmainfile}[]{%
    \RequirePackage{currfile-abspath}%
    \getmainfile
    \let\ig@convert@mainfile\themainfile
}
\ig@convertoption{jpg}[]{%
    \setkeys{igweb.sty/convert}{true,outext={.jpg}}%
}
\ig@clsoption{jpg}[]{%
    \setkeys{igweb.sty/convert}{jpg,#1}%
}
\ig@convertoption{gif}[]{%
    \setkeys{igweb.sty/convert}{true,outext={.gif}}%
}
\ig@clsoption{gif}[]{%
    \setkeys{igweb.sty/convert}{gif,#1}%
}
\ig@convertoption{onfailure}{%
    \begingroup
    \edef\@tempa{#1}%
    \def\@tempb{error}%
    \ifx\@tempa\@tempb
        \endgroup
        \let\ig@convert@failuremsg\PackageError
    \else
    \def\@tempb{warning}%
    \ifx\@tempa\@tempb
        \endgroup
        \let\ig@convert@failuremsg\PackageWarning
    \else
    \def\@tempb{info}%
    \ifx\@tempa\@tempb
        \endgroup
        \let\ig@convert@failuremsg\PackageInfo
    \else
    \def\@tempb{ignore}%
    \ifx\@tempa\@tempb
        \endgroup
        \def\ig@convert@failuremsg##1##2##3{}%
        \let\ig@convert@notfoundmsg\@gobbletwo
    \else
        \let\on@line\@empty
        \PackageError{igweb}{Invalid value '\@tempa' for the 'onfailure' option.\MessageBreak
                                Valid values: 'error', 'warning', 'info', 'ignore'}{}%
        \endgroup
    \fi\fi\fi\fi
}
\let\ig@convert@failuremsg\PackageWarning
\let\ig@convert@notfoundmsg\PackageWarning
\ig@convertoption{defgsdevice}{%
    \ig@defgsdevice#1\relax\relax
}
\def\ig@defgsdevice#1#2{%
    \@namedef{ig@gsdevice@#1}{#2}%
}
\@namedef{ig@gsdevice@.jpg}{jpeg}%
\@namedef{ig@gsdevice@.png}{png16m}%
\ig@convertoption{command}{%
    \def\ig@convert@command{#1}%
}
\ig@convertoption{pdf2svg}[]{%
    \def\ig@convert@command{pdf2svg \infile\space\outfile}%
    \ig@convertvar{outext}{.svg}
}
\ig@convertoption{imagemagick}[]{%
    \def\ig@convert@command{\convertexe\space -density \density\space -units PixelsPerInch \infile\space \ifx\size\empty\else -resize \size\fi\space -quality 90 \outfile}%
    \let\ig@convert@pageoffset\m@ne
}
\ig@convertoption{ghostscript}[]{%
    \def\ig@convert@command{\gsexe\space -dSAFER -dBATCH -dNOPAUSE -sDEVICE=\gsdevice\space -r\density\space -sOutputFile=\outfile\space \infile}%
    \let\ig@convert@pageoffset\z@
}
\ig@convertvar{latexoptions}{ -shell-escape }
\ig@convertvar{subjobname}{\jobname}
\ig@convertvar{mainfile}{\jobname}
\ig@convertvar{quote}{}
\let\ig@convert@quote\relax
\ig@convertvar{size}{}
\ig@convertvar{inname}{\subjobname}
\ig@convertvar{infile}{\inname\inext}
\ig@convertvar{outext}{.png}
\ig@convertvar{imgdir}{\jobname-\expandafter\@gobble\ig@convert@outext}
\ig@convertvar{outname}{\ig@convert@imgdir/}
\ig@convertvar{outfile}{\outname\ifig@multi\ig@multi@pagemark\fi\outext}
\def\ig@multi@pagemark{\percent0d}%
\ig@convertvar{density}{300}
\ig@convertvar{gsdevice}{%
    \expandafter\ifx\csname ig@gsdevice@\outext\endcsname\relax
        \expandafter\@gobble\outext
    \else
        \csname ig@gsdevice@\outext\endcsname
    \fi
}
\ifluatex
    \ig@convertvar{latex}{lualatex}
    \ig@convertvar{inext}{.pdf}
    \ig@convertvar{precommand}{}
    \setkeys{igweb.sty/convert}{imagemagick}
\else
\ifpdf
    \ig@convertvar{latex}{pdflatex}
    \ig@convertvar{inext}{.pdf}
    \ig@convertvar{precommand}{}
    \setkeys{igweb.sty/convert}{imagemagick}
\else
\ifxetex
    \ig@convertvar{latex}{xelatex}
    \ig@convertvar{inext}{.pdf}
    \ig@convertvar{precommand}{}
    \setkeys{igweb.sty/convert}{imagemagick}
\else
    \ig@convertvar{latex}{latex}
    \ig@convertvar{inext}{.ps}
    \ig@convertvar{precommand}{dvips \subjobname.dvi}
    \setkeys{igweb.sty/convert}{ghostscript}
\fi\fi\fi

\def\ig@convertvar#1#2{%
    \define@key{igweb.sty/convert}{#1}{%
        \@namedef{ig@convert@#1}{##1}%
    }%
    \@namedef{ig@convert@#1}{#2}%
}
\begingroup
\ifluatex
  \csname @tempswa\directlua{
      if os.type == "windows" then
        tex.sprint("true")
      else
        tex.sprint("false")
      end
    }\endcsname
\else
    \IfFileExists{/dev/null}{\@tempswafalse}{\@tempswatrue}%
\fi
\if@tempswa
    \endgroup
    \ig@convertvar{convertexe}{imgconvert}
    \ig@convertvar{gsexe}{gswin32c}
\else
    \endgroup
    \ig@convertvar{convertexe}{convert}
    \ig@convertvar{gsexe}{gs}
\fi
\newcommand*\igwebenv[1]{%
    \begingroup
    \edef\@tempa{\endgroup\noexpand\@for\noexpand\@tempa:=\zap@space#1 \@empty}%
    \@tempa\do{\expandafter\@igwebenv\expandafter{\@tempa}}%
    \setkeys{igweb.sty}{multi}%
}
\@onlypreamble\igwebenv
\newcommand*{\igwebconfig}{\setkeys{igweb.sty}}
\expandafter\igwebconfig\expandafter{\convert@options}
\let\@igwebenv\@gobble
\newcount\ig@internal
\newcounter{igpage}
\let\igweb\empty
\let\endigweb\relax
\def\ig@width{\linewidth}
\InputIfFileExists{igweb.cfg}{}{}
\begingroup
\def\@tempa{\endgroup\setkeys*{igweb.sty}}
\expandafter\expandafter\expandafter\@tempa
\expandafter\expandafter\expandafter{\csname opt@igweb.sty\endcsname}
\let\@packageoptionslist\XKV@rm
\disable@keys{igweb.sty}{crop,ignorerest}
\AtBeginDocument{%
    \disable@keys{igweb.sty}{multi}%
}
\ifig@convert\ig@mkdir{\ig@convert@imgdir}\fi%

\ifig@ignorerest
    \def\ig@startignore{\ig@boxit}
\else
    \let\ig@startignore\relax
\fi
\ifig@ignorerest
    \def\ig@stopignore{\endig@boxit}
\else
    \let\ig@stopignore\relax
\fi
%\ifig@multido
\RequirePackage{multido}
\let\ig@orig@multido@\multido@
\renewcommand{\multido@}[6]{%
  \ig@stopignore
  \ig@orig@multido@{#1}{#2}{#3}{#4}{#5}{%
    \ig@startignore
    \begin{igmultido}%
      \let\multido@\ig@orig@multido@
      #6%
    \end{igmultido}%
    \ig@stopignore
  }%
  \ig@startignore
}
%\fi
\ifluatex
\RequirePackage{luatex85}
\RequirePackage{pdftexcmds}
\fi
\ifig@convert
\ifx\ig@convert@quote\relax
\begingroup
\@tempswafalse
\expandafter\ifx\csname pdftexbanner\endcsname\relax
    \@tempswatrue
\else
\def\MiKTeX{MiKTeX}
\@onelevel@sanitize\MiKTeX
\expandafter\def\expandafter\testmiktex\expandafter#\expandafter1\MiKTeX#2\relax{%
        \ifx\empty#2\empty
             \@tempswafalse
        \else
             \@tempswatrue
        \fi
}
\expandafter\expandafter
\expandafter\testmiktex\expandafter\pdftexbanner\MiKTeX\relax\relax

\fi
\expandafter
\endgroup
\if@tempswa
\def\ig@convert@quote{"}
\else
\def\ig@convert@quote{'}
\fi
\fi
\fi

\RequirePackage{tikz}

\newcounter{quiz}
\igdefcounter{ch@ice}{}[quiz]
\igdefcounter{fake@choice}{}[quiz]

\ifig@crop
\newbox\ig@box
\pagestyle{empty}
\hoffset=-72.27pt
\voffset=-72.27pt
\topmargin=0pt
\headheight=0pt
\headsep=0pt
\marginparsep=0pt
\marginparwidth=0pt
\footskip=0pt
\marginparpush=0pt
\oddsidemargin=0pt
\evensidemargin=0pt
\topskip=0pt
\textheight=\maxdimen
\def\ig@boxit{%
    \setbox\ig@box\hbox\bgroup\color@setgroup\ig@varwidth
}%
\def\endig@boxit{%
    \ig@endvarwidth\color@endgroup\egroup
}%
\renewenvironment{igweb}{%
    \csuse{ifig@multi}
        \ig@startignore
    \csuse{else}
        \ig@boxit
    \csuse{fi}
}{%
    \csuse{ifig@multi}
        \ig@stopignore
    \csuse{else}
        \endig@boxit
        \ig@handlebox
    \csuse{fi}
}
\ifig@multi\else
    \ig@ignorerestfalse
\fi
\ifig@ignorerest
    \def\@igwebenv#1{%
        \expandafter\ifx\csname ig@orig@#1\endcsname\relax
            \expandafter\let\csname ig@orig@#1\expandafter\endcsname\csname #1\endcsname
            \expandafter\let\csname ig@orig@end#1\expandafter\endcsname\csname end#1\endcsname
        \fi
        \expandafter\def\csname #1\endcsname{%
            \ifnum\ig@internal=0
                \addtocounter{igpage}\@ne
                \edef\@tempa{\endgroup
                    \noexpand\endig@boxit
                    \begingroup
                    \def\noexpand\@currenvir{\@currenvir}%
                    \def\noexpand\@currenvline{\@currenvline}%
                }%
                \@tempa
                \ig@boxit
            \fi
            \advance\ig@internal\@ne
            \csname ig@orig@#1\endcsname
        }%
        \expandafter\def\csname end#1\endcsname{%
            \csname ig@orig@end#1\endcsname
            \advance\ig@internal\m@ne
            \ifnum\ig@internal=0
                \endig@boxit
                \ig@handlebox
                \aftergroup\ig@boxit
            \fi
        }%
    }%
\else
    \def\@igwebenv#1{%
        \expandafter\ifx\csname ig@orig@#1\endcsname\relax
            \expandafter\let\csname ig@orig@#1\expandafter\endcsname\csname #1\endcsname
            \expandafter\let\csname ig@orig@end#1\expandafter\endcsname\csname end#1\endcsname
        \fi
        \expandafter\def\csname #1\endcsname{%
            \ifnum\ig@internal=0
                \addtocounter{igpage}\@ne
                \ig@boxit
            \fi
            \advance\ig@internal\@ne
            \csname ig@orig@#1\endcsname
        }%
        \expandafter\def\csname end#1\endcsname{%
            \csname ig@orig@end#1\endcsname
            \advance\ig@internal\m@ne
            \ifnum\ig@internal=0
                \endig@boxit
                \ig@handlebox
            \fi
        }%
    }%
\fi
\def\ig@handlebox{%
    \ifcase
        0%
        \ifig@ignoreempty
            \ifdim\wd\ig@box=\z@
            \ifdim\ht\ig@box=\z@
            \ifdim\dp\ig@box=\z@
                1%
            \fi\fi\fi
        \fi
    \relax
    \sbox\ig@box{%
        \hskip\ig@border@left
        \@tempdima=\ht\ig@box
        \advance\@tempdima\ig@border@top\relax
        \ht\ig@box=\@tempdima
        \@tempdima=\dp\ig@box
        \advance\@tempdima\ig@border@bottom\relax
        \dp\ig@box=\@tempdima
        \raise\dp\ig@box
            \box\ig@box
        \hskip\ig@border@right
    }%
    \ig@placebox
    \fi
}
\ifcase0%
    \ifpdf\else\ifluatex\else\ifxetex\else 1\fi\fi\fi
  \relax
    \def\ig@placebox{%
        \newpage
        \ifluatex
          \ifnum\luatexversion<85
            % LuaLaTeX < 0.85 does define the PDF-specific globals.
            \global\pdfpagewidth=\wd\ig@box
            \global\pdfpageheight=\ht\ig@box
          \else
            % LuaLaTeX >= 0.85 doesn't define the PDF-specific globals.
            \global\pagewidth=\wd\ig@box
            \global\pageheight=\ht\ig@box
          \fi
        \else
          % Not LuaLaTeX at all, so still need this.
          \global\pdfpagewidth=\wd\ig@box
          \global\pdfpageheight=\ht\ig@box
        \fi
        \global\paperwidth=\wd\ig@box
        \global\paperheight=\ht\ig@box
        \global\hsize=\wd\ig@box
        \global\vsize=\ht\ig@box
        \global\@colht=\ht\ig@box
        \global\@colroom=\ht\ig@box
        \noindent\usebox\ig@box
        \newpage
    }
  \else
    \def\ig@placebox{%
        \global\paperwidth=\wd\ig@box
        \global\paperheight=\ht\ig@box
        \global\@colht=\maxdimen
        \global\@colroom=\maxdimen
        \global\hsize=\maxdimen
        \global\vsize=\maxdimen
        \ig@papersize
        \ifig@multi
        \begingroup
        \@tempdima0.99626\paperwidth
        \@tempdimb0.99626\paperheight
        \edef\@tempc{\strip@pt\@tempdima}%
        \edef\@tempd{\strip@pt\@tempdimb}%
        \advance\@tempdima by .998pt
        \advance\@tempdimb by .998pt
        \def\strip@float##1.##2\relax{##1}%
        \edef\@tempa{\expandafter\strip@float\the\@tempdima\relax}%
        \edef\@tempb{\expandafter\strip@float\the\@tempdimb\relax}%
        \special{ps::%
            \@percentchar\@percentchar PageBoundingBox: 0 0 \@tempa\space\@tempb^^J%
            \@percentchar\@percentchar HiResPageBoundingBox: 0 0 \@tempc\space\@tempd^^J%
            \@percentchar\@percentchar BeginPageSetup^^J%
            << /PageSize [\@tempc\space\@tempd]
            >> setpagedevice^^J%<<
            0 0 bop^^J%
            \@percentchar\@percentchar EndPageSetup}%
        \endgroup
        \fi
        \topskip=0pt
        \noindent\ig@ps@content
        \newpage
    }
\def\ig@ps@content{%
    \noindent\usebox\ig@box
    \global\def\ig@ps@content{%
        \@tempdima\ig@yoffset
        \advance\@tempdima-\topskip
        \dp\ig@box\z@
        \ht\ig@box\z@
        \noindent\lower\@tempdima\copy\ig@box
    }%
}
\def\ig@papersize{%
    \global\let\ig@papersize\relax
    \global\ig@yoffset=\paperheight
    \global\setbox\@begindvibox\vbox{%
        \special{papersize=\the\paperwidth,\the\paperheight}%
        \special{ps::%
            \@percentchar\@percentchar HiResBoundingBox: 0 0 \the\paperwidth\space\the\paperheight^^J%
        }%
        \unvbox\@begindvibox
        \special{papersize=\the\paperwidth,\the\paperheight}%
    }%
}
\newlength\ig@yoffset
\fi
\fi

\expandafter\ifx\csname ig@internal@run\endcsname\relax\else
    \AtEndDocument{%
        \immediate\write\@mainaux{\noexpand\@gobbletwo\noexpand\ig@multi@setnumpages{\arabic{igpage}}}%
    }
    \ig@convertfalse
\fi
\ifig@convert
\let\ig@convert@stop\stop
\begingroup
\let\on@line\@gobble
\def\ig@convert#1{%
    \IfFileExists{\outfile}{%
        \edef\filemodbefore{\csname pdf\ifluatex @\fi filemoddate\endcsname{\outfile}}%
    }{%
    \IfFileExists{\outname\outext}{%
        \edef\filemodbefore{\csname pdf\ifluatex @\fi filemoddate\endcsname{\outname\outext}}%
    }{%
    \IfFileExists{\outname-0\outext}{%
        \edef\filemodbefore{\csname pdf\ifluatex @\fi filemoddate\endcsname{\outname-0\outext}}%
    }{%
    \IfFileExists{\outname-1\outext}{%
        \edef\filemodbefore{\csname pdf\ifluatex @\fi filemoddate\endcsname{\outname-1\outext}}%
    }{%
        \def\filemodbefore{}%
    }}}}%
    \edef\@tempa{\jobname}%
    \edef\@tempb{\ig@convert@subjobname}%
    \@onelevel@sanitize\@tempa
    \@onelevel@sanitize\@tempb
    \@tempswafalse
    \ifx\@tempa\@tempb
        \@tempswatrue
        \edef\infile@filemodbefore{\csname pdf\ifluatex @\fi filemoddate\endcsname{\infile}}%
    \else
        \global\let\ig@convert@stop\relax
    \fi
    \ShellEscape{\ig@convert@latex\space\ig@convert@latexoptions\space
        -jobname \ig@convert@quote\ig@convert@subjobname\ig@convert@quote\space
        \ig@convert@quote\string\expandafter\string\def\string\csname\space
        ig@internal@run\string\endcsname{1}\string\input{\ig@convert@mainfile}\ig@convert@quote}%
    \def\ig@multi@numpages{0}%
    \begingroup
    \IfFileExists{\ig@convert@subjobname.aux}{\@tempswatrue}{\@tempswafalse}%
    \if@tempswa
      \newread\ig@read
      \def\@tempa##1\ig@multi@setnumpages##2##3\@nnil{%
        \def\@tempc{##2}%
        \ifx\@tempc\@nnil\else
          \gdef\ig@multi@numpages{##2}%
        \fi
      }%
      \endlinechar=\m@ne
      \immediate\openin\ig@read=\ig@convert@subjobname.aux\relax
      \loop\unless\ifeof\ig@read
        \read\ig@read to\@tempb
        \expandafter\@tempa\@tempb\ig@multi@setnumpages\@nil\@empty\@nnil
      \repeat
      \immediate\closein\ig@read
    \fi
    \endgroup
    \@tempcnta\ig@multi@numpages\relax
    \advance\@tempcnta\ig@convert@pageoffset\relax
    \ifnum\@tempcnta=\z@
        \def\ig@multi@pagemark{}%
        \edef\ig@lastoutfile{\outfile}%
    \else
        \@tempcntb\z@
        \loop\ifnum\@tempcnta>0
            \advance\@tempcntb\@ne
            \divide\@tempcnta by 10\relax
        \repeat
        \edef\ig@multi@pagemark{\percent0\the\@tempcntb d}%
        \begingroup
        \def\ig@multi@pagemark{-\the\@tempcnta}%
        \xdef\ig@lastoutfile{\outfile}%
        \endgroup
    \fi
    \if@tempswa
        \edef\infile@filemodafter{\csname pdf\ifluatex @\fi filemoddate\endcsname{\infile}}%
        \ifx\infile@filemodbefore\infile@filemodafter
            \global\let\ig@convert@stop\relax
        \fi
    \fi
    \edef\ig@convert@precommand{\ig@convert@precommand}%
    \ifx\ig@convert@precommand\@empty\else
        \ShellEscape{\ig@convert@precommand}%
    \fi
    \ShellEscape{\ig@convert@command}%
    \@tempswafalse
    \IfFileExists{\ig@lastoutfile}{%
        \edef\filemodafter{\csname pdf\ifluatex @\fi filemoddate\endcsname{\ig@lastoutfile}}%
        \ifx\filemodbefore\filemodafter
            \expandafter\ifx\csname pdf\ifluatex @\fi filemoddate\endcsname\relax\else
                \ig@convert@failuremsg{igweb}{#1}{}%
            \fi
        \else
            \typeout{Package igweb:^^JOutput written on \ig@lastoutfile.}%
        \fi
    }{%
        \ig@convert@failuremsg{igweb}{#1}{}%
    }%
}
\let\subjobname\ig@convert@subjobname
\let\mainfile\ig@convert@mainfile
\let\infile\ig@convert@infile
\let\inext\ig@convert@inext
\let\inname\ig@convert@inname
\let\gsdevice\ig@convert@gsdevice
\let\convertexe\ig@convert@convertexe
\let\gsexe\ig@convert@gsexe
\let\density\ig@convert@density
\let\size\ig@convert@size
\let\outext\ig@convert@outext
\let\outname\ig@convert@outname
\let\outfile\ig@convert@outfile
\let\percent\@percentchar
\let\quote\ig@convert@quote
\edef\ig@shellescape{%
    \ifluatex
      \directlua{tex.write(status.shell_escape or 2)}%
    \else\ifxetex
      \the\shellescape
    \else
    \expandafter\ifx\csname pdfshellescape\endcsname\relax
      0%
    \else
      \the\pdfshellescape
    \fi\fi\fi
}%
\ifcase\ig@shellescape\relax% 0
    \ig@convert@failuremsg
        {igweb}{Shell escape disabled! Cannot convert file '\infile'.}{}%
    \global\let\ig@convert@stop\relax
\or% 1
	\PackageWarning{igweb}{conversion begins}{}%
    \ig@convert{successful Conversion!\MessageBreak
                Images files are in \ig@convert@imgdir}%
\else% 2 or 3
    \ig@convert{Conversion failed! Please ensure that shell escape\MessageBreak
                is enabled (e.g. use '-shell-escape').}%
\fi
\endgroup
\expandafter\ig@convert@stop
\fi

%\begingroup
%\toks@\expandafter{%
%    \document
%    \ig@cls@afterbegindocument
%}
%\xdef\document{\the\toks@}%
%\toks@\expandafter{%
%    \expandafter
%    \ig@cls@beforeenddocument
%    \enddocument
%}
%\xdef\enddocument{\the\toks@}%
%\endgroup
%\def\ig@cls@afterbegindocument{\igweb\ignorespaces}
%\def\ig@cls@beforeenddocument{\ifhmode\unskip\fi\endigweb}




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%% Les ajouts propres à igweb.sty %%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\igdefcounter{quiz}{}
\igdefcounter{ch@ice}{}[quiz]
\igdefcounter{rigid@choice}{}[quiz]
\newcounter{imgcnt}

\pgfdeclarelayer{background}
\pgfdeclarelayer{foreground}
\pgfsetlayers{background,main,foreground}
\tikzset{ifvaluetf/.code n args =
	{3}{\IfValueTF{#1}{\pgfkeysalso{#2}}{\pgfkeysalso{#3}}}
}

\def\mlform#1{\formule{$\begin{multlined}#1\end{multlined}$}}


\igset{tikz/.unknown/.code=\tikzset{\pgfkeyscurrentname=#1}}

\def\igsetnullify#1{\igset{#1/.is family, #1/.unknown/.code=\relax}}
\igsetnullify{geometry}
\igsetnullify{tcb}
\igsetnullify{devoir}
\igsetnullify{problem}

\igset[theme]{%
	dark/.is if=dark,
	colors/.code=\pgfkeysalso{/ig/colors/.cd,#1},
	font/.code=\igusefont{#1},
	rm/.style={font=rm},
	sf/.style={font=sf},
    .unknown/.code={}
}

\DeclareDocumentCommand\igusetheme{O{} m}{%
    \igset[theme]{sf,#1}
	\IfFileExists{q#2web.sty}
			{\AtEndPreamble{\RequirePackage{q#2web}}}{}%
	\reloadcolors%
}
%\NewDocumentCommand\igusetheme{om}{%
%	\IfFileExists{q#2web.sty}{\RequirePackage{q#2web}}{}
%}
\DeclareDocumentCommand\igusegeometry{om}{}


%%%% Mécanisme de désactivation des environnements à ignorer
\RequirePackage{xcomment}

\igset[igenv]{
    image width/.code= \imagewidth#1,
    image height/.code = \tikzset{minimum height=#1\imagewidth},
    top skip/.store in=\igenv@topskip,
    bottom skip/.store in=\igenv@bottomskip,
    foot skip/.store in=\igenv@footskip,
    head height/.store in=\igenv@headheight,
    top skip=1.5cm, bottom skip=1.5cm, foot skip=14pt, head height=30pt,
    .unknown/.code={}
}
\def\tikz@title#1#2{
    \ifblank{#2}
        {\ifblank{#1}{}{\hfill\tikz\node (title) [title style] {\TitlingFont#1};\hfill\null}}
        {\ifblank{#1}
            {\hfill\tikz\node (title) [title style] {\normalfont\Large\textcolor{warmcol}{(#2)}\hfill};\hfill\null}
            {\hfill\tikz\node (title) [title style] 
                {{\TitlingFont#1}
                {\\\normalfont\Large\textcolor{warmcol}{(#2)}\hfill}};\hfill\null%
            }%
        }%
}
\NewDocumentEnvironment{igenv}{m O{} D(){} d<> +b}{%
    \igset[igenv]{image height=.2,#2}%
    \stepcounter{imgcnt}
    \set@defaultforlistsinsideunite%
	\begin{tikzpicture}
        \begin{pgfonlayer}{foreground}
            \node (page) 
                [inner sep=0, outer sep=0, text width=\imagewidth] 
            {
                \tikzset{minimum height=0}%
                \vrule width\z@ height\igenv@headheight depth\z@\par\unskip\unskip%
                \tikz@title{#1}{#3}\par%
                \vskip\igenv@topskip plus 1fill%
                \fontsize{16pt}{20pt}\selectfont\hfill%
                \minipage{\imagewidth-32pt}%
                    \flushleft #5
                \endminipage\hfill\null\par%
                \vskip\igenv@bottomskip plus 1fill%
                \vrule width\z@ height\igenv@footskip depth\z@%
            };
        \ifdef\numberdeco
            {\begin{scope}[overlay]\numberdeco\end{scope}}{}
        \end{pgfonlayer}
        \begin{pgfonlayer}{background}
            \begin{scope}[overlay, minimum height=0]
                \clip (page.north west) rectangle (page.south east);
                \fill [overlay, bgcol] (page.north west) rectangle (page.south east);
                \igenv@backdeco%
            \end{scope}
	    \end{pgfonlayer}%
    \end{tikzpicture}%
}{\closeunite}
\NewDocumentEnvironment{notations}{}{%
    \igdefdeco{enumi}{\color{brightcol}\xsquare}
    \igenv{Notations}
}{\endigenv}

\newcommand\ignewwebenv[2]{
    \ifcsdef{#1}{}
        {\csdef{#1}{\igenv{#2}}\cslet{end#2}\endigenv}
}
\newcommand\igrenewwebenv[2]{
        \csdef{#1}{\igenv{#2}}%
        \cslet{end#1}\endigenv%
}
\ignewwebenv{theo}{Théorème}
\ignewwebenv{prop}{Proposition}
\ignewwebenv{coro}{Corollaire}
\ignewwebenv{lemm}{Lemme}
\ignewwebenv{ppte}{Propriétés}
\ignewwebenv{defi}{Définition}
\def\genwebenv{\igenv}
\let\endgenwebenv\endigenv 

\expandafter\xcomment\expandafter{\xcomment@list}


%%%% écriture du CSV



\newwrite\ig@record@out
\newwrite\devnull

\def\ig@null#1{}
\newcommand{\igcsv@record}[1]{%
	\begingroup\let\tofs\@secondoftwo%
	\igprotected@iwrite\ig@record@out{}{#1}
	\endgroup}

\def\question@do{%
	\stepcounter{tmpdo}%
	\ifnum\value{tmpdo}>\ques@number\relax\else%
		\eappto\csv@header{, "Question \thetmpdo", "Reponse \thetmpdo"}
		 \expandafter\question@do\fi
}
\DeclareDocumentCommand\startcsvrecording{O{4}}{%
  \gdef\ques@number{#1}%
  \def\csv@header{"Quiz", "Title image", "Title text"}
  \question@do%
  \let\igcsvrecord\igcsv@record%
  \edef\ig@record@file{\jobname.csv}%
  	\immediate\openout\ig@record@out\ig@record@file%
	 \igcsvrecord{\csv@header}
}

\newcommand{\stopcsvrecording}{%
  \immediate\closeout\ig@record@out%
  \let\igcsvrecord\ig@null%
}

\ifdefstring\igcurrentclass{igdev}{\AtBeginDocument{\startcsvrecording}}{}
\ifdefstring\igcurrentclass{igdev}{\AtEndDocument{\stopcsvrecording}}{}


%%% Traitement des quiz en deux passes

\def\choice@undef{%
	\gdef\ig@choicelist{}%
	\setcounter{ch@ice}0%
	}

%\def\undef@afterexec#1{\ifdefvoid{#1}{\relax}{#1}\gundef{#1}}
%\def\csundef@afterexec#1{\csuse{#1}\csgundef{#1}}

\long\def\intro#1\endintro{#1}
\long\def\collect@intro#1\endintro{%
	\gdef\intro@body{#1}}
\def\intro@body{}

\DeclareDocumentCommand\firstpass@cmd{t+ t- m O{ } D<>{} E\br{{}}}{%
	\stepcounter{fake@choice}%
	\ig@prechoicedo{\thefake@choice}
	\csgdef{choice@body\thefake@choice}{\rawchoice}%
	\IfBooleanT{#1}{\csxappto{choice@body\thefake@choice}{{TRUE}}}
	\IfBooleanT{#2}{\csxappto{choice@body\thefake@choice}{{FALSE}}}
	\csname collect@#3\endcsname
}

\long\def\collect@choice#1\endchoice{%
	\preprocess@genbody{#1}%
	\csxappto{choice@body\thefake@choice}{{\expandonce\gen@upper}}%
}
\long\def\collect@ques#1\endques{%
	\preprocess@genbody{#1}%
	\csxappto{choice@body\thefake@choice}{{\expandonce\gen@upper}}%
	}

\DeclareDocumentCommand\rawchoice@many{m+m}{%
	\stepcounter{ch@ice}%
	\xappto\ig@quizcsventry{, "\two@digits\theimgcnt.png", "#1"}%
	\ig@choicemany{#2}%
   }
\DeclareDocumentCommand\rawchoice@single{m+m}{%
   \stepcounter{ch@ice}%
   \ig@choicesingle{#2}%
   \xappto\ig@quizcsventry{, "\two@digits\theenumi", "#1"}%
  }

\def\number@deco{
    \node at ([yshift=-8pt]page.north)
        [question number, anchor=north, minimum height=0]
           {\arabic{ch@ice}}; 
}
\NewDocumentCommand\ig@choicemany{+m}{%
  \begin{igenv}{}
        [image width=8cm, 
        image height=1, 
        top skip=0pt, 
        bottom skip=12pt, 
        foot skip=8pt, 
        head height=34pt]{}
        #1
   \end{igenv}%  
}
\NewDocumentCommand\ig@choicesingle{+m}{\xit #1}

\long\def\firstpass@quiz#1{\begingroup%
	\def\ques##1\endques{}%
	\def\choice##1\endchoice{}%
	\def\tchoice{\firstpass@cmd+{choice}}%
	\def\fchoice{\firstpass@cmd-{choice}}%
	\let\intro\collect@intro%
	%\def\hint##1\endhint{}
	\let\solution\relax%
	\DeclareDocumentCommand\justification{O{} D(){}}{}%
	\setbox\trash@box\vbox{#1}%
	\numgdef\choice@count{\thefake@choice}%
\endgroup}

\let\tofs\@firstoftwo

%%% Une page par question
\DeclareDocumentEnvironment{quiz@many}{mm O{} d()  d<> E\br{{}} +b}{%
	\csuse{quiz#1}%
	\igxname{quiz}{#2}%
	\stepcounter{quiz}%
	\def\ig@quizcsventry{"\thequiz"}
	\def\ig@tmpe{}
	\ifig@rigid{title}
		{\let\ig@tmpe\ig@rigid@title}
		{\IfValueT{#4}{\def\ig@tmpe{#4}}}%
	\eappto\ig@quizcsventry{, "\two@digits\theimgcnt.png",
		"\expandafter\unexpanded\expandafter{\ig@tmpe}"}
	\firstpass@quiz{#7}%
	\ifig@rigid{choicelist}{\reprocess@choicelist}{}%
	  {\begin{ig@intro}(\ig@tmpe)
	  	\csundef@afterexec{intro@body}
		\end{ig@intro}}%
    \let\numberdeco\number@deco%
	\ifdef{\ig@choicelist}
      {\forlistloop{\for@cmd{choice}}\ig@choicelist}{}
}{%
	\choice@undef%
	\igcsvrecord{\ig@quizcsventry}
}
\NewDocumentEnvironment{ig@intro}{d()}{%
    \igenv{\deco@thequiz{\thequiz}\IfValueT{#1}{\\ #1}}[.1]
    \mbox{}
}{\endigenv}
\def\for@cmd#1#2{\csundef@afterexec{#1@body#2}}

%%% Une page par quiz
\def\xitball#1{%
    \tikz[baseline=(N.base)] \node  (N) [circle, inner sep=0, top color=coldcol!90, bottom color=coldcol!60!black, text=white, minimum height=0, text width=1cm, align=center, line width=2pt, draw=bgcol,font=\Large\bfseries]{#1};
    }
\newif\ifsinglequizimage
\DeclareDocumentEnvironment{quiz@single}{mm O{} d()  d<> E\br{{}} +b}{%
	\csuse{quiz#1}%
	\igxname{quiz}{#2}%
	\stepcounter{quiz}%
	\def\ig@quizcsventry{"\thequiz"}
	\def\ig@tmpe{}
	\ifig@rigid{title}
		{\let\ig@tmpe\ig@rigid@title}
		{\IfValueT{#4}{\def\ig@tmpe{#4}}}%
	\eappto\ig@quizcsventry{, "\two@digits\theimgcnt.png",
		"\expandafter\unexpanded\expandafter{\ig@tmpe}"}
	\firstpass@quiz{#7}%
	\ifig@rigid{choicelist}{\reprocess@choicelist}{}%
    \singlequizimagetrue
    \igenv
    {\deco@thequiz{\thequiz}\ifdefempty{\ig@tmpe}{}{\\[\medskipamount] \ig@tmpe}}[image height=1,#3]
        \begin{xenum}[d=\xitball, m, s=.5\baselineskip]
	  	   \item[] \csundef@afterexec{intro@body}
                \ifdef{\ig@choicelist}
                {\forlistloop{\for@cmd{choice}}\ig@choicelist}{}
            \end{xenum}
    \endigenv%
}{%
    \choice@undef%
	\igcsvrecord{\ig@quizcsventry}
}
\AtBeginDocument{
\ifsingleimage
    \def\quiz{\quiz@single{true}{\name@quiz}}
    \let\endquiz\endquiz@single
    \def\rawchoice{\rawchoice@single}
\else 
    \def\quiz{\quiz@many{true}{\name@quiz}}
    \let\endquiz\endquiz@many
    \def\rawchoice{\rawchoice@many}
\fi 
}
%%%% Les instructions de rendu des "pages" 
\usetikzlibrary{shadows, fadings, positioning}
\newdimen\imagewidth

\igset[tikz]{%
	image width/.code={\imagewidth=#1},
	image width=16cm,
	}
	
\tikzset{image deco/.style={%
	fill=bgcol, 
	draw=warmcol, 
	line width=20pt, 
	rounded corners= 20pt
	}
}

\tikzset{question number/.style={%
	font=\fontsize{32pt}{32pt}\bfseries,
	text=warmcol, xshift=1cm, text width=1cm,
	align=left, yshift=-.8cm
	}
}

\tikzset{title style/.style={%
	font=\fontsize{24pt}{24pt}\bfseries\scshape\boldmath,
	text = coldcol,
    text width=.7\imagewidth,
	align=flush center,
	}
}

\def\igenv@backdeco{ 
	\draw [overlay, fill=bgcol, 
			draw=warmcol, 
			line width=20pt, 
			rounded corners= 20pt]
	 (page.north west) rectangle (page.south east);
}



\igdefdeco{thequiz}{{\color{warmcol}[\ #1\ ]}}


%%%%% Définition du contenu de la commande \titre.
\igset[rules]{ %
	question number/.code=\gdef\ig@quesnum{#1},
	quiz number/.code=\gdef\ig@quiznum{#1}, 
	title/.code=\igname*{rules}{#1},
	quiz score/.code=\gdef\ig@quizscore{#1},
	question number=4,
	quiz number=6,
	quiz score=4,
	title={R\`egles du questionnaire}
}
\def\ig@totalscore{\number\numexpr\ig@quizscore*\ig@quiznum\relax}
\def\numbername#1{%
   \ifcase#1%
   \or un \or deux \or trois \or quatre
    \or cinq \or six \or sept \or huit
     \or  neuf \or dix \or onze \or douze 
      \or treize or quatorze \else\fi}

\NewDocumentEnvironment{regles}{O{}+b}{}{}
\NewDocumentEnvironment{webregles}{O{}+b}{%
	\igset[rules]{#1}%
	\ifblank{#2}
		{%
			\gdef\rules@body{%
				Le devoir est form\'e de \ig@quiznum{} unit\'es de \ig@quesnum{}
				questions pour un bar\`eme total de \ig@totalscore{}
				points. La note d'une unité est indivisible. 
				Pour la recevoir il faut r\'epondre
				\strut\scshape\bfseries correctement aux 
				\numbername{\ig@quesnum} questions.}
		}{%
			\long\gdef\rules@body{#2}
		}%
	}{}

% \igaddkeyword{title}{regles}{%
% 	\begin{igenv}(\csuse{name@rules})
% 		\rules@body
% 	\end{igenv}
% }
% \RenewDocumentCommand\titre{sod()}{%
% 	\iglocaltitle{|regles|}
% 	\igtitlecontents
% 	}


\AtBeginDocument{%
	\fontsize{20pt}{24pt}\selectfont
	\everymath{\displaystyle}%
}

\igset[mini]{%
	font=\Large,
	label font=\Large\scshape\bfseries\color{brightcol},
	left margin=1pc
}

\endinput
