%%%%% chargement de package, définition de couleurs, chargement de police,...


\usetikzlibrary{shapes.misc, arrows.meta}

%%% Colors 
\definecolor{cpgeblue}{HTML}{373A73}
\definecolor{cpgealtblue}{HTML}{007AFF}
\definecolor{iggreen}{HTML}{8CBA30}
\definecolor{stcol}{HTML}{D68A36}
\definecolor{cpgeblack}{HTML}{1F1F1F}

\cpgeset[colors]{    
    warm={iggreen!85!black}{iggreen},
    cold={cpgeblue}{cpgealtblue},
	link={CornflowerBlue!50!black}{CornflowerBlue!75!black},
	page={white}{cpgeblack},
	tcbtext=fgcol,
	tcbframe=warmcol,
	tcbback=bgcol,
	tcbtitle=white, 
	tcbbacktitle=warmcol,
}
\AtBeginDocument{%
	\unless\ifsoutien\colorlet{stcol}{warmcol}\fi%
}

%%%% Les boites pour les quiz 
\tcbset{%
	only top and bottom rules/.style={}
}

\tcbset{box@sep/.code=%
	\ifdim\Gm@littlemargin>\z@\relax%
		\pgfkeysalso{left=.4\Gm@littlemargin, right=.2\Gm@littlemargin}
	\else
		\pgfkeysalso{left=#1, right=#1}
	\fi}
\tcbset{generic box/.style={% 
	arc=6pt,
	boxrule=.4pt, toprule=1pt, bottomrule=1pt,
	box@sep=3pt, 
	top=8pt, bottom=8pt,
	toptitle=3pt, bottomtitle=3pt,
	fonttitle=\sffamily\scshape\bfseries,
}}
\tcbset{quiz body/.style={
	arc=6pt, sharp corners=north,
	boxsep=0pt, left=3pt, right=3pt,
	boxrule=.4pt, bottomrule=1.4pt,
	colback=bgcol, coltext=fgcol, colframe=coldcol
}}
\cpgedefdeco{quiz}{%
	\tcolorbox[%
			arc=10pt, sharp corners=south, boxrule=0pt, 
			boxsep=0pt, left=8pt, right=8pt, top=2pt, bottom=2pt,  
			colback=coldcol, coltext=white
		]
	 #1
	\endtcolorbox%
}
\cpgedefdeco{choice}{%
	\tikz[baseline=(T.base)]\node (T) 
				[inner sep=0pt, 
				rounded corners=3pt,
				fill=none, draw=coldcol, text=fgcol
		]{#1};%
	}
\cpgedefdeco{solchoice}{%
	\tikz[baseline=(T.base)]\node (T) 
				[inner sep=2pt, 
				line width=0pt, rounded corners=2pt,
				fill=warmcol, text=white
				]{#1};%
	}

\tcbset{student infos/.style={toprule=1pt, bottomrule=1pt}}

\cpgedefdeco{unite}{%
	\hfill
	\genboxcmd[boxrule=.4pt, boxsep=1.5pt, arc=5pt, left=3pt, right=3pt, colback=warmcol, colframe=white, coltext=white]
		{\sffamily\footnotesize #1 \name@unity}%
	}
\DeclareDocumentCommand\minimal@deco{O{}m}{%
		\genboxcmd[%
			tcbox raise=-1pt,
			fontupper=\sffamily,
			arc=2pt,
			boxsep=0pt, boxrule=0pt,
			tcbox width = minimum center, width=2em,
			top=2pt, bottom=2pt, right=3pt, left=3pt,  
			#1
		]
		{#2\vphantom{15}}%
	}
\DeclareDocumentCommand\longminimal@deco{O{}m}{%
		\genboxcmd[%
			tcbox raise=.1ex,
			fontupper=\sffamily,
			arc=4.5pt, sharp corners=west,
			boxsep=0pt, boxrule=0pt,
			tcbox width = minimum left, width = 2.8em,
			top=2pt, bottom=2pt, right=2pt, left=6pt,
			#1
		]
		{#2\vphantom{9}}%
	}
\DeclareDocumentCommand\arctop@deco{O{}m}{%
	\ifblank{#2}{}{%
		\genboxcmd[%
				fontupper=\sffamily,
				arc=10pt, sharp corners=south,
				boxsep=0pt, boxrule=0pt,
				width = 3.5cm, tcbox width = minimum center, 
				top=2pt, bottom=2pt, left =1pc, right=1pc,
				#1
			]{{\vphantom{)}#2}}
	}%
}
\DeclareDocumentCommand\bcpgetext@deco{O{}m}{%
	\genboxcmd[%
			fontupper=\sffamily,
			arc=4pt, %sharp corners=west,
			boxsep=0pt, boxrule=0pt,
			top=2pt, bottom=2pt, 
			right=5pt, left=5pt,
			width=4em, tcbox width=minimum center,
			#1
		]{\vphantom{)}#2}
	} 

%%% Décoration des formules
\tcbset{math@box/.style={
		reset,
		nobeforeafter,
		text width=\linewidth-6.8pt,
		colframe=warmcol,
    	title hidden,
    	tcbox raise base,
		left=3pt,right=3pt,top=2pt,bottom=2pt,
    	colback=bgcol,
    	coltext=fgcol,
		boxrule=.4pt,
		#1
	}}
\renewtcbox{\rslt@box}[1][]{math@box,#1}
%\fadjwidth=12pt
\cpgedefdeco{result}{\rslt@box[colback=bgcol!85!tcbcolbacktitle]{#1}}
\setlength\xframe@gap{6.8pt}

%%%% Styles des titres

%% Devoir 
\cpget@shape{display}{devoir}[right][right]
\def\deco@devoir#1#2{%
	\vskip20pt%
	\begin{minipage}[t]{\textwidth-1.5cm+12pt}%
			\color{coldcol}\filleft 
			\textsf{\fontsize{24}{24}\TitlingFont\color{coldcol}#1}%
			\\ \LARGE\bfseries #2%
	\end{minipage}%
}
\cpgedefdeco{devoirlabelnumberless}{%
	\begin{tikzpicture} [overlay] 
		\ifcpge@tmpswa
			\draw [warmcol, line width=12pt, rounded corners=30pt, line cap=round] 
				(.33\textwidth,0) -| (\textwidth,-1.2cm) ;
		\else
			\draw [warmcol, line width=12pt, rounded corners=30pt, line cap=round] 
				(.33\textwidth,0) -| (\textwidth,-2.4cm) ;
		\fi%
	\end{tikzpicture}\hfill%
}
\def\deco@devoirlabel#1#2{%
	\begin{tikzpicture} [overlay, baseline=(C.base)] 
		\node (C) at (30pt,0) [circle,
			top color=coldcol!80,
			bottom color=coldcol!60!black, 
			text=white,
			text width=40pt,
			align=center,
			font=\fontsize{36}{36}\bfseries,
		]{#2};
		\node [warmcol] at ([yshift=6pt] C.north) 
			{\TitlingFont\Large #1};
		\ifcpge@tmpswa 
			\draw [warmcol, line width=12pt, rounded corners=30pt, line cap=round] 
				([xshift=12pt]C.east) -| (\textwidth,-1.2cm) ; 
		\else
			\draw [warmcol, line width=12pt, rounded corners=30pt, line cap=round] 
				([xshift=12pt]C.east) -| (\textwidth,-2.8cm) ;
		\fi% 
	\end{tikzpicture}\hfill%
}
\cpgetspacing*{\@devoir}{\z@}{*1}{*6}

% Problèmes et exercices
\def\TitlingFont{\sffamily\scshape\lsstyle}
\cpge@format{\section}[display]
	{\sffamily\scshape\LARGE\color{coldcol}}
	{\color{warmcol}}
	{6pt}
	{\parbox{\columnwidth-8pt}{\filleft #1}}
\cpge@format{name=\section,numberless}[display]
		{\sffamily\scshape\LARGE\color{coldcol}}
		{\begin{tikzpicture}  [overlay] 
		\draw [warmcol, line width=.6pt, rounded corners=16pt, line cap=round] 
		(3.6cm,0) -| (\columnwidth+1.2pt,-32pt) ; 
	\end{tikzpicture}
	}
	{\z@}
	{\filleft #1}
\cpgetspacing*{\section}{\bigskipamount}{*6}{*3}

%%% Probleme
\cpget@shape{display}{problem}[left][right]
%\cpge@format{\@problem}[display]
\tikzset{
	collink/.code={%
		\ifsolution
			\tikzset{top color=linkcol!90,bottom color=linkcol!60!black}
		\else
			\tikzset{top color=neutralcol!90,bottom color=neutralcol!60!black}
		\fi}
}
\cpgedefdeco{problemlabel}{%
	\hskip-5pt\begin{tikzpicture}  [baseline=(S.base)] 
		\node (S)  [rounded rectangle,
			collink,
			inner sep=1pt, inner xsep=6pt,
			text=white,
			minimum width=2.4cm,
			align=center,
			anchor=west,
			font=\TitlingFont\large\vphantom{()},
		]{\MakeLowercase{#1}};
		\ifcpge@tmpswa%
			\draw [overlay, warmcol, line width=.6pt, rounded corners=6pt] 
				([xshift=4pt]S.east) -| (\columnwidth+6.2pt,-6pt) ;
		\else%
			\draw [overlay, warmcol, line width=.6pt, rounded corners=12pt] 
				([xshift=4pt]S.east) -| (\columnwidth+6.2pt,-28pt) ; 
		\fi
	\end{tikzpicture}\hfill%
}
\cpgedefdeco{problemlabelnumberless}{%
	\begin{tikzpicture}  [overlay, baseline=(S.base)] 
		\ifcpge@tmpswa%
			\draw [warmcol, line width=.6pt, rounded corners=6pt] 
				(.33\columnwidth) -| (\columnwidth+1.2pt,-6pt) ;
		\else%
			\draw [warmcol, line width=.6pt, rounded corners=12pt] 
				(.33\columnwidth) -| (\columnwidth+1.2pt,-24pt) ; 
		\fi
	\end{tikzpicture}\hfill%
}
\cpgedefdeco{problem}{%
	\ifblank{#1}
		{\vskip-1.2\baselineskip}
		{\color{coldcol}\parbox[t]{\columnwidth-16pt}{\filleft #1}\hskip8pt\null}%
}
\cpge@format{name=\@problem,numberless}[display]
	{\sffamily\scshape\LARGE\color{coldcol}}
	{\begin{tikzpicture}  [overlay] 
		\draw [warmcol, line width=.6pt, rounded corners=16pt, line cap=round] 
			(3.6cm,0) -| (\columnwidth+1.2pt,-32pt) ; 
	\end{tikzpicture}
	}
	{\z@}
	{\filleft #1}
\cpge@format{\parti}[hang]
	{\Large\color{coldcol}}
	{%
		\tikz[overlay]\fill [top color=coldcol!80,
			bottom color=coldcol!60!black] 
			(-2.5pt,2.5pt) circle (5pt);%
		\enskip\TitlingFont\color{warmcol} \label@parti~:~\hfill
	}
	{0pt}
	{#1}
\cpge@format{name=\parti,numberless}[hang]
	{\Large\color{coldcol}}
	{%
		\tikz[overlay]\fill [top color=coldcol!80,
			bottom color=coldcol!60!black] 
			(-2.5pt,2.5pt) circle (5pt);%
	}
	{.5em}
	{#1}

%\cpgedeflabel{parti}{|1|}
%\cpgedeflabel{partii}{|P|.|a|}
\cpgedefdeco{partii}{%
	\textcolor{warmcol}{#1}}
\cpgedefdeco{partiilabel}{%
	\longminimal@deco[colback=coldcol, coltext=white]
		{\small\bfseries#1}%
}
\cpgedefdeco{enumi}{%
	\minimal@deco[colback=neutralcol, coltext=bgcol]
		{\scriptsize\bfseries#1}%
}
\cpgedefdeco{enumii}{%
	\minimal@deco[colback=neutralcol, coltext=bgcol]
		{\scriptsize\bfseries#1}%
}
\cpgedefdeco{enumiii}{%
	\minimal@deco[colback=neutralcol, coltext=bgcol]
		{\scriptsize\bfseries#1}%
}
\cpgedefdeco{nolinkenumi}{%
	\minimal@deco[colback=neutralcol, coltext=bgcol]
		{\scriptsize\bfseries#1}%
}
\cpgedefdeco{nolinkenumii}{%
	\minimal@deco[colback=neutralcol, coltext=bgcol]
		{\scriptsize\bfseries#1}%
}
\cpgedefdeco{nolinkenumiii}{%
	\minimal@deco[colback=neutralcol, coltext=bgcol]
		{\scriptsize\bfseries#1}%
}
\cpgedefdeco{linkenumi}{%
	\minimal@deco[colback=linkcol, coltext=white]
		{\scriptsize\bfseries#1}%
}
\cpgedefdeco{linkenumii}{%
	\minimal@deco[colback=linkcol, coltext=white]
		{\scriptsize\bfseries#1}%
}
\cpgedefdeco{linkenumiii}{%
	\minimal@deco[colback=linkcol, coltext=white]
		{\scriptsize\bfseries#1}%
}
\cpgedefdeco{innersol}{%
	\longminimal@deco[colback=linkcol, coltext=white]
		{\scriptsize\bfseries#1}%
	}

% \tcbset{%
% 	font/.style={fontupper=#1},
% 	collink/.style={%
% 		colframe=linkcol,
% 		colback=linkcol,  
% 		coltext=white, 
% 		font=\small\bfseries},
% 	soldeco/.style={%
% 		collink,
% 		tcbox width=forced left,
% 		text width=2.4em,
% 		arc=3pt,
% 		font=\small\bfseries},
% 	enodeco/.style={
% 		tcbox width=forced center,
% 		text width=2em,
% 		arc=3pt,
% 		boxsep=0pt, top=1pt, bottom=1pt,
% 		font=\small\bfseries}
% }

%%% environnement mini
\def\funnyarrow#1#2{%
	\tikz[baseline] 
		\draw [
				line width=\dimexpr\fntht x, #2, 
				-{Round Cap[sep=-1pt] . Fast Round[]}
			] 
        (0,\dimexpr.5\fntht x) -- (#1,\dimexpr.5\fntht x);%
}
\cpgeset[mini]{%
	mini deco=\llap{\funnyarrow{1.2em}{warmcol}}%
		\textcolor{coldcol}{#1.}\kern1ex%
}
%%% Page de garde 
\def\title@document{%
	{\Large\bfseries\color{cpgeblue}\cpge@relsize
		\csuse{cpge@document}%
     \global\cpge@dima\baselineskip%
	}%
	\baselineskip\cpge@dima%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%% Page de garde %%%%%%  
%%%%%%%%%%%%%%%%%%%%%%%%%%%
\def\STRIP{}
\let\endStrip\relax
\newif\ifcover@exists 
\cover@existstrue
\def\setcover@back#1{%
	\IfFileExists{../../img/cover/#1-\cpge@classe.pdf}
		{\pgfdeclareimage[width=1.05\pdfpagewidth]
			{cover}
			{../../img/cover/#1-\cpge@classe}%%
		}{
			\IfFileExists{#1-\cpge@classe.pdf}
				{\pgfdeclareimage[width=1.05\pdfpagewidth]
					{cover}
					{#1-\cpge@classe}%%
				}{
				\cover@existsfalse%
				\colorlet{coverfill}{stcol}%
				}%
		}
\ifcover@exists%
	\iftitlepage@exception%
		\tikz [overlay,remember picture]%
			\node at ([xshift=1.9cm, yshift=.4cm]current page.south) 
			[anchor=south,inner sep=0] 
			{\pgfuseimage{cover}};%
	\else%
		\tikz [overlay,remember picture]%
			\node at ([xshift=0pt, yshift=0pt]current page.south) 
			[anchor=south,inner sep=0] 
			{\pgfuseimage{cover}};%
	\fi%
\else%
	\iftitlepage@exception%
		\tikz [overlay]
			\draw [coldcol, fill=coverfill,  line width=6pt]
			(2.25cm,-2cm) rectangle 
			(\textwidth, -\pdfpageheight+4cm);%
	\else%
		\tikz [overlay, remember picture]
			\draw [coldcol, fill=coverfill,  line width=3pt]
			(3pt,-1.5pt) rectangle 
			(\textwidth-6pt,-\pdfpageheight+13.5pt) ;
	\fi% 
\fi%
}

\NewDocumentEnvironment{cgnew@title@page}{}{%
	\color{white}%
	\ignorespaces%
	\ifsoutien%
		\pagecolor{iggreen}% 
		\setcover@back{capge}%
	\else%
		\pagecolor{white}%
		\setcover@back{cpge}%
	\fi%
	\hfill%
	\iftitlepage@exception%
		\smash{%
			\resizebox{.33\paperwidth}{!}{%
				\bfseries\scshape\color{cpgeblue}%
				\csuse{cpge@matiere}%
			}%
		}%
	\else%
		\vskip.01\pdfpageheight\leavevmode%
		\hfill\smash{%
			\resizebox{.33\paperwidth}{!}{%
				\bfseries\scshape\color{cpgeblue}%
				\csuse{cpge@matiere}%
			}%
		}%
		\hskip.05\pdfpagewidth\null%
		\par\vskip-.05\pdfpageheight\vskip-\baselineskip%
	\fi%
	\null\vskip.18\pdfpageheight%
	\hfill%
	\begin{minipage}{.75\textwidth}
	\fil@inner@titlepage% 
}{%
	\end{minipage}%
	\hskip\z@ plus.1fill\null\vfill%
}
\newif\ifwire@exists
\wire@existstrue
\def\setwire@title{
	\ifstriptitle%
		\dimdef\wire@width{\textwidth}%
	\else%
		\dimdef\wire@width{\columnwidth}%
	\fi %
	\IfFileExists{../../img/cover/twire.pdf}
		{\pgfdeclareimage[width=\wire@width]{twire}
			{../../img/cover/twire}
		}{
			\IfFileExists{twire.pdf}
				{\pgfdeclareimage[width=\wire@width]{twire}
					{twire}}
				{\wire@existsfalse}
		}
	\IfFileExists{../../img/cover/bwire.pdf}
		{\pgfdeclareimage[width=\wire@width]{bwire}
			{../../img/cover/bwire}
		}{
			\IfFileExists{bwire.pdf}
				{\pgfdeclareimage[width=\wire@width]{bwire}
					{bwire}}
				{\wire@existsfalse}
		}
} 
\NewDocumentEnvironment{cgnew@title@inline}{}{%
		\thispagestyle{plain}%
		\setwire@title
		\begin{STRIP}%
		\ifwire@exists\tikz\node{\pgfuseimage{twire}};\par\fi
		\fil@inner 
}{%
		\par\medskip
		\begin{tikzpicture}
			\ifwire@exists\node {\pgfuseimage{bwire}};\fi
			\node  
				[	xshift=.5\linewidth, 
					anchor=east,
					white, 
					font=\sffamily\bfseries\cpge@relsize,
					inner sep=0pt
				]
			{\cpge@classe\kern6pt};
		\end{tikzpicture}
		\end{STRIP}%
}
\cpgeset[title]{%
	before 	=	\ifstriptitle
					\let\STRIP\strip%
					\let\endSTRIP\endstrip%
				\fi%
				\let\title@centre\relax%
				\let\title@classe\relax%
				\begin{cgnew@title@inline},
	after 	=	\end{cgnew@title@inline},
	before* =	\let\title@centre\relax%
				\let\title@classe\relax%
				\begin{cgnew@title@page},
	after*	=	\end{cgnew@title@page},
	inner align*=l,
	afterskip=2
}
\AtEndPreamble{%
	\iftitlepage
		\renew@title@format[4]
			(\bfseries\color{cpgeblue})
			{document}%
		\renew@title@format[4]
			(\bfseries\color{cpgeblue})
			{concours}%	
		\renew@title@format[3]
			(\scshape\bfseries)
			{theme}%
		\renew@title@format[3]
			(\scshape\bfseries)
			{epreuve}%
		\renew@title@format[2]
			(\scshape)
			{subtheme}%
		\renew@title@format[2]
			(\scshape)
			{periode}%
		\renew@title@format[2]
			(\scshape)
			{session}%
		\renew@title@format
			(\hfill\tiny)
			{auteur}%
		\fi%
}
\cpgedeftitleformat*{
  |document|\par
  \bigskip\hrule\bigskip
  |theme|\\
  |subtheme|\par
  \bigskip
  |auteur|
}
\cpgedeftitleformat{
  |document|\par
  \bigskip
  |theme|\\
  |subtheme|\par
  \bigskip
  |auteur|
}
%%%% Tete et pied de page
\newif\iffootimage@exists
\newdimen\logo@width
\newdimen\head@height
\logo@width=.2\paperwidth
\ifdim\logo@width>2cm\relax	
	\logo@width=2cm
\fi
\head@height=\dimexpr\headsep+\headheight\relax
\def\setfoot@logo#1{
	\ifnofootimage
		\footimage@existsfalse
	\else
		\IfFileExists{../../img/cover/#1_foot.pdf}
			{\pgfdeclareimage[width=\logo@width]{logofoot}
				{../../img/cover/#1_foot}
			}{
				\IfFileExists{#1_foot.pdf}
					{\pgfdeclareimage[width=\logo@width]{logofoot}
						{#1_foot}}
					{\footimage@existsfalse}
			}
	\fi%
}
%%%% En tete
\let\newcg@head\relax
\unless\ifprint
	\def\newcg@head{
	\tikz[overlay]
	\draw [stcol, line width=\head@height] 
	(-.75\paperwidth,.5\head@height-3pt) -- 
	(\paperwidth+3cm,.5\head@height-3pt);
	}
\fi%
%%%% Pieds de page
\def\cpgecenterenter{Ibn\! Ghazi}
\ifsoutien
	\setfoot@logo{capge}
\else 
	\setfoot@logo{cpge}
\fi 
\iffootimage@exists	
	\def\newcg@foot{%
		\begin{tikzpicture}[overlay, yshift=8pt] 
			\draw [stcol] (-3cm,0) -- (\paperwidth,0) ;
			\node  at (\textwidth,0)
			[inner ysep=0pt, inner xsep=5pt, 
			anchor=east, fill=pagecol]
			{\pgfuseimage{logofoot}};%
		\end{tikzpicture}%
	}
\else
	\def\newcg@foot{%
		\begin{tikzpicture}[overlay, yshift=8pt] 
			\draw [baseline, stcol] (-3cm,0) -- (\paperwidth,0) ;
			\node at (\textwidth,0)
			[anchor=east, baseline, yshift=.5ex,
			fill=pagecol, font=\sffamily\scshape\bfseries] 
			{\color{stcol}\small cpge\kern1ex\large\color{coldcol}\cpgecenterenter};%
		\end{tikzpicture}%
	}
\fi 
\AtEndPreamble{%
	\renewpagestyle{cpgemain}[\fontsize{8}{8}\sffamily\scshape\itshape]{%
		\renewcommand\makeheadrule{\newcg@head}%
		\renewcommand\makefootrule{\newcg@foot}%
		\cpgesethead(|theme|)()(|document|)%
		\cpgesetfoot(|classe|)(|pages|)()%
	}
	\renewpagestyle{plain}[\fontsize{8}{8}\sffamily\scshape\itshape]{%
		\renewcommand\makefootrule{\newcg@foot}%
		\sethead{}{}{}%
		\setfoot{}{\thepage}{}%
	}%
}
\endinput
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
