\def\filedate{2024/06/06}
\def\fileversion{v0.1alpha}
\def\fileauthor{Sadik Boujaida}

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{cpgecommon}[\filedate\space\fileversion]

\newif\ifcustomtitles
\DeclareOption{customtitles}{\customtitlestrue}
\ProcessOptions\relax


\@ifundefined{NewDocumentCommand}
	{\RequirePackage{xparse}}
	{}
\ifundef\cpgesetup
{
	\pgfkeysifdefined{/cpge/.is family}{}{\pgfkeys{/cpge/.is family}}
	\NewDocumentCommand\cpgesetup{o}{%
    	\IfValueT{#1}
   			{\pgfkeysifdefined{/cpge/#1/.is family}{}{\pgfkeys{/cpge/#1/.is family}}}%
    	\IfValueTF{#1}{\pgfqkeys{/cpge/#1}}{\pgfqkeys{/cpge}}%
	}%
}{}

\ifcustomtitles
   \RequirePackage[loadonly,explicit,nobottomtitles*,pagestyles]{titlesec}
\else 
   \RequirePackage[explicit,nobottomtitles*,pagestyles]{titlesec}
\fi 
\RequirePackage{titletoc}

%%%%% gestion de la couleur
\RequirePackage{cpgecolor}

%%% hyperref, aboslument indispensable
\RequirePackage[pdfencoding=auto,psdextra]{hyperref}
\hypersetup{colorlinks,linkcolor=linktextcol,urlcolor=linktextcol,breaklinks,raiselinks}
\pdfstringdefDisableCommands{%
	\def\({}%
	\def\){}%
}
\let\ToP\texorpdfstring
\ProvideDocumentCommand\MakeLinkTarget{sO{}m}{}
\ProvideDocumentCommand\LinkTargetOn{}{}
\ProvideDocumentCommand\LinkTargetOff{}{}
\ProvideDocumentCommand\NextLinkTarget{m}{}
\newif\ifsoutien


%%%% Structure de bas niveau d'inclusion de fichiers  
%%%% Ajout 09/10/2023
%%%% emprunté à answers.sty et tcolorbox.sty avec adaptation 
%%%% Pemet d'écrire les solutions dans un fichier séparé.
%%%% L'écriture ne se produit que si \ifsolution est initialisé en true.  
%%%% \ifsolution doit être déclaré par la classe avant le chargement de cpgebase.sty.
%%%% Sa création ici provoquera sa réinitialisation en false. 


%%% tcolorbox.sty : 
%%% environnement : {cpgewriteonce}, #1 est le nom d'un fichier physique
%%% crée le fichier #1, l'associe au stream cpgeoutonce, y écrit et le ferme.
%%% si \cpgewriteonce est utilisé dans un environnement avec un/des arguments
%%% optionnels, veiller à ce que les arguments suivent le nom de l'environnement
%%% sur la même ligne et sans espaces entre eux pour empêcher TeX d'aller chercher 
%%% trop loin des arguments, avalant des espaces et empêchant une lecture
%%% verbatim correcte.  (prefixer les spec des arguments xparse par !)
\RequirePackage{verbatim}

\let\cpge@verbatim@begin@hook\@empty
\let\cpge@verbatim@end@hook\@empty
\let\cpge@verbatim@change@percent\@empty
\let\cpge@set@verbatim@finish\@empty
\def\cpgewriteonce#1{%
  \@bsphack
  \cpge@set@verbatim@finish
  \cpgeopenfile{solhandle}
  \immediate\openout\solhandle@file #1.tex
  \cpge@verbatim@begin@hook%
  \let\do\@makeother\dospecials
  \cpge@verbatim@change@percent\catcode`\^^M\active \catcode`\^^I=12
  \def\verbatim@processline{%
    \immediate\write\solhandle@file
      {\the\verbatim@line}}%
  \verbatim@start}%'
\def\endcpgewriteonce{%
  \cpge@verbatim@end@hook%
  \immediate\closeout\solhandle@file
  \@esphack%
}

%%%% Le système record
\def\cpge@allocate@out{\newwrite\cpge@out}
\def\cpge@null#1{}
\let\cpgerecord\cpge@null
\newcommand{\cpge@record}[1]{\immediate\write\cpge@out{#1}}
\newif\ifcpgerecordfileopen
\newcommand{\cpgestartrecording}[1][\jobname]{%
   \unless\ifcpgerecordfileopen%
      \let\cpgerecord\cpge@record%
      \xdef\cpge@recordfile{#1.rec}%
      \global\cpgerecordfileopentrue%
      \cpge@allocate@out%
      \@xp\immediate\@xp\openout\@xp\cpge@out\cpge@recordfile%
   \fi%
}

\newcommand{\cpgestoprecording}{%
   \ifcpgerecordfileopen%
      \immediate\closeout\cpge@out%
      \global\cpgerecordfileopenfalse%
      \let\cpgerecord\cpge@null%
   \fi%
}

%%% answers.sty : 
%%% environnement : {cpgefilesave}, #1 est le nom d'un stream. 
%%% \cpgeopenfile{#1}[#2] crée le stream #1 et l'associe à au fichier physique #2, 
%%% sans #2 un fichier physique de nom #1 est crée.
%%% \cpgeclosefile{#1} ferme le stream #1, 
%%% \cpgereadfile{#1} ouvre le fichier associé au stream #1 s'il existe, 
%%% \cpgereadfile est remplaçable par un \input direct sur le fichier physique.
%%% plusieurs écritures possibles entre fermeture et ouverture du stream.
%%% possible de changer de fichier physique associé au stream, 
%%% aucune écriture si \solutionfalse : 
%%% fichier physique créé par \cpgeopenfile mais reste vide.

\long\def\cpgeprotected@iwrite#1#2#3{%
  \begingroup
    \let\thepage\relax
    #2%
    \let\protect\@unexpandable@protect
    \edef\reserved@a{\immediate\write#1{#3}}%
    \reserved@a
  \endgroup
  \if@nobreak
    \ifvmode
      \nobreak
    \fi
  \fi
}

\newenvironment{cpgefilesave}[1]{%
   \@bsphack
   \def\verbatim@processline{}%
   \ifcpge@fileundefined{#1}{}{%
      \ifcpge@open{#1}{%
         \def\verbatim@processline{%
            \ifcpge@solution{%
               \immediate\write\@nameuse{#1@file}%
                  {\the\verbatim@line}%
            }{}%
         }%
      }{}%
   }%
   \let\do\@makeother\dospecials
   \catcode`\^^M\active \catcode`\^^I=12\relax
   \verbatim@start
}{\@esphack}

\newcommand{\cpgewritetofile}[2]{%
   \@bsphack
   \ifcpge@fileundefined{#1}{}{%
      \ifcpge@open{#1}{%
         {%
            \let\protect\string
            \ifcpge@solution{%
               \cpgeprotected@iwrite{\@nameuse{#1@file}}{}{#2}%
            }{}%
         }%
      }{}%
   }%
   \@esphack%
}

\newcommand{\ifcpge@open}[3]{%
   \csname if#1open\endcsname#2\else#3\fi}%
   
\newcommand{\ifcpge@fileundefined}[3]{%
   \csname ifx\expandafter\endcsname
      \csname #1@file\endcsname\relax
      #2\else#3\fi}
      
\newcommand{\ifcpge@solution}[2]{%
   \ifsolution #1\else #2\fi}
   
\def\cpgeopenfile#1{%
	\expandafter\ifx\csname #1opentrue\endcsname\relax
      \expandafter\newif\csname if#1open\endcsname
   \fi
   \@ifnextchar[{\cpgedefine@filename{#1}}%
      {\cpgedefine@filename{#1}[#1]}}%
      
\def\cpgedefine@filename#1[#2]{%
   \global\@namedef{#1@filename}{#2.tex}%
   \ifcpge@solution{%
      \typeout{Écriture de #1 dans
        #2.tex}%
   }{}%
   \ifcpge@fileundefined{#1}{%
      \expandafter\newwrite\csname #1@file\endcsname
      \csname newif\expandafter\endcsname
         \csname if#1open\endcsname
      \global\csname #1openfalse\endcsname
      \expandafter\ifx\csname Open#1hook\endcsname\relax
         \global\@namedef{Open#1hook}##1{}%
      \fi
      \expandafter\ifx\csname Close#1hook\endcsname\relax
         \global\@namedef{Close#1hook}##1{}%
      \fi
   }{}%
   \let\Tmp\relax
   \ifcpge@open{#1}{\typeout{Fichier #1 déjà ouvert}}{%
      \ifcpge@solution{%
         \immediate\openout\@nameuse{#1@file}=%
         \@nameuse{#1@filename}%
      }{}%
      \global\csname#1opentrue\endcsname
      \def\Tmp{\@nameuse{Open#1hook}{#1}}%
   }%
   \Tmp
}

\def\cpgeclosefile#1{%
   \let\Tmp\relax
   \ifcpge@fileundefined{#1}{}{%
      \ifcpge@open{#1}{%
         \ifcpge@solution{%
            \immediate\closeout\@nameuse{#1@file}%
         }{}%
         \global\csname #1openfalse\endcsname
         \def\Tmp{\@nameuse{Close#1hook}{#1}}%
      }{}%
   }%
   \Tmp
}

\def\cpgereadfile#1{%
   \ifcpge@solution{%
      \ifcpge@fileundefined{#1}{}{%
         \ifcpge@open{#1}{%
            \typeout{WARNING: tentative de lire le fichier ouvert #1}%
         }{%
            \edef\Tmp{%
               \noexpand\InputIfFileExists
                  {\@nameuse{#1@filename}}{}%
               {\noexpand\message{Fichier
                  \@nameuse{#1@filename}%
                     \space non trouvé}}%
            }%
            \Tmp
         }%
      }%
   }{}%
}

%%% Si le moteur de compilation est luatex
%%% charger pdftexcmd.sty qui définit certaines 
%%% primitives pdftex qui ne sont pas disponibles dans lualatex
\RequirePackage{ifluatex}
\ifluatex\RequirePackage{pdftexcmds}\fi 
\def\IfFileEmpty#1{%
   \ifnum0\pdf@filesize{#1}>0
      \expandafter\@secondoftwo
   \else
      \expandafter\@firstoftwo
   \fi
}

%%% Ajout 05/08/2021
%%% gestion des références croisées VANILLA du noyaux LaTeX
%%% les commandes ne sont pas utilisables dans les documents finaux.

\def\cpgeG@refundefinedtrue{%
  \gdef\cpge@refundefined{%
    \@latex@warning@no@line{There were undefined references}}}
    
\let\cpge@refundefined\relax

\def\cpge@setref#1#2#3{%
  \ifx#1\relax
   \protect\cpgeG@refundefinedtrue
   \nfss@text{\reset@font\bfseries ??}%
   \@latex@warning{Reference `#3' on page \thepage \space
             undefined}%
  \else
   \expandafter#2#1\null
  \fi}
  
\def\cpgeref#1{\expandafter\cpge@setref\csname r@#1\endcsname\@firstoftwo{#1}}

\def\cpgepageref#1{\expandafter\cpge@setref\csname r@#1\endcsname
                                   \@secondoftwo{#1}}
\def\cpge@newl@bel#1#2#3{{%
  \@ifundefined{#1@#2}%
    \relax
    {\gdef \cpge@multiplelabels {%
       \@latex@warning@no@line{There were multiply-defined labels}}%
     \@latex@warning@no@line{Label `#2' multiply defined}}%
  \global\@namedef{#1@#2}{#3}}}
\def\cpgenewlabel{\cpge@newl@bel r}

%\@onlypreamble\cpge@newl@bel
\let\cpge@multiplelabels\relax

\def\cpgelabel#1{\@bsphack
  \immediate\write\@auxout{\string\cpgenewlabel{#1}{{\@currentlabel}{\thepage}}}%
  \@esphack}


\def\cpgeref@setcounter#1#2{%
   \setcounter{#1}{#2}%
   \edef\@currentcounter{#1}%
   \edef\@currentlabel
       {\csname p@#1\expandafter\endcsname\csname the#1\endcsname}%
}
\def\cpgeref@stepcounter#1{%
   \stepcounter{#1}%
   \edef\@currentcounter{#1}%
   \edef\@currentlabel
       {\csname p@#1\expandafter\endcsname\csname the#1\endcsname}%
}
% commande ajoutée pour référencer un compteur en utilisant \addtocounter
\def\cpgeref@addtocounter#1#2{%
    \addtocounter{#1}{#2}%
    \edef\@currentcounter{#1}%
    \edef\@currentlabel
    {\csname p@#1\expandafter\endcsname\csname the#1\endcsname}% 
 }
\def\cpge@labelformat#1{\expandafter\def\csname p@#1\endcsname##1}
\DeclareRobustCommand\cpgeRef[1]{\edef\@tempa{\cpgeref{#1}}%
   \expandafter\Makeuppercase\@tempa}


%%% code inspired by glocalvals.sty
\newcommand{\usevalue}[1]{\csuse{cpge:#1}}
\newcommand{\defvalue}[2]{%
\ifcsname cpge:#1:defined\endcsname
  \PackageError{cpgecommon}{Value "#1" already defined}{}%
\else%
  \immediate\write\@auxout{\string\csgdef{cpge:#1}{#2}}%
  \csgdef{cpge:#1:defined}{}%
  \csgdef{cpge:#1}{#2}%
  \PackageInfo{cpgecommon}{Defining new variable "#1" with value "#2"}%
\fi%
}

%%%%% Si jamais cpgebase.sty n'est pas chargé 
\ifundef{\cpgeaddkeyword}{%
	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%% Commandes utilitaires multi-usage %%%%%
\def\cslocal{%
\let\lorg@cslet=\cslet%
\let\lorg@csletcs=\csletcs%
\let\lorg@def=\def%
\let\lorg@edef=\edef%
\let\lorg@csdef=\csdef%
\let\lorg@csedef=\csedef%
\let\lorg@listadd=\listadd%
\let\lorg@listeadd=\listeadd%
\let\lorg@listcsadd=\listcsadd%
\let\lorg@listcseadd=\listcseadd%
\let\lorg@csappto=\csappto%
\let\lorg@cseappto=\cseappto%
\let\lorg@appto=\appto%
\let\lorg@eappto=\eappto%
}
\def\csglobal{%
\begingroup\cpge@globaltrue%
\def\lorg@cslet{\global\cslet}%
\def\lorg@csletcs{\golbal\csletcs}%
\let\lorg@def=\gdef%
\let\lorg@edef=\xdef%
\let\lorg@csdef=\csgdef%
\let\lorg@csedef=\csxdef%
\let\lorg@listadd=\listgadd%
\let\lorg@listeadd=\listxadd%
\let\lorg@listcsadd=\listcsgadd%
\let\lorg@listcseadd=\listcsxadd%
\let\lorg@csappto=\csgappto%
\let\lorg@cseappto=\csxappto%
\let\lorg@appto=\gappto%
\let\lorg@eappto=\xappto%
}
\def\endcslorg{\ifcpge@global\endgroup\fi}
\cslocal
\def\undef@afterexec#1{\ifdefvoid{#1}{\relax}{#1}\gundef{#1}}
\def\csundef@afterexec#1{\csuse{#1}\csgundef{#1}}
\def\cpge@removestar#1*{#1}
\def\cpge@removeplus#1+{#1}
\def\cpge@erasestar*#1+{#1}
\def\if@staratend#1{%
	\def\in@@{\in@{*!}}%
	\@xp\in@@\@xp{#1!}%
	\ifin@%
		\edef\x@arg{\cpge@removestar#1}\expandafter\@firstoftwo%
	\else%
		\def\x@arg{#1}\expandafter\@secondoftwo%
	\fi%
}
\def\if@plusatend#1{%
	\def\in@@{\in@{+!}}%
	\@xp\in@@\@xp{#1!}%
	\ifin@%
		\edef\x@arg{\cpge@removeplus#1}\expandafter\@firstoftwo%
	\else%
		\def\x@arg{#1}\expandafter\@secondoftwo%
	\fi%
}
%\NewDocumentCommand\cpgesetdeco{ s mom}{%
%}
\newcommand\cpgesetdeco{\@ifstar\cpge@deco@\cpge@deco}
\long\def\cpge@deco#1#2{%
\long\csdef{deco@#1}##1{\color@begingroup#2\color@endgroup}}
\long\def\cpge@deco@#1#2{%
\long\csdef{deco@#1}{#2}}
\long\def\usedeco#1{\csuse{deco@#1}}
\cpgesetdeco*{simple}{\fbox}
\DeclareDocumentCommand\cpgename{smm}{%
\IfBooleanT{#1}{\csglobal}%
\lorg@csdef{name@#2}{#3}%
\endcslorg%
}
\DeclareDocumentCommand\cpgexname{smm}{%
\IfBooleanT{#1}{\csglobal}%
\lorg@csedef{name@#2}{#3}%
\endcslorg%
}
\cpgesetup[decorations]{%
.unknown/.code=\cpgesetdeco{\pgfkeyscurrentname}{#1}
}
\def\cpgethe#1{\ifnum\value{#1}>\z@\csuse{the#1}.\fi}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%% base de la gestion des mots clés entre ||  %%%%%
%%%%% Commandes pour le parsing des elements
\DeclareListParser*{\OutParser}{|}
%% \OutParser{\cmd}{item1|item2|...} retourne la séquence
%% \cmd{item1}\cmd{item2}...
\DeclareListParser*{\in@parser}{+}
%% \in@parser{\cmd}{item1+item2+...} retourne la séquence
%% \cmd{item1}\cmd{item2}...
\def\DoubleParser#1#2#3{%
\def\tmp@parser##1{#1{\in@parser{#2}{##1}}}%
\OutParser{\tmp@parser}{#3}%
}
%% \DoubleParser{\cmd1}{\cmd2}{1a+1b|2a+2b+2c|...} retourne la sequence 
%% \cmd1{\cmd2{1a}\cmd2{1b}}\cmd1{\cmd2{2a}\cmd2{2b}\cmd2{2c}}...
\DeclareDocumentCommand\csvtolistcsadd{smm}{%
\IfBooleanT{#1}{\csglobal}%
\def\do{\forcsvlist{\lorg@listcsadd{#2}}}
\expandafter\docsvlist\expandafter{#3}
\endcslorg%
}
\DeclareDocumentCommand\csvtolistcseadd{smm}{%
\IfBooleanT{#1}{\csglobal}%
\def\do{\forcsvlist{\lorg@listcseadd{#2}}}
\expandafter\docsvlist\expandafter{#3}
\endcslorg%
}
\DeclareDocumentCommand\csvtolistadd{smm}{%
\IfBooleanT{#1}{\csglobal}%
\def\do{\forcsvlist{\lorg@listadd{#2}}}
\expandafter\docsvlist\expandafter{#3}%
\endcslorg%
}
\DeclareDocumentCommand\csvtolisteadd{smm}{%
\IfBooleanT{#1}{\csglobal}%
\def\do{\forcsvlist{\lorg@listeadd{#2}}}
\expandafter\docsvlist\expandafter{#3}%
\endcslorg%
}
%%% Gestion de listes CSV
\newrobustcmd{\csvadd}[2]{%
\ifblank{#2}{}{\appto#1{#2,}}}
\newrobustcmd{\csveadd}[2]{%
\begingroup%
\edef\cpgeb@tempa{\endgroup\noexpand\ifblank{#2}}%
\cpgeb@tempa{}{\eappto#1{#2,}}}
\newrobustcmd{\csvgadd}[2]{%
\ifblank{#2}{}{\gappto#1{#2,}}}
\newrobustcmd{\csvxadd}[2]{%
\begingroup%
\edef\cpgeb@tempa{\endgroup\noexpand\ifblank{#2}}%
\cpgeb@tempa{}{\xappto#1{#2,}}}
\newrobustcmd{\csvcsadd}[1]{%
\expandafter\csvadd\csname#1\endcsname}
\newrobustcmd{\csvcseadd}[1]{%
\expandafter\csveadd\csname#1\endcsname}
\newrobustcmd{\csvcsgadd}[1]{%
\expandafter\csvgadd\csname#1\endcsname}
\newrobustcmd{\csvcsxadd}[1]{%
\expandafter\csvxadd\csname#1\endcsname}
\newrobustcmd{\csvremove}[2]{%
\cpgeb@csvremove{#1}{#2}\def}
\newrobustcmd{\csvgremove}[2]{%
\cpgeb@csvremove{#1}{#2}\gdef}
\long\def\cpgeb@csvremove#1#2#3{%
\ifblank{#2}
{}
{\ifincsv{#2}{#1}{%
 \begingroup%
 \def\cpgeb@tempa##1,#2,##2&{\endgroup%
   \expandafter#3\expandafter#1\expandafter{\@gobble##1,##2}}%
\expandafter\cpgeb@tempa\expandafter,#1&}{}}%
}
\newrobustcmd{\csvcsremove}[1]{%
\expandafter\csvremove\csname#1\endcsname}
\newrobustcmd{\csvcsgremove}[1]{%
\expandafter\csvgremove\csname#1\endcsname}
\newrobustcmd{\ifincsv}[2]{%
\begingroup
\def\cpgeb@tempa##1,#1,##2&{\endgroup%
\ifblank{##2}\@secondoftwo\@firstoftwo}%
\expandafter\expandafter\expandafter\cpgeb@tempa%
\expandafter\expandafter\expandafter,\expandafter\zap@space#2 \@empty,#1,&}
\newrobustcmd{\xifincsv}[1]{%
\begingroup%
\edef\cpgeb@tempa{\endgroup\ifincsv{#1}}%
\cpgeb@tempa}
\newrobustcmd{\ifincsvcs}[2]{%
\expandafter\cpgeb@ifincsvcs@i\csname #2\endcsname{#1}}
\long\def\cpgeb@ifincsvcs@i#1#2{\ifincsvcs{#2}{#1}}
\newrobustcmd{\xifincsvcs}[1]{%
\begingroup%
\edef\cpgeb@tempa{\endgroup\ifincsvcs{#1}}%
\cpgeb@tempa}
%% ajoute les éléments de #2 (separe par des virgules)
%% a la liste interne \list@#1
\DeclareDocumentCommand\cpgeaddkeyword{st+m+m+m}{%
\csvtolistcsadd{list@#3}{#4}%
\IfBooleanT{#1}{\csglobal}%
\IfBooleanTF{#2}{\long\lorg@csdef{#3@#4}##1{#5}}{\long\lorg@csdef{#3@#4}{#5}}%
\endcslorg%
}%
}{}

%%%%% Gestion des métadonnées 
\newcommand\addmeta[4]{%
   \csdef{#1}##1{%
      \csgdef{cpge@#2}{##1}%
      \csgdef{cpge@#2@format}{{#3{##1}}}%
   }
   \ifblank{#4}{}{\csuse{#1}{#4}}%
}
\newcommand\usemeta[1]{\csuse{cpge@#1@format}}
\def\ifdefmeta#1{\ifcsdef{cpge@#1}}

\addmeta{Centre}{centre}{\scshape}{}
\addmeta{Ville}{ville}{\scshape}{}
\addmeta{Classe}{classe}{\scshape}{}
\addmeta{Matiere}{matiere}{\scshape}{}

\addmeta{Auteur}{auteur}{\scshape}{}
\addmeta{Email}{email}{\ttfamily}{}
\addmeta{Website}{website}{\ttfamily\url}{}
\addmeta{Preauteur}{preauthor}{\itshape}{Rédigé par~}

\addmeta{Document}{document}{}{}
\addmeta{Devoir}{devoir}{}{}
\addmeta{Theme}{theme}{}{}
\addmeta{Subtheme}{subtheme}{}{}
\addmeta{Periode}{periode}{}{}

\addmeta{Concours}{concours}{}{}
\addmeta{Epreuve}{epreuve}{}{}
\addmeta{Session}{session}{\itshape Session\space}{}
\addmeta{Duree}{duree}{\@duree}{}
\def\@duree#1{Durée~:~#1~heures}
\addmeta{Texte}{texte}{\@texte}{}
\def\@texte#1{\parbox{.75\columnwidth}
   {\centering #1}%
}
\cpgesetup[meta]{%
   add/.code n args={4}{%
      \addmeta{#1}{#2}{#3}{#4}%
      \pgfqkeys{#1/.code=\csuse{#1}{##1}}%
      },
	Centre/.code=\Centre{#1},
	Classe/.code=\Classe{#1},
	Auteur/.code=\Auteur{#1},
	Email/.code=\Email{#1},
	Website/.code=\Website{#1},
   	Preauteur/.code=\Preauteur{#1},
	Matiere/.code=\Matiere{#1},
	Document/.code=\Document{#1},
   	Devoir/.code=\Devoir{#1},
	Theme/.code=\Theme{#1},
   	Subtheme/.code=\Subtheme{#1},
	Concours/.code=\Concours{#1},
	Session/.code=\Session{#1},
	Epreuve/.code=\Epreuve{#1},
	Periode/.code=\Periode{#1},
	Duree/.code=\Duree{#1},
   	Texte/.code=\Texte{#1},
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% Décoration de l'arrière-plan %%%%%

%%%% première application de la  commande \cpgesetup ci-dessus
\cpgesetup[background]{
	position/.is choice,
	position/pb/.code=\def\back@pos{\AtPageLowerleft},
	position/pt/.code=\def\back@pos{\AtPageupperleft},
	position/pc/.code=\def\back@pos{\AtPageCenter},
	position/tb/.code=\def\back@pos{\AtTextLowerleft},
	position/tt/.code=\def\back@pos{\AtTextupperleft},
	position/tc/.code=\def\back@pos{\AtTextCenter},
	code/.code=\def\back@code{#1},
}
\cpgesetup[background]{position=pb, code=\relax}

%%% Fonts loading. 
\RequirePackage{ifxetex} 
\cpgesetup[font]{%
	libertine/.code={%
		\def\load@thefonts{
			\ifxetex
				\RequirePackage{fontspec}
				\let\lsstyle\relax
			\else 
				\RequirePackage[T1]{fontenc}
				\RequirePackage{microtype}
			\fi
			\RequirePackage[french]{babel}
			\RequirePackage[tt=false]{libertine}
			 \RequirePackage[%
			 	libertine,smallerops,bigdelims,upint,vvarbb
			 ]{newtxmath}
			%\usepackage[amsthm,sansmath]{libertinust1math}
			\usepackage[scr=boondoxo,bb=boondox]{mathalpha}
			\RequirePackage[scaled=.8]{FiraMono}
			\useosf
			\def\TitlingFont{\sffamily\scshape}
	}},
	garamond/.code={%
		\def\load@thefonts{
			\ifxetex
				\RequirePackage{fontspec}
				\let\lsstyle\relax
			\else 
				\RequirePackage[T1]{fontenc}
				\RequirePackage{microtype}
			\fi
			 \RequirePackage[french]{babel}
			 \usepackage[vvarbb,ebgaramond,smallerops]{newtx}
			 \usepackage[sf,scale=0.95]{libertine}
			 % \usepackage[cmintegrals,cmbraces]{newtxmath}
			 % \usepackage{ebgaramond-maths}
			 %\RequirePackage[scaled=.8]{FiraMono}
			 \usepackage[scr=boondoxo,bb=boondox]{mathalpha}
			\def\TitlingFont{\scshape}
	}},
	lmodern/.code={%
		\def\load@thefonts{
			\ifxetex
				\RequirePackage{fontspec}
				\let\lsstyle\relax
			\else 
				\RequirePackage[T1]{fontenc}
				\RequirePackage{microtype}
			\fi
		\usepackage{mlmodern}
		\RequirePackage[french]{babel}
		\def\TitlingFont{\scshape}
	}},
	utopia/.code={%
		\def\load@thefonts{
			\ifxetex
				\RequirePackage{fontspec}
				\let\lsstyle\relax
			\else 
				\RequirePackage[T1]{fontenc}
				\RequirePackage{microtype}
			\fi
		\RequirePackage[french]{babel}
		\usepackage[p,scaled=.98,space]{erewhon}
		\usepackage[scaled=1.05]{biolinum} % sans serif like Gill Sans
		\usepackage[varqu,varl]{inconsolata} % typewriter
		\usepackage[utopia,vvarbb]{newtxmath}
		\useosf
		\def\TitlingFont{\sffamily\scshape}
	}},
	palatino/.code={%
		\def\load@thefonts{
			\ifxetex
				\RequirePackage{fontspec}
				\let\lsstyle\relax
			\else 
				\RequirePackage[T1]{fontenc}
				\RequirePackage{microtype}
			\fi
		\RequirePackage[french]{babel}
		\usepackage[nohelv]{newpxtext}
		\usepackage[scaled=1.05]{biolinum}
		\usepackage[vvarbb,smallerops]{newpxmath}
		\useosf
		\def\TitlingFont{\sffamily\scshape}
	}},
	fira/.code={%
		\def\load@thefonts{%
			\ifxetex
				\RequirePackage{fontspec}
				\let\lsstyle\relax
			\else 
				\RequirePackage[T1]{fontenc}
				\RequirePackage{microtype}

			\fi
			\RequirePackage[french]{babel}
			\RequirePackage[sfdefault, scaled=.92]{FiraSans}
			\RequirePackage[scaled=.88]{FiraMono}
			\RequirePackage[smallerops,upint]{newtxsf}
			\def\fira@loaded{}%
			\firaoldstyle
			\def\TitlingFont{\scshape}
	}},
	load/.code={%
		\def\load@thefonts{%
			\RequirePackage[T1]{fontenc}
			\RequirePackage[french]{babel}
			\RequirePackage{#1}
			\RequirePackage{microtype}
	}},
	none/.code={\def\load@thefonts{}},
	titling font/.store in=\TitlingFont,
}
\DeclareDocumentCommand\cpgefont{m}{%
	\cpgesetup[font]{#1}
}
\def\reloadthefonts{
	\load@thefonts%
	\ifundef\fira@loaded{}{% patch de la commande \mathbb de newtxsf qui n'est pas assez robuste.
		\RenewDocumentCommand\mathbb{>{\TrimSpaces}m}
			{\unexpanded{\varmathbb{##1}}}
		}
}

\AtEndPreamble{
	\def\label@itemi{\relsize{-2}$\mathcolor{cpgeneutral}\xdiamond$}
	\def\label@itemii{\relsize{-2}$\mathcolor{cpgeneutral}\xsquare$}
	\def\label@itemiii{\relsize{-2}$\mathcolor{cpgeneutral}\xbullet$}
	\def\ccsi{\textcolor{cpgeneutral}\xheadarrowright}
	\def\ccalors{\textcolor{cpgeneutral}\xheadarrowleft}	
	\def\ccneutre{\relsize{-2}$\mathcolor{cpgeneutral}\xbullet$}
}
\let\xdocument\document
\let\endsxdocument\enddocument

%%% Acronymes

\RequirePackage{acronym}
%\RequirePackage{acro}
% \acsetup{
% 	list/display=used,
% 	list/template=description,
% 	pages/display=first,
% 	format/short=\sffamily\scshape,
% 	format/long=\sffamily,
% }
% \def\listofacronyms{\printacronyms}

\renewcommand\acsfont[1]{\textsc{#1}}
\renewcommand\acffont[1]{\emph{#1}}
\def\acro@@{\newacro}
\def\acro@@plural{\newacroplural}

\acro@@				{vap}{valeur propre}
\acro@@plural		{vap}{valeurs propres}
\acro@@				{vep}{vecteur propre}
\acro@@plural		{vep}{vecteurs propres}
\acro@@				{sep}{sous-espace propre}
\acro@@plural		{sep}{sous-espaces propres}
\acro@@				{sev}{sous-espace vectoriel}
\acro@@plural		{sev}{sous-espaces vectoriels}
\acro@@				{ts}{triangulaire supérieure}
\acro@@				{tss}{triangulaire supérieure stricte}
\acro@@				{sp}{symétrique positive}
\acro@@				{sdp}{symétrique définie positive}
\acro@@				{evn}{espace vectoriel norm\'e}
\acro@@plural		{evn}{espaces vectoriels norm\'es}
\acro@@				{cpa}{connexe par arcs}
\acro@@plural		{cpa}{connexes par arcs}
\acro@@				{uc}{uniform\'ement continue}
\acro@@				{uce}[uc]{uniform\'ement continue}
\acro@@plural		{uc}{uniform\'ement continues}
\acro@@				{bon}{base orthonorm\'ee}
\acro@@plural		{bon}{bases orthonorm\'ees}
\acro@@				{pgcd}{plus grand diviseur commun}
\acro@@				{ppcm}{plus petit multiple commun}
\acro@@				{de}{division euclidienne}
\acro@@				{cvs}{converge simplement}
\acro@@				{cves}[cvs]{convergence simple}
\acro@@				{cva}{converge absolument}
\acro@@				{cvea}[cva]{convergence absolue}
\acro@@				{cvu}{converge uniform\'ement}
\acro@@				{cveu}[cvu]{convergence uniforme}
\acro@@				{cvuc}{converge uniformément sur tout compact}
\acro@@				{cveuc}[cvuc]{convergence uniforme sur tout compact}
\acro@@				{cvn}{converge normalement}
\acro@@				{cven}[cvn]{convergence normale}
\acro@@				{dse}{d\'eveloppable en s\'erie enti\`ere}
\acro@@				{rc}{rayon de convergence}
\acro@@plural		{rc}{rayons de convergence}
\acro@@				{cpm}{continue par morceaux}
\acro@@plural		{cpm}{continues par morceaux}
\acro@@				{cepm}{continuit\'e par morceaux}
\acro@@				{va}{variable al\'eatoire}
\acro@@				{var}{variable al\'eatoire r\'eelle}
\acro@@				{vad}{variable al\'eatoire discrète}
\acro@@				{vadr}{variable al\'eatoire discr\`ete r\'eelle}
\acro@@				{eaf}{\'egalit\'e des accroissements finis}
\acro@@				{iaf}{in\'egalit\'e des accroissements finis}
\acro@@				{ics}{in\'egalit\'e de Cauchy-Schwarz}
\acro@@				{ipp}{int\'egration par parties}
\acro@@				{itt}{int\'egration terme \`a terme}
\acro@@				{dtt}{d\'erivation terme \`a terme}
\acro@@				{il}{interversion de limites}
\acro@@				{cvd}{convergence domin\'ee}
\acro@@				{tdn}{th\'eor\`eme de la d\'ecomposition des noyax}
\acro@@				{tch}{th\'eor\`eme de Cayley-Hamilton}
\acro@@				{tsp}{th\'eor\`eme spectral}
\acro@@				{tcd}{th\'eor\`eme de la convergence domin\'ee}
\acro@@				{til}{th\'eor\`eme d'interversion de limites}
\acro@@				{tdtt}{th\'eor\`eme de d\'erivation terme \`a terme}
\acro@@				{titt}{th\'eor\`eme d'int\'egration terme \`a terme}
\acro@@				{tvi}{th\'eor\`eme des valeurs int\'erm\'ediaires}
\acro@@				{ticc}{th\'eor\`eme de l'image continue d'un compact}
\acro@@				{cscsa}{critère spécial de convergence des séries altérnées}


\RequirePackage{xspace}
\def\vap{\ac{vap}\xspace}
\def\vep{\ac{vep}\xspace}
\def\sev{\ac{sev}\xspace}
\def\sep{\ac{sep}\xspace}
\def\evn{\ac{evn}\xspace}
\def\bon{\ac{bon}\xspace}
\def\cvs{\ac{cvs}\xspace}
\def\cvu{\ac{cvu}\xspace}
\def\cvuc{\ac{cvuc}\xspace}
\def\cvn{\ac{cvn}\xspace}
\def\rc{\ac{rc}\xspace}
\def\cpm{\ac{cpm}\xspace}
\def\dse{\ac{dse}\xspace}
\def\var{\ac{var}\xspace}
\def\vad{\ac{vad}\xspace}
\def\vadr{\ac{vadr}\xspace}

\ifweb\expandafter\endinput\fi

%%%% Gestion des themes
\cpgesetup[theme]{%
	postload/.is family,
	postload/.unknown/.code=\relax,
	postload/colors/.code=\pgfkeysalso{/cpge/colors,#1},
	postload/no colors/.is if=nocolors,
	color model/.store in=\cpge@colormodel,
	rgb/.style={color model=rgb}, rgb,
	cmyk/.style={color model=cmyk},
	palette/.store in=\cpge@palette,
	.unknown/.code=\relax,
	dark/.code=\unless\ifprint\csname dark#1\endcsname\fi,
	dark/.default=true,
	draft/.is if=draft,
	font/.code=\cpgefont{#1},
	libertine/.style={font=libertine},
	fira/.style={font=fira},
	utopia/.style={font=utopia},
	palatino/.style={font=palatino},
	lmodern/.style={font=lmodern},
	title page/.is if=titlepage,
	title format/.code=\cpgesettitle{#1},
	title format*/.code=\cpgesettitle*{#1},
	scale title/.code=
		\appto\endpreamble@hook{\pgfmathsetlength\cpge@ttlw{\cpge@ttlw/#1}},
	logo/.store in=\cpge@logo,
	logo=all, 
}
\cpgesetup[title]{%
	scale/.code=\appto\endpreamble@hook{\pgfmathsetlength\cpge@ttlw{\cpge@ttlw/#1}}
}
\DeclareDocumentCommand\cpgetheme{O{} m}{%
	\unless\ifdraft
		\cpgesetup[theme]{#1}
		\ifstrequal{#2}{ibnghazi}{\def\cpge@palette{ibnghazi}}{}
		\load@thecolors
		\cpgesetup[theme/postload]{#1}
		\IfFileExists{#2\cpgecurrentclass.sty}
			{\def\load@thetheme{\RequirePackage{#2\cpgecurrentclass}}}{}%
	\fi%
	\setup@enumstyle%
	\let\darktrue\relax%
}
\DeclareDocumentCommand\cpgeconfig{O{}m}{%
	\let\load@thetheme\relax
	\cpgesetup[theme]{#1}
	\load@thecolors
	\cpgesetup[theme/postload]{#1}
	\IfFileExists{cfg-#2.sty}
		{\def\load@theconfig{\RequirePackage{cfg-#2}}}{}
	\let\darktrue\relax%
}
\def\load@thetheme{}
\def\load@theconfig{}
\AtEndPreamble{
	\cpgedefinecolors
	\load@theconfig%
	\load@thetheme%
	\ifundef\load@thefonts
		{\ifprint\cpgefont{libertine}\else\cpgefont{fira}\fi}
		{}%
	\reloadthefonts%
	\reloadthecolors%
	\endpreamble@hook%
	\ifdefstring\cpgecurrentclass{doc}{\titlepagetrue}{}
}

% \AtBeginDocument{%
%  \cpgesetup{background}
%  \ifbackground%
%      \AddToShipoutPictureBG{\back@pos{\back@code}}%
%   \fi%
% }
   % \titleformat\section
   %    {\Large\sffamily\scshape}
   %    {\deco@section{\label@section}}
   %    {1.8pc}
   %    {#1}
   % \titleformat\subsection
   %    {\large\sffamily\scshape
   %    }{\deco@subsection{\label@subsection}}
   %    {1.8pc}
   %    {#1}

%%%%% Geometrie du document

\RequirePackage{geometry}
\RequirePackage{cuted,flushend}
\newif\iflandscape


% patch de la commande qui contrôle le format de papier
\newdimen\Gm@littlemargin
\Gm@littlemargin\z@
\dimdef\compactlimit{123mm}
\preto\Gm@adjustpaper{%
 	\ifdim\linewidth<\compactlimit\relax
 		\compacttrue%
 	\fi}

% ajout de formats, reconnaissables par la commande \goemetry
\@namedef{Gm@bk17x24}#1{\Gm@setsize{#1}(170,240){truemm}}	%livre 17x24
\@namedef{Gm@bk19x24}#1{\Gm@setsize{#1}(190,240){truemm}}	%livre 19x24
\@namedef{Gm@sc16x9}#1{\Gm@setsize{#1}(135,240){truemm}}	%smartphone 16x9 (Apple)
\@namedef{Gm@sc19x9}#1{\Gm@setsize{#1}(135,285){truemm}}	%smartphone 19x9	(Samsung)
\@namedef{Gm@sc4x3}#1{\Gm@setsize{#1}(180,240){truemm}}		%tablette 4x3 (Apple)
\@namedef{Gm@sc16x10}#1{\Gm@setsize{#1}(180,288){truemm}}	%tablette 16x10 (Samsung)
\@namedef{Gm@sc4x3b}#1{\Gm@setsize{#1}(128,96){truemm}}		%beamer
%\define@key{Gm}{a4paper}[true]{\Gm@setpaper@ifpre{a4paper}}%
\define@key{Gm}{bk17x24}[true]{\Gm@setpaper@ifpre{bk17x24}}
\define@key{Gm}{bk19x24}[true]{\Gm@setpaper@ifpre{bk19x24}}
\define@key{Gm}{sc16x9}[true]{\Gm@setpaper@ifpre{sc16x9}}
\define@key{Gm}{sc19x9}[true]{\Gm@setpaper@ifpre{sc19x9}}
\define@key{Gm}{sc16x10}[true]{\Gm@setpaper@ifpre{sc16x10}}
\define@key{Gm}{sc4x3}[true]{\Gm@setpaper@ifpre{sc4x3}}
\define@key{Gm}{sc4x3beamer}[true]{\Gm@setpaper@ifpre{sc4x3b}}
% ajout de la cl\'e Gm@littlemargin
\define@key{Gm}{littlemargin}{%
        \Gm@setlength\Gm@littlemargin{#1}
        \Gm@setlength\marginparwidth{#1}%
        \Gm@setlength\marginparsep\z@%
}
\appto\Gm@save{\Gm@savelength{Gm@littlemargin}}
%\appto\Gm@save{\Gm@saveboolean{compact}}

% interface pgfkeys pour geometry
\newif\ifforced@geometry
\newif\ifactivated@geometry
\def\geom@options{reversemp,}

\cpgesetup[@geometry]{%
	print/.code=%
		\printtrue%
		\darkfalse%
		\compactfalse%
		\geometry{%
			a4paper,
			inner=3cm, outer=2cm,
			vmargin={2.4cm,3cm}, 
			footskip=2cm,
			littlemargin=6pc
		}, 
	2print/.code=%
		\printtrue%
		\darkfalse%
		\compacttrue%
		\striptitletrue%
		\geometry{%
			a4paper,
			twocolumn, columnsep=24truept,
			inner=1truecm, outer=1truecm,
			vmargin={2.4truecm,2.4truecm},
			footskip=1.6cm,
			littlemargin=4.5pc%
		},
	lsprint/.code=%
		\printtrue%
		\darkfalse%
		\compactfalse%
		\landscapetrue%
		\geometry{%
			a4paper,
			landscape,
			twocolumn, columnsep=36truept,
			inner=1.8truecm, outer=1.8truecm,
			vmargin={1.5truecm,1.5truecm},
			footskip=1cm,
			littlemargin=4.5pc
		},
	book/.code=%
		\darkfalse%
		\compactfalse%
		\geometry{%
			bk17x24,
			inner=2.4cm, outer=1.8cm,
			vmargin={2cm,3cm}, 
			littlemargin=6pc
		}, 
	altbook/.code=%
		\darkfalse%
		\compactfalse%
		\geometry{%
			bk19x24,
			inner=3cm, outer=2cm,
			vmargin={2cm,3cm}, 
			littlemargin=8pc
		}, 
	draft/.code=%
		\printfalse%
		\compacttrue%
		\titlepagetrue%
		\geometry{%
			a5paper,
			inner=1.25cm, outer=1.25cm,
			vmargin={1.2cm,1.8cm},
			littlemargin=4.5pc 
		}, 
	phone/.code=%
		\printfalse%
		\darktrue%
		\compacttrue%
		\titlepagetrue%
		\geometry{%
			sc16x9,
			hmargin={1cm,.5cm},
			vmargin={1.2cm,1.4cm},
			littlemargin=4.5pc,
		},%
	altphone/.code=%
		\printfalse%
		\darktrue%
		\compacttrue%
		\titlepagetrue%
		\geometry{%
			sc19x9,
			hmargin={1cm,.5cm},
			vmargin={1.4cm,1.8cm},
			littlemargin=4.5pc
		},%
	beamer/.code=%
		\printfalse%
		\darkfalse%
		\compactfalse%
		\titlepagetrue%
		\geometry{%
			sc4x3beamer,
			hmargin={1cm,.5cm},
			vmargin={.4cm,1.2cm},
			littlemargin=4.5pc
		},%
	tablet/.code=%
		\printfalse%
		\darkfalse%
		\compactfalse%
		\titlepagetrue%
		\geometry{%
			sc4x3,
			hmargin={1.8cm,1.8cm},
			vmargin={1.5cm,2cm},
			littlemargin=4.5pc
		},%
	lstablet/.code=%
		\printfalse%
		\compacttrue%
		\darkfalse%
		\landscapetrue%
		\titlepagetrue%
		\geometry{%
			sc4x3,
			landscape,
			twocolumn, columnsep=36truept,
			hmargin={.75cm,.75cm},
			vmargin={1.2cm,1.8cm},
			littlemargin=4.5pc
		},%
	alttablet/.code=%
		\printfalse%
		\darkfalse%
		\compactfalse%
		\titlepagetrue%
		\geometry{%
			sc16x10,
			hmargin={1.2cm,1.2cm},
			vmargin={2cm,3cm},
			littlemargin=4.5pc
		},%
	lsalttablet/.code=%
		\printfalse%
		\compacttrue%
		\darkfalse%
		\titlepagetrue%
		\geometry{%
			sc16x10,
			landscape,
			twocolumn, columnsep=40pt,
			hmargin={1cm,1cm},
			vmargin={1.2cm,1.2cm},
			littlemargin=6pc
		},%
}
\cpgesetup[geometry]{%
	.unknown/.code=\edef\tmp@value{#1}\ifdefvoid{\tmp@value}{\eappto\geom@options{%
		\pgfkeyscurrentname,}}{\eappto\geom@options{%
		\pgfkeyscurrentname={\tmp@value},}}, 
	force compact/.is if=compact,
	force geometry/.is if=forced@geometry,
	draft/.is if=draft,
	dark/.is if=dark
}
\NewDocumentCommand\cpgegeometry{O{}m}{%
	\unless\ifdraft%
			\forced@geometrytrue%
	\fi%
	\cpgesetup[geometry]{#1}
	\ifactivated@geometry\else%
		\activated@geometrytrue%
		\ifforced@geometry
			\cpgesetup[@geometry]{#2}
		\else
			\ifdraft
				\cpgesetup[@geometry]{draft}
			\fi
		\fi 
	\fi
	\ifdefempty{\geom@options}{}{
		\@xp\geometry\@xp{\geom@options}
	}%
	\setup@enumspaces%
}
\def\ttl@addstretch@origin{\advance\@tempskipa-\pagestretch}
\AtEndPreamble{%
	\unless\ifactivated@geometry
			\cpgesetup[@geometry]{draft}
	\fi%
	\ifdim\paperwidth>127mm\relax
		\def\cpge@relsize{\relsize{2}}
	\else
		\def\cpge@relsize{\relsize{1}}%
	\fi%
	\ifbackground
		\RequirePackage{eso-pic}
		\newcommand{\LocalClearShipoutPictureBG}{\let\ESO@HookIBG\@empty}
	\fi
	\if@twocolumn% rétablir les conditions de l'option bottomtitles de titlesec.sty
		\let\ttl@addstretch\ttl@addstretch@origin%
		\def\bottomtitlespace{-\p@}%
	\fi%
	\def\multicols#1{\relax}
	\csdef{multicols*}#1{\relax}
	\let\endumlticols\relax 
	\cslet{endmulticols*}{\relax}
	\unless\if@twocolumn
		\unless\ifcompact%
			\RequirePackage{multicol}
			\appto\prepare@multicols{%
				\compacttrue%
				 \setup@enumspaces%
				  \def\bottomtitlespace{-\p@}%
				   \let\ttl@addstretch\ttl@addstretch@origin%
				}
		\fi
	\fi
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% Titre du document %%%%%
\newif\iftitlepage
\newdimen\cpge@ttlw
\AtBeginDocument{\cpge@ttlw=\iflandscape4.23\else3\fi cm\relax}
%% Ajout des mots cles du titre
\DeclareDocumentCommand\cpgenewtitlekeyword{mm}{%
   \cpgeaddkeyword{title}{#1}{%
      {#2\cpge@relsize\csuse{cpge@#1@format}%
      \global\cpge@dima\baselineskip}%
      \baselineskip\cpge@dima%
   }%
}
\cpgenewtitlekeyword{document}{\LARGE\bfseries}
\cpgenewtitlekeyword{concours}{\LARGE\bfseries}
\cpgenewtitlekeyword{epreuve}{\Large\scshape}
\cpgenewtitlekeyword{theme}{\Large\scshape}
\cpgenewtitlekeyword{subtheme}{\large\scshape\itshape}
\cpgenewtitlekeyword{centre}{\Large\scshape}
\cpgenewtitlekeyword{classe}{\large\scshape}
\cpgenewtitlekeyword{texte}{\sffamily\slshape} 
\cpgenewtitlekeyword{periode}{\itshape}
\cpgenewtitlekeyword{session}{\itshape}
\cpgenewtitlekeyword{duree}{\itshape}
\cpgenewtitlekeyword{auteur}{\small\textit{\cpge@preauthor}~}
\cpgenewtitlekeyword{email}{\small\ttfamily}
\cpgenewtitlekeyword{website}{\small\ttfamily}


\NewDocumentCommand\renew@title@format{O{1}mm}{%
	\ifcase #1\relax	
		\or \csdef{title@#2}{%
			\resizebox{\hsize}{!}{%
				\parbox{3\cpge@ttlw}{%
					\fil@inner@titlepage\linespread{.8}%
					#3\csuse{cpge@#2@format}\strut%
				\global\cpge@dima\baselineskip%
				}%
			}\par\baselineskip1.56\cpge@dima%
		}%
		\or \csdef{title@#2}{%
			\resizebox{\hsize}{!}{%
				\parbox{2\cpge@ttlw}{%
					\fil@inner@titlepage\linespread{.8}%
					#3\csuse{cpge@#2@format}\strut%
				\global\cpge@dima\baselineskip%
				}%
			}\par\baselineskip1.56\cpge@dima%
		}%
		\or \csdef{title@#2}{%
			\resizebox{\hsize}{!}{%
				\parbox{1.5\cpge@ttlw}{%
					\fil@inner@titlepage\linespread{.8}%
					#3\csuse{cpge@#2@format}\strut%
					\global\cpge@dima\baselineskip%
				}%
			}\par\baselineskip1.56\cpge@dima%
		}%
		\or \csdef{title@#2}{%
			\resizebox{\hsize}{!}{%
				\parbox{\cpge@ttlw}{%
					\fil@inner@titlepage\linespread{.8}%
					#3\csuse{cpge@#2@format}\strut%
					\global\cpge@dima\baselineskip%
				}%
			}\par\baselineskip1.56\cpge@dima%
		}%
	\fi%
} 
\def\titlepage@formats{%
		\renew@title@format[2]{centre}{\scshape}%
		\renew@title@format[2]{classe}{\scshape}%
		\renew@title@format[3]{matiere}{\bfseries}%
		\renew@title@format[4]{document}{\bfseries}%
		\renew@title@format[4]{devoir}{\bfseries}%
		\renew@title@format[4]{concours}{\bfseries}%
		\renew@title@format[3]{theme}{\scshape}%
		\renew@title@format[2]{subtheme}{\scshape\itshape}%
		\renew@title@format[3]{epreuve}{\scshape}%
		\renew@title@format[2]{session}{\itshape}%
		\renew@title@format{periode}{\small\itshape}%
		\renew@title@format{duree}{\small\itshape}%
		\renew@title@format{auteur}{\footnotesize\textit{\cpge@preauthor}\small~}%
		\renew@title@format{email}{\footnotesize\ttfamily}%
		\renew@title@format{website}{\footnotesize\ttfamily}%
}

%% Commande \title@parser qui traduit les mots cles 
%% pour le titre. Le resultat
%% est stocke dans la macro \title@contents
\long\def\title@change#1{%
   \StrSubstitute{\title@contents}
     {|#1|}{\csname title@#1\endcsname}[\title@string]%
     \global\let\title@contents\title@string%
 }
\long\def\title@parser#1{\begingroup%
    \gdef\title@contents{#1}%
    \exploregroups\expandarg%
    \forlistloop{\title@change}{\list@title}%
    \endgroup%
}

%% Commande qui specifie le format du titre.
%% Elle utilise \title@contents pour formater
%% la macro \cpgetitlecontents (titre normal) 
%% ou \cpgetitlepagecontents, si * (page de garde)
\DeclareDocumentCommand\cpgesettitle{s+m}{%
	\title@parser{#2}%
	\IfBooleanTF{#1}
		{%
			\@xp\long\@xp\gdef
				\@xp\cpgetitlepagecontents\@xp
					{\title@contents}%
		}{%
			\@xp\long\@xp\gdef
				\@xp\cpgetitlecontents\@xp
					{\title@contents}%
		}%
}

%% commande qui prend en charge
%% une eventuelle description
%% du format par l'utilisateur
%% (argument entre () de la commande \titre)
\DeclareDocumentCommand\cpge@localtitle{s+m}{%
	\title@parser{#2}%
	\IfBooleanTF{#1}
		{%
			\@xp\long\@xp\def
				\@xp\cpgetitlepagecontents\@xp
					{\title@contents}%
		}{%
			\@xp\long\@xp\def
				\@xp\cpgetitlecontents\@xp
					{\title@contents}%
		}%
}


%% Options du formatage 
\def\cpgesetuptitle{\cpgesetup[title]}
\cpgesetuptitle{
	inner align/.is choice, %alignement interne 
	inner align/l/.code=\let\fil@inner\raggedright, 
	inner align/r/.code=\let\fil@inner\raggedleft,
	inner align/c/.code=\let\fil@inner\centering,
   	inner align*/.is choice, %alignement interne dans titlepage
	inner align*/c/.code=\let\fil@inner@titlepage\centering,
	inner align*/l/.code=\let\fil@inner@titlepage\raggedright, 
	inner align*/r/.code=\let\fil@inner@titlepage\raggedleft,
   	outer align/.is choice, % alignement externe
	outer align/l/.code=\let\fil@outer\raggedright,
	outer align/r/.code=\let\fil@outer\raggedleft,
	outer align/c/.code=\let\fil@outer\centering,
	outer align*/.is choice, % alignement externe
	outer align*/l/.code=\let\fil@outer@titlepage\raggedright,
	outer align*/r/.code=\let\fil@outer@titlepage\raggedleft,
	outer align*/c/.code=\let\fil@outer@titlepage\centering,
	before/.code=\def\hook@beforetitle{#1}, % hook avant titre normal 
	after/.code=\def\hook@aftertitle{#1}, % hook apres titre normal 
	before*/.code=\def\hook@beforetitlepage{#1}, % hook avant titre, titlepage
	after*/.code=\def\hook@aftertitlepage{#1}, % hook apres titre, titlepage
	before title/.code=\title@parser{#1}%
               \@xp\def\@xp 
		          \hook@titlebeforetitle\@xp
                {\title@contents}, % prefix au format
	after title/.code=\title@parser{#1}%
               \@xp\def\@xp
		         \hook@titleaftertitle\@xp
               {\title@contents}, % postfix au format 
	before title*/.code=\title@parser{#1}
               \@xp\def\@xp 
		         \hook@titlebeforetitlepage\@xp
               {\title@contents}, % prefix au format
	after title*/.code=\title@parser{#1}%
               \@xp\def\@xp
		         \hook@titleaftertitlepage\@xp
               {\title@contents}, % postfix au format 
	late after/.code=\def\hook@lateaftertitle{#1},
	early before*/.code=\def\hook@earlybeforetitlepage{#1}, 
	late after*/.code=\def\hook@lateaftertitlepage{#1},
	width/.code=\dimdef\title@width{#1}, % largeur du titre 
	format/.code=\cpgesettitle{#1}, % specification du format normal 
	format*/.code=\cpgesettitle*{#1}, % specification du format titlepage 
	afterskip/.code=\def\aftertitleskip{#1}
         % saut apres titre
}
\cpgesetuptitle{
	inner align/.default=c,
	inner align*/.default=l,
	outer align/.default=c,
	outer align*/.default=c,
	width/.default=.75\columnwidth,
	afterskip/.default=2.5,
	inner align, 
	inner align*, 
	outer align,
	outer align*, 
	width,
	before=\minipage{\title@width},
	after=\endminipage,
	afterskip
	}

%% La commande utilisateur qui produit le titre
%% titre normal sans *, page de garde avec *
%% option [] pour \cpgesetup[title]{}, sinon option par defaut 
%% option () pour le format, sinon format par defaut
\def\STRIP{}
\let\endSTRIP\relax
\NewDocumentCommand\titre{s e{\op} +d()}{%
   	\IfBooleanT{#1}{\titlepagetrue}%
	\IfValueT{#2}{\cpgesetup[title]{#2}}%
	\IfValueT{#3}{%
		\iftitlepage\cpge@localtitle*{#3}\else\cpge@localtitle{#3}\fi%
		}%
	\iftitlepage%
		\begin{titlepage}
			\titlepage@formats%
			\csuse{hook@earlybeforetitlepage}%
			\ifbackground\def\back@code{}\fi%
			\fil@outer@titlepage%
			\csuse{hook@beforetitlepage}%
			\csuse{hook@title@beforetitlepage}%
				\fil@inner@titlepage%
				\csuse{cpgetitlepagecontents}%
			\csuse{hook@titleaftertitlepage}%
			\csuse{hook@aftertitlepage}%
			\csuse{hook@lateaftertitlepage}%
		\end{titlepage}%
		\pagecolor{pagecol}%
		\color{textcol}%
		\restoregeometry%
	\else%
		\thispagestyle{plain}%
		\ifstriptitle%
			\def\STRIP{\strip}%
			\let\endSTRIP\endstrip%
		\fi%
		\begin{STRIP}%
			\renewcommand\thefootnote{\@fnsymbol\c@footnote}%
			\def\@makefnmark{\rlap{\@textsuperscript{\normalfont\@thefnmark}}}%
			\long\def\@makefntext##1{\parindent 1em\noindent%
				\hb@xt@1.8em{%
				\hss\@textsuperscript{\normalfont\@thefnmark}}##1}%
			\fil@outer%
			\csuse{hook@beforetitle}%
			\fil@inner%
			\csuse{hook@titlebeforetitle}%
				\csuse{cpgetitlecontents}%
				\csuse{hook@titleaftertitle}%
				\csuse{hook@aftertitle}%
			\csuse{hook@lateaftertitle}%
			\par\vspace{\bigskipamount*\real{\aftertitleskip}}%
		\end{STRIP}%
	\fi%
   \global\let\titre\dummy@titre%
}
\NewDocumentCommand\dummy@titre{s e\op d()}{}







%%%% Entetes et pieds de pages

\csvtolistcsadd{list@hf}{%
	centre,classe,periode,document,devoir,
	concours,epreuve,session,matiere,theme,subtheme,auteur,email,website}
	
\def\tmp@do#1{\csdef{hf@#1}{\csuse{cpge@#1}}}
\forcsvlist\tmp@do{%
	centre,classe,periode,document,devoir,
	concours,epreuve,session,matiere,theme,subtheme,auteur,email,website}

\def\hf@change#1#2{%
   \StrSubstitute{#1}
     {|#2|}{\csname hf@#2\endcsname}[\tmp@string]%
     \global\let#1\tmp@string%
 }
\def\hf@parser#1#2#3{\begingroup%
    \csgdef{#1@\romannumeral#2}{\csuse{#1@font}{#3}}%
    \expandafter\def\expandafter\hf@change@\expandafter%
         {\expandafter\hf@change\expandafter%
           {\csname#1@\romannumeral#2\endcsname}}%
    \exploregroups\expandarg
    \forlistloop{\hf@change@}{\list@hf}%
    \endgroup%
}
\NewDocumentCommand\cpgesethead{o O{} O{} D(){} D(){} D(){}}{%
	\IfNoValueTF{#1}
	{\hf@parser{head}{4}{#4}
      \hf@parser{head}{5}{#5}
       \hf@parser{head}{6}{#6}
        \sethead{\head@iv}{\head@v}{\head@vi}
    }
	{\hf@parser{head}{1}{#1}
     \hf@parser{head}{2}{#2}
      \hf@parser{head}{3}{#3}
       \hf@parser{head}{4}{#4}
      	\hf@parser{head}{5}{#5}
         \hf@parser{head}{6}{#6}
          \sethead[\head@i][\head@ii][\head@iii]
                            {\head@iv}{\head@v}{\head@vi}
     }
  }
\NewDocumentCommand\cpgesetfoot{o O{} O{} D(){} D(){} D(){}}{%
	\IfNoValueTF{#1}
	{\hf@parser{foot}{4}{#4}
      \hf@parser{foot}{5}{#5}
       \hf@parser{foot}{6}{#6}
       \setfoot{\foot@iv}{\foot@v}{\foot@vi}
    }
	{\hf@parser{foot}{1}{#1}
     \hf@parser{foot}{2}{#2}
      \hf@parser{foot}{3}{#3}
       \hf@parser{foot}{4}{#4}
      	\hf@parser{foot}{5}{#5}
         \hf@parser{foot}{6}{#6}
          \setfoot[\foot@i][\foot@ii][\foot@iii]
             {\foot@iv}{\foot@v}{\foot@vi}
     }
  }
\RequirePackage{lastpage}
\DeclareDocumentCommand\cpgenewpagestylekeyword{mm}{%
   \cpgeaddkeyword{hf}{#1}{{#2\csuse{cpge@#1}}
   }%
}
\cpgenewpagestylekeyword{centre}{\scshape}
\cpgenewpagestylekeyword{classe}{\scshape}
\cpgenewpagestylekeyword{matiere}{\scshape}
\cpgenewpagestylekeyword{document}{}
\cpgenewpagestylekeyword{devoir}{}
\cpgenewpagestylekeyword{theme}{\scshape}
\cpgenewpagestylekeyword{concours}{\scshape}
\cpgenewpagestylekeyword{epreuve}{\scshape}
\cpgenewpagestylekeyword{session}{\itshape}
\cpgenewpagestylekeyword{auteur}{\scshape}
\cpgenewpagestylekeyword{siteweb}{\ttfamily}
\cpgenewpagestylekeyword{email}{\ttfamily}

\cpgeaddkeyword{hf}{chapter}{\chaptertitle}
\cpgeaddkeyword{hf}{section}{\sectiontitle}
\cpgeaddkeyword{hf}{C}{\ifnum\value{chapter}>\z@\thechapter\fi}
\cpgeaddkeyword{hf}{S}{\ifnum\value{section}>\z@\thesection\fi}
\cpgeaddkeyword{hf}{page}{\thepage}
\cpgeaddkeyword{hf}{pages}{page\enskip\thepage{} / \pageref*{LastPage}}
\cpgeaddkeyword{hf}{square}{\cpgesquare}
\cpgeaddkeyword{hf}{tpsvp}{\quad\cpgesquare[1]\ %
   \ifnum\c@page<\getrefbykeydefault{LastPage}{page}{0}
      \cpgesquare[1]\ \cpgesquare[1]%
   \fi%
}
\def\hf@deco{\title@deco}

%%% Entete/pied de page 
\newpagestyle{main}[\fontsize{8}{8}\sffamily\scshape]{
   \renewcommand\makeheadrule{\csuse{deco@headrule}}
   \renewcommand\makefootrule{\csuse{deco@footrule}}
   \sethead{}{}{}
   \setfoot{}{\hf@page}{}
  }
\renewpagestyle{plain}[\fontsize{8}{8}\sffamily\scshape\itshape]{
   \renewcommand\makeheadrule{}
   \renewcommand\makefootrule{}
   \sethead{}{}{}
   \setfoot{}{page \thepage{}}{}
 }
 \newpagestyle{void}{
	\renewcommand\makeheadrule{}
	\renewcommand\makefootrule{}
	\sethead{}{}{}
	\setfoot{}{}{}
 }

%
%%%%%%

\RequirePackage[normalem]{ulem}
\newcommand\cst{\bgroup\markoverwith
    {\textcolor{cpgered}{\rule[0.5ex]{2pt}{0.4pt}}}\ULon}
\UL@protected\def\cwa{\leavevmode \bgroup  
  \markoverwith{\color@begingroup\color{cpgered}%
    \lower6pt\hbox to0pt{\ninely \char58}%
    \lower6.4pt\hbox{\ninely \char58}%
    \color@endgroup}\ULon}
\font\ninely=lasy9

\endinput