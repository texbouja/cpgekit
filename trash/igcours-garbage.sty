\def\filedate{2023/22/12}
\def\fileversion{v0.2alpha}
\def\fileauthor{Sadik Boujaida}

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{igcours}[\filedate\space\fileversion]

\RequirePackage{pgfopts}
\RequirePackage{etoolbox}


\ifundef{\ifsolution}{\newif\ifsolution}{}
\ifundef{\ifproof}{\newif\ifproof}{}
\ifundef{\ifdraf}{\newif\ifdraft}

\pgfkeys{/IGPC/.is family, /IGPC/.cd,
	proof/.is if=proof,
	solution/.is if=solution,
	draft/.is if=draft
}
\ProcessPgfOptions{/IGPC}

\ifundef{\igset}{
\pgfkeys{/ig/.is family}
\DeclareDocumentCommand\igset{o}{%
	\IfValueT{#1}
		{\pgfkeysifdefined{/ig/#1/.is family}{}{\pgfkeys{/ig/#1/.is family}}}%
	\IfValueTF{#1}{\pgfqkeys{/ig/#1}}{\pgfqkeys{/ig}}%
	}
\pgfkeys{/handlers/.colorlet/.code=
	\pgfkeysalso{\pgfkeyscurrentpath/.code=\colorlet{#1}{##1}}}
}{}
\ifundef{\tcbset}{
	\RequirePackage{tcolorbox}
}{}
\tcbuselibrary{breakable,theorems,xparse}
\usetikzlibrary{calc}
\tcbset{%
	first box/.style={%
		breakable,
		lines before break=1,
		height fixed for=first and middle,
		fonttitle=\sffamily\scshape\bfseries\footnotesize\vphantom{(},
		description font=\sffamily\scshape\footnotesize\vphantom{(},
		colback=bgcol,coltext=fgcol
	},
	secondary box/.style={%
		reset,
		notitle,
		colback=bgcol,
		coltext=fgcol
	}
}
\tcbset{%
	every box on layer 1/.style={first box},
	every box on layer 2/.style={secondary box},
	every box on layer 3/.style={secondary box},
	every box on layer 4/.style={secondary box}
}
%\tcbsetmanagedlayers{2}

\tcbset{%
	font app/.code 2 args={\csappto{kvtcb@font#1}{#2}},
	font reset/.code 2 args={\csdef{kvtcb@font#1}{#2}}
}

\igset{simple deco/.code={%
			\igdefdeco{simple}{\simple@label@font#1}%
			\let\deco@lrmargin\deco@simple},
	   simple label font/.code={\def\simple@label@font{#1\vphantom{(}}},
}
\igset{%
	simple deco=\fbox{#1}\enskip,
	simple label font=\scshape\sffamily\footnotesize,
}
\igset[mini]{
	left margin=1pc,
	right margin=0pt,
	font=\sffamily\footnotesize
	}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%% Mise en place des differents types de theoremes %%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newif\ifexo@type
\newif\iftheo@type
\newif\ifdef@type
\newif\ifrem@type
\newif\ifproof@type
\igset{theorem type/.is choice,
	 theorem type/exercise/.code={\rem@typefalse},
	 theorem type/theorem/.code={\rem@typefalse},
	 theorem type/definition/.code={\rem@typefalse},
	 theorem type/remark/.code={\rem@typetrue},
	 theorem type/proof/.code={\rem@typetrue}
 }
\tcbset{theorem type/.is choice,
	 theorem type/exercise/.code={\exo@typetrue},
	 theorem type/theorem/.code={\theo@typetrue},
	 theorem type/definition/.code={\def@typetrue},
	 theorem type/remark/.code={\rem@typetrue},
	 theorem type/proof/.code={\proof@typetrue},
 }
\tcbset{new/within chapter or section/.code=%
		{%
		\ifchapter@in@class
			\tcbset{new/number within=chapter}
		\else
			\tcbset{new/number within=section}
		\fi}
}
\ig@cnt@shortcut{X}{tcbcounter}
\igset[theorems]{%
	theorem style/.code=%
		\tcbset{theorem style/.style={%
			colbacktitle=warmcol,#1,current counter=\thetcbcounter}},
	definition style/.code=%
		\tcbset{definition style/.style={%
			colbacktitle=coldcol,#1,current counter=\thetcbcounter}},
	exercise style/.code=%
		\tcbset{exercise style/.style={#1}},
	remark style/.code=%
		\tcbset{remark style/.style={%
			colbacktitle=neutralcol,#1,current counter=\thetcbcounter}},
	proof style/.code=\tcbset{proof style/.style={#1}}
	}
\def\igsettheoremstyle{\pgfqkeys{/ig/theorems}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%% Gestion des demos et des solutions %%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%% cles d'enregistrement dans le fichier records
\tcbset{basic subtitle/.style={%
		spartan,
		coltext=white,
		colbacktitle=tcbcolbacktitle,
		boxrule=0pt,
		boxsep=0pt,
		top=.8pt,
		bottom=.8pt
	}
}
\def\draft@solution{\tcbsubtitle[basic subtitle]{Solution}}
\def\draft@proof{\tcbsubtitle[basic subtitle]{D\'emonstration}}
\let\solution\draft@solution
\let\proof\draft@proof
\newif\ifhas@solu
\newif\ifhas@prv
\def\out@dir{output}
\def\aux@dir{tmp}
\IfFileExists{/dev/null}
		{\immediate\write18{mkdir -p \aux@dir}}
		{\immediate\write18{md  "#1"}}%
\newcounter{file@number}
\setcounter{file@number}{1}
\ifdraft
	\tcbset{%
		with@solu/.style={},
		with@proof/.style={}
	}
\else 
\tcbset{%
		solu@rec/.style={record={%
			\string\solu{\thefile@number}%
				{\ig@theorem@prefix}%
				{\thetcbcounter}%
				{\ig@theorem@name}%
				{\igdu@theorem@name}%
				{\aux@dir/exe-\thetcbcounter.tex}%
				}},
		proof@rec/.style={record={%
			\string\preuve{\thefile@number}%
				{\ig@theorem@prefix}%
				{\thetcbcounter}%
				{\ig@theorem@name}%
				{\igdu@theorem@name}%
				{\aux@dir/prv-\thetcbcounter.tex}%
			}},
    with@solu/.style={%
        lowerbox=ignored,
        solution@link,
        before upper pre={\global\has@solutrue\let\solution\tcblower},
        hypertarget={\ig@theorem@prefix:\thetcbcounter},
        savelowerto=\aux@dir/exe-\thetcbcounter.tex,
        solu@rec
      },
    with@proof/.style={%
       	lowerbox=ignored,
        proof@link,
        before upper pre={\global\has@prvtrue\let\proof\tcblower},
        hypertarget={\ig@theorem@prefix:\thetcbcounter},
        savelowerto=\aux@dir/prv-\thetcbcounter.tex,
        proof@rec
      },
}
\fi 
\tcbset{%
	proof or solution/.code={%
	 	\ifexo@type\tcbset{with@solu}\fi%
		\iftheo@type\tcbset{with@proof}\fi}
	}


%%% cles de creation des liens sur l'ennonce
\ifdraft
\tcbset{@demolink/.style 2 args={},
	proof@link/.code=\relax,
	solution@link/.code=\relax,
}
\else 
\tcbset{@demolink/.style 2 args={%
	bottom=12pt,
	underlay unbroken and last={\node (link) at ([xshift=-6pt]frame.south east) 
		[text=linkcol,
		 draw=linkcol,
		 fill=tcbcolback!95!black,
		 inner ysep=2pt, inner xsep=6pt,
		 font=\fontsize{7}{7}\selectfont\scshape\vphantom{(}, 
		 anchor=south east, 
		 rounded corners=6pt,
		 yshift=2pt
		] 
		{#2 \thetcbcounter, page \pageref*{#1@\thetcbcounter}};},
		hyperlink node={#1@\thetcbcounter}{link}
	},
	proof@link/.code=\ifproof\tcbset{@demolink={proof}{d\'emonstration}}\fi,
	solution@link/.code=\ifsolution\tcbset{@demolink={solution}{solution}}\fi,
}
\fi 
%%%%% cles logiques d'insertion ou non de solution 
\tikzset{proof title style/.style={rounded corners=7pt,
		 inner xsep=8pt,
		 inner ysep=2pt,
		 }}	
%% boites tcolorbox pour demonstrations et solutions
\NewTotalTColorBox{\solu@box}{mmmmm}{%
  proof style,
  title={\tikz\node [proof title style]
  			{\hyperlink{#1:#2}{\vphantom{(}Solution #4~#2}};},  
  hypertarget={solution@#2},
  phantomlabel={solution@#2}
 }{\input{#5}}
\def\solu@#1{\ifnum\c@file@number=#1\relax\expandafter\solu@box\fi}
\def\solu@@#1{\solu@box}
\NewTotalTColorBox{\proof@box}{mmmmm}{%
  proof style,
  current counter=#2,
  title={\tikz\node [proof title style]
  			{\hyperlink{#1:#2}{\vphantom{(}D\'emonstration #4~#2}};},
  hypertarget={proof@#2},
  phantomlabel={proof@#2}
 }{\input{#5}}
\def\preuve@#1{\ifnum\c@file@number=#1\relax\expandafter\proof@box\fi}
\def\preuve@@#1{\proof@box}
\def\preuve#1#2#3#4#5#6{}
\def\solu#1#2#3#4#5#6{}

\newif\ifsol@forthisfile
\newif\ifsol@active
\sol@forthisfiletrue

\igset{solutions/.is family, solutions,
	solution/.is if=solution,
	proof/.is if=proof,
	solution/.default=true,
	proof/.default=true,
	proof and solution/.style={proof,solution},
	solution and proof/.style={proof,solution},
	solution title/.code 2 args=\def\sol@section{\csuse{#1}{#2}},
	solution title/.default={section}{Solutions des exercices},
	proof title/.code 2 args=\def\prv@section{\csuse{#1}{#2}},
	proof title/.default={section}{D\'emonstrations des th\'eor\`emes},
	proof, solution, solution title, proof title
	}% !TEX root = master-suite.tex
\def\iginclude{\@ifstar\ig@include@\ig@include}
\def\ig@include@{\ig@include[proof=false,solution=false]}
\def\ig@curbasefilename{\jobname}
\DeclareDocumentCommand\ig@include{t{+} O{} m}{%%
\RenewDocumentCommand\titre{sod()}{}%
\begingroup%
\ifdraft
	\subdoc{#3}
\else
	\def\ig@curbasefilename{#3}%
	\IfBooleanTF{#1}{\sol@forthisfilefalse}{}%
    \IfValueTF{#2}{\igset{solutions/.cd,#2}}{}%
    \ifsol@active\else\startrecording\fi%
	\subdoc{#3}%
	\ifsol@forthisfile%
		\stoprecording%
		\ifproof\ifhas@prv%
			%\eject\ifodd\thepage\null\eject\fi
			\clearpage%
			\prv@section%
			\typoutdemonstrations*%
		\fi\fi%
		\ifsolution\ifhas@solu
			%\eject\null\ifodd\c@page\else\eject\fi
			\clearpage%
			\sol@section
			\typoutsolutions*
		\fi\fi
	\fi%
\fi%
\endgroup%
\has@solufalse\has@prvfalse}
\AtEndDocument{\ifsol@active\stoprecording\fi}
\DeclareDocumentCommand{\typoutsolutions}{s O{\tcb@record@file}}{%
  \begingroup%
  \IfBooleanTF{#1}{\def\solu{\solu@}}{\def\solu{\solu@@}}%
  %\show\solu
  \IfFileExists{#2}{\input{#2}}%
  	{\tcb@error{fichier record `#2' non trouv\'e}{The record file `#2' was not found}}%
  \endgroup%
}
\DeclareDocumentCommand{\typoutdemonstrations}{s O{\tcb@record@file}}{%
  \begingroup%
  \IfBooleanTF{#1}{\def\preuve{\preuve@}}{\def\preuve{\preuve@@}}%
  %\show\preuve
  \IfFileExists{#2}{\input{#2}}%
  	{\tcb@error{record file `#2' not found}{The record file `#2' was not found}}%
  \endgroup%
}

%%% raccourci pour activer les sorties vers fichier record et les fichiers des sol
\def\startrecording{\tcbstartrecording\relax\global\sol@activetrue}
\def\stoprecording{\tcbstoprecording\relax\global\sol@activefalse}
\let\Exercices\startrecording
\let\endExercices\stoprecording

\tcbset{no@countertoolargemessage/.code={\let\@ctrerr\relax},
	no@countertoolargemessage
	}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%% Définition des environnements pour théroremes %%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%% macros et cles principales de creation de theorem

\def\kvtbc@titlewho{\ifdefempty{\kvtcb@title}{\tcbtitletext}{\kvtcb@title}}
\tcbset{title style if break/.style={%%
	title after break={\MakeLowercase{\kvtbc@titlewho}~(suite)},
	extras title after break={%
		halign title=right,
		coltitle=tcbcolbacktitle,
		font app={title}{\fontsize{7}{7}\mdseries\itshape}
		},
	extras middle and last={colbacktitle=tcbcolback},
	bottomrule=1pt, 
	bottomrule at break=0pt,
	toprule at break=0pt,
	titlerule=0pt
}}

\tcbset{%
		@theoprefix/.store in=\ig@theorem@prefix, 
		@theoname/.store in=\ig@theorem@name,
		du@theoname/.store in=\igdu@theorem@name,
		@demoname/.store in=\ig@demo@name
	}
\ifdraft
\tikzset{description path style/.style={%
				fill=tcbcolbacktitle,
				draw=none,
				font=\fontsize{10}{8}\selectfont\vphantom{(},
				text=tcbcoltitle,
				#1}}
\else  
\tikzset{description path style/.style={%
				fill=tcbcolbacktitle,
				draw=none,
				rounded corners=5pt,
				font=\fontsize{10}{8}\selectfont\vphantom{(},
				text=tcbcoltitle,
				#1}}
\fi 
\tcbset{description path/.style={%
	overlay unbroken and first={%
    	\path let \p1=(title.north east), \p2=([xshift=-12pt]frame.north east) in
			node [%
        		anchor=west,
				xshift=2pt,inner ysep=1pt,
				text width=\x2-\x1,
				description path style
				] 
			at (title.east) {#1};
  		}
}}
\def\important@message{\ifexo@type exercice \else r\'esultat\fi{} important}
\tcbset{
	important/.style={%
		colbacktitle=importantcol,
		code=\colorlet{tcbcolbacktitle}{importantcol},
		bottom=10pt,
		underlay unbroken and last={\node at (frame.south west) 
			[text=tcbcolbacktitle, 
			font=\fontsize{7}{8}\selectfont, 
			anchor=south west, 
			yshift=2pt
			] 
			{#1};}
		},
	important/.default=\important@message
}

%%% Environnement butineur : tous les environnement 
%%% de theoreme l'utilisent en interne
\def\ig@theo@form@namenumber#1#2{\hbox{#1~#2}}
\def\ig@theo@form@numbername#1#2{\hbox{#2~#1}}
\def\ig@theo@form@name#1#2{\hbox{#1}}
\tcbset{%
	theorem name and number/.code={\let\tcb@theo@form=\ig@theo@form@namenumber},
	theorem number and name/.code={\let\tcb@theo@form=\ig@theo@form@numbername},
	theorem name/.code={\let\tcb@theo@form=\ig@theo@form@name},
}
\NewDocumentCommand{\ig@new@tcbtheorem}{O{} mmmmm}{%
  \igset{theorem type=#5}%
  \unless\ifrem@type
  \@@newtcolorbox[auto counter, list inside=theo,#1]{#2}{O{} d() d<>}{%
	attach boxed title to top left={yshift*=-\tcboxedtitleheight},
  	@theoname=\detokenize{#3},
	du@theoname=\detokenize{#4},
    theorem type=#5,
    #5 style,
    theorem name and number,
	@theoprefix=#2,
    title={\ig@tcb@theo@title{#3}{\thetcbcounter}},%
    IfValueT={##2}{list entry=%
    	{\protect\numberline{\thetcbcounter}#3~:~##2}},%
    IfValueT={##2}{nameref={##2},description path={##2}},%
    IfValueT={##3}{label={##3}},%
	description delimiters none,
	separator sign none,
    #6,##1}%
    \fi
    \ifrem@type
    \@@newtcolorbox[auto counter, list inside=theo,#1]{#2}{O{} d() d<>}{%
    remark style, 
    theorem name and number,
	@theoprefix=#2,
    title={\ig@tcb@theo@title{#3}{\thetcbcounter}
    		\IfValueTF{##2}{\enskip\mdseries\itshape({##2})}{}},%
	title style if break,
    IfValueTF={##2}{list entry=%
    	{\protect\numberline{\thetcbcounter}#3~:~##2}}{},%
    IfValueTF={##2}{nameref={##2}}{},%
    IfValueTF={##3}{label={##3}}{},%
	description delimiters none,
	separator sign none,
    #6,##1,
    colframe=tcbcolbacktitle
    }%
	\fi
	\ifrem@type\else
    \DeclareDocumentEnvironment{#2+}{O{} d() d<>}
    	{\csname #2\endcsname [##1,proof or solution](##2)<##3>}
		{\csname end#2\endcsname}
	\fi
	\DeclareDocumentEnvironment{#2*}{O{} d() d<>}
    	{\csname #2\endcsname [##1,theorem name](##2)<##3>}
		{\csname end#2\endcsname}
	\rem@typefalse
	}
	
\ifchapter@in@class	
	\newcounter{genthm}[chapter]
\else
	\newcounter{genthm}
\fi
\NewTColorBox[use counter=genthm]{genthm*}{O{} m d() d<>}{%
	title={#2},
	IfValueT={#3}{description path={#3}},
	IfValueT={#4}{nameref={#3}},
	theorem style,
	theorem name,
	titled items,
	%colbacktitle=coldcol,
	#1}
\NewTColorBox[use counter=genthm]{genthm}{O{} m d() d<>}{%
	IfValueTF={#2}{title={\ig@tcb@theo@title{#2}{\thetcbcounter}}}{},
	IfValueTF={#3}{nameref={#3}, description path={#3}}{},
	IfValueTF={#4}{label={#4}}{},
	IfValueTF={#3}{list entry=%
    	{\protect\numberline{\thetcbcounter}#2~:~#3}}{},%
	theorem style,
	theorem name,
	titled items,
	%colbacktitle=coldcol,
	#1}
\tcbset{marge/.style={left=#1,right=#1}}	
	
%%%%%%%% Tables des théorèmes 
\def\ig@tcb@theo@title#1#2{%
	\ifdefempty{#2}{\setbox\z@=\color@hbox#1~\color@endbox}
  		{\setbox\z@=\tcb@theo@form{#1}{#2}}%
	\unhbox\z@%
}

\def\ig@addcontentsline#1#2{%
	\ifx\kvtcb@listentry\@empty\else
    	\addcontentsline{#1}{#2}{\kvtcb@listentry}%
	\fi%
}

\def\ignewtheorem{\let\tcb@addcontentsline\ig@addcontentsline%
	\let\@@newtcolorbox\NewTColorBox%
	\ig@new@tcbtheorem}

\def\igrenewtheorem{\let\@@newtcolorbox\RenewTColorBox%
  \ig@new@tcbtheorem}
  
\ProvideDocumentCommand\tableofresults%
	{O{\section*} D(){Liste des r\'esultats remarquables}}{%
		\tcblistof[#1]{theo}{#2}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%% jeu de styles tcolorbox %%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\tcbset{minimal/.style=blanker}

\tcbset{simple/.style={%
	colframe=tcbcolbacktitle,
	boxrule=.4pt,
	top=3pt,bottom=3pt,
	left=5pt,right=5pt
	}}
	
\tcbset{basic/.style={%
	spartan,
  	top=3pt,bottom=3pt,
	left=5pt,right=5pt,
	boxrule=.4pt, 
}}
\tcbset{
	basicthm/.style={%
		empty, 
		basic, 
		attach boxed title to top left={xshift=3pt,yshift*=-\tcboxedtitleheight+.1pt},
		boxed title style={%
					boxrule=0pt,
			boxsep=0pt,
			top=2pt,bottom=1pt,left=3pt,right=3pt,
		}
	}
}
\tcbset{%
	basicrmk/.style={
		blankest, 
		coltitle=neutralcol,
		top=0pt, bottomtitle=5pt, 
		left=20pt, before title={\hskip-14pt},
		borderline west={.6pt}{.6pt}{tcbcoltitle}
	}
}
\tcbset{rounded/.style={
	arc=5pt,
    colframe=tcbcolbacktitle,
    boxrule=-1pt,
	left=8pt,right=8pt
 }}
\tcbset{roundedthm/.style={%
	rounded,
    attach boxed title to top left={yshift=-\tcboxedtitleheight/2-1pt,xshift=3pt},
    boxed title style={%
    	arc=5pt,
        boxsep=0pt,
        top=2pt,bottom=1pt,left=6pt,right=6pt,
        boxrule=1pt,
        colframe=pagecol
        },
        bottomrule=.8pt
}}
\tcbset{uphill/.style={
    	colframe=tcbcolbacktitle,
		left=5pt,right=5pt,
    	arc=.2cm,
    	sharp corners=uphill
 }}
\tcbset{uphillthm/.style={%
	uphill,
    attach boxed title to top left={yshift=-\tcboxedtitleheight},
    boxed title style={%
        boxsep=0pt,
        top=2pt,bottom=1pt,left=6pt,right=6pt,
        arc=.2cm,
        sharp corners=uphill
        },
        boxrule=.4pt,
 }}



%%% Theme par defaut (basic)		
\igsettheoremstyle{%
	theorem style=basicthm,
	definition style=basicthm,
	exercise style=basicthm,
	remark style=basicrmk 
}
\igsettheoremstyle{proof style={%
	blankest,
	colbacktitle=linkcol,
	attach title to upper=\par\nobreak,
	left=8pt, right=3pt, top=0pt, bottom=0pt,
	before title={\hskip-8pt},
	code={\igsetenum{0}{marge*}},
	after skip=2\bigskipamount
}}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%% style d'enumerations dans les theorem %%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\def\ig@trivlist{%
  \if@noskipsec \leavevmode \fi
  \@topsepadd \topsep
  \ifvmode
    \advance\@topsepadd \partopsep
  \else
    \unskip \par
  \fi
  \if@inlabel
    \@noparitemtrue
    \@noparlisttrue
  \else
    %\if@newlist \@noitemerr \fi
    \@noparlistfalse
    \@topsep \@topsepadd
  \fi
  \advance\@topsep \parskip
  \leftskip \z@skip
  \rightskip \@rightskip
  \parfillskip \@flushglue
  \par@deathcycles \z@
  \@setpar{\if@newlist
             \advance\par@deathcycles \@ne
             \ifnum \par@deathcycles >\@m
               \@noitemerr
               {\@@par}%
             \fi
           \else
             {\@@par}%
           \fi}%
  \global \@newlisttrue
  \@outerparskip \parskip}

\def\ig@titem{%
  \if@noparitem
    \@donoparitem
  \else
    \if@inlabel
      \indent \par
    \fi
    \ifhmode
      \unskip\unskip \par
    \fi
    \if@newlist
      \if@nobreak
        \@nbitem
      \else
        \addpenalty\@beginparpenalty
        \addvspace\@topsep
        \addvspace{-\parskip}%
      \fi
    \else
      \addpenalty\@itempenalty
      \addvspace\itemsep
    \fi
    \global\@inlabeltrue
  \fi
  \everypar{%
    \@minipagefalse
    \global\@newlistfalse
%    \if@inlabel %%% Le patch en question
      \global\@inlabelfalse
      {\setbox\z@\lastbox
       \ifvoid\z@
         \kern-\itemindent
       \fi}%
      \box\@labels
      \penalty\z@
%    \fi %%% Le patch en question
    \if@nobreak
      \@nobreakfalse
      \clubpenalty \@M
    \else
      \clubpenalty \@clubpenalty
      \everypar{}%
    \fi}%
  \if@noitemarg
    \@noitemargfalse
  \fi
  \sbox\@tempboxa{\deco@titem{\label@titem}}%
  \global\setbox\@labels\hbox{%
    \unhbox\@labels
 %   \hskip \itemindent
 %   \hskip -\labelwidth
 %   \hskip -\labelsep
    \ifdim \wd\@tempboxa >\labelwidth
      \box\@tempboxa
    \else
      \hbox to\labelwidth {\unhbox\@tempboxa}%
    \fi
    \hskip \labelsep}%
  \ignorespaces}

\let\thecurrent@counter\@gobble
\igsetenum{1}{marge}
\igsetenum{2}{marge*}
\igdeflabel{enumi}{|X|.|1|}%
\igdefdeco{enumi}{\deco@simple{#1}}%
\igdeflabel{enumii}{|Q|\itshape|a|}
\igdefdeco{enumii}{\bfseries #1.}
\igdeflabel{equation}{\thecurrent@counter.|1|}
\makethetolabel{equation}
\tcbset{%
	current counter/.code={\def\thecurrent@counter{#1}}
	}	
\igdefcounter{titem}{|X|.|1|}(T)
\igdefdeco*{titem}{\deco@simple}
\ifdraft\igdefdeco{titem}{\bfseries#1.}\fi 
\makethetolabel{titem}
\let\unite\relax
\let\c@titem@\relax
\let\l@titem\relax
\let\t@titem\relax
%\def\titem@cmd#1{\par\addvspace\itemsep#1}
\def\the@titem{\deco@titem{\label@titem}\hskip\labelsep}
\ifdraft
	\tcbset{titled item style/.style={%
			spartan,
			boxrule=0pt,
			boxsep=0pt,
			top=.8pt, bottom=.8pt,
			colbacktitle=tcbcolbacktitle
		}}
\else
	\tcbset{titled item style/.style={}}
\fi
\DeclareDocumentCommand\titem@{sO{}d()d<>}{%
\igdeflabel{enumi}{|T|.|1|}%
\begingroup%
	\IfBooleanF{#1}%
		{\let\c@titem@\the@titem}%
	\IfValueTF{#4}
		{\refstepcounter{titem}%
		  \def\l@titem{\label{#4}}}
		{\refstepcounter{titem}}%
	\IfValueTF{#3}
		{\tcbsubtitle{\c@titem@ #3}}
		{\ig@titem}
	\l@titem
\endgroup}
\tcbset{%
	titled items/.code={%
  	\tcbset{before upper=\trivlist\item[],after upper=\endtrivlist}%
  	%\labelwidth\z@
	\setcounter{titem}\z@%
		\def\unite{\titem@}%
		\igdeflabel{enumii}{|a|}%
		\igdeflabel{enumiii}{|i|}%
		\igsetenum{1}{marge}%
		\igsetenum{2}{marge*}%
		\igsetenum{3}{marge*}%
		\igdefdeco{enumii}{\bfseries ##1.}%
		\igdefdeco{enumiii}{\bfseries ##1.}%
		\tcbset{subtitle style={empty,titled item style,#1}}%
}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%% exemples d'environement pour theoremes %%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ignewtheorem[within chapter or section]{theo}
	{Th\'eor\`eme}
	{du th\'eor\`eme}
	{theorem}
	{titled items}	
\ignewtheorem[use counter from=theo]{theodef}
	{Th\'eor\`eme et d\'efinition}
	{du th\'eor\`eme}
	{theorem}
	{titled items}
\ignewtheorem[use counter from=theo]{propdef}
	{Proposition et d\'efinition}
	{de la proposition}
	{theorem}
	{titled items}
\ignewtheorem[use counter from=theo]{prop}
	{Proposition}
	{de la proposition}
	{theorem}
	{titled items}
\ignewtheorem[use counter from=theo]{lemm}
	{Lemme}
	{du lemme}
	{theorem}
	{}
\ignewtheorem[use counter from=theo]{ppte}
	{Propri\'et\'es}
	{des propri\'et\'es}
	{theorem}
	{title style if break, titled items}
\ignewtheorem[use counter from=theo]{coro}
	{Corollaire}
	{du corollaire}
	{theorem}
	{titled items}
\ignewtheorem[within chapter or section]{defi}
	{D\'efinition}
	{}
	{definition}
	{titled items}
\ignewtheorem[use counter from=defi]{voca}
	{Vocabulaire}
	{}
	{definition}
	{theorem name, titled items}
\ignewtheorem[use counter from=defi]{nota}
	{Notations}
	{}
	{definition}
	{theorem name,titled items}
\ignewtheorem[within chapter or section]{rema}
	{Remarque}
	{}
	{remark}
	{colbacktitle=warmcol!75!black}
\ignewtheorem[use counter from=rema]{remas}
	{Remarques}
	{}
	{remark}
	{colbacktitle=warmcol!75!black,titled items}
\ignewtheorem[use counter from=rema]{remap}
	{Remarques pratiques}
	{}
	{remark}
	{colbacktitle=warmcol!75!black,titled items}
\ignewtheorem[within chapter or section]{exem}
	{Exemples}
	{}
	{remark}
	{colbacktitle=warmcol!90,titled items}
\ignewtheorem[use counter from=exem]{exemf}
	{Exemples fondamentaux}
	{}
	{remark}
	{colbacktitle=warmcol!90,titled items}
\ignewtheorem[use counter from=exem]{exema}
	{Exemple d'application}
	{}
	{remark}
	{colbacktitle=warmcol!90,titled items}
\ignewtheorem[use counter from=exem]{exemp}
	{Exemple pratique}
	{}
	{remark}
	{colbacktitle=warmcol!90,titled items}
\ignewtheorem[within chapter or section]{prob}
	{Probl\`eme}
	{du probl\`eme}
	{exercise}
	{}
\ignewtheorem[no counter]{demo}
	{D\'emonstration}
	{}
	{proof}
	{titled items, current counter=\@gobble}
\ignewtheorem[within chapter or section]{float}
	{Figure}
	{}
	{remark}
	{float, colbacktitle=coldcol!90, halign title=flush center}
\tcbset{floatplacement=tbp}
\ifserie
 	\igdefcounter{igexer}{}(E)<l'exercice>
    \ignewtheorem[use counter=igexer]{exer}
    	{Exercice}
    	{de l'exercice}
    	{exercise}
    	{colbacktitle=warmcol}
\else
	\ignewtheorem[within chapter or section]{exer}
		{Exercice}
		{de l'exercice}
		{exercise}
		{colbacktitle=importantcol}
	\ignewtheorem[within chapter or section]{exappli}
		{Exercice d'application}
		{de l'exercice}
		{exercise}
	{colbacktitle=importantcol}
	\ignewtheorem[within chapter or section]{exappro}
		{Exercice d'approfondissement}
		{de l'exercice}
		{exercise}
	{colbacktitle=importantcol}
\fi

\endinput
