\def\filedate{2020/10/01}
\def\fileversion{v0.2alpha}
\def\fileauthor{Sadik Boujaida}

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{cpgebase}[\filedate\space\fileversion]

\newif\ifcustomtitles
\DeclareOption{customtitles}{\customtitlestrue}
%\DeclareOption*{\PassOptionsToPackage{\CurrentOption}{cpgetitle}}
\ProcessOptions\relax

\RequirePackage{calc}
\RequirePackage{pgfkeys,pgfmath,pgffor}
\RequirePackage{etoolbox}
\RequirePackage{xstring}
\RequirePackage{relsize}
\RequirePackage{array}
\RequirePackage[svgnames]{xcolor}
\@ifundefined{NewDocumentCommand}
	{\RequirePackage{xparse}}
	{}
\ifcustomtitles
   \RequirePackage[loadonly, explicit,nobottomtitles*,pagestyles]{titlesec}
\else 
   \RequirePackage[explicit,nobottomtitles*,pagestyles]{titlesec}
\fi 
\RequirePackage{titletoc}
   % \titleformat\section
   %    {\Large\sffamily\scshape}
   %    {\deco@section{\label@section}}
   %    {1.8pc}
   %    {#1}
   % \titleformat\subsection
   %    {\large\sffamily\scshape
   %    }{\deco@subsection{\label@subsection}}
   %    {1.8pc}
   %    {#1}


%%%%% Déclarations
\newbox\cpge@boxa
\newbox\cpge@boxb
\newdimen\cpge@dima
%% permanents, pour pointillé
\newskip\ligneskip

\newcount\cpge@count
\newcount\cpge@lrcount


\newif\ifbackground
\newif\ifcpge@global
\newif\ifcpge@thetolabel
\newif\ifcpge@itemtitle
\newif\ifcpgein@

%%%%% Sauvegarde de certaines dimensions de la classe d'origine.
\edef\topsep@origin{\the\topsep}
\edef\partopsep@origin{\the\partopsep}
\edef\itemsep@origin{\the\itemsep}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%% localisation des commandes pgfkeys %%%%%

\ifundef{\cpgeset}{
\pgfkeys{/cpge/.is family}
\DeclareDocumentCommand\cpgeset{o}{%
	\IfValueT{#1}
		{\pgfkeysifdefined{/cpge/#1/.is family}{}{\pgfkeys{/cpge/#1/.is family}}}%
	\IfValueTF{#1}{\pgfqkeys{/cpge/#1}}{\pgfqkeys{/cpge}}%
	}
}{}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%% gestion des erreurs %%%%%
\DeclareRobustCommand\cpgeb@error[2]{%
	\PackageError{cpgebase}{#1}{#2}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%% Gestion des metadonnées %%%%%

\def\Document#1{%
   \gdef\cpge@document{#1}%
   \gdef\cpge@document@format{#1}%
}
\def\Epreuve#1{%
   \gdef\cpge@epreuve{#1}%
   \gdef\cpge@epreuve@format{#1}%
}
\def\Periode#1{%
   \gdef\cpge@periode{#1}%
   \gdef\cpge@periode@format{#1}%   
}
\def\Duree#1{%
   \gdef\cpge@duree{#1}%
   \gdef\cpge@duree@format{Dur\'ee~:~#1~heures}
}
\def\Theme#1{%
   \gdef\cpge@theme{#1}%
   \gdef\cpge@theme@format{#1}%
}
\def\Subtheme#1{%
   \gdef\cpge@subtheme{#1}%
   \gdef\cpge@subtheme@format{#1}%
}

\def\Centre#1{%
   \gdef\cpge@centre{#1}%
   \gdef\cpge@centre@format{#1}%
}
\def\Concours#1{%
   \gdef\cpge@concours{#1}%
   \gdef\cpge@concours@format{#1}%
}
\def\Session#1{%
   \gdef\cpge@session{#1}%
   \gdef\cpge@session@format{#1}%
}
\def\Classe#1{%
   \gdef\cpge@classe{#1}%
   \gdef\cpge@classe@format{\MakeLowercase{#1}}%
}
\def\Email#1{%
   \gdef\cpge@email{#1}%
   \gdef\cpge@email@format{#1}%
}
\def\Website#1{%
   \gdef\cpge@website{#1}%
   \gdef\cpge@website@format{#1}%
}
\def\Auteur#1{%
   \gdef\cpge@auteur{#1}%
   \gdef\cpge@auteur@format{\normalsize \cpge@preauthor~\scshape #1}%
}
\def\Matiere#1{%
   \gdef\cpge@matiere{#1}%
   \gdef\cpge@matiere@format{#1}%
}

\cpgeset[meta]{%
	Centre/.code=\Centre{#1},
	Centre/.default= CPGE Ibn Ghazi,
	Classe/.code=\Classe{#1},
	Classe/.default=MP,
	Auteur/.code=\Auteur{#1},
	Email/.code=\Email{#1},
	Website/.code=\Website{#1},
	Matiere/.code=\Matiere{#1},
	Matiere/.default=Math\'ematiques,
	Document/.code=\Document{#1},
	Theme/.code=\Theme{#1},
   Subtheme/.code=\Subtheme{#1},
	Concours/.code=\Concours{#1},
	Session/.code=\Session{#1},
	Epreuve/.code=\Epreuve{#1},
	Periode/.code=\Periode{#1},
	Periode/.default=\the\date,
	Duree/.code=\Duree{#1},
   preauteur/.code=\def\cpge@preauthor{#1},
   preauteur={R\'edig\'e par}
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% Décoration de l'arrière-plan %%%%%

%%%% première application de la  commande \cpgeset ci-dessus
\cpgeset[background]{
	position/.is choice,
	position/pb/.code=\def\back@pos{\AtPageLowerleft},
	position/pt/.code=\def\back@pos{\AtPageupperleft},
	position/pc/.code=\def\back@pos{\AtPageCenter},
	position/tb/.code=\def\back@pos{\AtTextLowerleft},
	position/tt/.code=\def\back@pos{\AtTextupperleft},
	position/tc/.code=\def\back@pos{\AtTextCenter},
	code/.code=\def\back@code{#1},
}
\cpgeset[background]{position=pb, code=\relax}
\AtEndPreamble{%
	\ifbackground
	  \RequirePackage{eso-pic}
	  \newcommand{\LocalClearShipoutPictureBG}{\let\ESO@HookIBG\@empty}
  \fi}

% \AtBeginDocument{%
%  \cpgeset{background}
%  \ifbackground%
%      \AddToShipoutPictureBG{\back@pos{\back@code}}%
%   \fi%
% }






%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%% Commandes utilitaires multi-usage %%%%%

\def\cpge@expandtwoargs#1#2#3{\begingroup%
	\edef\cpge@tempa{\endgroup\noexpand#1{#2}{#3}}\cpge@tempa}
\def\cpge@expandfirstarg#1#2#3{\begingroup%
	\edef\cpge@tempa{\endgroup\noexpand#1{#2}\unexpanded{#3}}\cpge@tempa}
\def\cpge@expandsecondarg#1#2#3{\begingroup%
	\edef\cpge@tempa{\endgroup\noexpand#1\unexpanded{#2}{#3}}\cpge@tempa}

\def\cslocal{%
	\let\lorg@cslet=\cslet%
	\let\lorg@csletcs=\csletcs%
	\let\lorg@def=\def%
	\let\lorg@edef=\edef%
	\let\lorg@csdef=\csdef%
	\let\lorg@csedef=\csedef%
	\let\lorg@listadd=\listadd%
	\let\lorg@listeadd=\listeadd%
	\let\lorg@listcsadd=\listcsadd%
	\let\lorg@listcseadd=\listcseadd%
	\let\lorg@csappto=\csappto%
	\let\lorg@cseappto=\cseappto%
	\let\lorg@appto=\appto%
	\let\lorg@eappto=\eappto%
}
\def\csglobal{%
	\begingroup\cpge@globaltrue%
	\def\lorg@cslet{\global\cslet}%
	\def\lorg@csletcs{\golbal\csletcs}%
	\let\lorg@def=\gdef%
	\let\lorg@edef=\xdef%
	\let\lorg@csdef=\csgdef%
	\let\lorg@csedef=\csxdef%
	\let\lorg@listadd=\listgadd%
	\let\lorg@listeadd=\listxadd%
	\let\lorg@listcsadd=\listcsgadd%
	\let\lorg@listcseadd=\listcsxadd%
	\let\lorg@csappto=\csgappto%
	\let\lorg@cseappto=\csxappto%
	\let\lorg@appto=\gappto%
	\let\lorg@eappto=\xappto%
}
\def\endcslorg{\ifcpge@global\endgroup\fi}
\cslocal

\def\undef@afterexec#1{\ifdefvoid{#1}{\relax}{#1}\gundef{#1}}
\def\csundef@afterexec#1{\csuse{#1}\csgundef{#1}}

\def\cpge@removestar#1*{#1}
\def\cpge@erasesymbol#1#2+{#2}
\def\cpge@erasestar*#1+{#1}

\newcommand\cpgedefdeco{\@ifstar\cpge@deco@\cpge@deco}

\long\def\@cpge@deco#1#2{
  \long\csdef{deco@#2}##1{\begingroup#1\endgroup}}
\long\def\@cpge@deco@#1#2{
  \long\csdef{deco@#2}{#1}}
\long\def\cpge@deco#1#2{\forcsvlist{\@cpge@deco{#2}}{#1}}
\long\def\cpge@deco@#1#2{\forcsvlist{\@cpge@deco@{#2}}{#1}}
\cpgedefdeco*{simple}{\fbox}

\DeclareDocumentCommand\cpgename{smm}{%
	\IfBooleanT{#1}{\csglobal}%
	\lorg@csdef{name@#2}{#3}%
	\endcslorg
}
\DeclareDocumentCommand\cpgexname{smm}{%
	\IfBooleanT{#1}{\csglobal}%
	\lorg@csedef{name@#2}{#3}%
	\endcslorg%
}
\cpgeset[decorations]{
   .unknown/.code=\cpgedefdeco{\pgfkeyscurrentname}{#1}
}
\def\cpgethe#1{\ifnum\value{#1}>\z@\csuse{the#1}.\fi}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%% base de la gestion des mots clés entre ||  %%%%%

%%%%% Commandes pour le parsing des elements
\DeclareListParser*{\OutParser}{|}
%% \OutParser{\cmd}{item1|item2|...} retourne la séquence
%% \cmd{item1}\cmd{item2}...
\DeclareListParser*{\in@parser}{+}
%% \in@parser{\cmd}{item1+item2+...} retourne la séquence
%% \cmd{item1}\cmd{item2}...
\def\DoubleParser#1#2#3{%
	\def\tmp@parser##1{#1{\in@parser{#2}{##1}}}%
	\OutParser{\tmp@parser}{#3}%
}
%% \DoubleParser{\cmd1}{\cmd2}{1a+1b|2a+2b+2c|...} retourne la sequence 
%% \cmd1{\cmd2{1a}\cmd2{1b}}\cmd1{\cmd2{2a}\cmd2{2b}\cmd2{2c}}...

\DeclareDocumentCommand\csvtolistcsadd{smm}{%
   \IfBooleanT{#1}{\csglobal}%
   \def\do{\forcsvlist{\lorg@listcsadd{#2}}}
   \expandafter\docsvlist\expandafter{#3}
   \endcslorg%
}
\DeclareDocumentCommand\csvtolistcseadd{smm}{%
   \IfBooleanT{#1}{\csglobal}%
   \def\do{\forcsvlist{\lorg@listcseadd{#2}}}
   \expandafter\docsvlist\expandafter{#3}
   \endcslorg%
}
\DeclareDocumentCommand\csvtolistadd{smm}{%
   \IfBooleanT{#1}{\csglobal}%
   \def\do{\forcsvlist{\lorg@listadd{#2}}}
   \expandafter\docsvlist\expandafter{#3}%
   \endcslorg%
}
\DeclareDocumentCommand\csvtolisteadd{smm}{%
   \IfBooleanT{#1}{\csglobal}%
   \def\do{\forcsvlist{\lorg@listeadd{#2}}}
   \expandafter\docsvlist\expandafter{#3}%
   \endcslorg%
}

%%% Gestion de listes CSV
\newrobustcmd{\csvadd}[2]{%
  \ifblank{#2}{}{\appto#1{#2,}}}
\newrobustcmd{\csveadd}[2]{%
  \begingroup
  \edef\cpgeb@tempa{\endgroup\noexpand\ifblank{#2}}%
  \cpgeb@tempa{}{\eappto#1{#2,}}}
\newrobustcmd{\csvgadd}[2]{%
  \ifblank{#2}{}{\gappto#1{#2,}}}
\newrobustcmd{\csvxadd}[2]{%
  \begingroup
  \edef\cpgeb@tempa{\endgroup\noexpand\ifblank{#2}}%
  \cpgeb@tempa{}{\xappto#1{#2,}}}

\newrobustcmd{\csvcsadd}[1]{%
  \expandafter\csvadd\csname#1\endcsname}
\newrobustcmd{\csvcseadd}[1]{%
  \expandafter\csveadd\csname#1\endcsname}
\newrobustcmd{\csvcsgadd}[1]{%
  \expandafter\csvgadd\csname#1\endcsname}
\newrobustcmd{\csvcsxadd}[1]{%
  \expandafter\csvxadd\csname#1\endcsname}
 
\newrobustcmd{\csvremove}[2]{%
  \cpgeb@csvremove{#1}{#2}\def}
\newrobustcmd{\csvgremove}[2]{%
  \cpgeb@csvremove{#1}{#2}\gdef}

\long\def\cpgeb@csvremove#1#2#3{%
  \ifblank{#2}
    {}
    {\ifincsv{#2}{#1}{%
     \begingroup
     \def\cpgeb@tempa##1,#2,##2&{\endgroup
       \expandafter#3\expandafter#1\expandafter{\@gobble##1,##2}}%
    \expandafter\cpgeb@tempa\expandafter,#1&}{}}%
}

\newrobustcmd{\csvcsremove}[1]{%
  \expandafter\csvremove\csname#1\endcsname}
\newrobustcmd{\csvcsgremove}[1]{%
  \expandafter\csvgremove\csname#1\endcsname}

\newrobustcmd{\ifincsv}[2]{%
  \begingroup
  \def\cpgeb@tempa##1,#1,##2&{\endgroup
    \ifblank{##2}\@secondoftwo\@firstoftwo}%
  \expandafter\expandafter\expandafter\cpgeb@tempa
  \expandafter\expandafter\expandafter,\expandafter\zap@space#2 \@empty,#1,&}

\newrobustcmd{\xifincsv}[1]{%
  \begingroup
  \edef\cpgeb@tempa{\endgroup\ifincsv{#1}}%
  \cpgeb@tempa}

\newrobustcmd{\ifincsvcs}[2]{%
  \expandafter\cpgeb@ifincsvcs@i\csname #2\endcsname{#1}}
\long\def\cpgeb@ifincsvcs@i#1#2{\ifincsvcs{#2}{#1}}

\newrobustcmd{\xifincsvcs}[1]{%
  \begingroup
  \edef\cpgeb@tempa{\endgroup\ifincsvcs{#1}}%
  \cpgeb@tempa}


  	
%% ajoute les éléments de #2 (separe par des virgules)
%% a la liste interne \list@#1

\DeclareDocumentCommand\cpgeaddkeyword{st+m+m+m}{%
	\csvtolistcsadd{list@#3}{#4}%
	\IfBooleanT{#1}{\csglobal}%
	\IfBooleanTF{#2}{\long\lorg@csdef{#3@#4}##1{#5}}{\long\lorg@csdef{#3@#4}{#5}}%
	\endcslorg%
}

%% \cpgeaddkeyword{<name>}{<elt>}{<texte>}
%% ajoute <elt> a la liste \list@name et affecte 
%% le code <texte> a la commande sans 
%% parametre \name@elt
%% \cpgeaddkeyword+{<name>}{<elt>}{<texte>}
%% ajoute <elt> a la liste \list@name et affecte 
%% le code <texte> a la commande \name@elt  
%% avec un seul parametre 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%% utilitaires de gestion des compteurs façon cpgebase %%%%%


\def\MO@rdinal#1{%
   \ifcase#1%
   \or Premier \or Deuxi\`eme \or Troisi\`eme \or Quatri\`eme
    \or Cinqui\`eme \or Sixi\`eme \or Septi\`eme \or Huiti\`eme
     \or  Neuvi\`eme \else\@ctrerr\fi}
\def\MOrdinal#1{\expandafter\MO@rdinal\csname c@#1\endcsname}
\def\FO@rdinal#1{%
   \ifcase#1%
   \or Premi\`ere \or Deuxi\`eme \or Troisi\`eme \or Quatri\`eme
    \or Cinqui\`eme \or Sixi\`eme \or Septi\`eme \or Huiti\`eme
     \or  Neuvi\`eme \else\@ctrerr\fi}
\def\FOrdinal#1{\expandafter\FO@rdinal\csname c@#1\endcsname}
\def\mo@rdinal#1{%
   \ifcase#1%
   \or premier \or deuxi\`eme \or troisi\`eme \or quatri\`eme
    \or cinqui\`eme \or sixi\`eme \or septi\`eme \or huiti\`eme
     \or  neuvi\`eme \else\@ctrerr\fi}
\def\mordinal#1{\expandafter\mo@rdinal\csname c@#1\endcsname}
\def\fo@rdinal#1{%
   \ifcase#1%
   \or premi\`ere \or deuxi\`eme \or troisi\`eme \or quatri\`eme
    \or cinqui\`eme \or sixi\`eme \or septi\`eme \or huiti\`eme
     \or  neuvi\`eme \else\@ctrerr\fi}
\def\fordinal#1{\expandafter\fo@rdinal\csname c@#1\endcsname}

%%% cree les listes 
% \list@count=tous les raccourcis, 
% \list@readonly = non modifiables 
% \list@active=raccourcis "actifs"
\csvtolistcsadd{list@count}{1,a,A,i,I,M,F,m,f,s,S,C,q,Q,p,P,e,R,X}
\csvtolistcsadd{list@active}{M,F,m,f,1,a,A,i,I}
\csvtolistcsadd{list@readonly}{M,F,m,f,1,a,A,i,I,q,Q,e,C}

%%% Définition des commandes qui se substituent aux raccourcis dans \list@readonly

%%%%% Hack en attendant de trouver la source de l'erreur \@ctrerr
\def\cpgealph#1{\expandafter\cpge@alph\csname c@#1\endcsname}
\def\cpgeAlph#1{\expandafter\cpge@Alph\csname c@#1\endcsname}
\def\cpge@alph#1{%
  \ifcase#1\or a\or b\or c\or d\or e\or f\or g\or h\or i\or j\or
   k\or l\or m\or n\or o\or p\or q\or r\or s\or t\or u\or v\or w\or x\or
    y\or z\fi}
\def\cpge@Alph#1{%
  \ifcase#1\or A\or B\or C\or D\or E\or F\or G\or H\or I\or J\or
   K\or L\or M\or N\or O\or P\or Q\or R\or S\or T\or U\or V\or W\or X\or
    Y\or Z\fi}
%%%%%

\begingroup
\def\tmp@do#1#2{\csgdef{count@#1}{#2}}
\def\do@do#1{\tmp@do#1}
\forcsvlist{\do@do}{{1}{\arabic},
                     {a}{\cpgealph},
                     {A}{\cpgeAlph},
                     {i}{\roman},
                     {I}{\Roman},
                     {F}{\FOrdinal},
                     {M}{\MOrdinal},
                     {m}{\mordinal},
                     {f}{\fordinal}
                  }
\def\tmp@do#1#2{\csgdef{count@#1}##1{#2}}
\forcsvlist{\do@do}{%
					{q}{\theenumii},
					{Q}{\theenumi},
					{s}{\thesubsection},
					{S}{\thesection},
					{C}{\thechapter},
					{e}{\theequation},
				}
\endgroup

\ifundef{\c@chapter}{\let\thechapter\relax}{}

%\def\nocountertoolargemessage{\let\@ctrerr\relax}

%%%%% Command utilisateur \cpgedefcounter

\DeclareDocumentCommand\cpge@cnt@shortcut{smm}{%
 \in@{!*}{!#2}%
  \ifin@\edef\cshr@{\expandafter\cpge@erasestar#2+}\else\edef\cshr@{#2}\fi
 \xifinlist{\cshr@}{\list@readonly}{\cpgein@true}{}%
 \IfBooleanT{#1}{\cpgein@false}%
 \ifcpgein@%
	\cpgeb@error{impossible de créer le raccourci \cshr@. 
			  \MessageBreak Il est affecté à un compteur système}
			  {le raccourci #2 sera ignoré, 
			  \messageBreak il n'est pas sûr que tout fonctionne ensuite}%
 \else%
      \ifin@\csundef{count@\cshr@}\fi
       \ifcsundef{count@\cshr@}
             {\xifinlist{\cshr@}{\list@count}{}{\listxadd{\list@count}{\cshr@}}%
               \csgdef{count@\cshr@}##1{\csuse{the#3}}}
	         {\cpgeb@error{Le raccourci #2 est pris.}
				        {Vous pouvez l'écraser avec (*#2)}}%
\fi}
 
% {} = name, [] = within list, () = shortcut, <> = label numbering format
\DeclareDocumentCommand\cpgedefcounter{mm o d() d<>}{%
\@bsphack\begingroup
   \def\cpge@tmpa{#2}
   \ifx\cpge@tmpa*
      \global\cslet{label@#1}\relax
   \else 
      \IfValueT{#4}{\cpge@cnt@shortcut{#4}{#1}}
      \ifcpgein@\else
         \ifltxcounter{#1}{}{\newcounter{#1}}
         \ifblank{#2}{\cpgedeflabel*{#1}{|1|}}{\cpgedeflabel*{#1}{#2}}
         \IfValueT{#3}
            {\def\do##1{\counterwithin*{#1}{##1}}\docsvlist{#3}}
         \IfValueT{#5}{\csdef{p@#1}{#5}}
      \fi
   \fi
\endgroup\@esphack}

%%%%% commande utilisateur \cpgedeflabel

\def\single@count@change#1#2{\begingroup%
 \exploregroups\expandarg%
% \expandafter\StrSubstitute\expandafter%
%   {\csname label@#1\endcsname}
%   {|#2|}
	\def\StrSubstitute@expansion{%
	\expandafter\StrSubstitute\expandafter%
	 {\csname label@#1\endcsname}%
	 {|#2|}%
	}
	\expandafter\StrSubstitute@expansion\expandafter%
   		{\csname count@#2\endcsname{#1}}
   		[\tmp@string]%
   \global\let\tmp@string@\tmp@string%
   \endgroup
  \expandafter\ifx\csname label@#1\endcsname\tmp@string@\else%
     \ifinlist{#2}{\list@active}
       {\lorg@csedef{the#1}{%
         \expandafter\expandafter\expandafter\noexpand%
         	\csname count@#2\endcsname{#1}}%
       }{}%
       \lorg@cslet{label@#1}\tmp@string@%
       %\lorg@cslet{theH#1}\tmp@string@%
  \fi%
 } 
\def\count@parser#1#2{%
   \csdef{label@#1}{#2}%
   \def\tmp@for{\single@count@change{#1}}%
   \forlistloop{\tmp@for}{\list@count}%
   \ifcpge@thetolabel\makethetolabel{#1}\fi%
   \endcslorg%
   }
\newcommand\cpgedeflabel{\@ifstar{\csglobal\count@parser}{\count@parser}}
\let\allthetolabel\cpge@thetolabeltrue
\DeclareDocumentCommand\makethetolabel{sm}{%
	\IfBooleanT{#1}{\csglobal}
	\lorg@csedef{the#2}{\expandafter\expandonce\csname label@#2\endcsname}%
	\endcslorg%
}




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%% Environnements de type list %%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%% Options de gestion des espaces pour les questions
%%% clés pour marge et separation
%%% ne doivent pas être utilisées directement
\cpgeset[@lists]{%
   marge/.code=\list@setmarge{#1},
   marge/.default=\z@,
   marge*/.code=\list@setmarge@star{#1},
   marge*/.default=\z@,
   separation/.code=\list@setsep{#1},
   separation/.default=\itemsep@origin,
   separation*/.code=\list@setsep@star{#1},
   separation*/.default=\z@,
}

%%% les commandes suivantes 
%%% ne devraient être utilisées qu'une fois la boite
%%% \cpge@boxa préparée avec un échantillon de numéro.
%%% c'est la commande \list@setprop qui veille à l'exécution
%%% de toute la séquence dans le bon ordre.
%%% Elle même n'est exécutée que lorsqu'une liste
%%% est sur le point d'être initiée.

\def\list@setmarge#1{%
   \expandafter\global\csname leftmargin\cpge@listlevel\endcsname=%
        \dimexpr\wd\cpge@boxa+#1\relax%
   \ifdim\csname leftmargin\cpge@listlevel\endcsname>4em%
       \expandafter\global\csname leftmargin\cpge@listlevel\endcsname=4em%
    \fi%
    \csgdef{marge@\cpge@listctr}{%
        \labelwidth%
            \dimexpr\csname leftmargin\cpge@listlevel\endcsname-\labelsep\relax%
         \itemindent\z@}%
   }
\def\list@setmarge@star#1{%
   \expandafter\global\csname leftmargin\cpge@listlevel\endcsname\dimexpr#1\relax%
   \csgdef{marge@\cpge@listctr}{%
         \labelwidth\z@\itemindent\labelsep}%
  }
\def\list@setsep#1{%
   \csgdef{separation@\cpge@listctr}{%
     \topsep\glueexpr#1\relax%
     \partopsep\z@%
     \itemsep\glueexpr#1\relax}%
 }
\def\list@setsep@star#1{%
   \csgdef{separation@\cpge@listctr}{%
     \topsep\glueexpr#1\relax%
     \partopsep\z@%
     \itemsep\z@}%
 } 

%%% Commandes utilisateur pour configurer marge et separation
%%% Ne font que stocker tels quels les couples key=val dans des macros
%%% et celles-ci ne seront utilisées que lors de l'initialisation  
%%% d'une liste (par \list@setprop)

\NewDocumentCommand\cpgeset@list{ s mm }{
   \IfBooleanT{#1}{\csdef{prop@\cpge@listenv\romannumeral#2}{}}
   \ifnum\numexpr#2>\z@%
      \csappto{prop@\cpge@listenv\romannumeral#2}{#3,}%
   \else%
      \def\tmp@for##1{\csapto{prop@\cpge@listenv\romannumeral##1}{#3}}%
      \forcsvlist{\tmp@for}{1,2,3}%
   \fi%
}
\NewDocumentCommand\cpgeset@list@name{ s mm }{
   \IfBooleanT{#1}{\csdef{prop@#2}{}}
      \csappto{prop@#2}{#3,}%
}
\NewDocumentCommand\cpgesetenum{ s mm }{
   \IfBooleanT{#1}{\csdef{prop@enum\romannumeral#2}{}}
   \ifnum\numexpr#2>\z@%
       \csappto{prop@enum\romannumeral#2}{#3,}%
   \else%
      \def\tmp@for##1{\csappto{prop@enum\romannumeral##1}{#3,}}%
      \forcsvlist{\tmp@for}{1,2,3}%
   \fi%
   %\expandafter\show\csname prop@enum\romannumeral#2\endcsname
}
\NewDocumentCommand\cpgesetitem{ s mm }{
   \IfBooleanT{#1}{\csdef{prop@item\romannumeral#2}{}}
   \ifnum\numexpr#2>\z@%
       \csappto{prop@item\romannumeral#2}{#3,}%
   \else%
      \def\tmp@for##1{\csappto{prop@item\romannumeral##1}{#3,}}%
      \forcsvlist{\tmp@for}{1,2,3}%
   \fi%
}                                                
\def\list@setprop{\begingroup%
   \ifcsdef{c@\cpge@listctr}
      {\csname c@\cpge@listctr\endcsname11\relax}%
      {}
    \setbox\cpge@boxa\hbox{\color@begingroup%
         \csuse{label@\cpge@listctr}\hskip\labelsep\null%
      \color@endgroup}%
      \dimgdef\item@maxwidth{\wd\cpge@boxa}
      \setbox\cpge@boxa\hbox{\color@begingroup%
         \csuse{deco@\cpge@listctr}{\csuse{label@\cpge@listctr}}\hskip\labelsep\null%
      \color@endgroup}
   \edef\cpge@tempa{%
      \noexpand\cpgeset[@lists]{\csuse{prop@\cpge@listctr}}
      }%
   \cpge@tempa% 
   \endgroup%
}   

\cpgesetenum{0}{marge}
\cpgesetitem{0}{marge=1pc}
\cpgedeflabel{enumi}{|1|}
\cpgedeflabel{enumii}{|a|}
\cpgedeflabel{enumiii}{|i|}
\cpgedeflabel{section}{|I|}
\cpgedeflabel{subsection}{|A|}

\cpgedefdeco{enumi}{\bfseries #1.}
\cpgedefdeco{enumii}{\bfseries #1.}
\cpgedefdeco{enumii}{(#1)}
\cpgedefdeco{section}{#1}
\cpgedefdeco{subsection}{#1}
%%%% Chargement de font pour des symboles à utiliser avec {xitem}
\DeclareFontFamily{U}{FdSymbolA}{}
\DeclareFontShape{U}{FdSymbolA}{m}{n}{
    <-> s * [1] FdSymbolA-Book
}{}
\DeclareFontShape{U}{FdSymbolA}{m}{b}{
    <-> s * [1] FdSymbolA-Medium
}{}
\DeclareSymbolFont{fdsymbols}{U}{FdSymbolA}{m}{n}
\SetSymbolFont{fdsymbols}{bold}{U}{FdSymbolA}{m}{b}

\DeclareMathSymbol{\xdottriangleright}{\mathord}{fdsymbols}{9}
\DeclareMathSymbol{\xdottriangleup}{\mathord}{fdsymbols}{10}
\DeclareMathSymbol{\xdottriangleleft}{\mathord}{fdsymbols}{11}
\DeclareMathSymbol{\xdottriangledown}{\mathord}{fdsymbols}{12}
\DeclareMathSymbol{\xdotsquare}{\mathord}{fdsymbols}{13}
\DeclareMathSymbol{\xtrianglerightL}{\mathord}{fdsymbols}{86}
\DeclareMathSymbol{\xtriangleupL}{\mathord}{fdsymbols}{87}
\DeclareMathSymbol{\xtriangleleftL}{\mathord}{fdsymbols}{88}
\DeclareMathSymbol{\xtriangledownL}{\mathord}{fdsymbols}{89}
\DeclareMathSymbol{\xtriangleright}{\mathord}{fdsymbols}{90}
\DeclareMathSymbol{\xtriangleup}{\mathord}{fdsymbols}{91}
\DeclareMathSymbol{\xtriangleleft}{\mathord}{fdsymbols}{92}
\DeclareMathSymbol{\xtriangledown}{\mathord}{fdsymbols}{93}
\DeclareMathSymbol{\xcircle}{\mathord}{fdsymbols}{98}
\DeclareMathSymbol{\xbullet}{\mathord}{fdsymbols}{99}
\DeclareMathSymbol{\xsquareL}{\mathord}{fdsymbols}{117}
\DeclareMathSymbol{\xsquare}{\mathord}{fdsymbols}{118}
\DeclareMathSymbol{\xdiamondL}{\mathord}{fdsymbols}{131}
\DeclareMathSymbol{\xdiamond}{\mathord}{fdsymbols}{132}
\DeclareMathSymbol{\xstarL}{\mathord}{fdsymbols}{148}
\DeclareMathSymbol{\xstar}{\mathord}{fdsymbols}{149}
\DeclareMathSymbol{\xheart}{\mathord}{fdsymbols}{118}
\DeclareMathSymbol{\xspad}{\mathord}{fdsymbols}{185}
\DeclareMathSymbol{\xsuit}{\mathord}{fdsymbols}{186}

\RequirePackage{adforn}
\newcommand*\xheadarrowright{\adforn{43}}
\newcommand*\xheadarrowleft{\adforn{42}}

\def\label@itemi{\relsize{-2}$\xdiamond$}
\def\label@itemii{\relsize{-2}$\xsquare$}
\def\label@itemiii{\relsize{-2}$\xcircle$}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Ajouts 9/12/23 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% interface utilisateur plus conforme à l'orientation globale 

\def\fake@deco#1{#1}
\def\lists@outerr#1{
   \ifundef\cpge@listenv{
   \cpgeb@error{
         l'option #1 ne peut être utilisée \MessageBreak
         en dehors d'un environnement de liste
      }{L'option #1 n'aura aucun effet}
   }{}
}
\newif\iflocal@prop
\def\set@local@prop#1{
   \iflocal@prop%
      \cpgeset@list@name{\cpge@listctr}{#1}
   \else
      \local@proptrue%
      \cpgeset@list@name*{\cpge@listctr}{#1}
   \fi
}
\newif\ifresume@xenum
\cpgeset[lists]{%
   custom counter/.code={%
      \lists@outerr{cc}%
      \ifltxcounter{#1}{}{\cpgedefcounter{#1}{}}%
      \def\cpge@listctr{#1}%
   },
   cc/.style={custom counter=#1},
   resume/.is if=resume@xenum,%
   r/.style={resume=#1},
   label prefix/.code=\def\cpge@enumlabelprefix{#1},
   l/.style={label prefix=#1},
   n/.code=\lists@outerr{n}\cpgedeflabel{\cpge@listctr}{#1},
   n*/.code=\lists@outerr{n*}\cslet{deco@\cpge@listctr}\fake@deco%
             \cpgedeflabel{\cpge@listctr}{#1},
   d/.code=\lists@outerr{d}\cpgedefdeco*{\cpge@listctr}{#1},
   d*/.code=\lists@outerr{d*}\cpgedefdeco{\cpge@listctr}{#1},
   m/.code=\lists@outerr{m}\set@local@prop{marge=#1},
   m*/.code=\lists@outerr{m*}\set@local@prop{marge*=#1},
   s/.code=\lists@outerr{s}\set@local@prop{separation=#1},
   s*/.code=\lists@outerr{s*}\set@local@prop{separation*=#1},
   m/.default=\z@,
   m*/.default=\z@,
   enum@i/.is family,
   enum@i/n/.code=\cpgedeflabel{enumi}{#1},
   enum@i/n*/.code=\let\deco@enumi\fake@deco
                    \cpgedeflabel{enumi}{#1},
   enum@i/d*/.code=\cpgedefdeco{enumi}{#1},
   enum@i/d/.code=\cpgedefdeco*{enumi}{#1},
   enum@i/m/.code=\cpgesetenum{1}{marge=#1},
   enum@i/m*/.code=\cpgesetenum{1}{marge*=#1},
   enum@i/s/.code=\cpgesetenum{1}{separation=#1},
   enum@i/s*/.code=\cpgesetenum{1}{separation*=#1},
   enum@i/m/.default=\z@,
   enum@i/m*/.default=\z@,
   enumi/.code=\pgfqkeys{/cpge/lists/enum@i}{#1},
   enum@ii/.is family,
   enum@ii/n/.code=\cpgedeflabel{enumii}{#1},
   enum@ii/n*/.code=\let\deco@enumii\fake@deco%
                     \cpgedeflabel{enumii}{#1},
   enum@ii/d*/.code=\cpgedefdeco{enumii}{#1},
   enum@ii/d/.code=\cpgedefdeco*{enumii}{#1},
   enum@ii/m/.code=\cpgesetenum{2}{marge=#1},
   enum@ii/m*/.code=\cpgesetenum{2}{marge*=#1},
   enum@ii/s/.code=\cpgesetenum{2}{separation=#1},
   enum@ii/s*/.code=\cpgesetenum{2}{separation*=#1},
   enum@ii/m/.default=\z@,
   enum@ii/m*/.default=\z@,
   enumii/.code=\pgfqkeys{/cpge/lists/enum@ii}{#1},
   enum@iii/.is family,
   enum@iii/n/.code=\cpgedeflabel{enumiii}{#1},
   enum@iii/n*/.code=\let\deco@enumiii\fake@deco%
                      \cpgedeflabel{enumiii}{#1},
   enum@iii/d*/.code=\cpgedefdeco{enumiii}{#1},
   enum@iii/d/.code=\cpgedefdeco*{enumiii}{#1},
   enum@iii/m/.code=\cpgesetenum{3}{marge=#1},
   enum@iii/m*/.code=\cpgesetenum{3}{marge*=#1},
   enum@iii/s/.code=\cpgesetenum{3}{separation=#1},
   enum@iii/s*/.code=\cpgesetenum{3}{separation*=#1},
   enum@iii/m/.default=\z@,
   enum@iii/m*/.default=\z@,
   enumiii/.code=\pgfqkeys{/cpge/lists/enum@iii}{#1},
   item@i/.is family,
   item@i/n/.store in=\label@itemi,
   item@i/n*/.code=\let\deco@itemi\fake@deco%
                    \cpgedeflabel{itemi}{#1},
   item@i/d/.code=\cpgedefdeco{itemi}{#1},
   item@i/d*/.code=\cpgedefdeco*{itemi}{#1},
   item@i/m/.code=\cpgesetitem{1}{marge=#1},
   item@i/m*/.code=\cpgesetitem{1}{marge*=#1},
   item@i/s/.code=\cpgesetitem{1}{separation=#1},
   item@i/s*/.code=\cpgesetitem{1}{separation*=#1},
   item@i/m/.default=\z@,
   item@i/m*/.default=\z@,
   itemi/.code=\pgfqkeys{/cpge/lists/item@i}{#1},
   item@ii/.is family,
   item@ii/n/.store in=\label@itemii,
   item@ii/n*/.code=\let\deco@itemii\fake@deco%
                         \cpgedeflabel{itemii}{#1},
   item@ii/d/.code=\cpgedefdeco{itemii}{#1},
   item@ii/d*/.code=\cpgedefdeco*{itemii}{#1},
   item@ii/m/.code=\cpgesetitem{2}{marge=#1},
   item@ii/m*/.code=\cpgesetitem{2}{marge*=#1},
   item@ii/s/.code=\cpgesetitem{2}{separation=#1},
   item@ii/s*/.code=\cpgesetitem{2}{separation*=#1},
   item@ii/m/.default=\z@,
   item@ii/m*/.default=\z@,
   itemii/.code=\pgfqkeys{/cpge/lists/item@ii}{#1},
   item@iii/.is family,
   item@iii/n/.store in=\label@itemiii,
   item@iii/n*/.code=\let\deco@itemiii\fake@deco%
                      \cpgedeflabel{itemiii}{#1},
   item@iii/d/.code=\cpgedefdeco{itemiii}{#1},
   item@iii/d*/.code=\cpgedefdeco*{itemiii}{#1},
   item@iii/m/.code=\cpgesetitem{3}{marge=#1},
   item@iii/m*/.code=\cpgesetitem{3}{marge*=#1},
   item@iii/s/.code=\cpgesetitem{3}{separation=#1},
   item@iii/s*/.code=\cpgesetitem{3}{separation*=#1},
   item@iii/m/.default=\z@,
   item@iii/m*/.default=\z@,
   itemiii/.code=\pgfqkeys{/cpge/lists/item@iii}{#1},
}
\cpgeset[lists]{local/.is family, local/.cd, t/.store in=\local@item, .unknown/.code=\relax}

\def\cpgesetlists{\cpgeset[lists]}
\def\@ques@{%
   \list@setprop%
   \expandafter
   \list
   \csname label@\cpge@listctr\endcsname%
        {\usecounter{\cpge@listctr}%
        \csuse{marge@\cpge@listctr}%
         \csuse{separation@\cpge@listctr}%
         \listparindent\parindent%
          \let\makelabel\cpge@makelabel%
        }
   }
\def\@ques@star{%
   \list@setprop%
   \expandafter
   \list
   \csname label@\cpge@listctr\endcsname%
        {\csuse{marge@\cpge@listctr}%
         \csuse{separation@\cpge@listctr}%
         \listparindent\parindent%
          \let\makelabel\cpge@makelabel%
        }
   }
\def\cpge@makelabel#1{\hfill\ifblank{#1}{}{\csuse{deco@\cpge@listctr}{#1}}}
\NewDocumentCommand\xenum{o}{%
   \def\cpge@listenv{enum}
   \def\cpge@xlistenv{xenum}
   \ifnum \@enumdepth >2 \@toodeep\else%
      \advance\@enumdepth\@ne%
      \edef\cpge@listdepth{\the\@enumdepth}
      \edef\cpge@listlevel{\romannumeral\@enumdepth}%
      \edef\cpge@listctr{enum\cpge@listlevel}%
   \fi%
   \IfValueT{#1}{\cpgeset[lists]{#1}}%
   \@ques@%
   \ifresume@xenum%
      \csname c@\cpge@listctr\expandafter\endcsname
       \csname last@\cpge@listctr\endcsname\relax%
        \resume@xenumfalse%
   \fi%
 }
 \def\endxenum{\save@enumctr\endlist}
 \def\save@enumctr{%
	\csnumgdef{last@\cpge@listctr}{\value{\cpge@listctr}}%
}
 \NewDocumentCommand\xitem{o}{%
  \def\cpge@listenv{item}
  \def\cpge@xlistenv{xitem}
  \ifnum \@itemdepth >2 \@toodeep\else%
      \advance\@itemdepth\@ne%
      \edef\cpge@listdepth{\the\@itemdepth}
      \edef\cpge@listlevel{\romannumeral\@itemdepth}%
      \edef\cpge@listctr{item\cpge@listlevel}%
  \fi%
  \IfValueT{#1}{\cpgeset[lists]{#1}}%
  \@ques@star%
 }
\let\endxitem\endlist
\NewDocumentCommand\init@xlist{mm t- t- t- t\r t+  E{\op}{{}} }{
	\IfBooleanTF{#6}%
        {\begin{#1}[r,#8]}
        {\IfBooleanT{#7}{\begin{#1}[#8]}}%
	\IfBooleanT{#3}{\exit-\IfBooleanT{#4}{\exit-\IfBooleanT{#5}{\exit-}}}%
	\cpgeset[lists]{local,#8}
	#2%
}
\NewDocumentCommand\xit@enum{o E{\zap}{{@}} d() d<>}{%
      \ifstrequal{#2}{@}{}
            {\addtocounter{\cpge@listctr}{#2}}%
      \IfValueTF{#1}
         {\item[#1]}
         {\item}%
      \IfValueT{#3}
         {\deco@itemtitle{#3}}%
      \IfValueT{#4}
         {\label{\cpge@enumlabelprefix#4}}%
 }
\def\xitenum{\init@xlist{xenum}\xit@enum}
\NewDocumentCommand\xit@item{E{\lab\zap}{{}{@}} d() d<>}{%
   \ifblank{#1}
         {\item}
         {\item[\csuse{deco@\cpge@listctr}{#1}]}%
   \IfValueT{#3}{\deco@itemtitle{#3}}%
}
\def\xititem{\init@xlist{xitem}\xit@item}
\def\xit{\@ifstar\xititem\xitenum}
\def\cpge@enumlabelprefix{}
\def\end@xlist{%
	\ifundef\cpge@listenv{}{\expandafter\end\expandafter{\cpge@xlistenv}}
}
\def\end@xlist@rec{%
   \ifundef\cpge@listenv{}{%
      \expandafter\end\expandafter{\cpge@xlistenv}%
		 \end@xlist@rec%
  }%
}%
\NewDocumentCommand\exit{t- t- t- t-}{
   \IfBooleanTF{#1}
      {%
         \end@xlist%
         \IfBooleanT{#2}
            {\end@xlist%
               \IfBooleanT{#3}{%
                     \end@xlist%
                      \IfBooleanT{#3}{%
                         \end@xlist}%
               }%
            }%
      }%
      {\end@xlist@rec}%
}
\NewDocumentCommand\cpgenewlist{ smmm }{
   \IfBooleanF{#1}{
      \expandafter\newcommand\csname#2\endcsname[1][]
         {\xenum[#4,##1]\def\cpge@xlistenv{#2}}
      \csdef{end#2}{\save@enumctr\endlist}
      \def#3{\init@xlist{#2}\xit@enum}
   }
   \IfBooleanT{#1}{
      \expandafter\newcommand\csname#2\endcsname[1][]
         {\xitem[#4]\def\cpge@xlistenv{#2}}
      \cslet{end#2}\endlist
      \def#3{\init@xlist{#2}\xit@item}
   }
}



%%%% 
\DeclareDocumentCommand\disc@unite{mmd()}{
   \IfValueTF{#3}{\item[#1#3#2]}{\item}
}
\def\item@imp#1#2{\item[$#1\Rightarrow#2\,)$]} 
\def\item@equiv#1#2{\item[$#1\Leftrightarrow#2\,)$]} 
\newenvironment*{discussion}[1][]{%
	\def\unite{\disc@unite{}{~:~}}%
	\def\si{\disc@unite{Si\ }{~:~}}%
	\def\cas{\disc@unite{Cas où\ }{~:~}}
	\let\imp\item@imp
   \let\equ\item@equiv
	\def\cs{\item[$\Leftarrow\,)$]}
	\def\cn{\item[$\Rightarrow\,)$]}
	\list{}{%
		\ifblank{#1}
			{\labelwidth=\z@ \leftmargin=1pc \itemindent=-\leftmargin}
			{%
				\settowidth\leftmargin{#1}%
				\advance\leftmargin\labelsep%
				\labelwidth=\leftmargin%
				\itemindent\z@%
			}
    	\let\makelabel\discuss@label%
	}%
}{%
  \endlist
}
\def\discuss@label#1{%
	\hskip\labelsep%
	\ifblank{#1}
		{\makebox[\leftmargin-\labelsep][l]{\deco@discuss{}}}
		{\deco@discuss{#1}\hfil}%
	}
\cpgedefdeco{discuss}{$\bullet\;$ \bfseries\boldmath #1}
%% Pour compatibilite
\let\discuss\discussion
\let\enddiscuss\enddiscussion

%% Ajout 07/01/2024
%% Commande \unite pour utilisation dans theoremes et similaire
%% sans que l'utilisateur ait besoin d'initier une liste. 
%% C'est l'environnement qui s'en charge.
%% Il doit initier la commande \unite avec \def\unite{\first@unite}
%% dans le bloc d'ouverture.
%% et avoir \endlist dans le bloc de fermeture ou d'utilise \closeunite. 
\let\thegobbler\@gobble
\cpge@cnt@shortcut{X}{gobbler}
\cpgedefcounter{unite}{|X|.|1|}(T)
\cpgedefdeco{unite}{\bfseries#1.}
\makethetolabel{unite}
\newif\ifinsideuniteenv
\def\unite@env{%
   \@enumdepth\@ne%
   \list\label@unite%
        {\usecounter{unite}%
         \listparindent\z@%
		   \labelwidth\z@%
		    \itemindent\labelsep%
		     \leftmargin\z@%
			  \let\makelabel\lab@unite%
        }%
 }
 \def\lab@unite#1{\ifblank{#1}{}{\deco@unite{#1}}}
 \def\closeunite{
   \ifinsideuniteenv%
      \endlist%
      \let\unite\relax%
      \insideuniteenvfalse%
   \fi%
}
 \def\first@unite{%   
   \insideuniteenvtrue
   \cpgedeflabel{enumii}{|T|.|1|}%
 	\cpgedeflabel{enumiii}{|q|.|a|}%
	\def\unite{\unite@}%
	\unite@env\unite%
 }
 \DeclareDocumentCommand\unite@{od()d<>}{%
	\IfValueTF{#1}{\item[#1]}{\item}%
	\IfValueT{#2}{\deco@unitetitle{#2}}%
	\IfValueT{#3}{\IfValueF{#1}{\label{#3}}}%
}
\cpgedefdeco{unitetitle}{\textbf{#1~:~}}
\def\set@defaultforlistsinsideunite{
	\def\unite{\first@unite}%
	\cpgesetenum{1}{marge*}%
	\cpgesetenum{2}{marge}%
	\cpgesetenum{3}{marge*}%
	\cpgedefdeco{enumii}{\bfseries ##1.}%
	\cpgedefdeco{enumiii}{\bfseries ##1.}
}

%%% Ajout 2020 
%%% environnement simple pour formater conditions et conséquences (obsolete)
\def\ccsi{\relsize{-2}$\xbullet\;$}
\def\blneutre{\relsize{-2}$\xsquare\;$}
\def\ccalors{\relsize{-2}$\xdiamond\;$}
\newdimen\ccleftmargin
\newdimen\ccrightmargin
\newdimen\ccsymbolwidth
\settowidth\ccsymbolwidth{\enskip\ccsi\;}
\def\ccjot{3pt}
\newif\ifccinsidetab
\newif\ifccvline
\settowidth\ccleftmargin{Si} 
\DeclareDocumentEnvironment{cond}{O{\ccleftmargin} O{l}}{%
	\ifhmode\par\else\leavevmode\fi%
	\extrarowheight3pt%
	\tabular[t]{@{}p{#1}@{\ccsi}#2@{}}%
	}
	{\endtabular\par\smallskip}
\DeclareDocumentEnvironment{cons}{O{\ccleftmargin} O{l}}{%
	\ifhmode\par\else\leavevmode\fi%
	\extrarowheight3pt%
	\tabular[t]{@{}p{#1}@{\ccalors}#2@{}}%
	}
	{\endtabular\par\smallskip}
\DeclareDocumentEnvironment{stab}{O{2cm} O{l}}{%
	\extrarowheight3pt%
	\tabular[t][t]{@{}p{#1}#2@{}}%
	}
	{\endtabular\par\smallskip}

%%% Ajout le 21/12/2023
%%% Environnement {condcons} plus évolué
%%% capable de mesurer les parties latérales du tableau. 
\NewDocumentCommand\line@tab{ D(){\ccneutre} somo }{%
   \tab@init%
   \IfValueT{#3}{#3}&#1\enskip\null&#4&\IfValueT{#5}{#5}%
   \IfBooleanF{#2}{\cr}%
}
\def\tab@init{%
   \ifccinsidetab\else%
      \ifccvline%
         \init@tab%
      \else%
         \init@tab@novline%
      \fi%
   \fi%
}
\def\init@tab{%
   \ifhmode\hfill\par\fi\addvspace{\smallskipamount}%
   \ccinsidetabtrue%
   \csuse{tabular*}{\linewidth-\@totalleftmargin}[t]
      {@{}p{\ccleftmargin}|r@{}
         p{\linewidth-\ccleftmargin-\ccrightmargin-\ccsymbolwidth
            -2\tabcolsep-\fboxrule}@{}%
         p{\ccrightmargin}@{}}%
}
\def\init@tab@novline{%
   \ifhmode\hfill\par\fi\addvspace{\smallskipamount}%
   \ccinsidetabtrue%
   \csuse{tabular*}{\linewidth-\@totalleftmargin}[t]
      {@{}p{\ccleftmargin}@{\enskip}@{}r@{}
         p{\linewidth-\ccleftmargin-\ccrightmargin-\ccsymbolwidth-1em}@{}
         p{\ccrightmargin}@{}}%
}

\def\close@tab{%
   \ifccinsidetab%
      \csuse{endtabular*}\par\addvspace{\medskipamount}%
      \ccinsidetabfalse%
   \fi}
\long\def\no@tab#1{\close@tab#1}
\def\first@linetab{%
   \close@tab%
   \def\linetab{\line@tab}%
   \linetab%
}
\def\first@cond{%
   \close@tab%
   \def\cond{\line@tab(\ccsi)}%
   \cond%
}
\def\first@cons{%
   \close@tab%
   \def\cons{\line@tab(\ccalors)}%
   \cons%
}
\def\break@tab{%
   \close@tab\ifccvline\init@tab\else\init@tab@novline\fi%
}
\def\symbol@measuring#1{%
   \setbox0\hbox{#1\enskip}%
   \ifdim\wd0>\ccsymbolwidth\relax\global\ccsymbolwidth\wd0\fi
}
\DeclareDocumentCommand\cc@measuring{ d()somo }{%
   \IfValueT{#3}{%}
      \setbox0\hbox{#3}%
      \ifdim\wd0>\ccleftmargin\relax\global\ccleftmargin\wd0\fi%
   }
   \IfValueT{#5}{%
      \setbox0\hbox{#5}%
       \ifdim\wd0>\ccrightmargin\relax\global\ccrightmargin\wd0\fi%
      }%
   \IfValueT{#1}{\symbol@measuring{#1}}
}
\long\def\condcons@measuring#1{%
   \@bsphack%
      \settowidth\ccsymbolwidth{\ccsi\enskip\null}
      \ccleftmargin\z@\relax\ccrightmargin\z@\relax%
      \def\cond{\cc@measuring}%
      \def\cons{\cc@measuring}%
      \def\linetab{\@ifnextchar(\cc@measuring{\cc@measuring(\ccneutre)}}%
      \let\breaktab\relax%
      \def\notab##1{}%
      \setbox0\vbox{\everypar{}#1}%
   \@esphack%
}
\NewDocumentEnvironment{condcons}{O{}+b}{%
   \dimdef\ccleftmargin@limit{.28\linewidth}%
   \dimdef\ccrightmargin@limit{.17\linewidth}%
   \symbol@measuring{\ccsi}%
   \symbol@measuring{\ccalors}%
   \cpgeset[condcons]{#1}%
   \condcons@measuring{#2}%
   \ifdim\ccleftmargin>\ccleftmargin@limit\relax%
      \ccleftmargin=\ccleftmargin@limit%
   \fi%
   \ifdim\ccrightmargin>\ccrightmargin@limit\relax%
      \ccrightmargin=\ccrightmargin@limit%
   \fi%
	\extrarowheight=\ccjot\relax%
   \everymath{\displaystyle}%
   \let\breaktab\break@tab%
   \let\notab\no@tab%
   \def\linetab{\first@linetab}%
   \def\cond{\first@cond}%
   \def\cons{\first@cons}%
      #2 
   \close@tab%
}{}
\cpgeset[condcons]{%
   l/.code=\dimdef\ccleftmargin@limit{#1},
   r/.code=\dimdef\ccrightmargin@limit{#1},
   s/.code=\dimdef\ccjot{#1},
   s/.default=3pt,
   f/.is if=ccvline
}

%%%%%% lrmargin and mini environments %%%%
%%%%%% Borrowed from adjustwidth.sty

\newenvironment{lrmargin}[3][]{%
  \advance\cpge@lrcount\@ne%
  \list\relax{%
    \topsep\smallskipamount%
    \listparindent\parindent%
    \parsep\parskip%
		\itemindent\z@\relax%
      \labelwidth\z@\relax%
		\itemindent\labelsep%
	 \ifnum\cpge@lrcount>\tw@%
		\leftmargin\z@\relax%
		\rightmargin\z@\relax%
	\else%
    	\ifblank{#2}{\leftmargin\z@}{\leftmargin=#2\relax}%
    	\ifblank{#3}{\rightmargin\z@}{\rightmargin=#3\relax}%
	\fi%
   \let\makelabel\lrmargin@label%
    }%
    \item[#1]\ignorespaces}
 {\endlist}
\def\lrmargin@label#1{%
	\ifblank{#1}{\relax}
				 {\csuse{deco@lrmargin}{#1}}%
	}
\cpgedefdeco{lrmargin}{\fbox{#1}} 

\dimdef\lrmarginleft{\z@}
\dimdef\lrmarginright{\z@}
\cpgeset[mini]{%
	left margin/.code=\dimdef{\lrmarginleft}{#1},
	right margin/.code=\dimdef{\lrmarginright}{#1},
   lm/.style={left margin=#1},
   rm/.style={right margin=#1},
	font/.code=\def\mini@font{#1},
	label font/.code=\def\mini@label@font{#1\vphantom{(}},
	mini deco/.code=\cpgedefdeco{lrmargin}{\mini@label@font#1},
}
\cpgeset[mini]{%
	font=\sffamily\small,
	label font=\sffamily\small\scshape\bfseries,
	mini deco/.initial={#1.}
	}
\DeclareDocumentEnvironment{MINI}{O{} D(){}}{%
		\cpgeset[mini]{#1}%
      \ifdim\leftmargin>3.4em\relax
         \let\lrmarginleft\z@
      \fi
		\begin{lrmargin}[\MakeLowercase{#2}]
			{\lrmarginleft}
			{}%
		\mini@font%
	}{\end{lrmargin}}

\def\mini{\begin{MINI}}
\def\endmini{\end{MINI}}
\def\nb{\mini(n.b)}
\let\endnb\endmini
\def\dem{\mini(dem)}
\let\enddem\endmini
\def\ind{\mini(ind)}
\let\endind\endmini
\def\snt{\mini(synthèse)}
\let\endsnt\endmini 
\def\newmini#1#2{\csdef{#1}{\mini(#2)}\cslet{end#1}\endmini}

%%%%%% Ajout 17/07/2021 %%%%%%%%
%%%%% Pointillé 
\setlength{\ligneskip}{\baselineskip*\real{.33}}
\def\set@point@box{\setbox\cpge@boxb=\hbox{\deco@pointille\hss}}
\cpgedefdeco{pointille}{\textcolor{black!75}{\rule{.8pt}{.4pt}\hskip1.2pt}}
\def\lignes{\@ifstar\cpge@lign\cpge@lign@}
\def\cpge@lign@{\set@point@box%
	\hbox{}\vrule height \ligneskip width\z@\relax%
	 \xleaders\copy\cpge@boxb\hskip 0pt plus 1fill%
	  \vadjust{\vskip\ligneskip}%
	   \hbox{}\cpge@lign%
}
\def\cpge@lign#1{\set@point@box%
 	\par\addvspace{\ligneskip}
	\begingroup%
	 \foreach \x in{1,2,...,#1}
		{\hbox to \hsize {%
		  \mbox{}\xleaders\copy\cpge@boxb\hskip 0pt plus 1fill\relax
		  \vadjust{\vskip\ligneskip}\hbox{}}
		}
	\endgroup
	 \addvspace{\ligneskip*\real{2.0}}
}
\def\points{\@ifstar\cpge@point@@\cpge@point@}
\def\cpge@point@#1{\set@point@box%
		\hbox to #1{\xleaders\copy\cpge@boxb\hskip 0pt plus 1fill\hbox{}}}
\def\cpge@point@@#1{\set@point@box%
		\xleaders\copy\cpge@boxb\hskip 0pt plus 1fill\hbox{}\linebreak
		\hbox to #1{\xleaders\copy\cpge@boxb\hskip 0pt plus 1fill\hbox{}}%
}

%%% Ajout 05/08/2021
%%% gestion des références croisées VANILLA du noyaux LaTeX
%%% les commandes ne sont pas utilisables dans les documents finaux.

\def\cpgeG@refundefinedtrue{%
  \gdef\cpge@refundefined{%
    \@latex@warning@no@line{There were undefined references}}}
    
\let\cpge@refundefined\relax

\def\cpge@setref#1#2#3{%
  \ifx#1\relax
   \protect\cpgeG@refundefinedtrue
   \nfss@text{\reset@font\bfseries ??}%
   \@latex@warning{Reference `#3' on page \thepage \space
             undefined}%
  \else
   \expandafter#2#1\null
  \fi}
  
\def\cpge@ref#1{\expandafter\cpge@setref\csname r@#1\endcsname\@firstoftwo{#1}}

\def\cpge@pageref#1{\expandafter\cpge@setref\csname r@#1\endcsname
                                   \@secondoftwo{#1}}
\def\cpge@newl@bel#1#2#3{{%
%  \@ifundefined{#1@#2}%
%    \relax
%    {\gdef \cpge@multiplelabels {%
%       \@latex@warning@no@line{There were multiply-defined labels}}%
%     \@latex@warning@no@line{Label `#2' multiply defined}}%
  \global\@namedef{#1@#2}{#3}}}
\def\cpge@newlabel{\cpge@newl@bel r}

%\@onlypreamble\cpge@newl@bel
\let \cpge@multiplelabels \relax

\def\cpge@label#1{\@bsphack
  \write\@auxout{}%
         {\string\cpge@newlabel{#1}{{\cpge@currentlabel}{\thepage}}}%
  \@esphack}

\def\cpge@currentcounter{}

\def\cpge@refstepcounter#1{\stepcounter{#1}%
    \edef\cpge@currentcounter{#1}%
    \edef\cpge@currentlabel
       {\csname p@#1\expandafter\endcsname\csname the#1\endcsname}%
}
% commande ajoutée pour référencer un compteur en utilisant \addtocounter
\def\cpge@refaddtocounter#1#2{%
    \addtocounter{#1}{#2}%
    \edef\cpge@currentcounter{#1}%
    \edef\cpge@currentlabel
    {\csname p@#1\expandafter\endcsname\csname the#1\endcsname}% 
 }
\def\cpge@labelformat#1{\expandafter\def\csname p@#1\endcsname##1}
\DeclareRobustCommand\cpgeRef[1]{\edef\@tempa{\cpgeref{#1}}%
   \expandafter\Makeuppercase\@tempa}

\def\cpge@currentlabel{}

%%% code from glocalvals.sty

\newcommand{\usevalue}[1]{%
  \ifcsname cpgeval@#1\endcsname\csname cpgeval@#1\endcsname\fi}

% cpgeval@#1 is defined in the .aux file to be used on the next run.
% cpgeval@#1@defined is defined immediately to mark that cpgeval@#1 has already
% been used and cannot be used again
\newcommand{\defvalue}[2]{%
\ifcsname cpgeval@#1@defined\endcsname
  \PackageError{cpgebase}{Value "#1" already defined}{}%
\else%
  \write\@auxout{%
    \unexpanded{\csgdef{cpgeval@#1}{#2}}%
  }%
  \csgdef{cpgeval@#1@defined}{}%
  \csgdef{cpgeval@#1}{#2}%
  \PackageInfo{cpgebase}{Defining new variable "#1" with value "#2"}%
\fi%
}

\def\fntht{\fontcharht\font`}
\def\fntdp{\fontchardp\font`}
\def\fntwd{\fontcharwd\font`}
\newcommand\cpge@square[1][x]{\rule{\fntht#1}{\fntht#1}}
  
%%%% Ajout 09/10/2023
%%%% emprunté à answers.sty et tcolorbox.sty avec adaptation 
%%%% Pemet d'écrire les solutions dans un fichier séparé.
%%%% L'écriture ne se produit que si \ifsolution est initialisé en true.  
%%%% \ifsolution doit être déclaré par la classe avant le chargement de cpgebase.sty.
%%%% Sa création ici provoquera sa réinitialisation en false. 
\ifundef{\ifsolution}{\newif\ifsolution}{}


%%% tcolorbox.sty : 
%%% environnement : {cpgewriteonce}, #1 est le nom d'un fichier physique
%%% crée le fichier #1, l'associe au stream cpgeoutonce, y écrit et le ferme.
%%% si \cpgewriteonce est utilisé dans un environnement avec un/des arguments
%%% optionnels, veiller à ce que les arguments suivent le nom de l'environnement
%%% sur la même ligne et sans espaces entre eux pour empêcher TeX d'aller chercher 
%%% trop loin des arguments, avalant des espaces et empêchant une lecture
%%% verbatim correcte.  (prefixer les spec des arguments xparse par !)
\RequirePackage{verbatim}
\def\cpge@allocate@out{%
  \newwrite\cpge@out%
  \xdef\cpge@allocate@out{}%
}
\let\cpge@verbatim@begin@hook\@empty
\let\cpge@verbatim@end@hook\@empty
\let\cpge@verbatim@change@percent\@empty
\let\cpge@set@verbatim@finish\@empty
\def\cpgewriteonce#1{%
  \@bsphack
  \cpge@set@verbatim@finish%
  %\cpge@allocate@out%
  \cpgeopenfile{solhandle}
  \immediate\openout\solhandle@file #1.tex
  \cpge@verbatim@begin@hook%
  \let\do\@makeother\dospecials
  \cpge@verbatim@change@percent\catcode`\^^M\active \catcode`\^^I=12
  \def\verbatim@processline{%
    \immediate\write\solhandle@file
      {\the\verbatim@line}}%
  \verbatim@start}%'
\def\endcpgewriteonce{%
  \cpge@verbatim@end@hook%
  \immediate\closeout\solhandle@file
  \@esphack%
}

\def\cpge@null#1{}
\newcommand{\cpge@record}[1]{\immediate\write\cpge@out{#1}}

\newcommand{\cpgestartrecording}[1][\jobname.records]{%
  \let\cpgerecord\cpge@record%
  \edef\cpge@record@file{#1}%
  \cpge@allocate@out%
  \immediate\openout\cpge@out\cpge@record@file%
}

\newcommand{\cpgestoprecording}{%
  \immediate\closeout\cpge@out%
  \let\cpgerecord\cpge@null%
}

%%% answers.sty : 
%%% environnement : {cpgefilesave}, #1 est le nom d'un stream. 
%%% \cpgeopenfile{#1}[#2] crée le stream #1 et l'associe à au fichier physique #2, 
%%% sans #2 un fichier physique de nom #1 est crée.
%%% \cpgeclosefile{#1} ferme le stream #1, 
%%% \cpgereadfile{#1} ouvre le fichier associé au stream #1 s'il existe, 
%%% \cpgereadfile est remplaçable par un \input direct sur le fichier physique.
%%% plusieurs écritures possibles entre fermeture et ouverture du stream.
%%% possible de changer de fichier physique associé au stream, 
%%% aucune écriture si \solutionfalse : 
%%% fichier physique créé par \cpgeopenfile mais reste vide.

\long\def\cpgeprotected@iwrite#1#2#3{%
  \begingroup
    \let\thepage\relax
    #2%
    \let\protect\@unexpandable@protect
    \edef\reserved@a{\immediate\write#1{#3}}%
    \reserved@a
  \endgroup
  \if@nobreak
    \ifvmode
      \nobreak
    \fi
  \fi
}

\newenvironment{cpgefilesave}[1]{%
   \@bsphack
   \def\verbatim@processline{}%
   \ifcpge@fileundefined{#1}{}{%
      \ifcpge@open{#1}{%
         \def\verbatim@processline{%
            \ifcpge@solution{%
               \immediate\write\@nameuse{#1@file}%
                  {\the\verbatim@line}%
            }{}%
         }%
      }{}%
   }%
   \let\do\@makeother\dospecials
   \catcode`\^^M\active \catcode`\^^I=12\relax
   \verbatim@start
}{\@esphack}

\newcommand{\cpgewritetofile}[2]{%
   \@bsphack
   \ifcpge@fileundefined{#1}{}{%
      \ifcpge@open{#1}{%
         {%
            \let\protect\string
            \ifcpge@solution{%
               \cpgeprotected@iwrite{\@nameuse{#1@file}}{}{#2}%
            }{}%
         }%
      }{}%
   }%
   \@esphack%
}

\newcommand{\ifcpge@open}[3]{%
   \csname if#1open\endcsname#2\else#3\fi}%
   
\newcommand{\ifcpge@fileundefined}[3]{%
   \csname ifx\expandafter\endcsname
      \csname #1@file\endcsname\relax
      #2\else#3\fi}
      
\newcommand{\ifcpge@solution}[2]{%
   \ifsolution #1\else #2\fi}
   
\def\cpgeopenfile#1{%
	\expandafter\ifx\csname #1opentrue\endcsname\relax
      \expandafter\newif\csname if#1open\endcsname
   \fi
   \@ifnextchar[{\cpgedefine@filename{#1}}%
      {\cpgedefine@filename{#1}[#1]}}%
      
\def\cpgedefine@filename#1[#2]{%
   \global\@namedef{#1@filename}{#2.tex}%
   \ifcpge@solution{%
      \typeout{Output from handle #1 going
         to #2.tex}%
   }{}%
   \ifcpge@fileundefined{#1}{%
      \expandafter\newwrite\csname #1@file\endcsname
      \csname newif\expandafter\endcsname
         \csname if#1open\endcsname
      \global\csname #1openfalse\endcsname
      \expandafter\ifx\csname Open#1hook\endcsname\relax
         \global\@namedef{Open#1hook}##1{}%
      \fi
      \expandafter\ifx\csname Close#1hook\endcsname\relax
         \global\@namedef{Close#1hook}##1{}%
      \fi
   }{}%
   \let\Tmp\relax
   \ifcpge@open{#1}{\typeout{File #1 already open}}{%
      \ifcpge@solution{%
         \immediate\openout\@nameuse{#1@file}=%
         \@nameuse{#1@filename}%
      }{}%
      \global\csname#1opentrue\endcsname
      \def\Tmp{\@nameuse{Open#1hook}{#1}}%
   }%
   \Tmp
}

\def\cpgeclosefile#1{%
   \let\Tmp\relax
   \ifcpge@fileundefined{#1}{}{%
      \ifcpge@open{#1}{%
         \ifcpge@solution{%
            \immediate\closeout\@nameuse{#1@file}%
         }{}%
         \global\csname #1openfalse\endcsname
         \def\Tmp{\@nameuse{Close#1hook}{#1}}%
      }{}%
   }%
   \Tmp
}

\def\cpgereadfile#1{%
   \ifcpge@solution{%
      \ifcpge@fileundefined{#1}{}{%
         \ifcpge@open{#1}{%
            \typeout{WARNING: attempt to read open file #1}%
         }{%
            \edef\Tmp{%
               \noexpand\InputIfFileExists
                  {\@nameuse{#1@filename}}{}%
               {\noexpand\message{File
                  \@nameuse{#1@filename}%
                     \space not found}}%
            }%
            \Tmp
         }%
      }%
   }{}%
}

%%%%% Enonce/Corrige %%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% \NewDocumentEnvironment{enonce}{mm O{} d() d<>}{%
% 			\def\cpge@current@id{#2}%
% 			\csepreto{\cpge@current@id @opts}{\expandonce\corr@common@opt,}%
% 			\cpgeset[@problem]{current counter=#1,#3}%
% 			\ifcsundef{#2@title}{\csdef{#2@title}{#4}}{}%
% 			%\problemtitle{#2}{#3}(##3)<##4>
% 			\setup@id%
% 			\setup@sol%
% 			\setup@hint%
% 			\csuse{hook@beforeproblem}%
% 		}{%
% 			\exit%
% 			\csuse{hook@afterproblem}%
% 			\close@problem{#2}%
% 		}


%%% Ajout 07/08/2021
%%% interface pgfkeys pour contrôler les styles de page selon titlesec.sty %%%

\newpagestyle{main}[\fontsize{8}{8}\sffamily\scshape\itshape]{
   \renewcommand\makeheadrule{\csuse{deco@headrule}}
   \renewcommand\makefootrule{\csuse{deco@footrule}}
   \sethead{}{}{}
   \setfoot{}{}{\hf@page}
  }
\renewpagestyle{plain}[\fontsize{8}{8}\sffamily\scshape\itshape]{
   \renewcommand\makeheadrule{}
   \renewcommand\makefootrule{}
   \sethead{}{}{}
   \setfoot{}{page \thepage{}}{}
 }

%%%% Entetes et pieds de pages

\csvtolistcsadd{list@hf}{%
	centre,classe,periode,document,devoir,
	concours,epreuve,session,matiere,theme,subtheme,auteur,email,website}
	
\def\tmp@do#1{\csdef{hf@#1}{\csuse{cpge@#1}}}
\forcsvlist\tmp@do{%
	centre,classe,periode,document,devoir,
	concours,epreuve,session,matiere,theme,subtheme,auteur,email,website}

\def\hf@change#1#2{%
   \StrSubstitute{#1}
     {|#2|}{\csname hf@#2\endcsname}[\tmp@string]%
     \global\let#1\tmp@string
 }
\def\hf@parser#1#2#3{\begingroup
    \csgdef{#1@\romannumeral#2}{#3}
    \expandafter\def\expandafter\hf@change@\expandafter%
         {\expandafter\hf@change\expandafter%
           {\csname#1@\romannumeral#2\endcsname}}
    \exploregroups\expandarg
    \forlistloop{\hf@change@}{\list@hf}%
    \endgroup
}
\NewDocumentCommand\cpgesethead{o O{} O{} D(){} D(){} D(){}}{%
	\IfNoValueTF{#1}
	{\hf@parser{head}{4}{#4}
      \hf@parser{head}{5}{#5}
       \hf@parser{head}{6}{#6}
        \sethead{\head@iv}{\head@v}{\head@vi}
    }
	{\hf@parser{head}{1}{#1}
     \hf@parser{head}{2}{#2}
      \hf@parser{head}{3}{#3}
       \hf@parser{head}{4}{#4}
      	\hf@parser{head}{5}{#5}
         \hf@parser{head}{6}{#6}
          \sethead[\head@i][\head@ii][\head@iii]
                            {\head@iv}{\head@v}{\head@vi}
     }
  }
\NewDocumentCommand\cpgesetfoot{o O{} O{} D(){} D(){} D(){}}{%
	\IfNoValueTF{#1}
	{\hf@parser{foot}{4}{#4}
      \hf@parser{foot}{5}{#5}
       \hf@parser{foot}{6}{#6}
       \setfoot{\foot@iv}{\foot@v}{\foot@vi}
    }
	{\hf@parser{foot}{1}{#1}
     \hf@parser{foot}{2}{#2}
      \hf@parser{foot}{3}{#3}
       \hf@parser{foot}{4}{#4}
      	\hf@parser{foot}{5}{#5}
         \hf@parser{foot}{6}{#6}
          \setfoot[\foot@i][\foot@ii][\foot@iii]
             {\foot@iv}{\foot@v}{\foot@vi}
     }
  }
\RequirePackage{lastpage}
\cpgeaddkeyword{hf}{auteur}{\scshape\csuse{cpge@auteur}}
\cpgeaddkeyword{hf}{concours}{\scshape\csuse{cpge@concours}}
\cpgeaddkeyword{hf}{session}{\scshape\csuse{cpge@session}}
\cpgeaddkeyword{hf}{chapter}{\chaptertitle}
\cpgeaddkeyword{hf}{section}{\sectiontitle}
\cpgeaddkeyword{hf}{C}{\ifnum\value{chapter}>\z@\thechapter\fi}
\cpgeaddkeyword{hf}{S}{\ifnum\value{section}>\z@\thesection\fi}
\cpgeaddkeyword{hf}{page}{\thepage}
\cpgeaddkeyword{hf}{pages}{page\enskip\thepage{} / \pageref*{LastPage}}
\cpgeaddkeyword{hf}{square}{\cpge@square}
\cpgeaddkeyword{hf}{tpsvp}{\quad\cpge@square[1]\ %
  \ifnum\c@page<\getrefbykeydefault{LastPage}{page}{0}
  \cpge@square[1]\ \cpge@square[1]
  \fi}
\def\hf@deco{\title@deco}


%%% Entete/pied de page 
\newpagestyle{cpgemain}[\fontsize{8}{8}\sffamily\scshape\itshape]{
   \renewcommand\makeheadrule{\csuse{head@rule}}
   \renewcommand\makefootrule{\csuse{foot@rule}}
   \sethead{}{}{}
   \setfoot{}{}{\hf@page}
  }
\AtBeginDocument{\pagestyle{cpgemain}}

%%%%%%%
%%%%%%%%%
\endinput

\let\action@parser\@firstofone
\def\generic@parser#1#2{%
   \IfSubStr{#2}{(}
      {\gen@parser{#1}#2}
      {\gen@parser@{#1}{#2}}%
 }
\def\gen@parser#1#2(#3){%
   \ifcsdef{#1@#2}
      {\expandafter\action@parser\expandafter{\csname#1@#2\endcsname{#3}}}
      {\ifcsdef{#2}
         {\ifcsdef{#1@#3}
            {\expandafter\action@parser\expandafter%
               {\csname#2\endcsname{\csname#1@#3\endcsname}}}
            {\expandafter\action@parser\expandafter%
               {\csname#2\endcsname}{#3}}%
         }
         {#2(#3)}%
       }%
    }

\def\gen@parser@#1#2{%
   \ifcsdef{#1@#2}
     {\expandafter\action@parser
       \expandafter{\csname#1@#2\endcsname{}}}
     {\ifcsdef{#2}
       {\action@parser{\csname#2\endcsname}}
         {\action@parser{#2}}%
     }%
  }

\long\def\Ifiscs#1{%
    \if\noexpand#1\relax
        \expandafter\@firstoftwo
    \else
        \ifcat\noexpand~\noexpand#1%
            \expandafter\expandafter
            \expandafter\@firstoftwo
        \else
            \expandafter\expandafter
            \expandafter\@secondoftwo
        \fi
    \fi
}
\def\mapcs#1{\Ifiscs#1{\forcsvlist{#1}}{}}
\def\mapscss#1#2{\Ifiscs#1{\forcsvlist}}

